# Time-why it also matters {#Time}

The chapter contains the theory required for handling time series data. From this chapter, the reader will have gained an understanding of the following topics:

- That a temporal process consists of both low and high frequency components, the former playing a key role in determining long-term trends while the latter may be associated with shorter-term changes.
- Techniques for the exploratory analysis of the data generated by the temporal process, including the ACF (correlogram) and PACF (periodogram).
- Models for irregular (high frequency) components after the regular components (trend) have been removed.
- Methods for forecasting, including exponential smoothing and ARIMA modelling.
- The state space modelling approach, which sits naturally within a Bayesian setting and which provides a general framework for most of the classical time series models and many more besides.
- Implementing time series processes within a Bayesian hierarchical framework.


## Example 11.1 Ground level ozone concentrations {-}


Load the daily and hourly data for one site.

```{r Ex 11.1 load data, message=FALSE, echo = TRUE, warning=FALSE, message= FALSE}

library(ggplot2)

# Load data for one site
site_daily <- read.csv("data/LA_ozone_daily.csv", header = TRUE)

# change the format of the date column
site_daily$date <- as.Date(site_daily$date, "%m/%d/%Y")

# load hourly data from that same site
site_hourly <- read.csv("data/LA_ozone_hourly.csv", header = TRUE)

# Add a theme to clear axes and background in ggplot (optional)
theme_clear <- function(){
  theme(
    panel.grid.major = element_blank(), # remove background grid
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), # remove grey background
    axis.line = element_line(colour = "black") # keep axis line
  )
}
  
```


Plot the daily and hourly time series. 

```{r Ex 11.1 plot time series}
# Plot daily data
ggplot(data = site_daily) +
  geom_line(aes(x = date, y = max.ozone, group = 1)) +
  # draw a line at the first data
  geom_vline(xintercept = as.Date("2013-01-01"), color = "grey") +
  # 8 hour regulatory standard of 0.075 (ppm)
  geom_hline(yintercept = 0.075, color = "grey") +
  xlab("Day in 2013 at Los Angeles Site 060379033") + 
  ylab("Max Daily 8hr Ozone Level (ppm)") + theme_clear()
  

# Plot hourly data
ggplot(data = site_hourly,) +
  geom_line(aes(x = time, y = ozone, group = 1)) +
  geom_vline(xintercept = 1, color = "grey") +
   # 8 hour regulatory standard of 0.075 (ppm).
  geom_hline(yintercept = 0.075, color = "grey") +
  xlab("Hour in 2013's ozone season") + 
  ylab("Hourly Ozone Concentration (ppm)") +  theme_clear()

```

## Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average {-}

```{r Ex 11.2 clean, include = FALSE}
rm(list=ls())
```

For this example we will use the TTR package (Technical Trading Rules). This allow us to manipulate objects like time series for forecasting.


```{r Ex 11.2 load data, message=FALSE, echo = TRUE, warning=FALSE, message= FALSE}

library(TTR)
# Load daily data
site_daily <- read.csv("data/LA_ozone_daily.csv", header = TRUE)
# add an identifier column for each day in the sample
site_daily$day <- 1:nrow(site_daily)
# add a theme to clear axes and background in ggplot
theme_clear <- function(){
  theme(
    panel.grid.major = element_blank(), # remove background grid
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), # remove grey background
    axis.line = element_line(colour = "black"), # keep axis line
  )
}

```


```{r Ex 11.2 moving averages plot, warning=FALSE}

# Add loess smooth
# Single day
ozone.loess <- loess(max.ozone ~ day, span = 0.75, data = site_daily[,c("max.ozone", "day")])
ozone.predict <- predict(ozone.loess, data.frame(day = 1:nrow(site_daily)))
ozone.predict_df <- data.frame(day = 1:nrow(site_daily), 
                               ozone.prediction = ozone.predict)

ggplot(data = site_daily) +
  geom_line(aes(x = day, y = max.ozone, group = 1)) +
  geom_line(data = ozone.predict_df, aes(x = day, y = ozone.predict)) +
  xlab("Day in 2013 at Los Angeles Site 060379033") + 
  ylab("Max Daily 8hr Ozone Level (ppm)") +
  ggtitle("Single day") + 
  theme_clear()

# Three days
ozone_SMA3 <- data.frame(sma = SMA(site_daily$max.ozone, n = 3),
                         day = 1:nrow(site_daily))

ggplot(data = ozone_SMA3) +
  geom_line(aes(x = day, y = sma, group = 1)) +
  geom_line(data = ozone.predict_df, aes(x = day, y = ozone.predict)) +
  xlab("Day in 2013 at Los Angeles Site 060379033") + 
  ylab("Max Daily 8hr Ozone Level (ppm)") +  
  ggtitle("Three days") + 
  theme_clear()


# Six days
ozone_SMA6 <- data.frame(sma = SMA(site_daily$max.ozone, n = 6),
                         day = 1:nrow(site_daily))

ggplot(data = ozone_SMA6) +
  geom_line(aes(x = day, y = sma, group = 1)) +
  geom_line(data = ozone.predict_df, aes(x = day, y = ozone.predict)) +
  xlab("Day in 2013 at Los Angeles Site 060379033") + 
  ylab("Max Daily 8hr Ozone Level (ppm)") +  
  ggtitle("Six days") + 
  theme_clear()


# Twelve days
ozone_SMA12 <- data.frame(sma = SMA(site_daily$max.ozone, n = 12),
                         day = 1:nrow(site_daily))

ggplot(data = ozone_SMA12) +
  geom_line(aes(x = day, y = sma, group = 1)) +
  geom_line(data = ozone.predict_df, aes(x = day, y = ozone.predict)) +
  xlab("Day in 2013 at Los Angeles Site 060379033") + 
  ylab("Max Daily 8hr Ozone Level (ppm)") +
  ggtitle("Twelve days") + 
  theme_clear()

```

## Example 11.13 Forecasting ozone levels {-}

```{r Ex 11.12 clean, include = FALSE}
rm(list = ls())
```

```{r Ex 11.13 load, message=FALSE, echo = TRUE, warning=FALSE, message= FALSE}

library(TTR)
library(forecast)

# Load hourly data for site 060379033
site_hourly <- read.csv("data/LA_ozone_hourly.csv", header = TRUE)
# add a theme to clear axes and background in ggplot
theme_clear <- function(){
  theme(
    panel.grid.major = element_blank(), # remove background grid
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), # remove grey background
    axis.line = element_line(colour = "black"), # keep axis line
  )
}

```

```{r Ex 11.13 data munge}

# one night hour per day missing for instrument calibration - imputed for simplicity
imputeNA <- mean(site_hourly$ozone, na.rm = TRUE)
site_hourly$ozone[is.na(site_hourly$ozone)] <- imputeNA

# Select the first seven days in july
# days_pattern contains the dates for the first seven days
days_pattern <- paste0("^2013070", 1:7, collapse="|") 

# select all the rows that follow that pattern using grepl
july_seven_days <- site_hourly[grepl(days_pattern, site_hourly$datetime),] 
july_seven_days$hours <- 1:nrow(july_seven_days)

# Turn this into a time series object to use Holt-Winters forecast
level_ts <- ts(july_seven_days$ozone,
               frequency = 24,
               start = c(1))

ozone_forecast <- HoltWinters(level_ts) 
ozone_forecast_fitted <- as.data.frame(ozone_forecast$fitted)
ozone_forecast_fitted$hours <- 1:nrow(ozone_forecast_fitted) + 24 

# Plot Holt-Winters model fitting
## REVIEW: I know you might not like it but the plot from the forecast package seems more straightforwardthan using ggplot, I'll leave the two for now

# Plot using ggplot
ggplot(july_seven_days) + # Plot the original data for the first seven days
  geom_line(aes(x = hours, y = ozone)) +
  # Plot the fitted values
  geom_line(data = ozone_forecast_fitted, aes(x = hours, y = xhat), linetype = "dashed") +
  ggtitle("Holt-Winters filtering") +
  xlab("Hours - First Week -July 2013") +
  theme_clear()

# Plot using the default function
plot(
  ozone_forecast,
  xlab = "Hours - First Week -July 2013",
  ylab = "O3 (ppm)",
  col.predicted = 1,
  col = "black",
  lty = 2
)

# Holt- Winters 24 ahead forast on Day 8 
# no need to specify Holt-Winters forecast as the object is already HoltWinters class
ozoneforecast_day8 <- forecast(ozone_forecast, h=24)
ozoneforecast_day8_df <- data.frame(mean =  as.vector(ozoneforecast_day8$mean),
                            lwr = as.vector(ozoneforecast_day8$lower[,"95%"]),
                            uppr =  as.vector(ozoneforecast_day8$upper[,"95%"]),
                            hours = (nrow(july_seven_days)+1):(nrow(july_seven_days) + 24))

# Plot using ggplot
ggplot(july_seven_days) +
  geom_line(aes(x = hours, y = ozone))  +
  geom_line(data = ozoneforecast_day8_df, aes(x = hours, y = mean), color = "blue") +
  geom_ribbon(data = ozoneforecast_day8_df,
              aes(ymin = lwr, ymax = uppr, x = hours),
              alpha = 0.3) +
  ggtitle("Forecasts from Holt Winters") + theme_clear()

# Plot using default function
plot(ozoneforecast_day8)

```

## Example 11.14 Forecasting volcanic ash {-}


```{r Ex 11.14 clean, include = FALSE}
rm(list = ls())
```

The data in this example consists of atmospheric levels of volcanic ash from 1500AD to 2000AD. 

```{r Ex 11.14 load, message=FALSE, echo = TRUE, warning=FALSE, message= FALSE}

library(ggplot2)
library(forecast)
library(TTR)

# Load volcano dust data 
## REVIEW: Data source: Hyn�d�man, R.J.  Time Series Data Library, http://data.is/TSDLdemo
# Data cover the period from 1500AD to 2000AD
volcano_dust <-
  scan("http://robjhyndman.com/tsdldata/annual/dvi.dat", skip = 1)

# Add a theme to clear axes and background in ggplot
theme_clear <- function(){
  theme(
    panel.grid.major = element_blank(), # remove background grid
    panel.grid.minor = element_blank(),
    panel.background = element_blank(), # remove grey background
    axis.line = element_line(colour = "black"), # keep axis line
  )
}


```

The following figure shows the plot of the original time series.

```{r Ex 11.14 plot time series ACF and PACF}

# Turn data into data frame to plot it in ggplot
volcano_dust_df <- data.frame(year = 1500:(1500+length(volcano_dust)-1),
                              dust = volcano_dust)

ggplot(data = volcano_dust_df) +
  geom_line(aes(x = year, y = dust, group = 1)) +
  xlab("Year") + 
  ylab("Atmospheric levels of volcanic ash") + theme_clear()
  
```


We can also plot the autocorrelogram (ACF) and partial autocorrelogram (PACF) to identify any autocorrelation in the time series.

```{r Ex 11.14 acf and pacf}

# convert data into a time series object
volcano_dust_series <- ts(volcano_dust, start = c(1500))

# Compute the autocorrelogram with max lag 20
volcano_acf <- acf(volcano_dust_series, lag.max = 20, plot = FALSE) 
# create a data frame with the output of acf
volcano_acf_df <- with(volcano_acf, data.frame(lag, acf))
# Compute 95% CI
conf.level <- 0.95
ciline <- qnorm((1 - conf.level)/2)/sqrt(length(volcano_dust_series))
# plot using ggplot
ggplot(data = volcano_acf_df, mapping = aes(x = lag, y = acf)) +
  geom_hline(aes(yintercept = 0)) +
  # plot acf as lines 
  geom_segment(mapping = aes(xend = lag, yend = 0)) +
  # show the 95%CI 
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') + 
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') + 
  ggtitle("Autocorrelogram volcano dust") +
  theme_clear()

# Or plot using the acf function directly
acf(volcano_dust_series, lag.max = 20) 
# Compute the partial autocorrelogram with max lag 20 
volcano_pacf <- pacf(volcano_dust_series, lag.max = 20, plot = FALSE) 
# create a data frame with the output of pacf
volcano_pacf_df <- with(volcano_acf, data.frame(lag, acf))
# plot using ggplot
ggplot(data = volcano_pacf_df, mapping = aes(x = lag, y = acf)) +
  geom_hline(aes(yintercept = 0)) +
  # plot acf as lines
  geom_segment(mapping = aes(xend = lag, yend = 0)) +
  # plot 95%CI
  geom_hline(aes(yintercept = ciline), linetype = 2, color = 'blue') + 
  geom_hline(aes(yintercept = -ciline), linetype = 2, color = 'blue') + 
  ggtitle("Partial autocorrelogram volcano dust") +
  theme_clear()

# Or plot using pacf function directly
pacf(volcano_dust_series, lag.max = 20)

```

```{r Ex 11.14 arima model}

# Finding an ARIMA model
auto.arima(volcano_dust_series, ic = "aic")

# fitting the ARIMA(2,0,0) model
volcano_dust_arima <- arima(volcano_dust_series, order = c(2, 0, 0))

# forecast 31 years with the ARIMA(2,0,0) model
volcano_dust_forecast <- forecast(volcano_dust_arima, h = 31)
plot(volcano_dust_forecast)

# Make a data frame with the forecast information for ggplot
volcano_dust_forecast_df <- data.frame(
  mean =  as.vector(volcano_dust_forecast$mean),
  lwr = as.vector(volcano_dust_forecast$lower[, "95%"]),
  uppr =  as.vector(volcano_dust_forecast$upper[, "95%"]),
  year = 1970:2000
)

# Same plot using ggplot
ggplot(volcano_dust_df) +
  geom_line(aes(x = year, y = dust))  +
  geom_line(data = volcano_dust_forecast_df, aes(x = year, y = mean), color = "blue") +
  geom_ribbon(data = volcano_dust_forecast_df,
              aes(ymin = lwr, ymax = uppr, x = year),
              alpha = 0.3) +
  ggtitle("Forecasts from ARIMA (2, 0, 0)") + theme_clear()

```










