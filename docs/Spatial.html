<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2022-12-05" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="trusted.html"/>
<link rel="next" href="Disease.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data:increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a>
<ul>
<li class="chapter" data-level="" data-path="embracing.html"><a href="embracing.html#example-5.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 5.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="embracing.html"><a href="embracing.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="embracing.html"><a href="embracing.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="embracing.html"><a href="embracing.html#example-5.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 5.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs-1"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r-1"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>7</b> But-can the data be trusted</a></li>
<li class="chapter" data-level="8" data-path="Spatial.html"><a href="Spatial.html"><i class="fa fa-check"></i><b>8</b> Spatial patterns in disease</a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 8.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 8.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 8.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 8.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> # Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a>
<ul>
<li class="chapter" data-level="" data-path="frontiers.html"><a href="frontiers.html#course"><i class="fa fa-check"></i>Course</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Spatial" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Spatial patterns in disease<a href="Spatial.html#Spatial" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter introduces disease mapping and contains the theory for spatial lattice processes and models for performing smoothing of risks over space. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Disease mapping, where we have seen how to improve estimates of risk by borrowing strength from adjacent regions which can reduce the instability inherent in risk estimates (SMRs) based on small expected numbers.</li>
<li>Seen how smoothing can be performed using either the empirical Bayes or fully Bayesian approaches.</li>
<li>Been introduced to computational methods for handling areal data.</li>
<li>Learned about Besag’s seminal contributions to the field of spatial statistics including the very important concept of a Markov random field.</li>
<li>Explored approaches to modelling a real data including the conditional auto regressive models.</li>
<li>Seen how Bayesian spatial models for lattice data use <code>nimble</code>, <code>stan</code>, <code>R</code> and <code>R–INLA</code>.</li>
</ul>
<div id="example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="section level2 unnumbered hasAnchor">
<h2>Example 8.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010<a href="Spatial.html#example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Following Example 5.2 we look back at the hospital admission rates for COPD, in England for 2010. We can implement the same model we used on Example 5.2 in <code>nimble</code>.</p>
<div id="nimble" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Spatial.html#nimble" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following is the code for the Poisson-Gamma model implemented in <code>nimble</code>.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="Spatial.html#cb99-1" aria-hidden="true" tabindex="-1"></a>Example8_1Code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb99-2"><a href="Spatial.html#cb99-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb99-3"><a href="Spatial.html#cb99-3" aria-hidden="true" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb99-4"><a href="Spatial.html#cb99-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: There is an intercept in the book, </span></span>
<span id="cb99-5"><a href="Spatial.html#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but then we wouldn&#39;t be able to compare it to example 5.2</span></span>
<span id="cb99-6"><a href="Spatial.html#cb99-6" aria-hidden="true" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> E[i] <span class="sc">*</span> theta[i]</span>
<span id="cb99-7"><a href="Spatial.html#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: Same as before, the example in the book has theta[i] ~ Ga(a,a)</span></span>
<span id="cb99-8"><a href="Spatial.html#cb99-8" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dgamma</span>(a, b)</span>
<span id="cb99-9"><a href="Spatial.html#cb99-9" aria-hidden="true" tabindex="-1"></a>    Y.fit[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb99-10"><a href="Spatial.html#cb99-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-11"><a href="Spatial.html#cb99-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-12"><a href="Spatial.html#cb99-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb99-13"><a href="Spatial.html#cb99-13" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dexp</span>(lambda_a)</span>
<span id="cb99-14"><a href="Spatial.html#cb99-14" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dexp</span>(lambda_b)</span>
<span id="cb99-15"><a href="Spatial.html#cb99-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-16"><a href="Spatial.html#cb99-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Define the constants, data and initials lists for the <code>Nimble</code> model.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="Spatial.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb100-2"><a href="Spatial.html#cb100-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb100-3"><a href="Spatial.html#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb100-4"><a href="Spatial.html#cb100-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb100-5"><a href="Spatial.html#cb100-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb100-6"><a href="Spatial.html#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter of exponential prior for a</span></span>
<span id="cb100-7"><a href="Spatial.html#cb100-7" aria-hidden="true" tabindex="-1"></a>lambda_a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb100-8"><a href="Spatial.html#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter of exponential prior for b</span></span>
<span id="cb100-9"><a href="Spatial.html#cb100-9" aria-hidden="true" tabindex="-1"></a>lambda_b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb100-10"><a href="Spatial.html#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="Spatial.html#cb100-11" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb100-12"><a href="Spatial.html#cb100-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb100-13"><a href="Spatial.html#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb100-14"><a href="Spatial.html#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> lambda_a,</span>
<span id="cb100-15"><a href="Spatial.html#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> lambda_b</span>
<span id="cb100-16"><a href="Spatial.html#cb100-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-17"><a href="Spatial.html#cb100-17" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> y)</span>
<span id="cb100-18"><a href="Spatial.html#cb100-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-19"><a href="Spatial.html#cb100-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate initial values</span></span>
<span id="cb100-20"><a href="Spatial.html#cb100-20" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span></span>
<span id="cb100-21"><a href="Spatial.html#cb100-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>()</span>
<span id="cb100-22"><a href="Spatial.html#cb100-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb100-23"><a href="Spatial.html#cb100-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">theta =</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb100-24"><a href="Spatial.html#cb100-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">a =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_a),</span>
<span id="cb100-25"><a href="Spatial.html#cb100-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_b),</span>
<span id="cb100-26"><a href="Spatial.html#cb100-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y.fit =</span> <span class="fu">rpois</span>(N, E)</span>
<span id="cb100-27"><a href="Spatial.html#cb100-27" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>Define the parameter monitors and run the model.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="Spatial.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters to monitor</span></span>
<span id="cb101-2"><a href="Spatial.html#cb101-2" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;Y.fit&quot;</span>)</span>
<span id="cb101-3"><a href="Spatial.html#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="Spatial.html#cb101-4" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb101-5"><a href="Spatial.html#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example8_1Code,</span>
<span id="cb101-6"><a href="Spatial.html#cb101-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb101-7"><a href="Spatial.html#cb101-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb101-8"><a href="Spatial.html#cb101-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># provide the combined data &amp; constants as constants</span></span>
<span id="cb101-9"><a href="Spatial.html#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb101-10"><a href="Spatial.html#cb101-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb101-11"><a href="Spatial.html#cb101-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">50000</span>,</span>
<span id="cb101-12"><a href="Spatial.html#cb101-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb101-13"><a href="Spatial.html#cb101-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">30</span>,</span>
<span id="cb101-14"><a href="Spatial.html#cb101-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-15"><a href="Spatial.html#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb101-16"><a href="Spatial.html#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb101-17"><a href="Spatial.html#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb101-18"><a href="Spatial.html#cb101-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Check the WAIC and ESS.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="Spatial.html#cb102-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2416.146
## Field &quot;lppd&quot;:
## [1] -1060.126
## Field &quot;pWAIC&quot;:
## [1] 147.947</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="Spatial.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 240.898</code></pre>
<p>Show the trace plots and posterior summaries for each of the parameters.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="Spatial.html#cb106-1" aria-hidden="true" tabindex="-1"></a>mvSamples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples</span>
<span id="cb106-2"><a href="Spatial.html#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-3"><a href="Spatial.html#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of a</span></span>
<span id="cb106-4"><a href="Spatial.html#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="Spatial.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of b</span></span>
<span id="cb107-2"><a href="Spatial.html#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="Spatial.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<pre><code>## 
## Iterations = 1:1000
## Thinning interval = 1 
## Number of chains = 2 
## Sample size per chain = 1000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##    Mean    SD Naive SE Time-series SE
## a 11.79 1.006  0.02249        0.06538
## b 12.12 1.050  0.02347        0.06774
## 
## 2. Quantiles for each variable:
## 
##     2.5%   25%   50%   75% 97.5%
## a  9.871 11.12 11.74 12.39 13.94
## b 10.142 11.45 12.06 12.77 14.33</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="Spatial.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of theta&#39;s</span></span>
<span id="cb110-2"><a href="Spatial.html#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb110-3"><a href="Spatial.html#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;theta[&quot;</span>, i, <span class="st">&quot;]&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-3.png" width="672" /><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-4.png" width="672" /><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-5.png" width="672" /></p>
<p>Now that we have checked the convergence of the chains we can plot the posterior mean and 95% CIs for each of the parameters.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="Spatial.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summaries of theta_i</span></span>
<span id="cb111-2"><a href="Spatial.html#cb111-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains  <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb111-3"><a href="Spatial.html#cb111-3" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>)</span>
<span id="cb111-4"><a href="Spatial.html#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="Spatial.html#cb111-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the mean and 95% CIs for the thetas</span></span>
<span id="cb111-6"><a href="Spatial.html#cb111-6" aria-hidden="true" tabindex="-1"></a>post_theta <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;theta</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb111-7"><a href="Spatial.html#cb111-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-8"><a href="Spatial.html#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb111-9"><a href="Spatial.html#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb111-10"><a href="Spatial.html#cb111-10" aria-hidden="true" tabindex="-1"></a>  post_theta<span class="sc">$</span>Mean,</span>
<span id="cb111-11"><a href="Spatial.html#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb111-12"><a href="Spatial.html#cb111-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb111-13"><a href="Spatial.html#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb111-14"><a href="Spatial.html#cb111-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb111-15"><a href="Spatial.html#cb111-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb111-16"><a href="Spatial.html#cb111-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>))</span>
<span id="cb111-17"><a href="Spatial.html#cb111-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb111-18"><a href="Spatial.html#cb111-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb111-19"><a href="Spatial.html#cb111-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb111-20"><a href="Spatial.html#cb111-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="Spatial.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb112-2"><a href="Spatial.html#cb112-2" aria-hidden="true" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;Y.fit</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb112-3"><a href="Spatial.html#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="Spatial.html#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb112-5"><a href="Spatial.html#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb112-6"><a href="Spatial.html#cb112-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb112-7"><a href="Spatial.html#cb112-7" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb112-8"><a href="Spatial.html#cb112-8" aria-hidden="true" tabindex="-1"></a>  post_fitted<span class="sc">$</span>Mean,</span>
<span id="cb112-9"><a href="Spatial.html#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)),</span>
<span id="cb112-10"><a href="Spatial.html#cb112-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb112-11"><a href="Spatial.html#cb112-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb112-12"><a href="Spatial.html#cb112-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb112-13"><a href="Spatial.html#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb112-14"><a href="Spatial.html#cb112-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb112-15"><a href="Spatial.html#cb112-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb112-16"><a href="Spatial.html#cb112-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb112-17"><a href="Spatial.html#cb112-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb112-18"><a href="Spatial.html#cb112-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20posterior%20summary-2.png" width="672" /></p>
</div>
<div id="stan" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Spatial.html#stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Load <code>stan</code> with options</p>
<p>Write the <code>stan</code> model. This model is in a separate file called <code>Example8_1.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  real&lt;lower=0&gt; E[N]; // need to indicate that variable is strictly positive
  int&lt;lower=0&gt; Y[N];
  real&lt;lower=0&gt;lambda_a;
  real&lt;lower=0&gt;lambda_b;
}


parameters {
  
  real&lt;lower=0&gt; theta[N];
  real&lt;lower=0&gt; a;
  real&lt;lower=0&gt; b;
  
}


transformed parameters{
  
  real &lt;lower=0&gt; mu[N];
  
  for(i in 1:N){
    mu[i]=E[i]*theta[i];
  }
  
}


model {
  
  // likelihood function and prior for theta
  for(i in 1:N){
    Y[i] ~ poisson(mu[i]);
    theta[i]~gamma(a,b);
  }
  a~exponential(lambda_a);
  b~exponential(lambda_b);
}

generated quantities {
  
  
  vector [N] log_lik;
  int&lt;lower=0&gt; yfit [N];
  
  //computing the log_likelihood for each value of the mean mu and the fitted values
  for(i in 1:N){
    log_lik[i]=poisson_lpmf(Y[i] |mu[i]);
    yfit[i]=poisson_rng(mu[i]);
  }
  
}</code></pre>
<p>Define the data for the model, similar to <code>nimble</code>.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="Spatial.html#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb114-2"><a href="Spatial.html#cb114-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb114-3"><a href="Spatial.html#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb114-4"><a href="Spatial.html#cb114-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb114-5"><a href="Spatial.html#cb114-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb114-6"><a href="Spatial.html#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="Spatial.html#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data list </span></span>
<span id="cb114-8"><a href="Spatial.html#cb114-8" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb114-9"><a href="Spatial.html#cb114-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb114-10"><a href="Spatial.html#cb114-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> y,</span>
<span id="cb114-11"><a href="Spatial.html#cb114-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb114-12"><a href="Spatial.html#cb114-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> <span class="dv">1</span>,</span>
<span id="cb114-13"><a href="Spatial.html#cb114-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> <span class="dv">1</span></span>
<span id="cb114-14"><a href="Spatial.html#cb114-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb114-15"><a href="Spatial.html#cb114-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-16"><a href="Spatial.html#cb114-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the model in Stan</span></span>
<span id="cb114-17"><a href="Spatial.html#cb114-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-18"><a href="Spatial.html#cb114-18" aria-hidden="true" tabindex="-1"></a>mod0 <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb114-19"><a href="Spatial.html#cb114-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example8_1.stan&quot;</span>,</span>
<span id="cb114-20"><a href="Spatial.html#cb114-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb114-21"><a href="Spatial.html#cb114-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb114-22"><a href="Spatial.html#cb114-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb114-23"><a href="Spatial.html#cb114-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb114-24"><a href="Spatial.html#cb114-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb114-25"><a href="Spatial.html#cb114-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>),</span>
<span id="cb114-26"><a href="Spatial.html#cb114-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> <span class="st">&quot;random&quot;</span>,</span>
<span id="cb114-27"><a href="Spatial.html#cb114-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;log_lik&quot;</span>, <span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb114-28"><a href="Spatial.html#cb114-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb114-29"><a href="Spatial.html#cb114-29" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Compute the WAIC.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="Spatial.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb115-2"><a href="Spatial.html#cb115-2" aria-hidden="true" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(mod0)</span>
<span id="cb115-3"><a href="Spatial.html#cb115-3" aria-hidden="true" tabindex="-1"></a>waic0 <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglik0)</span>
<span id="cb115-4"><a href="Spatial.html#cb115-4" aria-hidden="true" tabindex="-1"></a>waic0</span></code></pre></div>
<pre><code>## 
## Computed from 1500 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1207.9  7.6
## p_waic       147.6  3.5
## waic        2415.7 15.2
## 
## 174 (53.7%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<p>Show the trace plots and posterior summaries of the parameters.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="Spatial.html#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co">#traceplots of the vector of coefficients beta</span></span>
<span id="cb117-2"><a href="Spatial.html#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="Spatial.html#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="Spatial.html#cb119-1" aria-hidden="true" tabindex="-1"></a>summary_theta <span class="ot">&lt;-</span></span>
<span id="cb119-2"><a href="Spatial.html#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb119-3"><a href="Spatial.html#cb119-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-4"><a href="Spatial.html#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="Spatial.html#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb119-6"><a href="Spatial.html#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb119-7"><a href="Spatial.html#cb119-7" aria-hidden="true" tabindex="-1"></a>  summary_theta<span class="sc">$</span>mean,</span>
<span id="cb119-8"><a href="Spatial.html#cb119-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb119-9"><a href="Spatial.html#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb119-10"><a href="Spatial.html#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb119-11"><a href="Spatial.html#cb119-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb119-12"><a href="Spatial.html#cb119-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb119-13"><a href="Spatial.html#cb119-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>))</span>
<span id="cb119-14"><a href="Spatial.html#cb119-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb119-15"><a href="Spatial.html#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb119-16"><a href="Spatial.html#cb119-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb119-17"><a href="Spatial.html#cb119-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="Spatial.html#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb120-2"><a href="Spatial.html#cb120-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-3"><a href="Spatial.html#cb120-3" aria-hidden="true" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span></span>
<span id="cb120-4"><a href="Spatial.html#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb120-5"><a href="Spatial.html#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="Spatial.html#cb120-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-7"><a href="Spatial.html#cb120-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb120-8"><a href="Spatial.html#cb120-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb120-9"><a href="Spatial.html#cb120-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb120-10"><a href="Spatial.html#cb120-10" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb120-11"><a href="Spatial.html#cb120-11" aria-hidden="true" tabindex="-1"></a>  summary_fit<span class="sc">$</span>mean,</span>
<span id="cb120-12"><a href="Spatial.html#cb120-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>)),</span>
<span id="cb120-13"><a href="Spatial.html#cb120-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb120-14"><a href="Spatial.html#cb120-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb120-15"><a href="Spatial.html#cb120-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb120-16"><a href="Spatial.html#cb120-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb120-17"><a href="Spatial.html#cb120-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb120-18"><a href="Spatial.html#cb120-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-19"><a href="Spatial.html#cb120-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb120-20"><a href="Spatial.html#cb120-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb120-21"><a href="Spatial.html#cb120-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-2.png" width="672" /></p>
</div>
</div>
<div id="example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="section level2 unnumbered hasAnchor">
<h2>Example 8.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code><a href="Spatial.html#example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-1" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Spatial.html#nimble-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="stan-1" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Spatial.html#stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we implement the CAR model using <code>stan</code>.</p>
<!-- QUESTION: Is it ok to reload the data everytime? -->
<p>We will need two function to structure the matrix of neighbors that will be needed in <code>stan</code>.</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="Spatial.html#cb121-1" aria-hidden="true" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb121-2"><a href="Spatial.html#cb121-2" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb121-3"><a href="Spatial.html#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb121-4"><a href="Spatial.html#cb121-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb121-5"><a href="Spatial.html#cb121-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb121-6"><a href="Spatial.html#cb121-6" aria-hidden="true" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb121-7"><a href="Spatial.html#cb121-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-8"><a href="Spatial.html#cb121-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-9"><a href="Spatial.html#cb121-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-10"><a href="Spatial.html#cb121-10" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb121-11"><a href="Spatial.html#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb121-12"><a href="Spatial.html#cb121-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb121-13"><a href="Spatial.html#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="Spatial.html#cb121-14" aria-hidden="true" tabindex="-1"></a>mungeCARdata4stan <span class="ot">=</span> <span class="cf">function</span>(adjBUGS, numBUGS) {</span>
<span id="cb121-15"><a href="Spatial.html#cb121-15" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(numBUGS)</span>
<span id="cb121-16"><a href="Spatial.html#cb121-16" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">=</span> numBUGS</span>
<span id="cb121-17"><a href="Spatial.html#cb121-17" aria-hidden="true" tabindex="-1"></a>  N_edges <span class="ot">=</span> <span class="fu">length</span>(adjBUGS) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb121-18"><a href="Spatial.html#cb121-18" aria-hidden="true" tabindex="-1"></a>  node1 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb121-19"><a href="Spatial.html#cb121-19" aria-hidden="true" tabindex="-1"></a>  node2 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb121-20"><a href="Spatial.html#cb121-20" aria-hidden="true" tabindex="-1"></a>  iAdj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb121-21"><a href="Spatial.html#cb121-21" aria-hidden="true" tabindex="-1"></a>  iEdge <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb121-22"><a href="Spatial.html#cb121-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-23"><a href="Spatial.html#cb121-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb121-24"><a href="Spatial.html#cb121-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nn[i]) {</span>
<span id="cb121-25"><a href="Spatial.html#cb121-25" aria-hidden="true" tabindex="-1"></a>      iAdj <span class="ot">=</span> iAdj <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb121-26"><a href="Spatial.html#cb121-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> adjBUGS[iAdj]) {</span>
<span id="cb121-27"><a href="Spatial.html#cb121-27" aria-hidden="true" tabindex="-1"></a>        iEdge <span class="ot">=</span> iEdge <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb121-28"><a href="Spatial.html#cb121-28" aria-hidden="true" tabindex="-1"></a>        node1[iEdge] <span class="ot">=</span> i</span>
<span id="cb121-29"><a href="Spatial.html#cb121-29" aria-hidden="true" tabindex="-1"></a>        node2[iEdge] <span class="ot">=</span> adjBUGS[iAdj]</span>
<span id="cb121-30"><a href="Spatial.html#cb121-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-31"><a href="Spatial.html#cb121-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-32"><a href="Spatial.html#cb121-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-33"><a href="Spatial.html#cb121-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(</span>
<span id="cb121-34"><a href="Spatial.html#cb121-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N&quot;</span> <span class="ot">=</span> N,</span>
<span id="cb121-35"><a href="Spatial.html#cb121-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N_edges&quot;</span> <span class="ot">=</span> N_edges,</span>
<span id="cb121-36"><a href="Spatial.html#cb121-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node1&quot;</span> <span class="ot">=</span> node1,</span>
<span id="cb121-37"><a href="Spatial.html#cb121-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node2&quot;</span> <span class="ot">=</span> node2</span>
<span id="cb121-38"><a href="Spatial.html#cb121-38" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb121-39"><a href="Spatial.html#cb121-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb121-40"><a href="Spatial.html#cb121-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="Spatial.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb122-2"><a href="Spatial.html#cb122-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb122-3"><a href="Spatial.html#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb122-4"><a href="Spatial.html#cb122-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-5"><a href="Spatial.html#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb122-6"><a href="Spatial.html#cb122-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb122-7"><a href="Spatial.html#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="Spatial.html#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb122-9"><a href="Spatial.html#cb122-9" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb122-10"><a href="Spatial.html#cb122-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-11"><a href="Spatial.html#cb122-11" aria-hidden="true" tabindex="-1"></a>neigh <span class="ot">=</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb122-12"><a href="Spatial.html#cb122-12" aria-hidden="true" tabindex="-1"></a>numneigh <span class="ot">=</span> <span class="fu">apply</span>(W.mat, <span class="dv">2</span>, sum)</span>
<span id="cb122-13"><a href="Spatial.html#cb122-13" aria-hidden="true" tabindex="-1"></a>nbs <span class="ot">=</span> <span class="fu">mungeCARdata4stan</span>(neigh, numneigh)</span>
<span id="cb122-14"><a href="Spatial.html#cb122-14" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> nbs<span class="sc">$</span>N</span>
<span id="cb122-15"><a href="Spatial.html#cb122-15" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> nbs<span class="sc">$</span>node1</span>
<span id="cb122-16"><a href="Spatial.html#cb122-16" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> nbs<span class="sc">$</span>node2</span>
<span id="cb122-17"><a href="Spatial.html#cb122-17" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> nbs<span class="sc">$</span>N_edges</span></code></pre></div>
<p><code>Stan</code> model for CAR effects.
This model is in a separate file called <code>Example8_3.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; N_edges;
  int&lt;lower=1, upper=N&gt; node1[N_edges];  // node1[i] adjacent to node2[i]
  int&lt;lower=1, upper=N&gt; node2[N_edges];  // and node1[i] &lt; node2[i]
  int&lt;lower=0&gt; y[N];              // count outcomes
  vector&lt;lower=0&gt;[N] E;           // exposure 
}

transformed data {
  vector[N] log_E = log(E);
}

parameters {
  real beta0;            // intercept
  vector[N] s;         // spatial effects
  real&lt;lower=0&gt; sigma_s;        // marginal standard deviation of spatial effects
}

transformed parameters {
  vector[N] b; // latent effect
  b =  sigma_s*s;
}

model {
  y ~ poisson_log(log_E + beta0 + b); 
  // This is the prior for s! (up to proportionality)
  target += -0.5 * dot_self(s[node1] - s[node2]);
  sum(s) ~ normal(0, 0.001 * N); 
  
  beta0 ~ normal(0.0, 10.0);
  sigma_s ~ normal(0.0,1.0);
}

generated quantities {
  vector[N] mu=exp(log_E + beta0 + b);
  vector[N] lik;
  
  for(i in 1:N){
    lik[i] = exp(poisson_lpmf(y[i] | mu[i] ));
  }
}</code></pre>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="Spatial.html#cb124-1" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> N_edges</span>
<span id="cb124-2"><a href="Spatial.html#cb124-2" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> node1</span>
<span id="cb124-3"><a href="Spatial.html#cb124-3" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> node2</span>
<span id="cb124-4"><a href="Spatial.html#cb124-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> N</span>
<span id="cb124-5"><a href="Spatial.html#cb124-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb124-6"><a href="Spatial.html#cb124-6" aria-hidden="true" tabindex="-1"></a>E <span class="ot">=</span> expected<span class="sc">$</span>E2010</span>
<span id="cb124-7"><a href="Spatial.html#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="Spatial.html#cb124-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-9"><a href="Spatial.html#cb124-9" aria-hidden="true" tabindex="-1"></a>COPD_fitCAR <span class="ot">=</span> <span class="fu">stan</span>(</span>
<span id="cb124-10"><a href="Spatial.html#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;functions/Example8_3.stan&quot;</span>,</span>
<span id="cb124-11"><a href="Spatial.html#cb124-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb124-12"><a href="Spatial.html#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> N,</span>
<span id="cb124-13"><a href="Spatial.html#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb124-14"><a href="Spatial.html#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">E =</span> E,</span>
<span id="cb124-15"><a href="Spatial.html#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_edges =</span> N_edges,</span>
<span id="cb124-16"><a href="Spatial.html#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">node1 =</span> node1,</span>
<span id="cb124-17"><a href="Spatial.html#cb124-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">node2 =</span> node2</span>
<span id="cb124-18"><a href="Spatial.html#cb124-18" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb124-19"><a href="Spatial.html#cb124-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb124-20"><a href="Spatial.html#cb124-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb124-21"><a href="Spatial.html#cb124-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb124-22"><a href="Spatial.html#cb124-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span></span>
<span id="cb124-23"><a href="Spatial.html#cb124-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Show traceplots.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="Spatial.html#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(COPD_fitCAR, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;sigma_s&quot;</span> ))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20stan%20CAR%20traceplots-1.png" width="672" /></p>
<p>Show the posterior summary for the parameters if interest.
Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike <code>CARBayes</code> where the variance is obtained.</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="Spatial.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb126-2"><a href="Spatial.html#cb126-2" aria-hidden="true" tabindex="-1"></a>summary_CAR <span class="ot">&lt;-</span></span>
<span id="cb126-3"><a href="Spatial.html#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb126-4"><a href="Spatial.html#cb126-4" aria-hidden="true" tabindex="-1"></a>    COPD_fitCAR,</span>
<span id="cb126-5"><a href="Spatial.html#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;sigma_s&quot;</span>),</span>
<span id="cb126-6"><a href="Spatial.html#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb126-7"><a href="Spatial.html#cb126-7" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="Spatial.html#cb127-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(summary_CAR<span class="sc">$</span>summary)</span></code></pre></div>
<table>
<colgroup>
<col width="10%" />
<col width="13%" />
<col width="12%" />
<col width="12%" />
<col width="13%" />
<col width="13%" />
<col width="11%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">mean</th>
<th align="right">se_mean</th>
<th align="right">sd</th>
<th align="right">2.5%</th>
<th align="right">97.5%</th>
<th align="right">n_eff</th>
<th align="right">Rhat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">beta0</td>
<td align="right">-0.0648777</td>
<td align="right">0.0001705</td>
<td align="right">0.0078457</td>
<td align="right">-0.0805037</td>
<td align="right">-0.0491011</td>
<td align="right">2117.915</td>
<td align="right">1.005224</td>
</tr>
<tr class="even">
<td align="left">sigma_s</td>
<td align="right">0.4111189</td>
<td align="right">0.0006244</td>
<td align="right">0.0250966</td>
<td align="right">0.3653234</td>
<td align="right">0.4626112</td>
<td align="right">1615.667</td>
<td align="right">1.002496</td>
</tr>
</tbody>
</table>
<!-- TODO: Plot map Stan output  -->
<!-- IDEA: Maybe we should agree on what output we will show for every method -->
</div>
</div>
<div id="example-8.4-fitting-a-conditional-spatial-model-using-carbayes" class="section level2 unnumbered hasAnchor">
<h2>Example 8.4: Fitting a conditional spatial model using CARBayes<a href="Spatial.html#example-8.4-fitting-a-conditional-spatial-model-using-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the necessary libraries</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="Spatial.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb128-2"><a href="Spatial.html#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3"><a href="Spatial.html#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CARBayes)</span>
<span id="cb128-4"><a href="Spatial.html#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb128-5"><a href="Spatial.html#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb128-6"><a href="Spatial.html#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code></pre></div>
<p>Load the COPD data. As in example 5.2 <code>englandlocalauthority.shp</code> and it’s related files contain the location, shape, and attributes of English local authorities.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="Spatial.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb129-2"><a href="Spatial.html#cb129-2" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb129-3"><a href="Spatial.html#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4"><a href="Spatial.html#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb129-5"><a href="Spatial.html#cb129-5" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb129-6"><a href="Spatial.html#cb129-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb129-7"><a href="Spatial.html#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="Spatial.html#cb129-8" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb129-9"><a href="Spatial.html#cb129-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>To calculate the smoother SMRs, we first need to create a <em>neighborhood</em> structure. The functions <code>poly2nb()</code> and <code>nb2mat()</code> from the <code>spdep</code> package can be used to create this</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="Spatial.html#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb130-2"><a href="Spatial.html#cb130-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb130-3"><a href="Spatial.html#cb130-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb130-4"><a href="Spatial.html#cb130-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-5"><a href="Spatial.html#cb130-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb130-6"><a href="Spatial.html#cb130-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span></code></pre></div>
<p>Here, we use <em>first neighbors</em> to define the structure, so any local authority sharing a border are considered neighbors.</p>
<p>The function <code>S.CARleroux()</code> allows us to use the neighborhood structure and performs a Bayesian analysis to create a smoothed set of observed values.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="Spatial.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Running smoothing model</span></span>
<span id="cb131-2"><a href="Spatial.html#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="Spatial.html#cb131-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span></span>
<span id="cb131-4"><a href="Spatial.html#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">S.CARleroux</span>(</span>
<span id="cb131-5"><a href="Spatial.html#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model Formula</span></span>
<span id="cb131-6"><a href="Spatial.html#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> observed<span class="sc">$</span>Y2010 <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(expected<span class="sc">$</span>E2010)),</span>
<span id="cb131-7"><a href="Spatial.html#cb131-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choosing Poisson Regression</span></span>
<span id="cb131-8"><a href="Spatial.html#cb131-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb131-9"><a href="Spatial.html#cb131-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Neighborhood matrix</span></span>
<span id="cb131-10"><a href="Spatial.html#cb131-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">W =</span> W.mat,</span>
<span id="cb131-11"><a href="Spatial.html#cb131-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of burn in samples</span></span>
<span id="cb131-12"><a href="Spatial.html#cb131-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">burnin =</span> <span class="dv">20000</span>,</span>
<span id="cb131-13"><a href="Spatial.html#cb131-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of MCMC samples</span></span>
<span id="cb131-14"><a href="Spatial.html#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.sample =</span> <span class="dv">100000</span>,</span>
<span id="cb131-15"><a href="Spatial.html#cb131-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb131-16"><a href="Spatial.html#cb131-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span></span>
<span id="cb131-17"><a href="Spatial.html#cb131-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods.</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb132-1"><a href="Spatial.html#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a dataset with smoothed SMRs in 2010</span></span>
<span id="cb132-2"><a href="Spatial.html#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="Spatial.html#cb132-3" aria-hidden="true" tabindex="-1"></a>SMR2010 <span class="ot">&lt;-</span> model<span class="sc">$</span>fitted.values <span class="sc">/</span> expected<span class="sc">$</span>E2010</span>
<span id="cb132-4"><a href="Spatial.html#cb132-4" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(SMR2010, <span class="at">row.names =</span> <span class="fu">rownames</span>(observed))</span></code></pre></div>
<p>Check that there are no errors and summarize the results</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="Spatial.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing first six rows of smoothed SMRs</span></span>
<span id="cb133-2"><a href="Spatial.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##        SMR2010
## 00AA 1.0096973
## 00AB 1.2640974
## 00AC 0.6879253
## 00AD 0.9738228
## 00AE 0.6011922
## 00AF 0.8612167</code></pre>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="Spatial.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb135-2"><a href="Spatial.html#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##     SMR2010      
##  Min.   :0.5486  
##  1st Qu.:0.8010  
##  Median :0.9280  
##  Mean   :0.9691  
##  3rd Qu.:1.0857  
##  Max.   :1.7307</code></pre>
<p>Show the summary of the parameters under the CAR model.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="Spatial.html#cb137-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(model<span class="sc">$</span>summary.results[])</span></code></pre></div>
<table>
<colgroup>
<col width="15%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="11%" />
<col width="11%" />
<col width="15%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Mean</th>
<th align="right">2.5%</th>
<th align="right">97.5%</th>
<th align="right">n.sample</th>
<th align="right">% accept</th>
<th align="right">n.effective</th>
<th align="right">Geweke.diag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.0645</td>
<td align="right">-0.0827</td>
<td align="right">-0.0467</td>
<td align="right">8000</td>
<td align="right">30.2</td>
<td align="right">5941.7</td>
<td align="right">-0.4</td>
</tr>
<tr class="even">
<td align="left">tau2</td>
<td align="right">0.1659</td>
<td align="right">0.1294</td>
<td align="right">0.2085</td>
<td align="right">8000</td>
<td align="right">100.0</td>
<td align="right">5734.6</td>
<td align="right">2.2</td>
</tr>
<tr class="odd">
<td align="left">rho</td>
<td align="right">1.0000</td>
<td align="right">1.0000</td>
<td align="right">1.0000</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>Use <code>ggplot()</code> and <code>geom_sf()</code> to plot the map of smoothed SMRs.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb138-1"><a href="Spatial.html#cb138-1" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(SMR_smooth, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb138-2"><a href="Spatial.html#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="Spatial.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Combining smoothed SMRs and the shapefile</span></span>
<span id="cb138-4"><a href="Spatial.html#cb138-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-5"><a href="Spatial.html#cb138-5" aria-hidden="true" tabindex="-1"></a>SMRspatial_smooth <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, SMR_smooth, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb138-6"><a href="Spatial.html#cb138-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-7"><a href="Spatial.html#cb138-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating breaks for legend in plot</span></span>
<span id="cb138-8"><a href="Spatial.html#cb138-8" aria-hidden="true" tabindex="-1"></a>range <span class="ot">&lt;-</span></span>
<span id="cb138-9"><a href="Spatial.html#cb138-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="fu">min</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb138-10"><a href="Spatial.html#cb138-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb138-11"><a href="Spatial.html#cb138-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">length.out =</span> <span class="dv">11</span>)</span>
<span id="cb138-12"><a href="Spatial.html#cb138-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-13"><a href="Spatial.html#cb138-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb138-14"><a href="Spatial.html#cb138-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-15"><a href="Spatial.html#cb138-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb138-16"><a href="Spatial.html#cb138-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb138-17"><a href="Spatial.html#cb138-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> SMRspatial_smooth, <span class="fu">aes</span>(<span class="at">fill =</span> SMR2010)) <span class="sc">+</span></span>
<span id="cb138-18"><a href="Spatial.html#cb138-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Break points for colours</span></span>
<span id="cb138-19"><a href="Spatial.html#cb138-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> range) <span class="sc">+</span></span>
<span id="cb138-20"><a href="Spatial.html#cb138-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb138-21"><a href="Spatial.html#cb138-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb138-22"><a href="Spatial.html#cb138-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb138-23"><a href="Spatial.html#cb138-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb138-24"><a href="Spatial.html#cb138-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb138-25"><a href="Spatial.html#cb138-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect =</span> <span class="fu">element_blank</span>()</span>
<span id="cb138-26"><a href="Spatial.html#cb138-26" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.4%20carbayes%20map%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="example-8.5-fitting-a-conditional-model-using-inla" class="section level2 unnumbered hasAnchor">
<h2>Example 8.5: Fitting a conditional model using INLA<a href="Spatial.html#example-8.5-fitting-a-conditional-model-using-inla" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="Spatial.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb139-2"><a href="Spatial.html#cb139-2" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb139-3"><a href="Spatial.html#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="Spatial.html#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb139-5"><a href="Spatial.html#cb139-5" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb139-6"><a href="Spatial.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb139-7"><a href="Spatial.html#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="Spatial.html#cb139-8" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb139-9"><a href="Spatial.html#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb139-10"><a href="Spatial.html#cb139-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-11"><a href="Spatial.html#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood matrix</span></span>
<span id="cb139-12"><a href="Spatial.html#cb139-12" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span> (england , <span class="at">row.names =</span> england<span class="sc">$</span>ID)</span>
<span id="cb139-13"><a href="Spatial.html#cb139-13" aria-hidden="true" tabindex="-1"></a>W.list <span class="ot">&lt;-</span> <span class="fu">nb2listw</span> (W.nb , <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb139-14"><a href="Spatial.html#cb139-14" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span> (W.nb , <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb139-15"><a href="Spatial.html#cb139-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-16"><a href="Spatial.html#cb139-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the adjacency matrix into a file in the INLA format</span></span>
<span id="cb139-17"><a href="Spatial.html#cb139-17" aria-hidden="true" tabindex="-1"></a><span class="fu">nb2INLA</span>(<span class="st">&quot;UK.adj&quot;</span>, W.nb)</span>
<span id="cb139-18"><a href="Spatial.html#cb139-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-19"><a href="Spatial.html#cb139-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create areas IDs to match the values in UK.adj</span></span>
<span id="cb139-20"><a href="Spatial.html#cb139-20" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="at">y =</span> observed<span class="sc">$</span>Y2010, <span class="at">E =</span> expected<span class="sc">$</span>E2010))</span>
<span id="cb139-21"><a href="Spatial.html#cb139-21" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">324</span></span></code></pre></div>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="Spatial.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the INLA model</span></span>
<span id="cb140-2"><a href="Spatial.html#cb140-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb140-3"><a href="Spatial.html#cb140-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">f</span>(ID , <span class="at">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="at">graph =</span> <span class="st">&quot;UK.adj&quot;</span>),</span>
<span id="cb140-4"><a href="Spatial.html#cb140-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb140-5"><a href="Spatial.html#cb140-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb140-6"><a href="Spatial.html#cb140-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb140-7"><a href="Spatial.html#cb140-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb140-8"><a href="Spatial.html#cb140-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="trusted.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Disease.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/08-Chpt8.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
