<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.30 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Spatial patterns in disease | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick and James V Zidek" />


<meta name="date" content="2022-11-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="RealData.html"/>
<link rel="next" href="PointsFields.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a></li>
<li class="chapter" data-level="2" data-path="health-risks.html"><a href="health-risks.html"><i class="fa fa-check"></i><b>2</b> Modelling health risks</a></li>
<li class="chapter" data-level="3" data-path="importance.html"><a href="importance.html"><i class="fa fa-check"></i><b>3</b> Importance of uncertainty</a></li>
<li class="chapter" data-level="4" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>4</b> Embracing uncertainty: The Bayesian approach</a></li>
<li class="chapter" data-level="5" data-path="Bayesian.html"><a href="Bayesian.html"><i class="fa fa-check"></i><b>5</b> The Bayesian approach in practice</a>
<ul>
<li class="chapter" data-level="" data-path="Bayesian.html"><a href="Bayesian.html#example-5.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 5.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="Bayesian.html"><a href="Bayesian.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="Bayesian.html"><a href="Bayesian.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Bayesian.html"><a href="Bayesian.html#example-5.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 5.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>6</b> Strategies for modelling</a></li>
<li class="chapter" data-level="7" data-path="RealData.html"><a href="RealData.html"><i class="fa fa-check"></i><b>7</b> Is ‘real’ data always quite so real?</a></li>
<li class="chapter" data-level="8" data-path="Spatial.html"><a href="Spatial.html"><i class="fa fa-check"></i><b>8</b> Spatial patterns in disease</a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 8.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 8.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 8.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Spatial.html"><a href="Spatial.html#example-8.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 8.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="PointsFields.html"><a href="PointsFields.html"><i class="fa fa-check"></i><b>9</b> From points to fields: modelling environmental hazards over space</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Spatial" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Spatial patterns in disease<a href="Spatial.html#Spatial" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="section level2 unnumbered hasAnchor">
<h2>Example 8.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010<a href="Spatial.html#example-8.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Following Example-5.2 we look back at the hospital admission rates for COPD, in England for 2010. We can implement the same model we used on Example-5.2 in <code>nimble</code>.</p>
<div id="nimble" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Spatial.html#nimble" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The following is the code for the Poisson-Gamma model implemented in <code>Nimble</code>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="Spatial.html#cb51-1" aria-hidden="true" tabindex="-1"></a>Example8_1Code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb51-2"><a href="Spatial.html#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb51-3"><a href="Spatial.html#cb51-3" aria-hidden="true" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb51-4"><a href="Spatial.html#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: There is an intercept in the book, </span></span>
<span id="cb51-5"><a href="Spatial.html#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but then we wouldn&#39;t be able to compare it to example 5.2</span></span>
<span id="cb51-6"><a href="Spatial.html#cb51-6" aria-hidden="true" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> E[i] <span class="sc">*</span> theta[i]</span>
<span id="cb51-7"><a href="Spatial.html#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: Same as before, the example in the book has theta[i] ~ Ga(a,a)</span></span>
<span id="cb51-8"><a href="Spatial.html#cb51-8" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dgamma</span>(a, b)</span>
<span id="cb51-9"><a href="Spatial.html#cb51-9" aria-hidden="true" tabindex="-1"></a>    Y.fit[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb51-10"><a href="Spatial.html#cb51-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb51-11"><a href="Spatial.html#cb51-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb51-12"><a href="Spatial.html#cb51-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb51-13"><a href="Spatial.html#cb51-13" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dexp</span>(lambda_a)</span>
<span id="cb51-14"><a href="Spatial.html#cb51-14" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dexp</span>(lambda_b)</span>
<span id="cb51-15"><a href="Spatial.html#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="Spatial.html#cb51-16" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Define the constants, data and initials lists for the <code>Nimble</code> model.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="Spatial.html#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb52-2"><a href="Spatial.html#cb52-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb52-3"><a href="Spatial.html#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb52-4"><a href="Spatial.html#cb52-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb52-5"><a href="Spatial.html#cb52-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb52-6"><a href="Spatial.html#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter of exponential prior for a</span></span>
<span id="cb52-7"><a href="Spatial.html#cb52-7" aria-hidden="true" tabindex="-1"></a>lambda_a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-8"><a href="Spatial.html#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter of exponential prior for b</span></span>
<span id="cb52-9"><a href="Spatial.html#cb52-9" aria-hidden="true" tabindex="-1"></a>lambda_b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb52-10"><a href="Spatial.html#cb52-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-11"><a href="Spatial.html#cb52-11" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb52-12"><a href="Spatial.html#cb52-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb52-13"><a href="Spatial.html#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb52-14"><a href="Spatial.html#cb52-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> lambda_a,</span>
<span id="cb52-15"><a href="Spatial.html#cb52-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> lambda_b</span>
<span id="cb52-16"><a href="Spatial.html#cb52-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-17"><a href="Spatial.html#cb52-17" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> y)</span>
<span id="cb52-18"><a href="Spatial.html#cb52-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-19"><a href="Spatial.html#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate initial values</span></span>
<span id="cb52-20"><a href="Spatial.html#cb52-20" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span></span>
<span id="cb52-21"><a href="Spatial.html#cb52-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>()</span>
<span id="cb52-22"><a href="Spatial.html#cb52-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb52-23"><a href="Spatial.html#cb52-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">theta =</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb52-24"><a href="Spatial.html#cb52-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">a =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_a),</span>
<span id="cb52-25"><a href="Spatial.html#cb52-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_b),</span>
<span id="cb52-26"><a href="Spatial.html#cb52-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y.fit =</span> <span class="fu">rpois</span>(N, E)</span>
<span id="cb52-27"><a href="Spatial.html#cb52-27" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<p>Define the parameter monitors and run the model.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="Spatial.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters to monitor</span></span>
<span id="cb53-2"><a href="Spatial.html#cb53-2" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;Y.fit&quot;</span>)</span>
<span id="cb53-3"><a href="Spatial.html#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="Spatial.html#cb53-4" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb53-5"><a href="Spatial.html#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example8_1Code,</span>
<span id="cb53-6"><a href="Spatial.html#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb53-7"><a href="Spatial.html#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb53-8"><a href="Spatial.html#cb53-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># provide the combined data &amp; constants as constants</span></span>
<span id="cb53-9"><a href="Spatial.html#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb53-10"><a href="Spatial.html#cb53-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb53-11"><a href="Spatial.html#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">50000</span>,</span>
<span id="cb53-12"><a href="Spatial.html#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb53-13"><a href="Spatial.html#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">30</span>,</span>
<span id="cb53-14"><a href="Spatial.html#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-15"><a href="Spatial.html#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb53-16"><a href="Spatial.html#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-17"><a href="Spatial.html#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb53-18"><a href="Spatial.html#cb53-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Check the WAIC and ESS.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="Spatial.html#cb54-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2417.405
## Field &quot;lppd&quot;:
## [1] -1060.275
## Field &quot;pWAIC&quot;:
## [1] 148.4276</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="Spatial.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 227.2731</code></pre>
<p>Show the trace plots and posterior summaries for each of the parameters.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="Spatial.html#cb58-1" aria-hidden="true" tabindex="-1"></a>mvSamples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples</span>
<span id="cb58-2"><a href="Spatial.html#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="Spatial.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of a</span></span>
<span id="cb58-4"><a href="Spatial.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="Spatial.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of b</span></span>
<span id="cb59-2"><a href="Spatial.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="Spatial.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<pre><code>## 
## Iterations = 1:1000
## Thinning interval = 1 
## Number of chains = 2 
## Sample size per chain = 1000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##    Mean    SD Naive SE Time-series SE
## a 11.82 1.049  0.02346        0.06863
## b 12.15 1.101  0.02461        0.07146
## 
## 2. Quantiles for each variable:
## 
##     2.5%   25%   50%   75% 97.5%
## a  9.887 11.10 11.76 12.50 13.96
## b 10.105 11.39 12.10 12.87 14.44</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="Spatial.html#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">#trace plots of theta&#39;s</span></span>
<span id="cb62-2"><a href="Spatial.html#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb62-3"><a href="Spatial.html#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;theta[&quot;</span>, i, <span class="st">&quot;]&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-3.png" width="672" /><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-4.png" width="672" /><img src="_main_files/figure-html/Ex%208.1%20nimble%20traceplots-5.png" width="672" /></p>
<p>Now that we have checked the convergence of the chains we can plot the posterior mean and 95% CIs for each of the parameters.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="Spatial.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summaries of theta_i</span></span>
<span id="cb63-2"><a href="Spatial.html#cb63-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains  <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="Spatial.html#cb63-3" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>)</span>
<span id="cb63-4"><a href="Spatial.html#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="Spatial.html#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the mean and 95% CIs for the thetas</span></span>
<span id="cb63-6"><a href="Spatial.html#cb63-6" aria-hidden="true" tabindex="-1"></a>post_theta <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;theta</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb63-7"><a href="Spatial.html#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="Spatial.html#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb63-9"><a href="Spatial.html#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb63-10"><a href="Spatial.html#cb63-10" aria-hidden="true" tabindex="-1"></a>  post_theta<span class="sc">$</span>Mean,</span>
<span id="cb63-11"><a href="Spatial.html#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb63-12"><a href="Spatial.html#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb63-13"><a href="Spatial.html#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb63-14"><a href="Spatial.html#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb63-15"><a href="Spatial.html#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb63-16"><a href="Spatial.html#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>))</span>
<span id="cb63-17"><a href="Spatial.html#cb63-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-18"><a href="Spatial.html#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb63-19"><a href="Spatial.html#cb63-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb63-20"><a href="Spatial.html#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="Spatial.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb64-2"><a href="Spatial.html#cb64-2" aria-hidden="true" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;Y.fit</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb64-3"><a href="Spatial.html#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="Spatial.html#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb64-5"><a href="Spatial.html#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb64-6"><a href="Spatial.html#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb64-7"><a href="Spatial.html#cb64-7" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb64-8"><a href="Spatial.html#cb64-8" aria-hidden="true" tabindex="-1"></a>  post_fitted<span class="sc">$</span>Mean,</span>
<span id="cb64-9"><a href="Spatial.html#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)),</span>
<span id="cb64-10"><a href="Spatial.html#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb64-11"><a href="Spatial.html#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb64-12"><a href="Spatial.html#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb64-13"><a href="Spatial.html#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb64-14"><a href="Spatial.html#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb64-15"><a href="Spatial.html#cb64-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-16"><a href="Spatial.html#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb64-17"><a href="Spatial.html#cb64-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb64-18"><a href="Spatial.html#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20nimble%20posterior%20summary-2.png" width="672" /></p>
</div>
<div id="stan" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Spatial.html#stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Load <code>stan</code> with options</p>
<p>Write the <code>stan</code> model. This model is in a separate file called <code>Example8_1.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  real&lt;lower=0&gt; E[N]; // need to indicate that variable is strictly positive
  int&lt;lower=0&gt; Y[N];
  real&lt;lower=0&gt;lambda_a;
  real&lt;lower=0&gt;lambda_b;
}


parameters {
  
  real&lt;lower=0&gt; theta[N];
  real&lt;lower=0&gt; a;
  real&lt;lower=0&gt; b;
  
}


transformed parameters{
  
  real &lt;lower=0&gt; mu[N];
  
  for(i in 1:N){
    mu[i]=E[i]*theta[i];
  }
  
}


model {
  
  // likelihood function and prior for theta
  for(i in 1:N){
    Y[i] ~ poisson(mu[i]);
    theta[i]~gamma(a,b);
  }
  a~exponential(lambda_a);
  b~exponential(lambda_b);
}

generated quantities {
  
  
  vector [N] log_lik;
  int&lt;lower=0&gt; yfit [N];
  
  //computing the log_likelihood for each value of the mean mu and the fitted values
  for(i in 1:N){
    log_lik[i]=poisson_lpmf(Y[i] |mu[i]);
    yfit[i]=poisson_rng(mu[i]);
  }
  
}</code></pre>
<p>Define the data for the model, similar to <code>nimble</code>.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="Spatial.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb66-2"><a href="Spatial.html#cb66-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb66-3"><a href="Spatial.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb66-4"><a href="Spatial.html#cb66-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb66-5"><a href="Spatial.html#cb66-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb66-6"><a href="Spatial.html#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="Spatial.html#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data list </span></span>
<span id="cb66-8"><a href="Spatial.html#cb66-8" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb66-9"><a href="Spatial.html#cb66-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb66-10"><a href="Spatial.html#cb66-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> y,</span>
<span id="cb66-11"><a href="Spatial.html#cb66-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb66-12"><a href="Spatial.html#cb66-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> <span class="dv">1</span>,</span>
<span id="cb66-13"><a href="Spatial.html#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> <span class="dv">1</span></span>
<span id="cb66-14"><a href="Spatial.html#cb66-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-15"><a href="Spatial.html#cb66-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-16"><a href="Spatial.html#cb66-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the model in Stan</span></span>
<span id="cb66-17"><a href="Spatial.html#cb66-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-18"><a href="Spatial.html#cb66-18" aria-hidden="true" tabindex="-1"></a>mod0 <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb66-19"><a href="Spatial.html#cb66-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example8_1.stan&quot;</span>,</span>
<span id="cb66-20"><a href="Spatial.html#cb66-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb66-21"><a href="Spatial.html#cb66-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb66-22"><a href="Spatial.html#cb66-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb66-23"><a href="Spatial.html#cb66-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb66-24"><a href="Spatial.html#cb66-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb66-25"><a href="Spatial.html#cb66-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>),</span>
<span id="cb66-26"><a href="Spatial.html#cb66-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> <span class="st">&quot;random&quot;</span>,</span>
<span id="cb66-27"><a href="Spatial.html#cb66-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;log_lik&quot;</span>, <span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb66-28"><a href="Spatial.html#cb66-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb66-29"><a href="Spatial.html#cb66-29" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Compute the WAIC.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="Spatial.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb67-2"><a href="Spatial.html#cb67-2" aria-hidden="true" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(mod0)</span>
<span id="cb67-3"><a href="Spatial.html#cb67-3" aria-hidden="true" tabindex="-1"></a>waic0 <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglik0)</span>
<span id="cb67-4"><a href="Spatial.html#cb67-4" aria-hidden="true" tabindex="-1"></a>waic0</span></code></pre></div>
<pre><code>## 
## Computed from 1500 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1207.0  7.5
## p_waic       146.9  3.3
## waic        2414.1 15.0
## 
## 174 (53.7%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<p>Show the trace plots and posterior summaries of the parameters.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="Spatial.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">#traceplots of the vector of coefficients beta</span></span>
<span id="cb69-2"><a href="Spatial.html#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0,<span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;a&quot;</span>,<span class="st">&quot;b&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="Spatial.html#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0,<span class="at">pars=</span><span class="fu">c</span>(<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="Spatial.html#cb71-1" aria-hidden="true" tabindex="-1"></a>summary_theta <span class="ot">&lt;-</span></span>
<span id="cb71-2"><a href="Spatial.html#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb71-3"><a href="Spatial.html#cb71-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-4"><a href="Spatial.html#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="Spatial.html#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb71-6"><a href="Spatial.html#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb71-7"><a href="Spatial.html#cb71-7" aria-hidden="true" tabindex="-1"></a>  summary_theta<span class="sc">$</span>mean,</span>
<span id="cb71-8"><a href="Spatial.html#cb71-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb71-9"><a href="Spatial.html#cb71-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb71-10"><a href="Spatial.html#cb71-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb71-11"><a href="Spatial.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb71-12"><a href="Spatial.html#cb71-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb71-13"><a href="Spatial.html#cb71-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>))</span>
<span id="cb71-14"><a href="Spatial.html#cb71-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-15"><a href="Spatial.html#cb71-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb71-16"><a href="Spatial.html#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb71-17"><a href="Spatial.html#cb71-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="Spatial.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb72-2"><a href="Spatial.html#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="Spatial.html#cb72-3" aria-hidden="true" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span></span>
<span id="cb72-4"><a href="Spatial.html#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb72-5"><a href="Spatial.html#cb72-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-6"><a href="Spatial.html#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="Spatial.html#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb72-8"><a href="Spatial.html#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb72-9"><a href="Spatial.html#cb72-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb72-10"><a href="Spatial.html#cb72-10" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb72-11"><a href="Spatial.html#cb72-11" aria-hidden="true" tabindex="-1"></a>  summary_fit<span class="sc">$</span>mean,</span>
<span id="cb72-12"><a href="Spatial.html#cb72-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>)),</span>
<span id="cb72-13"><a href="Spatial.html#cb72-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb72-14"><a href="Spatial.html#cb72-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb72-15"><a href="Spatial.html#cb72-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb72-16"><a href="Spatial.html#cb72-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb72-17"><a href="Spatial.html#cb72-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb72-18"><a href="Spatial.html#cb72-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb72-19"><a href="Spatial.html#cb72-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb72-20"><a href="Spatial.html#cb72-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb72-21"><a href="Spatial.html#cb72-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-2.png" width="672" /></p>
</div>
</div>
<div id="example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="section level2 unnumbered hasAnchor">
<h2>Example 8.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code><a href="Spatial.html#example-8.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-1" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Spatial.html#nimble-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
<div id="stan-1" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Spatial.html#stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we implement the CAR model using <code>stan</code>.</p>
<!-- QUESTION: Is it ok to reload the data everytime? -->
<p>We will need two function to structure the matrix of neighbors that will be needed in <code>stan</code>.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="Spatial.html#cb73-1" aria-hidden="true" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb73-2"><a href="Spatial.html#cb73-2" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb73-3"><a href="Spatial.html#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb73-4"><a href="Spatial.html#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb73-5"><a href="Spatial.html#cb73-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb73-6"><a href="Spatial.html#cb73-6" aria-hidden="true" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb73-7"><a href="Spatial.html#cb73-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb73-8"><a href="Spatial.html#cb73-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-9"><a href="Spatial.html#cb73-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb73-10"><a href="Spatial.html#cb73-10" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb73-11"><a href="Spatial.html#cb73-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb73-12"><a href="Spatial.html#cb73-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-13"><a href="Spatial.html#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="Spatial.html#cb73-14" aria-hidden="true" tabindex="-1"></a>mungeCARdata4stan <span class="ot">=</span> <span class="cf">function</span>(adjBUGS, numBUGS) {</span>
<span id="cb73-15"><a href="Spatial.html#cb73-15" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(numBUGS)</span>
<span id="cb73-16"><a href="Spatial.html#cb73-16" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">=</span> numBUGS</span>
<span id="cb73-17"><a href="Spatial.html#cb73-17" aria-hidden="true" tabindex="-1"></a>  N_edges <span class="ot">=</span> <span class="fu">length</span>(adjBUGS) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb73-18"><a href="Spatial.html#cb73-18" aria-hidden="true" tabindex="-1"></a>  node1 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb73-19"><a href="Spatial.html#cb73-19" aria-hidden="true" tabindex="-1"></a>  node2 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb73-20"><a href="Spatial.html#cb73-20" aria-hidden="true" tabindex="-1"></a>  iAdj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb73-21"><a href="Spatial.html#cb73-21" aria-hidden="true" tabindex="-1"></a>  iEdge <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb73-22"><a href="Spatial.html#cb73-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-23"><a href="Spatial.html#cb73-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb73-24"><a href="Spatial.html#cb73-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nn[i]) {</span>
<span id="cb73-25"><a href="Spatial.html#cb73-25" aria-hidden="true" tabindex="-1"></a>      iAdj <span class="ot">=</span> iAdj <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb73-26"><a href="Spatial.html#cb73-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> adjBUGS[iAdj]) {</span>
<span id="cb73-27"><a href="Spatial.html#cb73-27" aria-hidden="true" tabindex="-1"></a>        iEdge <span class="ot">=</span> iEdge <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb73-28"><a href="Spatial.html#cb73-28" aria-hidden="true" tabindex="-1"></a>        node1[iEdge] <span class="ot">=</span> i</span>
<span id="cb73-29"><a href="Spatial.html#cb73-29" aria-hidden="true" tabindex="-1"></a>        node2[iEdge] <span class="ot">=</span> adjBUGS[iAdj]</span>
<span id="cb73-30"><a href="Spatial.html#cb73-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb73-31"><a href="Spatial.html#cb73-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-32"><a href="Spatial.html#cb73-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb73-33"><a href="Spatial.html#cb73-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(</span>
<span id="cb73-34"><a href="Spatial.html#cb73-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N&quot;</span> <span class="ot">=</span> N,</span>
<span id="cb73-35"><a href="Spatial.html#cb73-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N_edges&quot;</span> <span class="ot">=</span> N_edges,</span>
<span id="cb73-36"><a href="Spatial.html#cb73-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node1&quot;</span> <span class="ot">=</span> node1,</span>
<span id="cb73-37"><a href="Spatial.html#cb73-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node2&quot;</span> <span class="ot">=</span> node2</span>
<span id="cb73-38"><a href="Spatial.html#cb73-38" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb73-39"><a href="Spatial.html#cb73-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb73-40"><a href="Spatial.html#cb73-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="Spatial.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb74-2"><a href="Spatial.html#cb74-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb74-3"><a href="Spatial.html#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb74-4"><a href="Spatial.html#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="Spatial.html#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb74-6"><a href="Spatial.html#cb74-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb74-7"><a href="Spatial.html#cb74-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-8"><a href="Spatial.html#cb74-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb74-9"><a href="Spatial.html#cb74-9" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb74-10"><a href="Spatial.html#cb74-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-11"><a href="Spatial.html#cb74-11" aria-hidden="true" tabindex="-1"></a>neigh <span class="ot">=</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb74-12"><a href="Spatial.html#cb74-12" aria-hidden="true" tabindex="-1"></a>numneigh <span class="ot">=</span> <span class="fu">apply</span>(W.mat, <span class="dv">2</span>, sum)</span>
<span id="cb74-13"><a href="Spatial.html#cb74-13" aria-hidden="true" tabindex="-1"></a>nbs <span class="ot">=</span> <span class="fu">mungeCARdata4stan</span>(neigh, numneigh)</span>
<span id="cb74-14"><a href="Spatial.html#cb74-14" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> nbs<span class="sc">$</span>N</span>
<span id="cb74-15"><a href="Spatial.html#cb74-15" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> nbs<span class="sc">$</span>node1</span>
<span id="cb74-16"><a href="Spatial.html#cb74-16" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> nbs<span class="sc">$</span>node2</span>
<span id="cb74-17"><a href="Spatial.html#cb74-17" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> nbs<span class="sc">$</span>N_edges</span></code></pre></div>
<p><code>Stan</code> model for CAR effects.
This model is in a separate file called <code>Example8_3.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; N_edges;
  int&lt;lower=1, upper=N&gt; node1[N_edges];  // node1[i] adjacent to node2[i]
  int&lt;lower=1, upper=N&gt; node2[N_edges];  // and node1[i] &lt; node2[i]
  int&lt;lower=0&gt; y[N];              // count outcomes
  vector&lt;lower=0&gt;[N] E;           // exposure 
}

transformed data {
  vector[N] log_E = log(E);
}

parameters {
  real beta0;            // intercept
  vector[N] s;         // spatial effects
  real&lt;lower=0&gt; sigma_s;        // marginal standard deviation of spatial effects
}

transformed parameters {
  vector[N] b; // latent effect
  b =  sigma_s*s;
}

model {
  y ~ poisson_log(log_E + beta0 + b); 
  // This is the prior for s! (up to proportionality)
  target += -0.5 * dot_self(s[node1] - s[node2]);
  sum(s) ~ normal(0, 0.001 * N); 
  
  beta0 ~ normal(0.0, 10.0);
  sigma_s ~ normal(0.0,1.0);
}

generated quantities {
  vector[N] mu=exp(log_E + beta0 + b);
  vector[N] lik;
  
  for(i in 1:N){
    lik[i] = exp(poisson_lpmf(y[i] | mu[i] ));
  }
}</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="Spatial.html#cb76-1" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> N_edges</span>
<span id="cb76-2"><a href="Spatial.html#cb76-2" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> node1</span>
<span id="cb76-3"><a href="Spatial.html#cb76-3" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> node2</span>
<span id="cb76-4"><a href="Spatial.html#cb76-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> N</span>
<span id="cb76-5"><a href="Spatial.html#cb76-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb76-6"><a href="Spatial.html#cb76-6" aria-hidden="true" tabindex="-1"></a>E <span class="ot">=</span> expected<span class="sc">$</span>E2010</span>
<span id="cb76-7"><a href="Spatial.html#cb76-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-8"><a href="Spatial.html#cb76-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-9"><a href="Spatial.html#cb76-9" aria-hidden="true" tabindex="-1"></a>COPD_fitCAR <span class="ot">=</span> <span class="fu">stan</span>(</span>
<span id="cb76-10"><a href="Spatial.html#cb76-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;functions/Example8_3.stan&quot;</span>,</span>
<span id="cb76-11"><a href="Spatial.html#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(</span>
<span id="cb76-12"><a href="Spatial.html#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> N,</span>
<span id="cb76-13"><a href="Spatial.html#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb76-14"><a href="Spatial.html#cb76-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">E =</span> E,</span>
<span id="cb76-15"><a href="Spatial.html#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">N_edges =</span> N_edges,</span>
<span id="cb76-16"><a href="Spatial.html#cb76-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">node1 =</span> node1,</span>
<span id="cb76-17"><a href="Spatial.html#cb76-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">node2 =</span> node2</span>
<span id="cb76-18"><a href="Spatial.html#cb76-18" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb76-19"><a href="Spatial.html#cb76-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb76-20"><a href="Spatial.html#cb76-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb76-21"><a href="Spatial.html#cb76-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb76-22"><a href="Spatial.html#cb76-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span></span>
<span id="cb76-23"><a href="Spatial.html#cb76-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Show traceplots.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="Spatial.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(COPD_fitCAR, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;sigma_s&quot;</span> ))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20stan%20CAR%20traceplots-1.png" width="672" /></p>
<p>Show the posterior summary for the parameters if interest.
Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike <code>CARBayes</code> where the variance is obtained.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="Spatial.html#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb78-2"><a href="Spatial.html#cb78-2" aria-hidden="true" tabindex="-1"></a>summary_CAR <span class="ot">&lt;-</span></span>
<span id="cb78-3"><a href="Spatial.html#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb78-4"><a href="Spatial.html#cb78-4" aria-hidden="true" tabindex="-1"></a>    COPD_fitCAR,</span>
<span id="cb78-5"><a href="Spatial.html#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;sigma_s&quot;</span>),</span>
<span id="cb78-6"><a href="Spatial.html#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb78-7"><a href="Spatial.html#cb78-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb78-8"><a href="Spatial.html#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="Spatial.html#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_CAR<span class="sc">$</span>summary)</span></code></pre></div>
<pre><code>           mean      se_mean          sd        2.5%       97.5%    n_eff</code></pre>
<p>beta0 -0.06462819 0.0001741830 0.007607012 -0.07984097 -0.05033877 1907.290
sigma_s 0.41040730 0.0006004027 0.025342817 0.36345122 0.46141905 1781.659
Rhat
beta0 1.0004465
sigma_s 0.9998871</p>
<!-- TODO: Plot map Stan output  -->
<!-- IDEA: Maybe we should agree on what output we will show for every method -->
</div>
</div>
<div id="example-8.4-fitting-a-conditional-spatial-model-using-carbayes" class="section level2 unnumbered hasAnchor">
<h2>Example 8.4: Fitting a conditional spatial model using CARBayes<a href="Spatial.html#example-8.4-fitting-a-conditional-spatial-model-using-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the necessary libraries</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="Spatial.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb80-2"><a href="Spatial.html#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="Spatial.html#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CARBayes)</span>
<span id="cb80-4"><a href="Spatial.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb80-5"><a href="Spatial.html#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb80-6"><a href="Spatial.html#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code></pre></div>
<p>Load the COPD data. As in example 5.2 <code>englandlocalauthority.shp</code> and it’s related files contain the location, shape, and attributes of English local authorities.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="Spatial.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb81-2"><a href="Spatial.html#cb81-2" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb81-3"><a href="Spatial.html#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="Spatial.html#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb81-5"><a href="Spatial.html#cb81-5" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb81-6"><a href="Spatial.html#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb81-7"><a href="Spatial.html#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="Spatial.html#cb81-8" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb81-9"><a href="Spatial.html#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>To calculate the smoother SMRs, we first need to create a <em>neighborhood</em> structure. The functions <code>poly2nb()</code> and <code>nb2mat()</code> from the <code>spdep</code> package can be used to create this</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="Spatial.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb82-2"><a href="Spatial.html#cb82-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb82-3"><a href="Spatial.html#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb82-4"><a href="Spatial.html#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="Spatial.html#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb82-6"><a href="Spatial.html#cb82-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span></code></pre></div>
<p>Here, we use <em>first neighbors</em> to define the structure, so any local authority sharing a border are considered neighbors.</p>
<p>The function <code>S.CARleroux()</code> allows us to use the neighborhood structure and performs a Bayesian analysis to create a smoothed set of observed values.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="Spatial.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Running smoothing model</span></span>
<span id="cb83-2"><a href="Spatial.html#cb83-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-3"><a href="Spatial.html#cb83-3" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span></span>
<span id="cb83-4"><a href="Spatial.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">S.CARleroux</span>(</span>
<span id="cb83-5"><a href="Spatial.html#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model Formula</span></span>
<span id="cb83-6"><a href="Spatial.html#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> observed<span class="sc">$</span>Y2010 <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(expected<span class="sc">$</span>E2010)),</span>
<span id="cb83-7"><a href="Spatial.html#cb83-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choosing Poisson Regression</span></span>
<span id="cb83-8"><a href="Spatial.html#cb83-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb83-9"><a href="Spatial.html#cb83-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Neighborhood matrix</span></span>
<span id="cb83-10"><a href="Spatial.html#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">W =</span> W.mat,</span>
<span id="cb83-11"><a href="Spatial.html#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of burn in samples</span></span>
<span id="cb83-12"><a href="Spatial.html#cb83-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">burnin =</span> <span class="dv">20000</span>,</span>
<span id="cb83-13"><a href="Spatial.html#cb83-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of MCMC samples</span></span>
<span id="cb83-14"><a href="Spatial.html#cb83-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.sample =</span> <span class="dv">100000</span>,</span>
<span id="cb83-15"><a href="Spatial.html#cb83-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb83-16"><a href="Spatial.html#cb83-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span></span>
<span id="cb83-17"><a href="Spatial.html#cb83-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb84-1"><a href="Spatial.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a dataset with smoothed SMRs in 2010</span></span>
<span id="cb84-2"><a href="Spatial.html#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="Spatial.html#cb84-3" aria-hidden="true" tabindex="-1"></a>SMR2010 <span class="ot">&lt;-</span> model<span class="sc">$</span>fitted.values <span class="sc">/</span> expected<span class="sc">$</span>E2010</span>
<span id="cb84-4"><a href="Spatial.html#cb84-4" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(SMR2010, <span class="at">row.names =</span> <span class="fu">rownames</span>(observed))</span></code></pre></div>
<p>Check that there are no errors and summarize the results</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="Spatial.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing first six rows of smoothed SMRs</span></span>
<span id="cb85-2"><a href="Spatial.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##        SMR2010
## 00AA 1.0142368
## 00AB 1.2645745
## 00AC 0.6878243
## 00AD 0.9726070
## 00AE 0.6005188
## 00AF 0.8597476</code></pre>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="Spatial.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb87-2"><a href="Spatial.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##     SMR2010      
##  Min.   :0.5498  
##  1st Qu.:0.8003  
##  Median :0.9281  
##  Mean   :0.9691  
##  3rd Qu.:1.0837  
##  Max.   :1.7312</code></pre>
<p>Show the summary of the parameters under the CAR model.</p>
<table>
<colgroup>
<col width="15%" />
<col width="10%" />
<col width="10%" />
<col width="10%" />
<col width="11%" />
<col width="11%" />
<col width="15%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">Mean</th>
<th align="right">2.5%</th>
<th align="right">97.5%</th>
<th align="right">n.sample</th>
<th align="right">% accept</th>
<th align="right">n.effective</th>
<th align="right">Geweke.diag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">-0.0644</td>
<td align="right">-0.0818</td>
<td align="right">-0.0468</td>
<td align="right">8000</td>
<td align="right">34.9</td>
<td align="right">6878.1</td>
<td align="right">-2.2</td>
</tr>
<tr class="even">
<td align="left">tau2</td>
<td align="right">0.1654</td>
<td align="right">0.1303</td>
<td align="right">0.2079</td>
<td align="right">8000</td>
<td align="right">100.0</td>
<td align="right">6140.1</td>
<td align="right">1.4</td>
</tr>
<tr class="odd">
<td align="left">rho</td>
<td align="right">1.0000</td>
<td align="right">1.0000</td>
<td align="right">1.0000</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>Use <code>ggplot()</code> and <code>geom_sf()</code> to plot the map of smoothed SMRs.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb89-1"><a href="Spatial.html#cb89-1" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(SMR_smooth, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb89-2"><a href="Spatial.html#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="Spatial.html#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Combining smoothed SMRs and the shapefile</span></span>
<span id="cb89-4"><a href="Spatial.html#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="Spatial.html#cb89-5" aria-hidden="true" tabindex="-1"></a>SMRspatial_smooth <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, SMR_smooth, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb89-6"><a href="Spatial.html#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="Spatial.html#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating breaks for legend in plot</span></span>
<span id="cb89-8"><a href="Spatial.html#cb89-8" aria-hidden="true" tabindex="-1"></a>range <span class="ot">&lt;-</span></span>
<span id="cb89-9"><a href="Spatial.html#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="fu">min</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb89-10"><a href="Spatial.html#cb89-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb89-11"><a href="Spatial.html#cb89-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">length.out =</span> <span class="dv">11</span>)</span>
<span id="cb89-12"><a href="Spatial.html#cb89-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-13"><a href="Spatial.html#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb89-14"><a href="Spatial.html#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="Spatial.html#cb89-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-16"><a href="Spatial.html#cb89-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb89-17"><a href="Spatial.html#cb89-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> SMRspatial_smooth, <span class="fu">aes</span>(<span class="at">fill =</span> SMR2010)) <span class="sc">+</span></span>
<span id="cb89-18"><a href="Spatial.html#cb89-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Break points for colours</span></span>
<span id="cb89-19"><a href="Spatial.html#cb89-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> range) <span class="sc">+</span></span>
<span id="cb89-20"><a href="Spatial.html#cb89-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb89-21"><a href="Spatial.html#cb89-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb89-22"><a href="Spatial.html#cb89-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-23"><a href="Spatial.html#cb89-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-24"><a href="Spatial.html#cb89-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-25"><a href="Spatial.html#cb89-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect =</span> <span class="fu">element_blank</span>()</span>
<span id="cb89-26"><a href="Spatial.html#cb89-26" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.4%20carbayes%20map%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="example-8.5-fitting-a-conditional-model-using-inla" class="section level2 unnumbered hasAnchor">
<h2>Example 8.5: Fitting a conditional model using INLA<a href="Spatial.html#example-8.5-fitting-a-conditional-model-using-inla" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="Spatial.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb90-2"><a href="Spatial.html#cb90-2" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb90-3"><a href="Spatial.html#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="Spatial.html#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb90-5"><a href="Spatial.html#cb90-5" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb90-6"><a href="Spatial.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb90-7"><a href="Spatial.html#cb90-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-8"><a href="Spatial.html#cb90-8" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb90-9"><a href="Spatial.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb90-10"><a href="Spatial.html#cb90-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-11"><a href="Spatial.html#cb90-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood matrix</span></span>
<span id="cb90-12"><a href="Spatial.html#cb90-12" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span> (england , <span class="at">row.names =</span> england<span class="sc">$</span>ID)</span>
<span id="cb90-13"><a href="Spatial.html#cb90-13" aria-hidden="true" tabindex="-1"></a>W.list <span class="ot">&lt;-</span> <span class="fu">nb2listw</span> (W.nb , <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb90-14"><a href="Spatial.html#cb90-14" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span> (W.nb , <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb90-15"><a href="Spatial.html#cb90-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-16"><a href="Spatial.html#cb90-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the adjacency matrix into a file in the INLA format</span></span>
<span id="cb90-17"><a href="Spatial.html#cb90-17" aria-hidden="true" tabindex="-1"></a><span class="fu">nb2INLA</span>(<span class="st">&quot;UK.adj&quot;</span>, W.nb)</span>
<span id="cb90-18"><a href="Spatial.html#cb90-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-19"><a href="Spatial.html#cb90-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Create areas IDs to match the values in UK.adj</span></span>
<span id="cb90-20"><a href="Spatial.html#cb90-20" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="at">y =</span> observed<span class="sc">$</span>Y2010, <span class="at">E =</span> expected<span class="sc">$</span>E2010))</span>
<span id="cb90-21"><a href="Spatial.html#cb90-21" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ID <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">324</span></span></code></pre></div>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="Spatial.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the INLA model</span></span>
<span id="cb91-2"><a href="Spatial.html#cb91-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb91-3"><a href="Spatial.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">f</span>(ID , <span class="at">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="at">graph =</span> <span class="st">&quot;UK.adj&quot;</span>),</span>
<span id="cb91-4"><a href="Spatial.html#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb91-5"><a href="Spatial.html#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb91-6"><a href="Spatial.html#cb91-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb91-7"><a href="Spatial.html#cb91-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb91-8"><a href="Spatial.html#cb91-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="RealData.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="PointsFields.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/08-Chpt8.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
