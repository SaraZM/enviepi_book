<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-02-27" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Disease.html"/>
<link rel="next" href="Time.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a>
<ul>
<li class="chapter" data-level="" data-path="why.html"><a href="why.html#example-1.5"><i class="fa fa-check"></i>Example 1.5</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.9: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.10: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.11: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.12-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.12: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.13-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.13: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.14-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.14: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="8.1" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i><b>8.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i><b>8.1.1</b> PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-variogram"><i class="fa fa-check"></i>Example 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.9 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.11-inla-creating-a-mesh"><i class="fa fa-check"></i>Example 10.11: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.13-directional-variograms"><i class="fa fa-check"></i>Example 10.13: Directional variograms</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-implementation-of-a-dynamic-linear-model"><i class="fa fa-check"></i>Example 11.16 implementation of a dynamic linear model</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nile-river-data"><i class="fa fa-check"></i>Nile river data</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#uk-ozone-data"><i class="fa fa-check"></i>UK ozone data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="13.1" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i><b>13.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i><b>13.1.1</b> Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="13.1.2" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i><b>13.1.2</b> Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="13.1.3" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i><b>13.1.3</b> Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hazards" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Environmental hazards-spatial models<a href="hazards.html#hazards" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains the basic theory for spatial processes and a number of approaches to modelling point-referenced spatial data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Visualization techniques needed for both exploring and analyzing spatial data and communicating its features through the use of maps.</li>
<li>Exploring the underlying structure of spatial data and methods for characterizing dependence over space.</li>
<li>Second-order theory for spatial processes including the covariance. The variogram for measuring spatial associations.</li>
<li>Stationarity and isotropy.</li>
<li>Methods for spatial prediction, using both classical methods (kriging) as well as modern methods (Bayesian kriging).</li>
<li>Non-stationarity fields.</li>
</ul>
<!-- NOTE: Unlike some of the other chapters you have to run this code sequentially -->
<div id="example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="section level2 unnumbered hasAnchor">
<h2>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada<a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Map the locations of the monitoring stations in Montreal.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="hazards.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb145-2"><a href="hazards.html#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb145-3"><a href="hazards.html#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb145-4"><a href="hazards.html#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb145-5"><a href="hazards.html#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb145-6"><a href="hazards.html#cb145-6" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb145-7"><a href="hazards.html#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add description of the data, this is the April campaign</span></span></code></pre></div>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="hazards.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb146-2"><a href="hazards.html#cb146-2" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb146-3"><a href="hazards.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb146-4"><a href="hazards.html#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb146-5"><a href="hazards.html#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb146-6"><a href="hazards.html#cb146-6" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(benzene_geo)</span>
<span id="cb146-7"><a href="hazards.html#cb146-7" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb146-8"><a href="hazards.html#cb146-8" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb146-9"><a href="hazards.html#cb146-9" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span>,</span>
<span id="cb146-10"><a href="hazards.html#cb146-10" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb146-11"><a href="hazards.html#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb146-12"><a href="hazards.html#cb146-12" aria-hidden="true" tabindex="-1"></a>MontrelBenzeneMap <span class="ot">&lt;-</span></span>
<span id="cb146-13"><a href="hazards.html#cb146-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb146-14"><a href="hazards.html#cb146-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">10</span>)</span>
<span id="cb146-15"><a href="hazards.html#cb146-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(MontrelBenzeneMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> benzene,</span>
<span id="cb146-16"><a href="hazards.html#cb146-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">aes</span>(<span class="at">x =</span> lon,</span>
<span id="cb146-17"><a href="hazards.html#cb146-17" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">y =</span> lat,</span>
<span id="cb146-18"><a href="hazards.html#cb146-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span> Benzene), </span>
<span id="cb146-19"><a href="hazards.html#cb146-19" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">col =</span> <span class="st">&quot;#011f4b&quot;</span>,</span>
<span id="cb146-20"><a href="hazards.html#cb146-20" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20map%20data-1.png" width="672" /></p>
<p>Using the <code>geoR</code> package we can also plot the following:</p>
<ul>
<li>the locations of the sampling sites</li>
<li>the concentrations of ozone in relation to the x and y coordinates</li>
<li>and a histogram of the concentrations indicating the distribution of concentrations together with an estimate of the density.</li>
</ul>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="hazards.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert data to utm coordinates</span></span>
<span id="cb147-2"><a href="hazards.html#cb147-2" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb147-3"><a href="hazards.html#cb147-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb147-4"><a href="hazards.html#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb147-5"><a href="hazards.html#cb147-5" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb147-6"><a href="hazards.html#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(benzene_utm_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Benzene&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb147-7"><a href="hazards.html#cb147-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as geodata to generate the geodata plot</span></span>
<span id="cb147-8"><a href="hazards.html#cb147-8" aria-hidden="true" tabindex="-1"></a>benzene_geodata <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>(benzene_utm_df,</span>
<span id="cb147-9"><a href="hazards.html#cb147-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">data.col =</span> <span class="dv">1</span>)</span>
<span id="cb147-10"><a href="hazards.html#cb147-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(benzene_geodata)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20geoR%20plot-1.png" width="672" /></p>
</div>
<div id="example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.2: Examining the log concentrations of benzene in Montreal<a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="hazards.html#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram for the log of the benzene concentration</span></span>
<span id="cb148-2"><a href="hazards.html#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb148-3"><a href="hazards.html#cb148-3" aria-hidden="true" tabindex="-1"></a>log_histogram <span class="ot">&lt;-</span> <span class="fu">hist</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">main =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(Benzene)&quot;</span>)</span>
<span id="cb148-4"><a href="hazards.html#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb148-5"><a href="hazards.html#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.2%20plot%20hist%20and%20qqplot%20log-1.png" width="672" />
<!-- NOTE: I don't know how to generate the plot in Figure 9.4 --></p>
</div>
<div id="example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="section level2 unnumbered hasAnchor">
<h2>Example 10.3: Mapping the locations of ozone monitoring sites in New York State<a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="hazards.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the metadata giving the site coordinates </span></span>
<span id="cb149-2"><a href="hazards.html#cb149-2" aria-hidden="true" tabindex="-1"></a>ny_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/NY_metadata.txt&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>) </span>
<span id="cb149-3"><a href="hazards.html#cb149-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Now copy ny_data into ny_data_sp and convert data to &quot;sp&quot; format </span></span>
<span id="cb149-4"><a href="hazards.html#cb149-4" aria-hidden="true" tabindex="-1"></a>ny_data_sp <span class="ot">&lt;-</span> ny_data</span>
<span id="cb149-5"><a href="hazards.html#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="er">~</span>Longitude<span class="sc">+</span>Latitude </span>
<span id="cb149-6"><a href="hazards.html#cb149-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-7"><a href="hazards.html#cb149-7" aria-hidden="true" tabindex="-1"></a><span class="co"># assign a reference system to ny_data_sp </span></span>
<span id="cb149-8"><a href="hazards.html#cb149-8" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84&quot;</span>) </span>
<span id="cb149-9"><a href="hazards.html#cb149-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-10"><a href="hazards.html#cb149-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We next specify a bounding box - a 2 x 2 matrix of corners of the geographic </span></span>
<span id="cb149-11"><a href="hazards.html#cb149-11" aria-hidden="true" tabindex="-1"></a><span class="co"># area. Then specify the range of locations within the box. </span></span>
<span id="cb149-12"><a href="hazards.html#cb149-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: location must bounding box format be in left -bottom -right -top </span></span>
<span id="cb149-13"><a href="hazards.html#cb149-13" aria-hidden="true" tabindex="-1"></a>latLongBox  <span class="ot">&lt;-</span>  <span class="fu">bbox</span>(ny_data_sp)</span>
<span id="cb149-14"><a href="hazards.html#cb149-14" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span>  <span class="fu">c</span>(latLongBox [<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span> ,</span>
<span id="cb149-15"><a href="hazards.html#cb149-15" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span>,</span>
<span id="cb149-16"><a href="hazards.html#cb149-16" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span> ,</span>
<span id="cb149-17"><a href="hazards.html#cb149-17" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span>)</span>
<span id="cb149-18"><a href="hazards.html#cb149-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-19"><a href="hazards.html#cb149-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create the map with location dots </span></span>
<span id="cb149-20"><a href="hazards.html#cb149-20" aria-hidden="true" tabindex="-1"></a>NYmap <span class="ot">&lt;-</span></span>
<span id="cb149-21"><a href="hazards.html#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(</span>
<span id="cb149-22"><a href="hazards.html#cb149-22" aria-hidden="true" tabindex="-1"></a>   <span class="at">bbox =</span> location,</span>
<span id="cb149-23"><a href="hazards.html#cb149-23" aria-hidden="true" tabindex="-1"></a>   <span class="at">zoom =</span> <span class="dv">8</span></span>
<span id="cb149-24"><a href="hazards.html#cb149-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb149-25"><a href="hazards.html#cb149-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-26"><a href="hazards.html#cb149-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(NYmap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb149-27"><a href="hazards.html#cb149-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ny_data,</span>
<span id="cb149-28"><a href="hazards.html#cb149-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> Longitude , <span class="at">y =</span> Latitude),</span>
<span id="cb149-29"><a href="hazards.html#cb149-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb149-30"><a href="hazards.html#cb149-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span></span>
<span id="cb149-31"><a href="hazards.html#cb149-31" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.3%20plot%20ozone%20sites%20NY-1.png" width="672" /></p>
</div>
<div id="example-10.5-variogram" class="section level2 unnumbered hasAnchor">
<h2>Example 10.5: Variogram<a href="hazards.html#example-10.5-variogram" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="hazards.html#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb150-2"><a href="hazards.html#cb150-2" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo <span class="ot">&lt;-</span> benzene_utm_df</span>
<span id="cb150-3"><a href="hazards.html#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get the coordinates in kms and turn into a Spatial object</span></span>
<span id="cb150-4"><a href="hazards.html#cb150-4" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)] <span class="ot">&lt;-</span> benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb150-5"><a href="hazards.html#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_utm_geo) <span class="ot">&lt;-</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb150-6"><a href="hazards.html#cb150-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram intercept only</span></span>
<span id="cb150-7"><a href="hazards.html#cb150-7" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene)<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb150-8"><a href="hazards.html#cb150-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb150-9"><a href="hazards.html#cb150-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">10</span> <span class="co"># bins width </span></span>
<span id="cb150-10"><a href="hazards.html#cb150-10" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb150-11"><a href="hazards.html#cb150-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-12"><a href="hazards.html#cb150-12" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_inter_vgm,</span>
<span id="cb150-13"><a href="hazards.html#cb150-13" aria-hidden="true" tabindex="-1"></a>                                <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.02</span>))</span>
<span id="cb150-14"><a href="hazards.html#cb150-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-15"><a href="hazards.html#cb150-15" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01616521  0.00000
## 2   Exp 0.17301314 23.97153</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="hazards.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram using coordinates</span></span>
<span id="cb152-2"><a href="hazards.html#cb152-2" aria-hidden="true" tabindex="-1"></a>benzene_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene)<span class="sc">~</span> X <span class="sc">+</span> Y, <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb152-3"><a href="hazards.html#cb152-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb152-4"><a href="hazards.html#cb152-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">10</span> <span class="co"># bins width</span></span>
<span id="cb152-5"><a href="hazards.html#cb152-5" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb152-6"><a href="hazards.html#cb152-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-7"><a href="hazards.html#cb152-7" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_vgm,</span>
<span id="cb152-8"><a href="hazards.html#cb152-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">3</span>, <span class="fl">0.02</span>))</span>
<span id="cb152-9"><a href="hazards.html#cb152-9" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01638881 0.000000
## 2   Exp 0.05598753 7.365469</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="hazards.html#cb154-1" aria-hidden="true" tabindex="-1"></a>plot_inter_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_inter_vgm, benzene_inter_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb154-2"><a href="hazards.html#cb154-2" aria-hidden="true" tabindex="-1"></a>plot_coord_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_vgm, benzene_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb154-3"><a href="hazards.html#cb154-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-4"><a href="hazards.html#cb154-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(plot_inter_variog, plot_coord_variog, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.5%20plot%20variogram-1.png" width="672" /></p>
</div>
<div id="example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal<a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="hazards.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate grid</span></span>
<span id="cb155-2"><a href="hazards.html#cb155-2" aria-hidden="true" tabindex="-1"></a>MtlPred <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span> (<span class="dv">580</span>, <span class="dv">615</span> , <span class="fl">0.5</span>),</span>
<span id="cb155-3"><a href="hazards.html#cb155-3" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">seq</span> (<span class="dv">5020</span>, <span class="dv">5060</span> , <span class="fl">0.5</span>) )</span>
<span id="cb155-4"><a href="hazards.html#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="co"># change names grid</span></span>
<span id="cb155-5"><a href="hazards.html#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var1&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;X&quot;</span></span>
<span id="cb155-6"><a href="hazards.html#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var2&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb155-7"><a href="hazards.html#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make the grid a Spatial object</span></span>
<span id="cb155-8"><a href="hazards.html#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span> (MtlPred) <span class="ot">=</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb155-9"><a href="hazards.html#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="fu">gridded</span>(MtlPred) <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb155-10"><a href="hazards.html#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="co"># define the model based on the variogram fit from the previous example</span></span>
<span id="cb155-11"><a href="hazards.html#cb155-11" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">vgm</span> (<span class="fl">0.053</span> , <span class="st">&quot;Exp&quot;</span>, <span class="fl">5.54</span>, <span class="fl">0.0122</span>)</span>
<span id="cb155-12"><a href="hazards.html#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="co"># use ordinary kriging to predict values in the grid</span></span>
<span id="cb155-13"><a href="hazards.html#cb155-13" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">krige</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, benzene_utm_geo , MtlPred , <span class="at">model =</span> mod )</span></code></pre></div>
<pre><code>## [using universal kriging]</code></pre>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="hazards.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ordinary kriging predictions and their variance</span></span>
<span id="cb157-2"><a href="hazards.html#cb157-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-3"><a href="hazards.html#cb157-3" aria-hidden="true" tabindex="-1"></a>monitor_loc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;sp.points&#39;</span>, benzene_utm_geo, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span>.<span class="dv">8</span>, <span class="at">col=</span><span class="st">&#39;midnightblue&#39;</span>)</span>
<span id="cb157-4"><a href="hazards.html#cb157-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-5"><a href="hazards.html#cb157-5" aria-hidden="true" tabindex="-1"></a>krig_pred <span class="ot">&lt;-</span></span>
<span id="cb157-6"><a href="hazards.html#cb157-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb157-7"><a href="hazards.html#cb157-7" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.pred&quot;</span>],</span>
<span id="cb157-8"><a href="hazards.html#cb157-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging predictions &quot;</span>,</span>
<span id="cb157-9"><a href="hazards.html#cb157-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">20</span>),</span>
<span id="cb157-10"><a href="hazards.html#cb157-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc)</span>
<span id="cb157-11"><a href="hazards.html#cb157-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-12"><a href="hazards.html#cb157-12" aria-hidden="true" tabindex="-1"></a>krig_var <span class="ot">&lt;-</span></span>
<span id="cb157-13"><a href="hazards.html#cb157-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb157-14"><a href="hazards.html#cb157-14" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.var&quot;</span>],</span>
<span id="cb157-15"><a href="hazards.html#cb157-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging variance &quot;</span>,</span>
<span id="cb157-16"><a href="hazards.html#cb157-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">20</span>),</span>
<span id="cb157-17"><a href="hazards.html#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc)</span>
<span id="cb157-18"><a href="hazards.html#cb157-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb157-19"><a href="hazards.html#cb157-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-20"><a href="hazards.html#cb157-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(krig_pred, krig_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20kriging%20predictions-1.png" width="672" /></p>
</div>
<div id="example-10.9-spatial-modelling-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.9 Spatial modelling of Benzene in Montreal<a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-2" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="hazards.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb158-2"><a href="hazards.html#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb158-3"><a href="hazards.html#cb158-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span></code></pre></div>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="hazards.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb159-2"><a href="hazards.html#cb159-2" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb159-3"><a href="hazards.html#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb159-4"><a href="hazards.html#cb159-4" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb159-5"><a href="hazards.html#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb159-6"><a href="hazards.html#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb159-7"><a href="hazards.html#cb159-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-8"><a href="hazards.html#cb159-8" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb159-9"><a href="hazards.html#cb159-9" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb159-10"><a href="hazards.html#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb159-11"><a href="hazards.html#cb159-11" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb159-12"><a href="hazards.html#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers and observations to the log scale</span></span>
<span id="cb159-13"><a href="hazards.html#cb159-13" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb159-14"><a href="hazards.html#cb159-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb159-15"><a href="hazards.html#cb159-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb159-16"><a href="hazards.html#cb159-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb159-17"><a href="hazards.html#cb159-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb159-18"><a href="hazards.html#cb159-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb159-19"><a href="hazards.html#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb159-20"><a href="hazards.html#cb159-20" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span></code></pre></div>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="hazards.html#cb160-1" aria-hidden="true" tabindex="-1"></a>Example10_9Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb160-2"><a href="hazards.html#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb160-3"><a href="hazards.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span> (sigma<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n,<span class="dv">1</span><span class="sc">:</span>n]<span class="sc">/</span>phi) <span class="sc">+</span> (tau<span class="sc">^</span><span class="dv">2</span>)<span class="sc">*</span><span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb160-4"><a href="hazards.html#cb160-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb160-5"><a href="hazards.html#cb160-5" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb160-6"><a href="hazards.html#cb160-6" aria-hidden="true" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span> beta0 <span class="sc">+</span> beta1<span class="sc">*</span>easting[site] <span class="sc">+</span> beta2<span class="sc">*</span>northing[site]</span>
<span id="cb160-7"><a href="hazards.html#cb160-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-8"><a href="hazards.html#cb160-8" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb160-9"><a href="hazards.html#cb160-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb160-10"><a href="hazards.html#cb160-10" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb160-11"><a href="hazards.html#cb160-11" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb160-12"><a href="hazards.html#cb160-12" aria-hidden="true" tabindex="-1"></a>   phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">2</span>, <span class="at">scale =</span> <span class="dv">2</span>)</span>
<span id="cb160-13"><a href="hazards.html#cb160-13" aria-hidden="true" tabindex="-1"></a>   phi <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>phi_inv</span>
<span id="cb160-14"><a href="hazards.html#cb160-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior for the coefficients </span></span>
<span id="cb160-15"><a href="hazards.html#cb160-15" aria-hidden="true" tabindex="-1"></a>    beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb160-16"><a href="hazards.html#cb160-16" aria-hidden="true" tabindex="-1"></a>    beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb160-17"><a href="hazards.html#cb160-17" aria-hidden="true" tabindex="-1"></a>    beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb160-18"><a href="hazards.html#cb160-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-19"><a href="hazards.html#cb160-19" aria-hidden="true" tabindex="-1"></a>}) </span></code></pre></div>
<p>Define the constants, data and initials lists for the <code>nimble</code> model.</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb161-1"><a href="hazards.html#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb161-2"><a href="hazards.html#cb161-2" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb161-3"><a href="hazards.html#cb161-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample))</span>
<span id="cb161-4"><a href="hazards.html#cb161-4" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb161-5"><a href="hazards.html#cb161-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb161-6"><a href="hazards.html#cb161-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">easting =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting)),</span>
<span id="cb161-7"><a href="hazards.html#cb161-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">northing =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing)),</span>
<span id="cb161-8"><a href="hazards.html#cb161-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">distMatrix =</span> Dist)</span>
<span id="cb161-9"><a href="hazards.html#cb161-9" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(  <span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;tau&quot;</span>)</span>
<span id="cb161-10"><a href="hazards.html#cb161-10" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">sigma =</span> <span class="fl">0.1</span>, <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(Dist), <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb161-11"><a href="hazards.html#cb161-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb161-12"><a href="hazards.html#cb161-12" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb161-13"><a href="hazards.html#cb161-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example10_9Code,</span>
<span id="cb161-14"><a href="hazards.html#cb161-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb161-15"><a href="hazards.html#cb161-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb161-16"><a href="hazards.html#cb161-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb161-17"><a href="hazards.html#cb161-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb161-18"><a href="hazards.html#cb161-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">30000</span>,</span>
<span id="cb161-19"><a href="hazards.html#cb161-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">15000</span>,</span>
<span id="cb161-20"><a href="hazards.html#cb161-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb161-21"><a href="hazards.html#cb161-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb161-22"><a href="hazards.html#cb161-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb161-23"><a href="hazards.html#cb161-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb161-24"><a href="hazards.html#cb161-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb161-25"><a href="hazards.html#cb161-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="hazards.html#cb162-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.83973
## Field &quot;lppd&quot;:
## [1] 19.21979
## Field &quot;pWAIC&quot;:
## [1] 2.799925</code></pre>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="hazards.html#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 219.8516</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="hazards.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="hazards.html#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="hazards.html#cb168-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="hazards.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="hazards.html#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="hazards.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="hazards.html#cb172-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span></code></pre></div>
<pre><code>##             Mean     Median     St.Dev.   95%CI_low  95%CI_upp
## beta0 0.10422119 0.12680857  0.13629689 -0.22706800  0.3239731
## beta1 0.05842226 0.05505536  0.07699560 -0.09034058  0.2175965
## beta2 0.04885239 0.06051973  0.08802806 -0.13573285  0.2035957
## phi   9.62169385 5.76072017 17.54047310  1.83679078 35.2257173
## sigma 0.28052413 0.25373804  0.11520535  0.17129818  0.5442519
## tau   0.10844846 0.11349238  0.03425615  0.02184874  0.1634161</code></pre>
<!-- TODO: Predictions -->
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="hazards.html#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load centroids for spatial prediction</span></span>
<span id="cb174-2"><a href="hazards.html#cb174-2" aria-hidden="true" tabindex="-1"></a>Mtl_centroids <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_shp/centroids_mtl.csv&quot;</span>)</span>
<span id="cb174-3"><a href="hazards.html#cb174-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(Mtl_centroids) <span class="ot">&lt;-</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb174-4"><a href="hazards.html#cb174-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(Mtl_centroids) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb174-5"><a href="hazards.html#cb174-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-6"><a href="hazards.html#cb174-6" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(Mtl_centroids,</span>
<span id="cb174-7"><a href="hazards.html#cb174-7" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb174-8"><a href="hazards.html#cb174-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb174-9"><a href="hazards.html#cb174-9" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(Mtl_centroids_utm)</span>
<span id="cb174-10"><a href="hazards.html#cb174-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-11"><a href="hazards.html#cb174-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb174-12"><a href="hazards.html#cb174-12" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(Mtl_centroids_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)</span></code></pre></div>
<p>Spatial predictions are done through a function in Rcpp that can be found on the <strong>functions</strong> folder.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="hazards.html#cb175-1" aria-hidden="true" tabindex="-1"></a>mcmc_samples <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, mcmc.out<span class="sc">$</span>samples) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb175-2"><a href="hazards.html#cb175-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract chains for each parameter</span></span>
<span id="cb175-3"><a href="hazards.html#cb175-3" aria-hidden="true" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="fu">nrow</span>(mcmc_samples)</span>
<span id="cb175-4"><a href="hazards.html#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="hazards.html#cb175-5" aria-hidden="true" tabindex="-1"></a>spat.pred.nimble <span class="ot">&lt;-</span></span>
<span id="cb175-6"><a href="hazards.html#cb175-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(mcmc_output) {</span>
<span id="cb175-7"><a href="hazards.html#cb175-7" aria-hidden="true" tabindex="-1"></a>    beta0 <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;beta0&quot;</span>]</span>
<span id="cb175-8"><a href="hazards.html#cb175-8" aria-hidden="true" tabindex="-1"></a>    beta1 <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;beta1&quot;</span>]</span>
<span id="cb175-9"><a href="hazards.html#cb175-9" aria-hidden="true" tabindex="-1"></a>    beta2 <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;beta2&quot;</span>]</span>
<span id="cb175-10"><a href="hazards.html#cb175-10" aria-hidden="true" tabindex="-1"></a>    phi <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;phi&quot;</span>]</span>
<span id="cb175-11"><a href="hazards.html#cb175-11" aria-hidden="true" tabindex="-1"></a>    sigma <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;sigma&quot;</span>]</span>
<span id="cb175-12"><a href="hazards.html#cb175-12" aria-hidden="true" tabindex="-1"></a>    tau <span class="ot">&lt;-</span> mcmc_output[<span class="st">&quot;tau&quot;</span>]</span>
<span id="cb175-13"><a href="hazards.html#cb175-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-14"><a href="hazards.html#cb175-14" aria-hidden="true" tabindex="-1"></a>    coords  <span class="ot">&lt;-</span>  <span class="fu">as.data.frame</span>(<span class="fu">scale</span>(Mtl_benzene_sample[, <span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb175-15"><a href="hazards.html#cb175-15" aria-hidden="true" tabindex="-1"></a>    pred_coords_df <span class="ot">&lt;-</span>  Mtl_centroids_df <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb175-16"><a href="hazards.html#cb175-16" aria-hidden="true" tabindex="-1"></a>    pred_coords <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">scale</span>(pred_coords_df)) <span class="co"># </span><span class="al">TODO</span><span class="co">: this scaling is wrong</span></span>
<span id="cb175-17"><a href="hazards.html#cb175-17" aria-hidden="true" tabindex="-1"></a>    y_obs  <span class="ot">&lt;-</span>  Mtl_benzene_sample[, <span class="st">&quot;y&quot;</span>]</span>
<span id="cb175-18"><a href="hazards.html#cb175-18" aria-hidden="true" tabindex="-1"></a>    norg <span class="ot">&lt;-</span> <span class="fu">nrow</span>(coords)</span>
<span id="cb175-19"><a href="hazards.html#cb175-19" aria-hidden="true" tabindex="-1"></a>    npred <span class="ot">&lt;-</span> <span class="fu">nrow</span>(pred_coords)</span>
<span id="cb175-20"><a href="hazards.html#cb175-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-21"><a href="hazards.html#cb175-21" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span></span>
<span id="cb175-22"><a href="hazards.html#cb175-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(beta0, <span class="fu">nrow</span>(coords)) <span class="sc">+</span> beta1 <span class="sc">*</span> coords[, <span class="st">&quot;easting&quot;</span>] <span class="sc">+</span> beta2 <span class="sc">*</span> coords[, <span class="st">&quot;northing&quot;</span>]</span>
<span id="cb175-23"><a href="hazards.html#cb175-23" aria-hidden="true" tabindex="-1"></a>    mu_u <span class="ot">&lt;-</span></span>
<span id="cb175-24"><a href="hazards.html#cb175-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rep</span>(beta0, <span class="fu">nrow</span>(pred_coords)) <span class="sc">+</span> beta1 <span class="sc">*</span> pred_coords[, <span class="st">&quot;easting&quot;</span>] <span class="sc">+</span> beta2 <span class="sc">*</span> pred_coords[, <span class="st">&quot;northing&quot;</span>]</span>
<span id="cb175-25"><a href="hazards.html#cb175-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-26"><a href="hazards.html#cb175-26" aria-hidden="true" tabindex="-1"></a>    all_coord <span class="ot">&lt;-</span> <span class="fu">rbind</span>(pred_coords_df, coords)</span>
<span id="cb175-27"><a href="hazards.html#cb175-27" aria-hidden="true" tabindex="-1"></a>    all_dist <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(all_coord))</span>
<span id="cb175-28"><a href="hazards.html#cb175-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-29"><a href="hazards.html#cb175-29" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="ot">&lt;-</span></span>
<span id="cb175-30"><a href="hazards.html#cb175-30" aria-hidden="true" tabindex="-1"></a>      tau <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">diag</span>(norg <span class="sc">+</span> npred) <span class="sc">+</span> sigma <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>all_dist <span class="sc">/</span> phi)</span>
<span id="cb175-31"><a href="hazards.html#cb175-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-32"><a href="hazards.html#cb175-32" aria-hidden="true" tabindex="-1"></a>    Sigma_unobs <span class="ot">&lt;-</span> Sigma[<span class="dv">1</span><span class="sc">:</span>npred, <span class="dv">1</span><span class="sc">:</span>npred]</span>
<span id="cb175-33"><a href="hazards.html#cb175-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-34"><a href="hazards.html#cb175-34" aria-hidden="true" tabindex="-1"></a>    Sigma_obs <span class="ot">&lt;-</span></span>
<span id="cb175-35"><a href="hazards.html#cb175-35" aria-hidden="true" tabindex="-1"></a>      Sigma[(npred <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(npred <span class="sc">+</span> norg), (npred <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(npred <span class="sc">+</span> norg)]</span>
<span id="cb175-36"><a href="hazards.html#cb175-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-37"><a href="hazards.html#cb175-37" aria-hidden="true" tabindex="-1"></a>    Sigma_unobs_obs <span class="ot">&lt;-</span> Sigma[<span class="dv">1</span><span class="sc">:</span>npred, (npred <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(norg <span class="sc">+</span> npred)]</span>
<span id="cb175-38"><a href="hazards.html#cb175-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-39"><a href="hazards.html#cb175-39" aria-hidden="true" tabindex="-1"></a>    mu_pred <span class="ot">&lt;-</span></span>
<span id="cb175-40"><a href="hazards.html#cb175-40" aria-hidden="true" tabindex="-1"></a>      mu_u <span class="sc">+</span> Sigma_unobs_obs <span class="sc">%*%</span> <span class="fu">solve</span>(Sigma_obs) <span class="sc">%*%</span> (y_obs <span class="sc">-</span> mu)</span>
<span id="cb175-41"><a href="hazards.html#cb175-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-42"><a href="hazards.html#cb175-42" aria-hidden="true" tabindex="-1"></a>    Sigma_pred <span class="ot">&lt;-</span></span>
<span id="cb175-43"><a href="hazards.html#cb175-43" aria-hidden="true" tabindex="-1"></a>      Sigma_unobs <span class="sc">-</span> Sigma_unobs_obs <span class="sc">%*%</span> <span class="fu">solve</span>(Sigma_obs) <span class="sc">%*%</span> <span class="fu">t</span>(Sigma_unobs_obs)</span>
<span id="cb175-44"><a href="hazards.html#cb175-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-45"><a href="hazards.html#cb175-45" aria-hidden="true" tabindex="-1"></a>    Y_u <span class="ot">&lt;-</span> mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(<span class="dv">1</span>, mu_pred, Sigma_pred)</span>
<span id="cb175-46"><a href="hazards.html#cb175-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(Y_u)</span>
<span id="cb175-47"><a href="hazards.html#cb175-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb175-48"><a href="hazards.html#cb175-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb175-49"><a href="hazards.html#cb175-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-50"><a href="hazards.html#cb175-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-51"><a href="hazards.html#cb175-51" aria-hidden="true" tabindex="-1"></a><span class="co">#spatial_pred_MTL &lt;- apply(mcmc_samples, 1, spat.pred.nimble)</span></span>
<span id="cb175-52"><a href="hazards.html#cb175-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-53"><a href="hazards.html#cb175-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-54"><a href="hazards.html#cb175-54" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: reduce the grid, it takes too long</span></span>
<span id="cb175-55"><a href="hazards.html#cb175-55" aria-hidden="true" tabindex="-1"></a><span class="co"># REVIEW: Need to change the priors it seems like I am forcing phi</span></span></code></pre></div>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="hazards.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mtl_shape &lt;- st_read(&quot;data/montreal_shp/temp1.shp&quot;) %&gt;% st_as_sf()</span></span>
<span id="cb176-2"><a href="hazards.html#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Mtl_shape$mean_benzene &lt;- rowMeans(spatial_pred_MTL)</span></span>
<span id="cb176-3"><a href="hazards.html#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Mtl_shape$sd &lt;- apply(spatial_pred_MTL, 1, sd)</span></span>
<span id="cb176-4"><a href="hazards.html#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb176-5"><a href="hazards.html#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="co"># benzene_post_mean &lt;- ggplot() +</span></span>
<span id="cb176-6"><a href="hazards.html#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data = Mtl_shape, aes(fill = mean_benzene), color = NA) +</span></span>
<span id="cb176-7"><a href="hazards.html#cb176-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_point(data = benzene,</span></span>
<span id="cb176-8"><a href="hazards.html#cb176-8" aria-hidden="true" tabindex="-1"></a><span class="co">#              aes(x = lon, y = lat),</span></span>
<span id="cb176-9"><a href="hazards.html#cb176-9" aria-hidden="true" tabindex="-1"></a><span class="co">#              color = &quot;midnightblue&quot;) +</span></span>
<span id="cb176-10"><a href="hazards.html#cb176-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme_void() + labs(fill = &quot;Posterior mean&quot;)</span></span>
<span id="cb176-11"><a href="hazards.html#cb176-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb176-12"><a href="hazards.html#cb176-12" aria-hidden="true" tabindex="-1"></a><span class="co"># benzene_post_sd &lt;- ggplot() +</span></span>
<span id="cb176-13"><a href="hazards.html#cb176-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data = Mtl_shape, aes(fill = sd), color = NA) +</span></span>
<span id="cb176-14"><a href="hazards.html#cb176-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_point(data = benzene,</span></span>
<span id="cb176-15"><a href="hazards.html#cb176-15" aria-hidden="true" tabindex="-1"></a><span class="co">#              aes(x = lon, y = lat),</span></span>
<span id="cb176-16"><a href="hazards.html#cb176-16" aria-hidden="true" tabindex="-1"></a><span class="co">#              color = &quot;midnightblue&quot;) +</span></span>
<span id="cb176-17"><a href="hazards.html#cb176-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme_void() + labs(fill = &quot;Posterior sd&quot;)</span></span>
<span id="cb176-18"><a href="hazards.html#cb176-18" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb176-19"><a href="hazards.html#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_grid(benzene_post_mean, benzene_post_sd, labels = &quot;auto&quot;)</span></span></code></pre></div>
</div>
<div id="stan-2" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="hazards.html#cb177-1" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb177-2"><a href="hazards.html#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb177-3"><a href="hazards.html#cb177-3" aria-hidden="true" tabindex="-1"></a>benzene_data_geo <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb177-4"><a href="hazards.html#cb177-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb177-5"><a href="hazards.html#cb177-5" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb177-6"><a href="hazards.html#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="hazards.html#cb177-7" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_geo,</span>
<span id="cb177-8"><a href="hazards.html#cb177-8" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb177-9"><a href="hazards.html#cb177-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb177-10"><a href="hazards.html#cb177-10" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm)</span>
<span id="cb177-11"><a href="hazards.html#cb177-11" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb177-12"><a href="hazards.html#cb177-12" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb177-13"><a href="hazards.html#cb177-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb177-14"><a href="hazards.html#cb177-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb177-15"><a href="hazards.html#cb177-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb177-16"><a href="hazards.html#cb177-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb177-17"><a href="hazards.html#cb177-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb177-18"><a href="hazards.html#cb177-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb177-19"><a href="hazards.html#cb177-19" aria-hidden="true" tabindex="-1"></a>Dist <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span></code></pre></div>
<pre><code>
data {
  int&lt;lower=1&gt; N;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] dist_matrix;
  matrix[N,p] X; 
}

parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;

}
model {
  vector[N] mu;
  matrix[N, N] L;
  matrix[N, N] Sigma;

  real sigma_sq = square(sigma);
  real tau_sq = square(tau);

 for(i in 1:(N-1)){
   for(j in (i+1):N){
     Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements

  for(i in 1:N) {
    Sigma[i,i] = sigma_sq + tau_sq;
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="hazards.html#cb179-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb179-2"><a href="hazards.html#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb179-3"><a href="hazards.html#cb179-3" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting<span class="sc">/</span><span class="dv">1000</span>)),</span>
<span id="cb179-4"><a href="hazards.html#cb179-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">northing =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing<span class="sc">/</span><span class="dv">1000</span>))) </span>
<span id="cb179-5"><a href="hazards.html#cb179-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-6"><a href="hazards.html#cb179-6" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb179-7"><a href="hazards.html#cb179-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb179-8"><a href="hazards.html#cb179-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb179-9"><a href="hazards.html#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb179-10"><a href="hazards.html#cb179-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist_matrix =</span> Dist,</span>
<span id="cb179-11"><a href="hazards.html#cb179-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb179-12"><a href="hazards.html#cb179-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb179-13"><a href="hazards.html#cb179-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-14"><a href="hazards.html#cb179-14" aria-hidden="true" tabindex="-1"></a>Example10_9Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb179-15"><a href="hazards.html#cb179-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_9.stan&quot;</span>,</span>
<span id="cb179-16"><a href="hazards.html#cb179-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb179-17"><a href="hazards.html#cb179-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb179-18"><a href="hazards.html#cb179-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb179-19"><a href="hazards.html#cb179-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb179-20"><a href="hazards.html#cb179-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb179-21"><a href="hazards.html#cb179-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb179-22"><a href="hazards.html#cb179-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb179-23"><a href="hazards.html#cb179-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="hazards.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(Example10_9Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="hazards.html#cb181-1" aria-hidden="true" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb181-2"><a href="hazards.html#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb181-3"><a href="hazards.html#cb181-3" aria-hidden="true" tabindex="-1"></a>    Example10_9Stan,</span>
<span id="cb181-4"><a href="hazards.html#cb181-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>),</span>
<span id="cb181-5"><a href="hazards.html#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb181-6"><a href="hazards.html#cb181-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb181-7"><a href="hazards.html#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="hazards.html#cb181-8" aria-hidden="true" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##               mean      se_mean         sd         2.5%     97.5%    n_eff
## beta0   0.15268455 0.0018915990 0.08262618 -0.033757913 0.3001611 1907.995
## beta[1] 0.04809368 0.0013714567 0.06044758 -0.059958358 0.1837747 1942.646
## beta[2] 0.08273260 0.0016043297 0.06803673 -0.066272622 0.1976874 1798.455
## phi     3.63473577 0.0517940650 2.23198811  1.477722773 9.1418045 1857.051
## sigma   0.23222127 0.0009538352 0.04065768  0.169477214 0.3261857 1816.932
## tau     0.08705342 0.0009501848 0.03970717  0.006406996 0.1507703 1746.311
##              Rhat
## beta0   1.0000298
## beta[1] 0.9997141
## beta[2] 1.0004204
## phi     0.9998907
## sigma   0.9994753
## tau     0.9997791</code></pre>
<!-- TODO: Predictions -->
</div>
</div>
<div id="example-10.11-inla-creating-a-mesh" class="section level2 unnumbered hasAnchor">
<h2>Example 10.11: INLA, creating a mesh<a href="hazards.html#example-10.11-inla-creating-a-mesh" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="hazards.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb183-2"><a href="hazards.html#cb183-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb183-3"><a href="hazards.html#cb183-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb183-4"><a href="hazards.html#cb183-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-5"><a href="hazards.html#cb183-5" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb183-6"><a href="hazards.html#cb183-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb183-7"><a href="hazards.html#cb183-7" aria-hidden="true" tabindex="-1"></a>benzene_data_loc <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb183-8"><a href="hazards.html#cb183-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb183-9"><a href="hazards.html#cb183-9" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb183-10"><a href="hazards.html#cb183-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-11"><a href="hazards.html#cb183-11" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_loc,</span>
<span id="cb183-12"><a href="hazards.html#cb183-12" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb183-13"><a href="hazards.html#cb183-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb183-14"><a href="hazards.html#cb183-14" aria-hidden="true" tabindex="-1"></a>locations_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm<span class="sc">@</span>coords)</span>
<span id="cb183-15"><a href="hazards.html#cb183-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-16"><a href="hazards.html#cb183-16" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(benzene_data),</span>
<span id="cb183-17"><a href="hazards.html#cb183-17" aria-hidden="true" tabindex="-1"></a>                              <span class="at">X =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">1</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb183-18"><a href="hazards.html#cb183-18" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Y =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">2</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb183-19"><a href="hazards.html#cb183-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">logbenzene =</span> <span class="fu">log</span>(benzene_data_utm<span class="sc">$</span>Benzene))</span>
<span id="cb183-20"><a href="hazards.html#cb183-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb183-21"><a href="hazards.html#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb183-22"><a href="hazards.html#cb183-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-23"><a href="hazards.html#cb183-23" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.create</span>(locations_df, <span class="at">cutoff =</span> <span class="fl">0.01</span>, </span>
<span id="cb183-24"><a href="hazards.html#cb183-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">refine =</span>(<span class="fu">list</span>(<span class="at">min.angle =</span><span class="dv">20</span>)))</span>
<span id="cb183-25"><a href="hazards.html#cb183-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh , <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">main=</span><span class="st">&quot;&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.11%20load%20data%20for%20INLA-1.png" width="672" /></p>
<div class="sourceCode" id="cb184"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb184-1"><a href="hazards.html#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ukmap &lt;- readShapeLines(&quot;uk_BNG.shp&quot;) plot(mesh , col=&quot;gray&quot;, main=&quot;&quot;) </span></span>
<span id="cb184-2"><a href="hazards.html#cb184-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lines(ukmap)</span></span>
<span id="cb184-3"><a href="hazards.html#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="co"># points(locations , col=&quot;red&quot;, pch=20,bg=&quot;red&quot;) </span></span></code></pre></div>
</div>
<div id="example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal<a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="hazards.html#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Field std . dev . for theta =0</span></span>
<span id="cb185-2"><a href="hazards.html#cb185-2" aria-hidden="true" tabindex="-1"></a>sigma0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb185-3"><a href="hazards.html#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find the range of the location data</span></span>
<span id="cb185-4"><a href="hazards.html#cb185-4" aria-hidden="true" tabindex="-1"></a>size <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">c</span>(<span class="fu">diff</span>(<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">1</span>])),</span>
<span id="cb185-5"><a href="hazards.html#cb185-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">diff</span> (<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">2</span>]))))</span>
<span id="cb185-6"><a href="hazards.html#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="co"># A fifth of the approximate domain width .</span></span>
<span id="cb185-7"><a href="hazards.html#cb185-7" aria-hidden="true" tabindex="-1"></a>range0 <span class="ot">=</span> size<span class="sc">/</span><span class="dv">5</span></span>
<span id="cb185-8"><a href="hazards.html#cb185-8" aria-hidden="true" tabindex="-1"></a>kappa0 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">8</span>)<span class="sc">/</span>range0</span>
<span id="cb185-9"><a href="hazards.html#cb185-9" aria-hidden="true" tabindex="-1"></a>tau0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fu">sqrt</span> (<span class="dv">4</span><span class="sc">*</span>pi)<span class="sc">*</span>kappa0<span class="sc">*</span>sigma0)</span>
<span id="cb185-10"><a href="hazards.html#cb185-10" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">=</span> <span class="fu">inla.spde2.matern</span> (</span>
<span id="cb185-11"><a href="hazards.html#cb185-11" aria-hidden="true" tabindex="-1"></a>  mesh,</span>
<span id="cb185-12"><a href="hazards.html#cb185-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.tau =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (tau0), <span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb185-13"><a href="hazards.html#cb185-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.kappa =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (kappa0), <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb185-14"><a href="hazards.html#cb185-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta.prior.mean =</span> <span class="fu">c</span>(<span class="dv">0</span> , <span class="dv">0</span>),</span>
<span id="cb185-15"><a href="hazards.html#cb185-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">constr =</span> <span class="cn">TRUE</span></span>
<span id="cb185-16"><a href="hazards.html#cb185-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb185-17"><a href="hazards.html#cb185-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-18"><a href="hazards.html#cb185-18" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> logbenzene  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> <span class="fu">f</span>(ID , <span class="at">model =</span> spde)</span>
<span id="cb185-19"><a href="hazards.html#cb185-19" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb185-20"><a href="hazards.html#cb185-20" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb185-21"><a href="hazards.html#cb185-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb185-22"><a href="hazards.html#cb185-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> benzene_utm_df ,</span>
<span id="cb185-23"><a href="hazards.html#cb185-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb185-24"><a href="hazards.html#cb185-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span> , <span class="at">config =</span> <span class="cn">TRUE</span>)</span>
<span id="cb185-25"><a href="hazards.html#cb185-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb185-26"><a href="hazards.html#cb185-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-27"><a href="hazards.html#cb185-27" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>summary.fixed</span></code></pre></div>
<pre><code>##                     mean           sd    0.025quant      0.5quant   0.975quant
## (Intercept)  8.263107109 118.01744834 -189.26686123 -5.4724133487 298.73720629
## X            0.014532810   0.02130267   -0.02563718  0.0132910509   0.06340354
## Y           -0.003363563   0.02371941   -0.06108419 -0.0006481981   0.03642514
##                      mode          kld
## (Intercept) -20.057620990 5.350437e-05
## X             0.011915185 7.755183e-05
## Y             0.002407428 3.418641e-05</code></pre>
</div>
<div id="example-10.13-directional-variograms" class="section level2 unnumbered hasAnchor">
<h2>Example 10.13: Directional variograms<a href="hazards.html#example-10.13-directional-variograms" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="hazards.html#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Compute and plot the directional variogram</span></span>
<span id="cb187-2"><a href="hazards.html#cb187-2" aria-hidden="true" tabindex="-1"></a>CA.geo <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>( benzene_utm_df , <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span> , <span class="at">data.col=</span><span class="dv">1</span>)</span>
<span id="cb187-3"><a href="hazards.html#cb187-3" aria-hidden="true" tabindex="-1"></a>CA.vario4 <span class="ot">&lt;-</span> <span class="fu">variog4</span>(CA.geo )</span>
<span id="cb187-4"><a href="hazards.html#cb187-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CA.vario4)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.13%20directional%20variogram-1.png" width="672" /></p>
<!-- REVIEW: I am not sure where this example goes -->
</div>
<div id="example-10.14-spatial-modeling-of-malaria-in-gambia" class="section level2 unnumbered hasAnchor">
<h2>Example 10.14: Spatial modeling of malaria in Gambia<a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="hazards.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># to manipulate the data</span></span>
<span id="cb188-2"><a href="hazards.html#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR) <span class="co"># to get the dataset</span></span>
<span id="cb188-3"><a href="hazards.html#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap) <span class="co"># to plot the map</span></span>
<span id="cb188-4"><a href="hazards.html#cb188-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble) <span class="co"># for modeling</span></span>
<span id="cb188-5"><a href="hazards.html#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster) <span class="co"># to get the environmental data</span></span>
<span id="cb188-6"><a href="hazards.html#cb188-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgdal) <span class="co"># for adding and transforming coordinates</span></span>
<span id="cb188-7"><a href="hazards.html#cb188-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># manipulate spatial data</span></span>
<span id="cb188-8"><a href="hazards.html#cb188-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) <span class="co"># for manipulating spatial data</span></span>
<span id="cb188-9"><a href="hazards.html#cb188-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># to analyze posterior</span></span>
<span id="cb188-10"><a href="hazards.html#cb188-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># for a more cheerful color palette</span></span>
<span id="cb188-11"><a href="hazards.html#cb188-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-12"><a href="hazards.html#cb188-12" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(gambia) <span class="co"># gambia dataset from geoR package</span></span>
<span id="cb188-13"><a href="hazards.html#cb188-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-14"><a href="hazards.html#cb188-14" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb188-15"><a href="hazards.html#cb188-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb188-16"><a href="hazards.html#cb188-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb188-17"><a href="hazards.html#cb188-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb188-18"><a href="hazards.html#cb188-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb188-19"><a href="hazards.html#cb188-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>), <span class="co"># keep axis line</span></span>
<span id="cb188-20"><a href="hazards.html#cb188-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)</span>
<span id="cb188-21"><a href="hazards.html#cb188-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb188-22"><a href="hazards.html#cb188-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the data is given at the individual level, we want to aggregate the malaria tests by village.
If we explore the data frame we see that there are 2035 individuals at 65 villages.</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="hazards.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gambia)</span></code></pre></div>
<pre><code>##             x       y pos  age netuse treated green phc
## 1850 349631.3 1458055   1 1783      0       0 40.85   1
## 1851 349631.3 1458055   0  404      1       0 40.85   1
## 1852 349631.3 1458055   0  452      1       0 40.85   1
## 1853 349631.3 1458055   1  566      1       0 40.85   1
## 1854 349631.3 1458055   0  598      1       0 40.85   1
## 1855 349631.3 1458055   1  590      1       0 40.85   1</code></pre>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="hazards.html#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gambia)</span></code></pre></div>
<pre><code>## [1] 2035    8</code></pre>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="hazards.html#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">unique</span>(gambia[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)]))</span></code></pre></div>
<pre><code>## [1] 65  2</code></pre>
<p>We create a new data frame aggregated by village containing the coordinates, the number of malaria tests, the prevalence and the altitude.</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="hazards.html#cb195-1" aria-hidden="true" tabindex="-1"></a>malaria_village <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gambia, x, y) <span class="sc">|&gt;</span></span>
<span id="cb195-2"><a href="hazards.html#cb195-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">n</span>(),</span>
<span id="cb195-3"><a href="hazards.html#cb195-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">positive =</span> <span class="fu">sum</span>(pos),</span>
<span id="cb195-4"><a href="hazards.html#cb195-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">prev =</span> positive <span class="sc">/</span> total) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;x&#39;. You can override using the `.groups`
## argument.</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="hazards.html#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(malaria_village)</span></code></pre></div>
<pre><code>##          x       y total positive      prev
## 1 349631.3 1458055    33       17 0.5151515
## 2 358543.1 1460112    63       19 0.3015873
## 3 360308.1 1460026    17        7 0.4117647
## 4 363795.7 1496919    24        8 0.3333333
## 5 366400.5 1460248    26       10 0.3846154
## 6 366687.5 1463002    18        7 0.3888889</code></pre>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="hazards.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb199-2"><a href="hazards.html#cb199-2" aria-hidden="true" tabindex="-1"></a>malaria_utm <span class="ot">&lt;-</span> malaria_village</span>
<span id="cb199-3"><a href="hazards.html#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb199-4"><a href="hazards.html#cb199-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=28&quot;</span>)</span>
<span id="cb199-5"><a href="hazards.html#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to long lat </span></span>
<span id="cb199-6"><a href="hazards.html#cb199-6" aria-hidden="true" tabindex="-1"></a>malaria_geo <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(malaria_utm, <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span></code></pre></div>
<pre><code>## Warning: PROJ support is provided by the sf and terra packages among others</code></pre>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="hazards.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add long lat coordinates to malaria dataframe</span></span>
<span id="cb201-2"><a href="hazards.html#cb201-2" aria-hidden="true" tabindex="-1"></a>malaria_village[, <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">coordinates</span>(malaria_geo)</span>
<span id="cb201-3"><a href="hazards.html#cb201-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-4"><a href="hazards.html#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb201-5"><a href="hazards.html#cb201-5" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(malaria_geo)</span>
<span id="cb201-6"><a href="hazards.html#cb201-6" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb201-7"><a href="hazards.html#cb201-7" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb201-8"><a href="hazards.html#cb201-8" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb201-9"><a href="hazards.html#cb201-9" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb201-10"><a href="hazards.html#cb201-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-11"><a href="hazards.html#cb201-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb201-12"><a href="hazards.html#cb201-12" aria-hidden="true" tabindex="-1"></a>GambiaMap <span class="ot">&lt;-</span></span>
<span id="cb201-13"><a href="hazards.html#cb201-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb201-14"><a href="hazards.html#cb201-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">11</span>,</span>
<span id="cb201-15"><a href="hazards.html#cb201-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> terrain<span class="sc">-</span>background)</span></code></pre></div>
<pre><code>## ℹ Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</code></pre>
<pre><code>## ℹ 64 tiles needed, this may take a while (try a smaller zoom?)</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="hazards.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(GambiaMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> malaria_village,</span>
<span id="cb204-2"><a href="hazards.html#cb204-2" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">aes</span>(<span class="at">x =</span> long,</span>
<span id="cb204-3"><a href="hazards.html#cb204-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">y =</span> lat,</span>
<span id="cb204-4"><a href="hazards.html#cb204-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col =</span> prev),</span>
<span id="cb204-5"><a href="hazards.html#cb204-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20plot%20prevalence-1.png" width="672" /></p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="hazards.html#cb205-1" aria-hidden="true" tabindex="-1"></a>altitude_gambia <span class="ot">&lt;-</span> <span class="fu">getData</span>(<span class="at">name =</span> <span class="st">&quot;alt&quot;</span>, <span class="at">country =</span> <span class="st">&quot;GMB&quot;</span>, <span class="at">mask =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">projectRaster</span>(<span class="at">crs =</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&quot;</span>))</span>
<span id="cb205-2"><a href="hazards.html#cb205-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert raster to polygons to plot using ggmap</span></span>
<span id="cb205-3"><a href="hazards.html#cb205-3" aria-hidden="true" tabindex="-1"></a>altitude_pol <span class="ot">&lt;-</span> <span class="fu">rasterToPolygons</span>(altitude_gambia)</span>
<span id="cb205-4"><a href="hazards.html#cb205-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-5"><a href="hazards.html#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(GambiaMap) <span class="sc">+</span></span>
<span id="cb205-6"><a href="hazards.html#cb205-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inset_raster</span>(</span>
<span id="cb205-7"><a href="hazards.html#cb205-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>(altitude_gambia),</span>
<span id="cb205-8"><a href="hazards.html#cb205-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmin =</span> altitude_gambia<span class="sc">@</span>extent[<span class="dv">1</span>],</span>
<span id="cb205-9"><a href="hazards.html#cb205-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">xmax =</span> altitude_gambia<span class="sc">@</span>extent[<span class="dv">2</span>],</span>
<span id="cb205-10"><a href="hazards.html#cb205-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymin =</span> altitude_gambia<span class="sc">@</span>extent[<span class="dv">3</span>],</span>
<span id="cb205-11"><a href="hazards.html#cb205-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">ymax =</span> altitude_gambia<span class="sc">@</span>extent[<span class="dv">4</span>]</span>
<span id="cb205-12"><a href="hazards.html#cb205-12" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20load%20covariates%20and%20plot%20altitude-1.png" width="672" /></p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="hazards.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># extract from altitude_gambia the altitude values at malaria_village locations and add it to data frame</span></span>
<span id="cb206-2"><a href="hazards.html#cb206-2" aria-hidden="true" tabindex="-1"></a>malaria_village<span class="sc">$</span>alt <span class="ot">&lt;-</span></span>
<span id="cb206-3"><a href="hazards.html#cb206-3" aria-hidden="true" tabindex="-1"></a>  raster<span class="sc">::</span><span class="fu">extract</span>(altitude_gambia, malaria_village[, <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)])</span>
<span id="cb206-4"><a href="hazards.html#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(malaria_village)</span></code></pre></div>
<pre><code>##          x       y total positive      prev      long      lat      alt
## 1 349631.3 1458055    33       17 0.5151515 -16.38755 13.18541 13.79277
## 2 358543.1 1460112    63       19 0.3015873 -16.30543 13.20444 29.62704
## 3 360308.1 1460026    17        7 0.4117647 -16.28914 13.20374 32.02842
## 4 363795.7 1496919    24        8 0.3333333 -16.25869 13.53742 20.09067
## 5 366400.5 1460248    26       10 0.3846154 -16.23294 13.20603 27.60793
## 6 366687.5 1463002    18        7 0.3888889 -16.23041 13.23094 17.06336</code></pre>
<!-- NOTE: I am not doing a Matern cause I don't know how to code it, I'll use an exponential instead -->
<div id="nimble-3" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="hazards.html#cb208-1" aria-hidden="true" tabindex="-1"></a>Example10_14_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb208-2"><a href="hazards.html#cb208-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-3"><a href="hazards.html#cb208-3" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb208-4"><a href="hazards.html#cb208-4" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb208-5"><a href="hazards.html#cb208-5" aria-hidden="true" tabindex="-1"></a>  phi <span class="sc">~</span> <span class="fu">dexp</span>(<span class="at">rate =</span>  <span class="dv">1</span><span class="sc">/</span><span class="fl">45.51057</span>) <span class="co"># maxdist/6</span></span>
<span id="cb208-6"><a href="hazards.html#cb208-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-7"><a href="hazards.html#cb208-7" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb208-8"><a href="hazards.html#cb208-8" aria-hidden="true" tabindex="-1"></a>    (sigma <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> (tau <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb208-9"><a href="hazards.html#cb208-9" aria-hidden="true" tabindex="-1"></a> <span class="co"># L[1:n,1:n] &lt;- chol(Sigma[1:n, 1:n])</span></span>
<span id="cb208-10"><a href="hazards.html#cb208-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-11"><a href="hazards.html#cb208-11" aria-hidden="true" tabindex="-1"></a>  S[<span class="dv">1</span><span class="sc">:</span>n] <span class="sc">~</span> <span class="fu">dmnorm</span>(zeroes[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n,<span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb208-12"><a href="hazards.html#cb208-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-13"><a href="hazards.html#cb208-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb208-14"><a href="hazards.html#cb208-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logit</span>(p[i]) <span class="ot">&lt;-</span> b0 <span class="sc">+</span> b1<span class="sc">*</span>altitude[i] <span class="sc">+</span> S[i]</span>
<span id="cb208-15"><a href="hazards.html#cb208-15" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> N[i], <span class="at">prob =</span> p[i])</span>
<span id="cb208-16"><a href="hazards.html#cb208-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb208-17"><a href="hazards.html#cb208-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-18"><a href="hazards.html#cb208-18" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span>  <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">100</span>)</span>
<span id="cb208-19"><a href="hazards.html#cb208-19" aria-hidden="true" tabindex="-1"></a>  b1 <span class="sc">~</span>  <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">100</span>)</span>
<span id="cb208-20"><a href="hazards.html#cb208-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-21"><a href="hazards.html#cb208-21" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="hazards.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distance specification</span></span>
<span id="cb209-2"><a href="hazards.html#cb209-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-3"><a href="hazards.html#cb209-3" aria-hidden="true" tabindex="-1"></a>coords_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(malaria_village[,<span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)], <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb209-4"><a href="hazards.html#cb209-4" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb209-5"><a href="hazards.html#cb209-5" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(coords_sf)</span>
<span id="cb209-6"><a href="hazards.html#cb209-6" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, km)</span>
<span id="cb209-7"><a href="hazards.html#cb209-7" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, <span class="cn">NULL</span>)</span>
<span id="cb209-8"><a href="hazards.html#cb209-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-9"><a href="hazards.html#cb209-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb209-10"><a href="hazards.html#cb209-10" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fu">nrow</span>(malaria_village)</span>
<span id="cb209-11"><a href="hazards.html#cb209-11" aria-hidden="true" tabindex="-1"></a>altitude <span class="ot">&lt;-</span> malaria_village<span class="sc">$</span>alt</span>
<span id="cb209-12"><a href="hazards.html#cb209-12" aria-hidden="true" tabindex="-1"></a><span class="co"># there are two missing values in the altitude that will be replaced with the mean</span></span>
<span id="cb209-13"><a href="hazards.html#cb209-13" aria-hidden="true" tabindex="-1"></a>altitude[<span class="fu">is.na</span>(altitude)] <span class="ot">&lt;-</span> <span class="fu">mean</span>(altitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) </span>
<span id="cb209-14"><a href="hazards.html#cb209-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-15"><a href="hazards.html#cb209-15" aria-hidden="true" tabindex="-1"></a>zeroes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n)</span>
<span id="cb209-16"><a href="hazards.html#cb209-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb209-17"><a href="hazards.html#cb209-17" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="co"># number of villages</span></span>
<span id="cb209-18"><a href="hazards.html#cb209-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">zeroes =</span> zeroes)</span>
<span id="cb209-19"><a href="hazards.html#cb209-19" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> malaria_village<span class="sc">$</span>positive, <span class="co"># malaria prevalence </span></span>
<span id="cb209-20"><a href="hazards.html#cb209-20" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N =</span> malaria_village<span class="sc">$</span>total, <span class="co"># people sampled per village</span></span>
<span id="cb209-21"><a href="hazards.html#cb209-21" aria-hidden="true" tabindex="-1"></a>                 <span class="at">altitude =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(altitude)), <span class="co"># altitude per village</span></span>
<span id="cb209-22"><a href="hazards.html#cb209-22" aria-hidden="true" tabindex="-1"></a>                 <span class="at">obs_dist_mat =</span> obs_dist_mat <span class="co"># distance matrix in km</span></span>
<span id="cb209-23"><a href="hazards.html#cb209-23" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb209-24"><a href="hazards.html#cb209-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-25"><a href="hazards.html#cb209-25" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sigma =</span> <span class="fl">0.01</span>, <span class="at">p =</span> <span class="fu">rep</span>(<span class="fl">0.01</span>, n))</span>
<span id="cb209-26"><a href="hazards.html#cb209-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-27"><a href="hazards.html#cb209-27" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb209-28"><a href="hazards.html#cb209-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb209-29"><a href="hazards.html#cb209-29" aria-hidden="true" tabindex="-1"></a>    Example10_14_Nimble,</span>
<span id="cb209-30"><a href="hazards.html#cb209-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb209-31"><a href="hazards.html#cb209-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb209-32"><a href="hazards.html#cb209-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb209-33"><a href="hazards.html#cb209-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb209-34"><a href="hazards.html#cb209-34" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb209-35"><a href="hazards.html#cb209-35" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb209-36"><a href="hazards.html#cb209-36" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb209-37"><a href="hazards.html#cb209-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b1&quot;</span>, <span class="st">&quot;p&quot;</span>, <span class="st">&quot;S&quot;</span>))</span>
<span id="cb209-38"><a href="hazards.html#cb209-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-39"><a href="hazards.html#cb209-39" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb209-40"><a href="hazards.html#cb209-40" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb209-41"><a href="hazards.html#cb209-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb209-42"><a href="hazards.html#cb209-42" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb209-43"><a href="hazards.html#cb209-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb209-44"><a href="hazards.html#cb209-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb209-45"><a href="hazards.html#cb209-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span></span>
<span id="cb209-46"><a href="hazards.html#cb209-46" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb209-47"><a href="hazards.html#cb209-47" aria-hidden="true" tabindex="-1"></a>niters <span class="ot">&lt;-</span> <span class="dv">60000</span></span>
<span id="cb209-48"><a href="hazards.html#cb209-48" aria-hidden="true" tabindex="-1"></a>nburnins <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niters</span>
<span id="cb209-49"><a href="hazards.html#cb209-49" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb209-50"><a href="hazards.html#cb209-50" aria-hidden="true" tabindex="-1"></a>nthins <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb209-51"><a href="hazards.html#cb209-51" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb209-52"><a href="hazards.html#cb209-52" aria-hidden="true" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb209-53"><a href="hazards.html#cb209-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> niters,</span>
<span id="cb209-54"><a href="hazards.html#cb209-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnins,</span>
<span id="cb209-55"><a href="hazards.html#cb209-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nthins,</span>
<span id="cb209-56"><a href="hazards.html#cb209-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nchains,</span>
<span id="cb209-57"><a href="hazards.html#cb209-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb209-58"><a href="hazards.html#cb209-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb209-59"><a href="hazards.html#cb209-59" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="hazards.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-1.png" width="672" /></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="hazards.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-2.png" width="672" /></p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="hazards.html#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-3.png" width="672" /></p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="hazards.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-4.png" width="672" /></p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="hazards.html#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-5.png" width="672" /></p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="hazards.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-6.png" width="672" /></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="hazards.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[13]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[13]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-7.png" width="672" /></p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="hazards.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-8.png" width="672" /></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="hazards.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[13]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[13]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-9.png" width="672" /></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="hazards.html#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get minimum effective size (ESS) and which variable has the min ESS</span></span>
<span id="cb219-2"><a href="hazards.html#cb219-2" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 66.53177</code></pre>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="hazards.html#cb221-1" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(post_samples<span class="sc">$</span>samples<span class="sc">$</span>chain1)</span>
<span id="cb221-2"><a href="hazards.html#cb221-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-3"><a href="hazards.html#cb221-3" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names[<span class="fu">which</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples) <span class="sc">==</span> <span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples)))]</span></code></pre></div>
<pre><code>## [1] &quot;b0&quot;</code></pre>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="hazards.html#cb223-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb223-2"><a href="hazards.html#cb223-2" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b1&quot;</span>,<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>)</span>
<span id="cb223-3"><a href="hazards.html#cb223-3" aria-hidden="true" tabindex="-1"></a>summary_nimble <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb223-4"><a href="hazards.html#cb223-4" aria-hidden="true" tabindex="-1"></a>summary_nimble[variables,]</span></code></pre></div>
<pre><code>##               Mean       Median     St.Dev.   95%CI_low   95%CI_upp
## b0    -0.021800620 -0.022648903  0.10042494 -0.21101997   0.1784620
## b1     0.005941798  0.005681489  0.07219044 -0.13393380   0.1490428
## tau    0.438324690  0.445290960  0.18453932  0.05393761   0.7906616
## sigma  1.197175686  1.145603965  0.35152952  0.67475580   2.0269406
## phi   48.907807964 38.808796665 34.97473463 12.49579948 144.4258963</code></pre>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="hazards.html#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior summary for the spatial random effect by village</span></span>
<span id="cb225-2"><a href="hazards.html#cb225-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains </span>
<span id="cb225-3"><a href="hazards.html#cb225-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-4"><a href="hazards.html#cb225-4" aria-hidden="true" tabindex="-1"></a>post_sum_S <span class="ot">&lt;-</span></span>
<span id="cb225-5"><a href="hazards.html#cb225-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb225-6"><a href="hazards.html#cb225-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;S&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb225-7"><a href="hazards.html#cb225-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, Mean, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)  <span class="sc">|&gt;</span></span>
<span id="cb225-8"><a href="hazards.html#cb225-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))</span>
<span id="cb225-9"><a href="hazards.html#cb225-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-10"><a href="hazards.html#cb225-10" aria-hidden="true" tabindex="-1"></a>post_sum_S<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb225-11"><a href="hazards.html#cb225-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(post_sum_S<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb225-12"><a href="hazards.html#cb225-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-13"><a href="hazards.html#cb225-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_S, <span class="fu">aes</span>(<span class="at">x =</span> village)) <span class="sc">+</span></span>
<span id="cb225-14"><a href="hazards.html#cb225-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>, <span class="at">y =</span> Mean)) <span class="sc">+</span></span>
<span id="cb225-15"><a href="hazards.html#cb225-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-16"><a href="hazards.html#cb225-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb225-17"><a href="hazards.html#cb225-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> post_sum_S<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(post_sum_S<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb225-18"><a href="hazards.html#cb225-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb225-19"><a href="hazards.html#cb225-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20summary%20p-1.png" width="672" /></p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="hazards.html#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior summary for the probabilities</span></span>
<span id="cb226-2"><a href="hazards.html#cb226-2" aria-hidden="true" tabindex="-1"></a>post_sum_p <span class="ot">&lt;-</span></span>
<span id="cb226-3"><a href="hazards.html#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb226-4"><a href="hazards.html#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;p</span><span class="sc">\\</span><span class="st">[&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb226-5"><a href="hazards.html#cb226-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, Mean, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)  <span class="sc">|&gt;</span></span>
<span id="cb226-6"><a href="hazards.html#cb226-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))</span>
<span id="cb226-7"><a href="hazards.html#cb226-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-8"><a href="hazards.html#cb226-8" aria-hidden="true" tabindex="-1"></a>post_sum_p<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb226-9"><a href="hazards.html#cb226-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(post_sum_p<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb226-10"><a href="hazards.html#cb226-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-11"><a href="hazards.html#cb226-11" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_p, <span class="fu">aes</span>(<span class="at">x =</span> village)) <span class="sc">+</span></span>
<span id="cb226-12"><a href="hazards.html#cb226-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>, <span class="at">y =</span> Mean)) <span class="sc">+</span></span>
<span id="cb226-13"><a href="hazards.html#cb226-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">scale_x_discrete</span>(</span>
<span id="cb226-14"><a href="hazards.html#cb226-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> post_sum_p<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(post_sum_p<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb226-15"><a href="hazards.html#cb226-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span> </span>
<span id="cb226-16"><a href="hazards.html#cb226-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary probabilities by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20summary%20S-1.png" width="672" /></p>
</div>
<div id="stan-3" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>data {
  int&lt;lower=1&gt; n; //  number of villages
  int N[n]; //  total number of surveys
  int y[n]; //  number of positive cases
  matrix[n,n] dist_matrix; //  distance matrix
  vector[n] X; // vector with altitudes
}

parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[n] S; // spatial random effect
  real beta;
  real beta0;
}

transformed parameters {
  vector[n] logit_p = beta0 + X*beta + S;
  vector[n] p = inv_logit(logit_p);
  real sigma_sq = square(sigma);
  real tau_sq = square(tau);
}

model {
  matrix[n, n] L;
  matrix[n, n] Sigma;
  vector[n] zeroes; // vector of zeroes



 for(i in 1:(n-1)){
   for(j in (i+1):n){
     Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements covariances
for(i in 1:n){
  Sigma[i,i] = sigma_sq + tau_sq;
}

// sample spatial random effect
  L = cholesky_decompose(Sigma);
  zeroes = rep_vector(0, n);
  S ~ multi_normal_cholesky(zeroes, L);

  for(i in 1:n) {
    //logit_p[i] = beta0 + X[i]*beta + S[i];
    y[i] ~ binomial_logit(N[i], logit_p[i]);
  }

  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ exponential(1/45.51057);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);
  

}</code></pre>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="hazards.html#cb228-1" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> malaria_village<span class="sc">$</span>positive, <span class="co"># malaria prevalence </span></span>
<span id="cb228-2"><a href="hazards.html#cb228-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N =</span> malaria_village<span class="sc">$</span>total, <span class="co"># people sampled per village</span></span>
<span id="cb228-3"><a href="hazards.html#cb228-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(altitude)), <span class="co"># altitude per village</span></span>
<span id="cb228-4"><a href="hazards.html#cb228-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dist_matrix =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb228-5"><a href="hazards.html#cb228-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">n =</span> <span class="fu">nrow</span>(malaria_village) <span class="co"># number of villages</span></span>
<span id="cb228-6"><a href="hazards.html#cb228-6" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb228-7"><a href="hazards.html#cb228-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-8"><a href="hazards.html#cb228-8" aria-hidden="true" tabindex="-1"></a>Example10_14Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb228-9"><a href="hazards.html#cb228-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_14.stan&quot;</span>,</span>
<span id="cb228-10"><a href="hazards.html#cb228-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb228-11"><a href="hazards.html#cb228-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">15000</span>,</span>
<span id="cb228-12"><a href="hazards.html#cb228-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">30000</span>,</span>
<span id="cb228-13"><a href="hazards.html#cb228-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb228-14"><a href="hazards.html#cb228-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb228-15"><a href="hazards.html#cb228-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;S&quot;</span>, <span class="st">&quot;p&quot;</span>),</span>
<span id="cb228-16"><a href="hazards.html#cb228-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb228-17"><a href="hazards.html#cb228-17" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb229-1"><a href="hazards.html#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb229-2"><a href="hazards.html#cb229-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-3"><a href="hazards.html#cb229-3" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="hazards.html#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb230-2"><a href="hazards.html#cb230-2" aria-hidden="true" tabindex="-1"></a>summary_stan <span class="ot">&lt;-</span></span>
<span id="cb230-3"><a href="hazards.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb230-4"><a href="hazards.html#cb230-4" aria-hidden="true" tabindex="-1"></a>    Example10_14Stan,</span>
<span id="cb230-5"><a href="hazards.html#cb230-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb230-6"><a href="hazards.html#cb230-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb230-7"><a href="hazards.html#cb230-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb230-8"><a href="hazards.html#cb230-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-9"><a href="hazards.html#cb230-9" aria-hidden="true" tabindex="-1"></a>summary_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##              mean     se_mean         sd        2.5%       97.5%     n_eff
## beta0 -0.34973915 0.050360744  0.7668068 -1.55898728   1.8694512  231.8396
## beta  -0.01902933 0.002544680  0.1305381 -0.26710050   0.2381496 2631.5295
## tau    0.46251141 0.003959349  0.1957288  0.05150648   0.8077175 2443.7795
## sigma  1.21788102 0.018877886  0.4456589  0.59843048   2.3907382  557.3122
## phi   48.33797552 1.181148116 38.5990705  9.78540624 151.0966764 1067.9354
##            Rhat
## beta0 1.0036948
## beta  0.9995681
## tau   1.0000791
## sigma 1.0003651
## phi   1.0010729</code></pre>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="hazards.html#cb232-1" aria-hidden="true" tabindex="-1"></a>S_summary <span class="ot">&lt;-</span></span>
<span id="cb232-2"><a href="hazards.html#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb232-3"><a href="hazards.html#cb232-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-4"><a href="hazards.html#cb232-4" aria-hidden="true" tabindex="-1"></a>S_summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(S_summary) <span class="sc">|&gt;</span></span>
<span id="cb232-5"><a href="hazards.html#cb232-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb232-6"><a href="hazards.html#cb232-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;S[&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>, <span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb232-7"><a href="hazards.html#cb232-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>) <span class="sc">|&gt;</span></span>
<span id="cb232-8"><a href="hazards.html#cb232-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mean,  X2.<span class="fl">5.</span>, X97.<span class="fl">5.</span>, village)</span>
<span id="cb232-9"><a href="hazards.html#cb232-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb232-10"><a href="hazards.html#cb232-10" aria-hidden="true" tabindex="-1"></a>S_summary_df<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb232-11"><a href="hazards.html#cb232-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(S_summary_df<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb232-12"><a href="hazards.html#cb232-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-13"><a href="hazards.html#cb232-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-14"><a href="hazards.html#cb232-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(S_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> village, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb232-15"><a href="hazards.html#cb232-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb232-16"><a href="hazards.html#cb232-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb232-17"><a href="hazards.html#cb232-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb232-18"><a href="hazards.html#cb232-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> S_summary_df<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(S_summary_df<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb232-19"><a href="hazards.html#cb232-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb232-20"><a href="hazards.html#cb232-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20posterior%20plots-1.png" width="672" /></p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb233-1"><a href="hazards.html#cb233-1" aria-hidden="true" tabindex="-1"></a>p_summary <span class="ot">&lt;-</span></span>
<span id="cb233-2"><a href="hazards.html#cb233-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;p&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb233-3"><a href="hazards.html#cb233-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-4"><a href="hazards.html#cb233-4" aria-hidden="true" tabindex="-1"></a>p_summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(p_summary) <span class="sc">|&gt;</span></span>
<span id="cb233-5"><a href="hazards.html#cb233-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb233-6"><a href="hazards.html#cb233-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;p[&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>, <span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb233-7"><a href="hazards.html#cb233-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>) <span class="sc">|&gt;</span></span>
<span id="cb233-8"><a href="hazards.html#cb233-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mean,  X2.<span class="fl">5.</span>, X97.<span class="fl">5.</span>, village)</span>
<span id="cb233-9"><a href="hazards.html#cb233-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb233-10"><a href="hazards.html#cb233-10" aria-hidden="true" tabindex="-1"></a>p_summary_df<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb233-11"><a href="hazards.html#cb233-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(p_summary_df<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb233-12"><a href="hazards.html#cb233-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb233-13"><a href="hazards.html#cb233-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(p_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> village, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb233-14"><a href="hazards.html#cb233-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb233-15"><a href="hazards.html#cb233-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb233-16"><a href="hazards.html#cb233-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> p_summary_df<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(p_summary_df<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb233-17"><a href="hazards.html#cb233-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb233-18"><a href="hazards.html#cb233-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary probabilities by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20posterior%20plots-2.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Disease.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/10-Chpt10.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
