<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Environmental hazards-spatial models | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-03-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Disease.html"/>
<link rel="next" href="Time.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a>
<ul>
<li class="chapter" data-level="" data-path="why.html"><a href="why.html#example-1.5"><i class="fa fa-check"></i>Example 1.5</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.9: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.10: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.11: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.12-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.12: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.13-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.13: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.14-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.14: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="8.1" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i><b>8.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i><b>8.1.1</b> PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-variogram"><i class="fa fa-check"></i>Example 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.9 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.13-directional-variograms"><i class="fa fa-check"></i>Example 10.13: Directional variograms</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-implementation-of-a-dynamic-linear-model"><i class="fa fa-check"></i>Example 11.16 implementation of a dynamic linear model</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nile-river-data"><i class="fa fa-check"></i>Nile river data</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#uk-ozone-data"><i class="fa fa-check"></i>UK ozone data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="13.1" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i><b>13.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i><b>13.1.1</b> Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="13.1.2" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i><b>13.1.2</b> Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="13.1.3" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i><b>13.1.3</b> Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hazards" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> Environmental hazards-spatial models<a href="hazards.html#hazards" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter contains the basic theory for spatial processes and a number of approaches to modelling point-referenced spatial data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Visualization techniques needed for both exploring and analyzing spatial data and communicating its features through the use of maps.</li>
<li>Exploring the underlying structure of spatial data and methods for characterizing dependence over space.</li>
<li>Second-order theory for spatial processes including the covariance. The variogram for measuring spatial associations.</li>
<li>Stationarity and isotropy.</li>
<li>Methods for spatial prediction, using both classical methods (kriging) as well as modern methods (Bayesian kriging).</li>
<li>Non-stationarity fields.</li>
</ul>
<!-- NOTE: Unlike some of the other chapters you have to run this code sequentially -->
<div id="example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="section level2 unnumbered hasAnchor">
<h2>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada<a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Map the locations of the monitoring stations in Montreal.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="hazards.html#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)</span>
<span id="cb133-2"><a href="hazards.html#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb133-3"><a href="hazards.html#cb133-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap)</span>
<span id="cb133-4"><a href="hazards.html#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb133-5"><a href="hazards.html#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb133-6"><a href="hazards.html#cb133-6" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb133-7"><a href="hazards.html#cb133-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add description of the data, this is the April campaign</span></span></code></pre></div>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="hazards.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb134-2"><a href="hazards.html#cb134-2" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb134-3"><a href="hazards.html#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb134-4"><a href="hazards.html#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb134-5"><a href="hazards.html#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb134-6"><a href="hazards.html#cb134-6" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(benzene_geo)</span>
<span id="cb134-7"><a href="hazards.html#cb134-7" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb134-8"><a href="hazards.html#cb134-8" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb134-9"><a href="hazards.html#cb134-9" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.1</span>,</span>
<span id="cb134-10"><a href="hazards.html#cb134-10" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb134-11"><a href="hazards.html#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb134-12"><a href="hazards.html#cb134-12" aria-hidden="true" tabindex="-1"></a>MontrelBenzeneMap <span class="ot">&lt;-</span></span>
<span id="cb134-13"><a href="hazards.html#cb134-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb134-14"><a href="hazards.html#cb134-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">10</span>)</span>
<span id="cb134-15"><a href="hazards.html#cb134-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(MontrelBenzeneMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> benzene,</span>
<span id="cb134-16"><a href="hazards.html#cb134-16" aria-hidden="true" tabindex="-1"></a>                                      <span class="fu">aes</span>(<span class="at">x =</span> lon,</span>
<span id="cb134-17"><a href="hazards.html#cb134-17" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">y =</span> lat,</span>
<span id="cb134-18"><a href="hazards.html#cb134-18" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">size =</span> Benzene), </span>
<span id="cb134-19"><a href="hazards.html#cb134-19" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">col =</span> <span class="st">&quot;#011f4b&quot;</span>,</span>
<span id="cb134-20"><a href="hazards.html#cb134-20" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">alpha =</span> <span class="fl">0.45</span>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20map%20data-1.png" width="672" /></p>
<p>Using the <code>geoR</code> package we can also plot the following:</p>
<ul>
<li>the locations of the sampling sites</li>
<li>the concentrations of ozone in relation to the x and y coordinates</li>
<li>and a histogram of the concentrations indicating the distribution of concentrations together with an estimate of the density.</li>
</ul>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="hazards.html#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert data to utm coordinates</span></span>
<span id="cb135-2"><a href="hazards.html#cb135-2" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb135-3"><a href="hazards.html#cb135-3" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb135-4"><a href="hazards.html#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb135-5"><a href="hazards.html#cb135-5" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb135-6"><a href="hazards.html#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(benzene_utm_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Benzene&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)</span>
<span id="cb135-7"><a href="hazards.html#cb135-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Save as geodata to generate the geodata plot</span></span>
<span id="cb135-8"><a href="hazards.html#cb135-8" aria-hidden="true" tabindex="-1"></a>benzene_geodata <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>(benzene_utm_df,</span>
<span id="cb135-9"><a href="hazards.html#cb135-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">data.col =</span> <span class="dv">1</span>)</span>
<span id="cb135-10"><a href="hazards.html#cb135-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(benzene_geodata)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.1%20geoR%20plot-1.png" width="672" /></p>
</div>
<div id="example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.2: Examining the log concentrations of benzene in Montreal<a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="hazards.html#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Histogram for the log of the benzene concentration</span></span>
<span id="cb136-2"><a href="hazards.html#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb136-3"><a href="hazards.html#cb136-3" aria-hidden="true" tabindex="-1"></a>log_histogram <span class="ot">&lt;-</span> <span class="fu">hist</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">main =</span> <span class="st">&quot;&quot;</span>, <span class="at">xlab =</span> <span class="st">&quot;log(Benzene)&quot;</span>)</span>
<span id="cb136-4"><a href="hazards.html#cb136-4" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene), <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb136-5"><a href="hazards.html#cb136-5" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(<span class="fu">log</span>(benzene<span class="sc">$</span>Benzene))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.2%20plot%20hist%20and%20qqplot%20log-1.png" width="672" />
<!-- NOTE: I don't know how to generate the plot in Figure 9.4 --></p>
</div>
<div id="example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="section level2 unnumbered hasAnchor">
<h2>Example 10.3: Mapping the locations of ozone monitoring sites in New York State<a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="hazards.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the metadata giving the site coordinates </span></span>
<span id="cb137-2"><a href="hazards.html#cb137-2" aria-hidden="true" tabindex="-1"></a>ny_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/NY_metadata.txt&quot;</span>, <span class="at">sep=</span><span class="st">&quot;&quot;</span>) </span>
<span id="cb137-3"><a href="hazards.html#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Now copy ny_data into ny_data_sp and convert data to &quot;sp&quot; format </span></span>
<span id="cb137-4"><a href="hazards.html#cb137-4" aria-hidden="true" tabindex="-1"></a>ny_data_sp <span class="ot">&lt;-</span> ny_data</span>
<span id="cb137-5"><a href="hazards.html#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="er">~</span>Longitude<span class="sc">+</span>Latitude </span>
<span id="cb137-6"><a href="hazards.html#cb137-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-7"><a href="hazards.html#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="co"># assign a reference system to ny_data_sp </span></span>
<span id="cb137-8"><a href="hazards.html#cb137-8" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(ny_data_sp) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +ellps=WGS84&quot;</span>) </span>
<span id="cb137-9"><a href="hazards.html#cb137-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-10"><a href="hazards.html#cb137-10" aria-hidden="true" tabindex="-1"></a><span class="co"># We next specify a bounding box - a 2 x 2 matrix of corners of the geographic </span></span>
<span id="cb137-11"><a href="hazards.html#cb137-11" aria-hidden="true" tabindex="-1"></a><span class="co"># area. Then specify the range of locations within the box. </span></span>
<span id="cb137-12"><a href="hazards.html#cb137-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note: location must bounding box format be in left -bottom -right -top </span></span>
<span id="cb137-13"><a href="hazards.html#cb137-13" aria-hidden="true" tabindex="-1"></a>latLongBox  <span class="ot">&lt;-</span>  <span class="fu">bbox</span>(ny_data_sp)</span>
<span id="cb137-14"><a href="hazards.html#cb137-14" aria-hidden="true" tabindex="-1"></a>location <span class="ot">&lt;-</span>  <span class="fu">c</span>(latLongBox [<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span> ,</span>
<span id="cb137-15"><a href="hazards.html#cb137-15" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.2</span>,</span>
<span id="cb137-16"><a href="hazards.html#cb137-16" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span> ,</span>
<span id="cb137-17"><a href="hazards.html#cb137-17" aria-hidden="true" tabindex="-1"></a>               latLongBox [<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.2</span>)</span>
<span id="cb137-18"><a href="hazards.html#cb137-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-19"><a href="hazards.html#cb137-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Now create the map with location dots </span></span>
<span id="cb137-20"><a href="hazards.html#cb137-20" aria-hidden="true" tabindex="-1"></a>NYmap <span class="ot">&lt;-</span></span>
<span id="cb137-21"><a href="hazards.html#cb137-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(</span>
<span id="cb137-22"><a href="hazards.html#cb137-22" aria-hidden="true" tabindex="-1"></a>   <span class="at">bbox =</span> location,</span>
<span id="cb137-23"><a href="hazards.html#cb137-23" aria-hidden="true" tabindex="-1"></a>   <span class="at">zoom =</span> <span class="dv">8</span></span>
<span id="cb137-24"><a href="hazards.html#cb137-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb137-25"><a href="hazards.html#cb137-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-26"><a href="hazards.html#cb137-26" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(NYmap) <span class="sc">+</span> <span class="fu">geom_point</span>(</span>
<span id="cb137-27"><a href="hazards.html#cb137-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ny_data,</span>
<span id="cb137-28"><a href="hazards.html#cb137-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> Longitude , <span class="at">y =</span> Latitude),</span>
<span id="cb137-29"><a href="hazards.html#cb137-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="dv">4</span>,</span>
<span id="cb137-30"><a href="hazards.html#cb137-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="st">&quot;darkred&quot;</span></span>
<span id="cb137-31"><a href="hazards.html#cb137-31" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.3%20plot%20ozone%20sites%20NY-1.png" width="672" /></p>
</div>
<div id="example-10.5-variogram" class="section level2 unnumbered hasAnchor">
<h2>Example 10.5: Variogram<a href="hazards.html#example-10.5-variogram" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="hazards.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gstat)</span>
<span id="cb138-2"><a href="hazards.html#cb138-2" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo <span class="ot">&lt;-</span> benzene_utm_df</span>
<span id="cb138-3"><a href="hazards.html#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="co"># get the coordinates in kms and turn into a Spatial object</span></span>
<span id="cb138-4"><a href="hazards.html#cb138-4" aria-hidden="true" tabindex="-1"></a>benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)] <span class="ot">&lt;-</span> benzene_utm_geo[,<span class="fu">c</span>(<span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>)]<span class="sc">/</span><span class="dv">1000</span></span>
<span id="cb138-5"><a href="hazards.html#cb138-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_utm_geo) <span class="ot">&lt;-</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb138-6"><a href="hazards.html#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram intercept only</span></span>
<span id="cb138-7"><a href="hazards.html#cb138-7" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm <span class="ot">&lt;-</span> gstat<span class="sc">::</span><span class="fu">variogram</span>(<span class="fu">log</span>(Benzene)<span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb138-8"><a href="hazards.html#cb138-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb138-9"><a href="hazards.html#cb138-9" aria-hidden="true" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">10</span> <span class="co"># bins width </span></span>
<span id="cb138-10"><a href="hazards.html#cb138-10" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb138-11"><a href="hazards.html#cb138-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-12"><a href="hazards.html#cb138-12" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_inter_vgm,</span>
<span id="cb138-13"><a href="hazards.html#cb138-13" aria-hidden="true" tabindex="-1"></a>                                <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">15</span>, <span class="fl">0.02</span>))</span>
<span id="cb138-14"><a href="hazards.html#cb138-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-15"><a href="hazards.html#cb138-15" aria-hidden="true" tabindex="-1"></a>benzene_inter_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01616521  0.00000
## 2   Exp 0.17301314 23.97153</code></pre>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="hazards.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate variogram using coordinates</span></span>
<span id="cb140-2"><a href="hazards.html#cb140-2" aria-hidden="true" tabindex="-1"></a>benzene_vgm <span class="ot">&lt;-</span> <span class="fu">variogram</span>(<span class="fu">log</span>(Benzene)<span class="sc">~</span> X <span class="sc">+</span> Y, <span class="at">data =</span> benzene_utm_geo,</span>
<span id="cb140-3"><a href="hazards.html#cb140-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">cutoff =</span> <span class="dv">20</span>, <span class="co"># cutoff distance</span></span>
<span id="cb140-4"><a href="hazards.html#cb140-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">width =</span> <span class="dv">20</span><span class="sc">/</span><span class="dv">10</span> <span class="co"># bins width</span></span>
<span id="cb140-5"><a href="hazards.html#cb140-5" aria-hidden="true" tabindex="-1"></a>                         )</span>
<span id="cb140-6"><a href="hazards.html#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="hazards.html#cb140-7" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(benzene_vgm,</span>
<span id="cb140-8"><a href="hazards.html#cb140-8" aria-hidden="true" tabindex="-1"></a>                                <span class="at">model =</span> <span class="fu">vgm</span>(<span class="fl">0.1</span>, <span class="st">&quot;Exp&quot;</span>, <span class="dv">3</span>, <span class="fl">0.02</span>))</span>
<span id="cb140-9"><a href="hazards.html#cb140-9" aria-hidden="true" tabindex="-1"></a>benzene_vgm_fit</span></code></pre></div>
<pre><code>##   model      psill    range
## 1   Nug 0.01638881 0.000000
## 2   Exp 0.05598753 7.365469</code></pre>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="hazards.html#cb142-1" aria-hidden="true" tabindex="-1"></a>plot_inter_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_inter_vgm, benzene_inter_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb142-2"><a href="hazards.html#cb142-2" aria-hidden="true" tabindex="-1"></a>plot_coord_variog <span class="ot">&lt;-</span> <span class="fu">plot</span>(benzene_vgm, benzene_vgm_fit, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span>
<span id="cb142-3"><a href="hazards.html#cb142-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-4"><a href="hazards.html#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(plot_inter_variog, plot_coord_variog, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.5%20plot%20variogram-1.png" width="672" /></p>
</div>
<div id="example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal<a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="hazards.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate grid</span></span>
<span id="cb143-2"><a href="hazards.html#cb143-2" aria-hidden="true" tabindex="-1"></a>MtlPred <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="fu">seq</span> (<span class="dv">580</span>, <span class="dv">615</span> , <span class="fl">0.5</span>),</span>
<span id="cb143-3"><a href="hazards.html#cb143-3" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">seq</span> (<span class="dv">5020</span>, <span class="dv">5060</span> , <span class="fl">0.5</span>) )</span>
<span id="cb143-4"><a href="hazards.html#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co"># change names grid</span></span>
<span id="cb143-5"><a href="hazards.html#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var1&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;X&quot;</span></span>
<span id="cb143-6"><a href="hazards.html#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(MtlPred)[ <span class="fu">names</span>(MtlPred)<span class="sc">==</span><span class="st">&quot;Var2&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;Y&quot;</span></span>
<span id="cb143-7"><a href="hazards.html#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="co"># make the grid a Spatial object</span></span>
<span id="cb143-8"><a href="hazards.html#cb143-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span> (MtlPred) <span class="ot">=</span> <span class="er">~</span> X <span class="sc">+</span> Y</span>
<span id="cb143-9"><a href="hazards.html#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="fu">gridded</span>(MtlPred) <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb143-10"><a href="hazards.html#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="co"># define the model based on the variogram fit from the previous example</span></span>
<span id="cb143-11"><a href="hazards.html#cb143-11" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">vgm</span> (<span class="fl">0.053</span> , <span class="st">&quot;Exp&quot;</span>, <span class="fl">5.54</span>, <span class="fl">0.0122</span>)</span>
<span id="cb143-12"><a href="hazards.html#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="co"># use ordinary kriging to predict values in the grid</span></span>
<span id="cb143-13"><a href="hazards.html#cb143-13" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">krige</span>(<span class="fu">log</span>(Benzene) <span class="sc">~</span> X <span class="sc">+</span> Y, benzene_utm_geo , MtlPred , <span class="at">model =</span> mod )</span></code></pre></div>
<pre><code>## [using universal kriging]</code></pre>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="hazards.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the ordinary kriging predictions and their variance</span></span>
<span id="cb145-2"><a href="hazards.html#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="hazards.html#cb145-3" aria-hidden="true" tabindex="-1"></a>monitor_loc <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="st">&#39;sp.points&#39;</span>, benzene_utm_geo, <span class="at">pch=</span><span class="dv">19</span>, <span class="at">cex=</span>.<span class="dv">8</span>, <span class="at">col=</span><span class="st">&#39;cornsilk4&#39;</span>)</span>
<span id="cb145-4"><a href="hazards.html#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="hazards.html#cb145-5" aria-hidden="true" tabindex="-1"></a>krig_pred <span class="ot">&lt;-</span></span>
<span id="cb145-6"><a href="hazards.html#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb145-7"><a href="hazards.html#cb145-7" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.pred&quot;</span>],</span>
<span id="cb145-8"><a href="hazards.html#cb145-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging predictions &quot;</span>,</span>
<span id="cb145-9"><a href="hazards.html#cb145-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb145-10"><a href="hazards.html#cb145-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb145-11"><a href="hazards.html#cb145-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb145-12"><a href="hazards.html#cb145-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb145-13"><a href="hazards.html#cb145-13" aria-hidden="true" tabindex="-1"></a>krig_var <span class="ot">&lt;-</span></span>
<span id="cb145-14"><a href="hazards.html#cb145-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb145-15"><a href="hazards.html#cb145-15" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;var1.var&quot;</span>],</span>
<span id="cb145-16"><a href="hazards.html#cb145-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Ordinary kriging variance &quot;</span>,</span>
<span id="cb145-17"><a href="hazards.html#cb145-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb145-18"><a href="hazards.html#cb145-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb145-19"><a href="hazards.html#cb145-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb145-20"><a href="hazards.html#cb145-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb145-21"><a href="hazards.html#cb145-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-22"><a href="hazards.html#cb145-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(krig_pred, krig_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.6%20kriging%20predictions-1.png" width="672" /></p>
</div>
<div id="example-10.9-spatial-modelling-of-benzene-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.9 Spatial modelling of Benzene in Montreal<a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-2" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="hazards.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb146-2"><a href="hazards.html#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb146-3"><a href="hazards.html#cb146-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb146-4"><a href="hazards.html#cb146-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb146-5"><a href="hazards.html#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb146-6"><a href="hazards.html#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb146-7"><a href="hazards.html#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code></pre></div>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="hazards.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data on benzene concentration in Montreal</span></span>
<span id="cb147-2"><a href="hazards.html#cb147-2" aria-hidden="true" tabindex="-1"></a>benzene <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb147-3"><a href="hazards.html#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb147-4"><a href="hazards.html#cb147-4" aria-hidden="true" tabindex="-1"></a>benzene_geo <span class="ot">&lt;-</span> benzene</span>
<span id="cb147-5"><a href="hazards.html#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb147-6"><a href="hazards.html#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb147-7"><a href="hazards.html#cb147-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-8"><a href="hazards.html#cb147-8" aria-hidden="true" tabindex="-1"></a>benzene_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_geo,</span>
<span id="cb147-9"><a href="hazards.html#cb147-9" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb147-10"><a href="hazards.html#cb147-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb147-11"><a href="hazards.html#cb147-11" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_utm)</span>
<span id="cb147-12"><a href="hazards.html#cb147-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers and observations to the log scale</span></span>
<span id="cb147-13"><a href="hazards.html#cb147-13" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb147-14"><a href="hazards.html#cb147-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb147-15"><a href="hazards.html#cb147-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb147-16"><a href="hazards.html#cb147-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb147-17"><a href="hazards.html#cb147-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb147-18"><a href="hazards.html#cb147-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb147-19"><a href="hazards.html#cb147-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb147-20"><a href="hazards.html#cb147-20" aria-hidden="true" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb147-21"><a href="hazards.html#cb147-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-22"><a href="hazards.html#cb147-22" aria-hidden="true" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<div class="sourceCode" id="cb148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb148-1"><a href="hazards.html#cb148-1" aria-hidden="true" tabindex="-1"></a>Example10_9Code <span class="ot">&lt;-</span>  <span class="fu">nimbleCode</span> ({</span>
<span id="cb148-2"><a href="hazards.html#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Covariance matrix spatial effect</span></span>
<span id="cb148-3"><a href="hazards.html#cb148-3" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="ot">&lt;-</span></span>
<span id="cb148-4"><a href="hazards.html#cb148-4" aria-hidden="true" tabindex="-1"></a>    sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>distMatrix[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> n)</span>
<span id="cb148-5"><a href="hazards.html#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="hazards.html#cb148-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (site <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {</span>
<span id="cb148-7"><a href="hazards.html#cb148-7" aria-hidden="true" tabindex="-1"></a>    mean.site[site] <span class="ot">&lt;-</span></span>
<span id="cb148-8"><a href="hazards.html#cb148-8" aria-hidden="true" tabindex="-1"></a>      beta0 <span class="sc">+</span> beta1 <span class="sc">*</span> easting[site] <span class="sc">+</span> beta2 <span class="sc">*</span> northing[site]</span>
<span id="cb148-9"><a href="hazards.html#cb148-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb148-10"><a href="hazards.html#cb148-10" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span><span class="sc">:</span>n]  <span class="sc">~</span>  <span class="fu">dmnorm</span>(mean.site[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>n, <span class="dv">1</span><span class="sc">:</span>n])</span>
<span id="cb148-11"><a href="hazards.html#cb148-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up the priors for the spatial model</span></span>
<span id="cb148-12"><a href="hazards.html#cb148-12" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb148-13"><a href="hazards.html#cb148-13" aria-hidden="true" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb148-14"><a href="hazards.html#cb148-14" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb148-15"><a href="hazards.html#cb148-15" aria-hidden="true" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb148-16"><a href="hazards.html#cb148-16" aria-hidden="true" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb148-17"><a href="hazards.html#cb148-17" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb148-18"><a href="hazards.html#cb148-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># prior for the coefficients</span></span>
<span id="cb148-19"><a href="hazards.html#cb148-19" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb148-20"><a href="hazards.html#cb148-20" aria-hidden="true" tabindex="-1"></a>  beta1 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb148-21"><a href="hazards.html#cb148-21" aria-hidden="true" tabindex="-1"></a>  beta2 <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb148-22"><a href="hazards.html#cb148-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb148-23"><a href="hazards.html#cb148-23" aria-hidden="true" tabindex="-1"></a>}) </span></code></pre></div>
<p>Define the constants, data and initials lists for the <code>nimble</code> model.</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="hazards.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the constants, data, parameters and initial values</span></span>
<span id="cb149-2"><a href="hazards.html#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb149-3"><a href="hazards.html#cb149-3" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb149-4"><a href="hazards.html#cb149-4" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb149-5"><a href="hazards.html#cb149-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-6"><a href="hazards.html#cb149-6" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span></span>
<span id="cb149-7"><a href="hazards.html#cb149-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">nrow</span>(Mtl_benzene_sample))</span>
<span id="cb149-8"><a href="hazards.html#cb149-8" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span></span>
<span id="cb149-9"><a href="hazards.html#cb149-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb149-10"><a href="hazards.html#cb149-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">easting =</span> easting_scaled,</span>
<span id="cb149-11"><a href="hazards.html#cb149-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">northing =</span> northing_scaled,</span>
<span id="cb149-12"><a href="hazards.html#cb149-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">distMatrix =</span> obsDist)</span>
<span id="cb149-13"><a href="hazards.html#cb149-13" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>( <span class="st">&quot;beta0&quot;</span>,  <span class="st">&quot;beta1&quot;</span>,<span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;phi&quot;</span>,  <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>)</span>
<span id="cb149-14"><a href="hazards.html#cb149-14" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">sigma =</span> <span class="fl">0.1</span>, <span class="at">phi_inv =</span> <span class="dv">6</span><span class="sc">/</span><span class="fu">max</span>(obsDist), <span class="at">tau =</span> <span class="fl">0.1</span>)</span>
<span id="cb149-15"><a href="hazards.html#cb149-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb149-16"><a href="hazards.html#cb149-16" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb149-17"><a href="hazards.html#cb149-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-18"><a href="hazards.html#cb149-18" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb149-19"><a href="hazards.html#cb149-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example10_9Code,</span>
<span id="cb149-20"><a href="hazards.html#cb149-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb149-21"><a href="hazards.html#cb149-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb149-22"><a href="hazards.html#cb149-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb149-23"><a href="hazards.html#cb149-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb149-24"><a href="hazards.html#cb149-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb149-25"><a href="hazards.html#cb149-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb149-26"><a href="hazards.html#cb149-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb149-27"><a href="hazards.html#cb149-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-28"><a href="hazards.html#cb149-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb149-29"><a href="hazards.html#cb149-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb149-30"><a href="hazards.html#cb149-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb149-31"><a href="hazards.html#cb149-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb149-32"><a href="hazards.html#cb149-32" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb149-33"><a href="hazards.html#cb149-33" aria-hidden="true" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb149-34"><a href="hazards.html#cb149-34" aria-hidden="true" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb150-1"><a href="hazards.html#cb150-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] -32.37684
## Field &quot;lppd&quot;:
## [1] 19.03084
## Field &quot;pWAIC&quot;:
## [1] 2.842421</code></pre>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="hazards.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 985.2176</code></pre>
<div class="sourceCode" id="cb154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb154-1"><a href="hazards.html#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="hazards.html#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta1&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta1&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="hazards.html#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta2&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;beta2&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="hazards.html#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /></p>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="hazards.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<div class="sourceCode" id="cb159"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb159-1"><a href="hazards.html#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mcmc.out<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20WAIC,%20ESS%20and%20traceplots-6.png" width="672" /></p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="hazards.html#cb160-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains[<span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta1&quot;</span>, <span class="st">&quot;beta2&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>), ]</span></code></pre></div>
<pre><code>##                 Mean     Median     St.Dev.     95%CI_low  95%CI_upp
## beta0    0.143589662 0.15187505 0.081381727 -4.284934e-02 0.27866526
## beta1    0.051028164 0.04806334 0.060619017 -6.338295e-02 0.17328888
## beta2    0.077775628 0.08250220 0.068519017 -7.013084e-02 0.20323633
## sigma_sq 0.056087887 0.05202343 0.022624353  2.770244e-02 0.11140808
## tau_sq   0.009128758 0.00841011 0.006709036  5.744089e-05 0.02380432
## phi      3.697646345 3.09115863 2.228726265  1.463844e+00 9.40053808</code></pre>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="hazards.html#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb162-2"><a href="hazards.html#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb162-3"><a href="hazards.html#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb162-4"><a href="hazards.html#cb162-4" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb162-5"><a href="hazards.html#cb162-5" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<p>Following the posterior predictive distribution we have to define a model for the predictions.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb163-1"><a href="hazards.html#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb163-2"><a href="hazards.html#cb163-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples <span class="sc">%&gt;%</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb163-3"><a href="hazards.html#cb163-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-4"><a href="hazards.html#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb163-5"><a href="hazards.html#cb163-5" aria-hidden="true" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta0</span>
<span id="cb163-6"><a href="hazards.html#cb163-6" aria-hidden="true" tabindex="-1"></a>post_beta1 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta1</span>
<span id="cb163-7"><a href="hazards.html#cb163-7" aria-hidden="true" tabindex="-1"></a>post_beta2 <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>beta2</span>
<span id="cb163-8"><a href="hazards.html#cb163-8" aria-hidden="true" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb163-9"><a href="hazards.html#cb163-9" aria-hidden="true" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>phi</span>
<span id="cb163-10"><a href="hazards.html#cb163-10" aria-hidden="true" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb163-11"><a href="hazards.html#cb163-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-12"><a href="hazards.html#cb163-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb163-13"><a href="hazards.html#cb163-13" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb163-14"><a href="hazards.html#cb163-14" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb163-15"><a href="hazards.html#cb163-15" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb163-16"><a href="hazards.html#cb163-16" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb163-17"><a href="hazards.html#cb163-17" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb163-18"><a href="hazards.html#cb163-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb163-19"><a href="hazards.html#cb163-19" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb163-20"><a href="hazards.html#cb163-20" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb163-21"><a href="hazards.html#cb163-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-22"><a href="hazards.html#cb163-22" aria-hidden="true" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb163-23"><a href="hazards.html#cb163-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-24"><a href="hazards.html#cb163-24" aria-hidden="true" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta1, post_beta2))</span>
<span id="cb163-25"><a href="hazards.html#cb163-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-26"><a href="hazards.html#cb163-26" aria-hidden="true" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span></code></pre></div>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="hazards.html#cb164-1" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb164-2"><a href="hazards.html#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="hazards.html#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb166-2"><a href="hazards.html#cb166-2" aria-hidden="true" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb166-3"><a href="hazards.html#cb166-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb166-4"><a href="hazards.html#cb166-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb166-5"><a href="hazards.html#cb166-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb166-6"><a href="hazards.html#cb166-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb166-7"><a href="hazards.html#cb166-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb166-8"><a href="hazards.html#cb166-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb166-9"><a href="hazards.html#cb166-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb166-10"><a href="hazards.html#cb166-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb166-11"><a href="hazards.html#cb166-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb166-12"><a href="hazards.html#cb166-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb166-13"><a href="hazards.html#cb166-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed
## Prediction upto the 2000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##  144.33    0.03  169.41</code></pre>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="hazards.html#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(pred_samples)</span></code></pre></div>
<pre><code>##  num [1:5751, 1:2856] -0.116 -0.805 -0.7 -0.327 -0.402 ...</code></pre>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="hazards.html#cb171-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb171-2"><a href="hazards.html#cb171-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb171-3"><a href="hazards.html#cb171-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb171-4"><a href="hazards.html#cb171-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb171-5"><a href="hazards.html#cb171-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb171-6"><a href="hazards.html#cb171-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb171-7"><a href="hazards.html#cb171-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb171-8"><a href="hazards.html#cb171-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb171-9"><a href="hazards.html#cb171-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb171-10"><a href="hazards.html#cb171-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb171-11"><a href="hazards.html#cb171-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb171-12"><a href="hazards.html#cb171-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="hazards.html#cb172-1" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>nimble.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb172-2"><a href="hazards.html#cb172-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>nimble.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb172-3"><a href="hazards.html#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="hazards.html#cb172-4" aria-hidden="true" tabindex="-1"></a>nimble_pred <span class="ot">&lt;-</span></span>
<span id="cb172-5"><a href="hazards.html#cb172-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb172-6"><a href="hazards.html#cb172-6" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;nimble.pred&quot;</span>],</span>
<span id="cb172-7"><a href="hazards.html#cb172-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble spatial predictions &quot;</span>,</span>
<span id="cb172-8"><a href="hazards.html#cb172-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb172-9"><a href="hazards.html#cb172-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb172-10"><a href="hazards.html#cb172-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb172-11"><a href="hazards.html#cb172-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-12"><a href="hazards.html#cb172-12" aria-hidden="true" tabindex="-1"></a>nimble_var <span class="ot">&lt;-</span></span>
<span id="cb172-13"><a href="hazards.html#cb172-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb172-14"><a href="hazards.html#cb172-14" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;nimble.var&quot;</span>],</span>
<span id="cb172-15"><a href="hazards.html#cb172-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Nimble predictions variance &quot;</span>,</span>
<span id="cb172-16"><a href="hazards.html#cb172-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb172-17"><a href="hazards.html#cb172-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb172-18"><a href="hazards.html#cb172-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb172-19"><a href="hazards.html#cb172-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-20"><a href="hazards.html#cb172-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb172-21"><a href="hazards.html#cb172-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-22"><a href="hazards.html#cb172-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(nimble_pred, nimble_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20nimble%20plot%20predictions-1.png" width="672" /></p>
</div>
<div id="stan-2" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb173"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb173-1"><a href="hazards.html#cb173-1" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb173-2"><a href="hazards.html#cb173-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb173-3"><a href="hazards.html#cb173-3" aria-hidden="true" tabindex="-1"></a>benzene_data_geo <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb173-4"><a href="hazards.html#cb173-4" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb173-5"><a href="hazards.html#cb173-5" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_geo) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb173-6"><a href="hazards.html#cb173-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-7"><a href="hazards.html#cb173-7" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_geo,</span>
<span id="cb173-8"><a href="hazards.html#cb173-8" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb173-9"><a href="hazards.html#cb173-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb173-10"><a href="hazards.html#cb173-10" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm)</span>
<span id="cb173-11"><a href="hazards.html#cb173-11" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb173-12"><a href="hazards.html#cb173-12" aria-hidden="true" tabindex="-1"></a>Mtl_benzene_sample <span class="ot">&lt;-</span></span>
<span id="cb173-13"><a href="hazards.html#cb173-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb173-14"><a href="hazards.html#cb173-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb173-15"><a href="hazards.html#cb173-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">easting =</span>  benzene_utm_df<span class="sc">$</span>lon <span class="sc">/</span> <span class="dv">1000</span>,</span>
<span id="cb173-16"><a href="hazards.html#cb173-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">northing =</span> benzene_utm_df<span class="sc">$</span>lat <span class="sc">/</span> <span class="dv">1000</span></span>
<span id="cb173-17"><a href="hazards.html#cb173-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb173-18"><a href="hazards.html#cb173-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the distance matrix</span></span>
<span id="cb173-19"><a href="hazards.html#cb173-19" aria-hidden="true" tabindex="-1"></a>obsCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_benzene_sample[,<span class="fu">c</span>(<span class="st">&quot;easting&quot;</span>, <span class="st">&quot;northing&quot;</span>)]))</span>
<span id="cb173-20"><a href="hazards.html#cb173-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-21"><a href="hazards.html#cb173-21" aria-hidden="true" tabindex="-1"></a>obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(obsCoords)</span></code></pre></div>
<pre><code>
data {
  int&lt;lower=1&gt; N;
  int&lt;lower=0&gt; p;
  vector[N] y;
  matrix[N,N] dist_matrix;
  matrix[N,p] X; 
}

parameters {
  real&lt;lower=0&gt; phi;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[p] beta;
  real beta0;

}
transformed parameters{
  real&lt;lower=0&gt; sigma_sq = square(sigma);
  real&lt;lower=0&gt; tau_sq = square(tau);
}
model {
  vector[N] mu;
  matrix[N, N] L;
  matrix[N, N] Sigma;

 for(i in 1:(N-1)){
   for(j in (i+1):N){
     Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements

  for(i in 1:N) {
    Sigma[i,i] = sigma_sq + tau_sq;
    mu[i] = beta0 + X[i,]*beta;
  }
  
  L = cholesky_decompose(Sigma);
  
  beta0 ~ normal(0,10);
  beta ~ normal(0,10);
  phi ~ inv_gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);

  y ~ multi_normal_cholesky(mu, L);
}</code></pre>
<div class="sourceCode" id="cb175"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb175-1"><a href="hazards.html#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb175-2"><a href="hazards.html#cb175-2" aria-hidden="true" tabindex="-1"></a>easting_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>easting))</span>
<span id="cb175-3"><a href="hazards.html#cb175-3" aria-hidden="true" tabindex="-1"></a>northing_scaled <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(Mtl_benzene_sample<span class="sc">$</span>northing))</span>
<span id="cb175-4"><a href="hazards.html#cb175-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-5"><a href="hazards.html#cb175-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(benzene_utm_df)</span>
<span id="cb175-6"><a href="hazards.html#cb175-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Change coordinates to kilometers</span></span>
<span id="cb175-7"><a href="hazards.html#cb175-7" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">easting =</span> easting_scaled,</span>
<span id="cb175-8"><a href="hazards.html#cb175-8" aria-hidden="true" tabindex="-1"></a>                <span class="at">northing =</span> northing_scaled) </span>
<span id="cb175-9"><a href="hazards.html#cb175-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-10"><a href="hazards.html#cb175-10" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb175-11"><a href="hazards.html#cb175-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb175-12"><a href="hazards.html#cb175-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>,</span>
<span id="cb175-13"><a href="hazards.html#cb175-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span>   <span class="fu">log</span>(benzene_utm_df<span class="sc">$</span>Benzene),</span>
<span id="cb175-14"><a href="hazards.html#cb175-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">dist_matrix =</span> obsDist,</span>
<span id="cb175-15"><a href="hazards.html#cb175-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> <span class="fu">as.matrix</span>(X)</span>
<span id="cb175-16"><a href="hazards.html#cb175-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb175-17"><a href="hazards.html#cb175-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-18"><a href="hazards.html#cb175-18" aria-hidden="true" tabindex="-1"></a>Example10_9Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb175-19"><a href="hazards.html#cb175-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_9.stan&quot;</span>,</span>
<span id="cb175-20"><a href="hazards.html#cb175-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb175-21"><a href="hazards.html#cb175-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb175-22"><a href="hazards.html#cb175-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb175-23"><a href="hazards.html#cb175-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb175-24"><a href="hazards.html#cb175-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb175-25"><a href="hazards.html#cb175-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;beta&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb175-26"><a href="hazards.html#cb175-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb175-27"><a href="hazards.html#cb175-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="hazards.html#cb176-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_9Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>,<span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20stan%20exp%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="hazards.html#cb177-1" aria-hidden="true" tabindex="-1"></a>summary_exp_stan <span class="ot">&lt;-</span></span>
<span id="cb177-2"><a href="hazards.html#cb177-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb177-3"><a href="hazards.html#cb177-3" aria-hidden="true" tabindex="-1"></a>    Example10_9Stan,</span>
<span id="cb177-4"><a href="hazards.html#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>),</span>
<span id="cb177-5"><a href="hazards.html#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb177-6"><a href="hazards.html#cb177-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb177-7"><a href="hazards.html#cb177-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-8"><a href="hazards.html#cb177-8" aria-hidden="true" tabindex="-1"></a>summary_exp_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                 mean      se_mean          sd          2.5%      97.5%    n_eff
## beta0    0.153151957 0.0017454630 0.082542739 -0.0280454381 0.30104542 2236.333
## beta[1]  0.048260898 0.0014210620 0.060763462 -0.0628368700 0.17050377 1828.349
## beta[2]  0.079958055 0.0015912122 0.068248714 -0.0763104700 0.19962566 1839.640
## phi      3.577291239 0.0500854445 2.111837928  1.5099031977 9.06193864 1777.862
## sigma_sq 0.055305541 0.0004872241 0.021205779  0.0277406700 0.10511771 1894.310
## tau_sq   0.009140308 0.0001587922 0.006624496  0.0001113095 0.02330228 1740.394
##               Rhat
## beta0    1.0000400
## beta[1]  1.0010770
## beta[2]  0.9997490
## phi      0.9997624
## sigma_sq 1.0022418
## tau_sq   0.9998860</code></pre>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="hazards.html#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain coordinates for predictions </span></span>
<span id="cb179-2"><a href="hazards.html#cb179-2" aria-hidden="true" tabindex="-1"></a><span class="co"># note that we are using the same coordinates as the one generated for </span></span>
<span id="cb179-3"><a href="hazards.html#cb179-3" aria-hidden="true" tabindex="-1"></a><span class="co"># the kriging example</span></span>
<span id="cb179-4"><a href="hazards.html#cb179-4" aria-hidden="true" tabindex="-1"></a>Mtl_centroids_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(MtlPred)</span>
<span id="cb179-5"><a href="hazards.html#cb179-5" aria-hidden="true" tabindex="-1"></a>predCoords <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">as.matrix</span>(Mtl_centroids_df))</span></code></pre></div>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="hazards.html#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples from nimble model</span></span>
<span id="cb180-2"><a href="hazards.html#cb180-2" aria-hidden="true" tabindex="-1"></a>stan_post_samples <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">extract</span>(Example10_9Stan,</span>
<span id="cb180-3"><a href="hazards.html#cb180-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;beta&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;sigma_sq&quot;</span>, <span class="st">&quot;tau_sq&quot;</span>))</span>
<span id="cb180-4"><a href="hazards.html#cb180-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-5"><a href="hazards.html#cb180-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract posterior samples for each of the parameters of interest</span></span>
<span id="cb180-6"><a href="hazards.html#cb180-6" aria-hidden="true" tabindex="-1"></a>post_beta0 <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta0</span>
<span id="cb180-7"><a href="hazards.html#cb180-7" aria-hidden="true" tabindex="-1"></a>post_beta <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>beta</span>
<span id="cb180-8"><a href="hazards.html#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="co"># post_beta2 &lt;- stan_post_samples$beta2</span></span>
<span id="cb180-9"><a href="hazards.html#cb180-9" aria-hidden="true" tabindex="-1"></a>post_sigmasq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>sigma_sq</span>
<span id="cb180-10"><a href="hazards.html#cb180-10" aria-hidden="true" tabindex="-1"></a>post_phi <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>phi</span>
<span id="cb180-11"><a href="hazards.html#cb180-11" aria-hidden="true" tabindex="-1"></a>post_tausq <span class="ot">&lt;-</span> stan_post_samples<span class="sc">$</span>tau_sq</span>
<span id="cb180-12"><a href="hazards.html#cb180-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-13"><a href="hazards.html#cb180-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Scale coordinates for predictive locations</span></span>
<span id="cb180-14"><a href="hazards.html#cb180-14" aria-hidden="true" tabindex="-1"></a>predCoords_sc <span class="ot">&lt;-</span> predCoords </span>
<span id="cb180-15"><a href="hazards.html#cb180-15" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb180-16"><a href="hazards.html#cb180-16" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>easting)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>easting)</span>
<span id="cb180-17"><a href="hazards.html#cb180-17" aria-hidden="true" tabindex="-1"></a>predCoords_sc[,<span class="dv">2</span>] <span class="ot">&lt;-</span> </span>
<span id="cb180-18"><a href="hazards.html#cb180-18" aria-hidden="true" tabindex="-1"></a>  (predCoords_sc[,<span class="dv">2</span>] <span class="sc">-</span> <span class="fu">mean</span>(Mtl_benzene_sample<span class="sc">$</span>northing)) <span class="sc">/</span> <span class="fu">sd</span>(Mtl_benzene_sample<span class="sc">$</span>northing)</span>
<span id="cb180-19"><a href="hazards.html#cb180-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb180-20"><a href="hazards.html#cb180-20" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(predCoords_sc)</span>
<span id="cb180-21"><a href="hazards.html#cb180-21" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fu">length</span>(post_tausq)</span>
<span id="cb180-22"><a href="hazards.html#cb180-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-23"><a href="hazards.html#cb180-23" aria-hidden="true" tabindex="-1"></a>obsMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, easting_scaled, northing_scaled) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb180-24"><a href="hazards.html#cb180-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-25"><a href="hazards.html#cb180-25" aria-hidden="true" tabindex="-1"></a>predMu <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, <span class="fu">as.matrix</span>(predCoords_sc)) <span class="sc">%*%</span> <span class="fu">t</span>(<span class="fu">cbind</span>(post_beta0, post_beta))</span>
<span id="cb180-26"><a href="hazards.html#cb180-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-27"><a href="hazards.html#cb180-27" aria-hidden="true" tabindex="-1"></a>pred2obsDist <span class="ot">&lt;-</span> fields<span class="sc">::</span><span class="fu">rdist</span>(predCoords, obsCoords)</span></code></pre></div>
<div class="sourceCode" id="cb181"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb181-1"><a href="hazards.html#cb181-1" aria-hidden="true" tabindex="-1"></a>Rcpp<span class="sc">::</span><span class="fu">sourceCpp</span>(<span class="st">&quot;functions/prediction_marginal_gp12.cpp&quot;</span>)</span>
<span id="cb181-2"><a href="hazards.html#cb181-2" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(prediction_marginal_gp12)</span></code></pre></div>
<pre><code>## function (y, obsMu, predMu, obsDistMat, pred2ObsDistMat, sigmasq, 
##     phi, tausq, iterprint) 
## NULL</code></pre>
<div class="sourceCode" id="cb183"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb183-1"><a href="hazards.html#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb183-2"><a href="hazards.html#cb183-2" aria-hidden="true" tabindex="-1"></a>  pred_samples <span class="ot">&lt;-</span> <span class="fu">prediction_marginal_gp12</span>(</span>
<span id="cb183-3"><a href="hazards.html#cb183-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> Mtl_benzene_sample<span class="sc">$</span>y,</span>
<span id="cb183-4"><a href="hazards.html#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsMu =</span> obsMu,</span>
<span id="cb183-5"><a href="hazards.html#cb183-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">predMu =</span> predMu,</span>
<span id="cb183-6"><a href="hazards.html#cb183-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">obsDistMat =</span> obsDist,</span>
<span id="cb183-7"><a href="hazards.html#cb183-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred2ObsDistMat =</span> pred2obsDist,</span>
<span id="cb183-8"><a href="hazards.html#cb183-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigmasq =</span> post_sigmasq,</span>
<span id="cb183-9"><a href="hazards.html#cb183-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">phi =</span> post_phi,</span>
<span id="cb183-10"><a href="hazards.html#cb183-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">tausq =</span> post_tausq,</span>
<span id="cb183-11"><a href="hazards.html#cb183-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterprint =</span> <span class="dv">1000</span></span>
<span id="cb183-12"><a href="hazards.html#cb183-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb183-13"><a href="hazards.html#cb183-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Prediction upto the 0th MCMC sample is completed
## Prediction upto the 1000th MCMC sample is completed</code></pre>
<pre><code>##    user  system elapsed 
##   95.44    0.10  118.83</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb186-1"><a href="hazards.html#cb186-1" aria-hidden="true" tabindex="-1"></a>predict_res_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb186-2"><a href="hazards.html#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">xcoord =</span> predCoords[, <span class="dv">1</span>],</span>
<span id="cb186-3"><a href="hazards.html#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ycoord =</span> predCoords[, <span class="dv">2</span>],</span>
<span id="cb186-4"><a href="hazards.html#cb186-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.mean =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, mean),</span>
<span id="cb186-5"><a href="hazards.html#cb186-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">post.var =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, var),</span>
<span id="cb186-6"><a href="hazards.html#cb186-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">q2.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb186-7"><a href="hazards.html#cb186-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.025</span>)),</span>
<span id="cb186-8"><a href="hazards.html#cb186-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">q50 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb186-9"><a href="hazards.html#cb186-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.5</span>)),</span>
<span id="cb186-10"><a href="hazards.html#cb186-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">q97.5 =</span> <span class="fu">apply</span>(pred_samples, <span class="dv">1</span>, <span class="cf">function</span>(x)</span>
<span id="cb186-11"><a href="hazards.html#cb186-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">quantile</span>(x, <span class="at">prob =</span> <span class="fl">0.975</span>))</span>
<span id="cb186-12"><a href="hazards.html#cb186-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="hazards.html#cb187-1" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>stan.pred <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.mean</span>
<span id="cb187-2"><a href="hazards.html#cb187-2" aria-hidden="true" tabindex="-1"></a>x<span class="sc">$</span>stan.var <span class="ot">&lt;-</span> predict_res_dt<span class="sc">$</span>post.var</span>
<span id="cb187-3"><a href="hazards.html#cb187-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-4"><a href="hazards.html#cb187-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-5"><a href="hazards.html#cb187-5" aria-hidden="true" tabindex="-1"></a>stan_pred <span class="ot">&lt;-</span></span>
<span id="cb187-6"><a href="hazards.html#cb187-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb187-7"><a href="hazards.html#cb187-7" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;stan.pred&quot;</span>],</span>
<span id="cb187-8"><a href="hazards.html#cb187-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan spatial predictions &quot;</span>,</span>
<span id="cb187-9"><a href="hazards.html#cb187-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb187-10"><a href="hazards.html#cb187-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb187-11"><a href="hazards.html#cb187-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.02</span>)</span>
<span id="cb187-12"><a href="hazards.html#cb187-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb187-13"><a href="hazards.html#cb187-13" aria-hidden="true" tabindex="-1"></a>stan_var <span class="ot">&lt;-</span></span>
<span id="cb187-14"><a href="hazards.html#cb187-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">spplot</span> (</span>
<span id="cb187-15"><a href="hazards.html#cb187-15" aria-hidden="true" tabindex="-1"></a>    x[<span class="st">&quot;stan.var&quot;</span>],</span>
<span id="cb187-16"><a href="hazards.html#cb187-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">&quot;Stan predictions variance &quot;</span>,</span>
<span id="cb187-17"><a href="hazards.html#cb187-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.regions =</span> viridis<span class="sc">::</span><span class="fu">plasma</span>(<span class="dv">60</span>),</span>
<span id="cb187-18"><a href="hazards.html#cb187-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sp.layout =</span> <span class="fu">list</span>(monitor_loc),</span>
<span id="cb187-19"><a href="hazards.html#cb187-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">at =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span>)</span>
<span id="cb187-20"><a href="hazards.html#cb187-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb187-21"><a href="hazards.html#cb187-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-22"><a href="hazards.html#cb187-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_grid</span>(stan_pred, stan_var, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.9%20stan%20plot%20predictions-1.png" width="672" />
## Example 10.11: INLA, creating a mesh {-}</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="hazards.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR)</span>
<span id="cb188-2"><a href="hazards.html#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb188-3"><a href="hazards.html#cb188-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb188-4"><a href="hazards.html#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="hazards.html#cb188-5" aria-hidden="true" tabindex="-1"></a>benzene_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/montreal_benzene_apr.csv&quot;</span>)</span>
<span id="cb188-6"><a href="hazards.html#cb188-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb188-7"><a href="hazards.html#cb188-7" aria-hidden="true" tabindex="-1"></a>benzene_data_loc <span class="ot">&lt;-</span> benzene_data</span>
<span id="cb188-8"><a href="hazards.html#cb188-8" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb188-9"><a href="hazards.html#cb188-9" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(benzene_data_loc) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb188-10"><a href="hazards.html#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="hazards.html#cb188-11" aria-hidden="true" tabindex="-1"></a>benzene_data_utm <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(benzene_data_loc,</span>
<span id="cb188-12"><a href="hazards.html#cb188-12" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=18 +ellps=WGS72&quot;</span>))</span>
<span id="cb188-13"><a href="hazards.html#cb188-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the utm as a data frame</span></span>
<span id="cb188-14"><a href="hazards.html#cb188-14" aria-hidden="true" tabindex="-1"></a>locations_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(benzene_data_utm<span class="sc">@</span>coords)</span>
<span id="cb188-15"><a href="hazards.html#cb188-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-16"><a href="hazards.html#cb188-16" aria-hidden="true" tabindex="-1"></a>benzene_utm_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>( <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(benzene_data),</span>
<span id="cb188-17"><a href="hazards.html#cb188-17" aria-hidden="true" tabindex="-1"></a>                              <span class="at">X =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">1</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb188-18"><a href="hazards.html#cb188-18" aria-hidden="true" tabindex="-1"></a>                              <span class="at">Y =</span> benzene_data_utm<span class="sc">@</span>coords[,<span class="dv">2</span>]<span class="sc">/</span><span class="dv">1000</span>,</span>
<span id="cb188-19"><a href="hazards.html#cb188-19" aria-hidden="true" tabindex="-1"></a>                              <span class="at">logbenzene =</span> <span class="fu">log</span>(benzene_data_utm<span class="sc">$</span>Benzene))</span>
<span id="cb188-20"><a href="hazards.html#cb188-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb188-21"><a href="hazards.html#cb188-21" aria-hidden="true" tabindex="-1"></a><span class="co"># change the observed values to the log scale and the coordinates to km&#39;s</span></span>
<span id="cb188-22"><a href="hazards.html#cb188-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-23"><a href="hazards.html#cb188-23" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">=</span> <span class="fu">inla.mesh.create</span>(locations_df, <span class="at">cutoff =</span> <span class="fl">0.01</span>, </span>
<span id="cb188-24"><a href="hazards.html#cb188-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">refine =</span>(<span class="fu">list</span>(<span class="at">min.angle =</span><span class="dv">20</span>)))</span>
<span id="cb188-25"><a href="hazards.html#cb188-25" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh , <span class="at">col=</span><span class="st">&quot;gray&quot;</span>, <span class="at">main=</span><span class="st">&quot;&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.11%20load%20data%20for%20INLA-1.png" width="672" /></p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="hazards.html#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ukmap &lt;- readShapeLines(&quot;uk_BNG.shp&quot;) plot(mesh , col=&quot;gray&quot;, main=&quot;&quot;) </span></span>
<span id="cb189-2"><a href="hazards.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="co"># lines(ukmap)</span></span>
<span id="cb189-3"><a href="hazards.html#cb189-3" aria-hidden="true" tabindex="-1"></a><span class="co"># points(locations , col=&quot;red&quot;, pch=20,bg=&quot;red&quot;) </span></span></code></pre></div>
</div>
</div>
<div id="example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="section level2 unnumbered hasAnchor">
<h2>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal<a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="hazards.html#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Field std . dev . for theta =0</span></span>
<span id="cb190-2"><a href="hazards.html#cb190-2" aria-hidden="true" tabindex="-1"></a>sigma0 <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb190-3"><a href="hazards.html#cb190-3" aria-hidden="true" tabindex="-1"></a><span class="co"># find the range of the location data</span></span>
<span id="cb190-4"><a href="hazards.html#cb190-4" aria-hidden="true" tabindex="-1"></a>size <span class="ot">=</span> <span class="fu">min</span>(<span class="fu">c</span>(<span class="fu">diff</span>(<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">1</span>])),</span>
<span id="cb190-5"><a href="hazards.html#cb190-5" aria-hidden="true" tabindex="-1"></a>             <span class="fu">diff</span> (<span class="fu">range</span>(mesh<span class="sc">$</span>loc[, <span class="dv">2</span>]))))</span>
<span id="cb190-6"><a href="hazards.html#cb190-6" aria-hidden="true" tabindex="-1"></a><span class="co"># A fifth of the approximate domain width .</span></span>
<span id="cb190-7"><a href="hazards.html#cb190-7" aria-hidden="true" tabindex="-1"></a>range0 <span class="ot">=</span> size<span class="sc">/</span><span class="dv">5</span></span>
<span id="cb190-8"><a href="hazards.html#cb190-8" aria-hidden="true" tabindex="-1"></a>kappa0 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">8</span>)<span class="sc">/</span>range0</span>
<span id="cb190-9"><a href="hazards.html#cb190-9" aria-hidden="true" tabindex="-1"></a>tau0 <span class="ot">=</span> <span class="dv">1</span><span class="sc">/</span>(<span class="fu">sqrt</span> (<span class="dv">4</span><span class="sc">*</span>pi)<span class="sc">*</span>kappa0<span class="sc">*</span>sigma0)</span>
<span id="cb190-10"><a href="hazards.html#cb190-10" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">=</span> <span class="fu">inla.spde2.matern</span> (</span>
<span id="cb190-11"><a href="hazards.html#cb190-11" aria-hidden="true" tabindex="-1"></a>  mesh,</span>
<span id="cb190-12"><a href="hazards.html#cb190-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.tau =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (tau0), <span class="sc">-</span><span class="dv">1</span>, <span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb190-13"><a href="hazards.html#cb190-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">B.kappa =</span> <span class="fu">cbind</span>(<span class="fu">log</span> (kappa0), <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb190-14"><a href="hazards.html#cb190-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">theta.prior.mean =</span> <span class="fu">c</span>(<span class="dv">0</span> , <span class="dv">0</span>),</span>
<span id="cb190-15"><a href="hazards.html#cb190-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">constr =</span> <span class="cn">TRUE</span></span>
<span id="cb190-16"><a href="hazards.html#cb190-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb190-17"><a href="hazards.html#cb190-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-18"><a href="hazards.html#cb190-18" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">=</span> logbenzene  <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> X <span class="sc">+</span> Y <span class="sc">+</span> <span class="fu">f</span>(ID , <span class="at">model =</span> spde)</span>
<span id="cb190-19"><a href="hazards.html#cb190-19" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">inla</span>(</span>
<span id="cb190-20"><a href="hazards.html#cb190-20" aria-hidden="true" tabindex="-1"></a>  formula,</span>
<span id="cb190-21"><a href="hazards.html#cb190-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;gaussian&quot;</span>,</span>
<span id="cb190-22"><a href="hazards.html#cb190-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> benzene_utm_df ,</span>
<span id="cb190-23"><a href="hazards.html#cb190-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>),</span>
<span id="cb190-24"><a href="hazards.html#cb190-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">dic =</span> <span class="cn">TRUE</span> , <span class="at">config =</span> <span class="cn">TRUE</span>)</span>
<span id="cb190-25"><a href="hazards.html#cb190-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb190-26"><a href="hazards.html#cb190-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-27"><a href="hazards.html#cb190-27" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>summary.fixed</span></code></pre></div>
<pre><code>##                     mean           sd    0.025quant      0.5quant   0.975quant
## (Intercept)  8.263107109 118.01744834 -189.26686123 -5.4724133487 298.73720629
## X            0.014532810   0.02130267   -0.02563718  0.0132910509   0.06340354
## Y           -0.003363563   0.02371941   -0.06108419 -0.0006481981   0.03642514
##                      mode          kld
## (Intercept) -20.057620990 5.350437e-05
## X             0.011915185 7.755183e-05
## Y             0.002407428 3.418641e-05</code></pre>
</div>
<div id="example-10.13-directional-variograms" class="section level2 unnumbered hasAnchor">
<h2>Example 10.13: Directional variograms<a href="hazards.html#example-10.13-directional-variograms" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="hazards.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="do">### Compute and plot the directional variogram</span></span>
<span id="cb192-2"><a href="hazards.html#cb192-2" aria-hidden="true" tabindex="-1"></a>CA.geo <span class="ot">&lt;-</span> <span class="fu">as.geodata</span>( benzene_utm_df , <span class="at">coords.col =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3</span> , <span class="at">data.col=</span><span class="dv">1</span>)</span>
<span id="cb192-3"><a href="hazards.html#cb192-3" aria-hidden="true" tabindex="-1"></a>CA.vario4 <span class="ot">&lt;-</span> <span class="fu">variog4</span>(CA.geo )</span>
<span id="cb192-4"><a href="hazards.html#cb192-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CA.vario4)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.13%20directional%20variogram-1.png" width="672" /></p>
<!-- REVIEW: I am not sure where this example goes -->
</div>
<div id="example-10.14-spatial-modeling-of-malaria-in-gambia" class="section level2 unnumbered hasAnchor">
<h2>Example 10.14: Spatial modeling of malaria in Gambia<a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Note: There might be a warning when loading the <span class="math inline">\(\texttt{raster}\)</span> package, if necessary, uninstall and re-install the package.</p>
<p>For this example we are using the same <span class="math inline">\(\texttt{gambia}\)</span> data set from the <span class="math inline">\(\texttt{geoR}\)</span> package but an <span class="math inline">\(\texttt{id_area}\)</span> column was added using QGIS to differentiate the different areas as in the original paper.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="hazards.html#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># to manipulate the data</span></span>
<span id="cb193-2"><a href="hazards.html#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(geoR) <span class="co"># to get the dataset</span></span>
<span id="cb193-3"><a href="hazards.html#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggmap) <span class="co"># to plot the map</span></span>
<span id="cb193-4"><a href="hazards.html#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble) <span class="co"># for modeling</span></span>
<span id="cb193-5"><a href="hazards.html#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="co">#library(raster) # to get the environmental data</span></span>
<span id="cb193-6"><a href="hazards.html#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rgdal) <span class="co"># for adding and transforming coordinates</span></span>
<span id="cb193-7"><a href="hazards.html#cb193-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># manipulate spatial data</span></span>
<span id="cb193-8"><a href="hazards.html#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sp) <span class="co"># for manipulating spatial data</span></span>
<span id="cb193-9"><a href="hazards.html#cb193-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># to analyze posterior</span></span>
<span id="cb193-10"><a href="hazards.html#cb193-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># for a more cheerful color palette</span></span>
<span id="cb193-11"><a href="hazards.html#cb193-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-12"><a href="hazards.html#cb193-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Note, we are using the same Gambia dataset as in the geoR package but an id_area</span></span>
<span id="cb193-13"><a href="hazards.html#cb193-13" aria-hidden="true" tabindex="-1"></a><span class="co"># attribute has been added using QGIS to a</span></span>
<span id="cb193-14"><a href="hazards.html#cb193-14" aria-hidden="true" tabindex="-1"></a>gambia <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/gambia_area.csv&quot;</span>) <span class="co"># gambia dataset from geoR package</span></span>
<span id="cb193-15"><a href="hazards.html#cb193-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-16"><a href="hazards.html#cb193-16" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb193-17"><a href="hazards.html#cb193-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb193-18"><a href="hazards.html#cb193-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb193-19"><a href="hazards.html#cb193-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb193-20"><a href="hazards.html#cb193-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb193-21"><a href="hazards.html#cb193-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>), <span class="co"># keep axis line</span></span>
<span id="cb193-22"><a href="hazards.html#cb193-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>)</span>
<span id="cb193-23"><a href="hazards.html#cb193-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb193-24"><a href="hazards.html#cb193-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Since the data is given at the individual level, we want to aggregate the malaria tests by village.
If we explore the data frame we see that there are 2035 individuals at 65 villages.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="hazards.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(gambia)</span></code></pre></div>
<pre><code>##          x       y pos  age netuse treated green phc id_area
## 1 349631.3 1458055   1 1783      0       0 40.85   1       1
## 2 349631.3 1458055   0  404      1       0 40.85   1       1
## 3 349631.3 1458055   0  452      1       0 40.85   1       1
## 4 349631.3 1458055   1  566      1       0 40.85   1       1
## 5 349631.3 1458055   0  598      1       0 40.85   1       1
## 6 349631.3 1458055   1  590      1       0 40.85   1       1</code></pre>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="hazards.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gambia)</span></code></pre></div>
<pre><code>## [1] 2035    9</code></pre>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="hazards.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(<span class="fu">unique</span>(gambia[, <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>)]))</span></code></pre></div>
<pre><code>## [1] 65  2</code></pre>
<p>We create a new data frame aggregated by village containing the coordinates, the number of malaria tests, and the prevalence.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="hazards.html#cb200-1" aria-hidden="true" tabindex="-1"></a>malaria_village <span class="ot">&lt;-</span> <span class="fu">group_by</span>(gambia, x, y) <span class="sc">|&gt;</span></span>
<span id="cb200-2"><a href="hazards.html#cb200-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">total =</span> <span class="fu">n</span>(),</span>
<span id="cb200-3"><a href="hazards.html#cb200-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">positive =</span> <span class="fu">sum</span>(pos),</span>
<span id="cb200-4"><a href="hazards.html#cb200-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">prev =</span> positive <span class="sc">/</span> total) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;x&#39;. You can override using the `.groups`
## argument.</code></pre>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="hazards.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(malaria_village)</span></code></pre></div>
<pre><code>##          x       y total positive      prev
## 1 349631.3 1458055    33       17 0.5151515
## 2 358543.1 1460112    63       19 0.3015873
## 3 360308.1 1460026    17        7 0.4117647
## 4 363795.7 1496919    24        8 0.3333333
## 5 366400.5 1460248    26       10 0.3846154
## 6 366687.5 1463002    18        7 0.3888889</code></pre>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="hazards.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a new variable in &quot;sp&quot; format and define coordinates</span></span>
<span id="cb204-2"><a href="hazards.html#cb204-2" aria-hidden="true" tabindex="-1"></a>malaria_utm <span class="ot">&lt;-</span> malaria_village</span>
<span id="cb204-3"><a href="hazards.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coordinates</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="er">~</span> x <span class="sc">+</span> y</span>
<span id="cb204-4"><a href="hazards.html#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="fu">proj4string</span>(malaria_utm) <span class="ot">&lt;-</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=utm +zone=28&quot;</span>)</span>
<span id="cb204-5"><a href="hazards.html#cb204-5" aria-hidden="true" tabindex="-1"></a><span class="co"># convert to long lat </span></span>
<span id="cb204-6"><a href="hazards.html#cb204-6" aria-hidden="true" tabindex="-1"></a>malaria_geo <span class="ot">&lt;-</span> <span class="fu">spTransform</span>(malaria_utm, <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb204-7"><a href="hazards.html#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co"># add long lat coordinates to malaria dataframe</span></span>
<span id="cb204-8"><a href="hazards.html#cb204-8" aria-hidden="true" tabindex="-1"></a>malaria_village[, <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>, <span class="st">&quot;lat&quot;</span>)] <span class="ot">&lt;-</span> <span class="fu">coordinates</span>(malaria_geo)</span>
<span id="cb204-9"><a href="hazards.html#cb204-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-10"><a href="hazards.html#cb204-10" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the bounding box</span></span>
<span id="cb204-11"><a href="hazards.html#cb204-11" aria-hidden="true" tabindex="-1"></a>latLongBox <span class="ot">=</span> <span class="fu">bbox</span>(malaria_geo)</span>
<span id="cb204-12"><a href="hazards.html#cb204-12" aria-hidden="true" tabindex="-1"></a>location <span class="ot">=</span> <span class="fu">c</span>(latLongBox[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb204-13"><a href="hazards.html#cb204-13" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">0.05</span>,</span>
<span id="cb204-14"><a href="hazards.html#cb204-14" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">1</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb204-15"><a href="hazards.html#cb204-15" aria-hidden="true" tabindex="-1"></a>             latLongBox[<span class="dv">2</span>, <span class="dv">2</span>] <span class="sc">+</span> <span class="fl">0.05</span>)</span>
<span id="cb204-16"><a href="hazards.html#cb204-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-17"><a href="hazards.html#cb204-17" aria-hidden="true" tabindex="-1"></a><span class="co"># create map with location dots marked on it in</span></span>
<span id="cb204-18"><a href="hazards.html#cb204-18" aria-hidden="true" tabindex="-1"></a>GambiaMap <span class="ot">&lt;-</span></span>
<span id="cb204-19"><a href="hazards.html#cb204-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_stamenmap</span>(<span class="at">bbox =</span>  location,</span>
<span id="cb204-20"><a href="hazards.html#cb204-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">zoom =</span> <span class="dv">11</span>,</span>
<span id="cb204-21"><a href="hazards.html#cb204-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> terrain<span class="sc">-</span>background)</span>
<span id="cb204-22"><a href="hazards.html#cb204-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-23"><a href="hazards.html#cb204-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggmap</span>(GambiaMap) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">data =</span> malaria_village,</span>
<span id="cb204-24"><a href="hazards.html#cb204-24" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">aes</span>(<span class="at">x =</span> long,</span>
<span id="cb204-25"><a href="hazards.html#cb204-25" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">y =</span> lat,</span>
<span id="cb204-26"><a href="hazards.html#cb204-26" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">col =</span> prev),</span>
<span id="cb204-27"><a href="hazards.html#cb204-27" aria-hidden="true" tabindex="-1"></a>                              <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="fu">theme_void</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20plot%20prevalence-1.png" width="672" /></p>
<!-- NOTE: I am not doing a Matern cause I don't know how to code it, I'll use an exponential instead -->
<div id="nimble-3" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="hazards.html#nimble-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="hazards.html#cb205-1" aria-hidden="true" tabindex="-1"></a>Example10_14_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb205-2"><a href="hazards.html#cb205-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb205-3"><a href="hazards.html#cb205-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define priors</span></span>
<span id="cb205-4"><a href="hazards.html#cb205-4" aria-hidden="true" tabindex="-1"></a>  sigma <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb205-5"><a href="hazards.html#cb205-5" aria-hidden="true" tabindex="-1"></a>  sigma_sq <span class="ot">&lt;-</span> sigma <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb205-6"><a href="hazards.html#cb205-6" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb205-7"><a href="hazards.html#cb205-7" aria-hidden="true" tabindex="-1"></a>  tau_sq <span class="ot">&lt;-</span> tau  <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb205-8"><a href="hazards.html#cb205-8" aria-hidden="true" tabindex="-1"></a>  phi_inv <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="at">shape =</span>  <span class="dv">5</span>, <span class="at">rate =</span> <span class="dv">5</span>)</span>
<span id="cb205-9"><a href="hazards.html#cb205-9" aria-hidden="true" tabindex="-1"></a>  phi <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> phi_inv</span>
<span id="cb205-10"><a href="hazards.html#cb205-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb205-11"><a href="hazards.html#cb205-11" aria-hidden="true" tabindex="-1"></a>  Sigma[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span></span>
<span id="cb205-12"><a href="hazards.html#cb205-12" aria-hidden="true" tabindex="-1"></a>     sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>obs_dist_mat[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="sc">/</span> phi) <span class="sc">+</span> tau_sq  <span class="sc">*</span> <span class="fu">identityMatrix</span>(<span class="at">d =</span> N)</span>
<span id="cb205-13"><a href="hazards.html#cb205-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-14"><a href="hazards.html#cb205-14" aria-hidden="true" tabindex="-1"></a>  S[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(zeroes[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> Sigma[<span class="dv">1</span><span class="sc">:</span>N,<span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb205-15"><a href="hazards.html#cb205-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb205-16"><a href="hazards.html#cb205-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n) {  <span class="co"># by child</span></span>
<span id="cb205-17"><a href="hazards.html#cb205-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">logit</span>(p[j])  <span class="ot">&lt;-</span>  b0 <span class="sc">+</span> <span class="fu">inprod</span>(b[<span class="dv">1</span><span class="sc">:</span>k], X[j,<span class="dv">1</span><span class="sc">:</span>k]) <span class="sc">+</span> S[index_village[j]]</span>
<span id="cb205-18"><a href="hazards.html#cb205-18" aria-hidden="true" tabindex="-1"></a>    y[j] <span class="sc">~</span> <span class="fu">dbinom</span>(<span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p[j])</span>
<span id="cb205-19"><a href="hazards.html#cb205-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb205-20"><a href="hazards.html#cb205-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-21"><a href="hazards.html#cb205-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-22"><a href="hazards.html#cb205-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k){</span>
<span id="cb205-23"><a href="hazards.html#cb205-23" aria-hidden="true" tabindex="-1"></a>    b[l] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">100</span>)</span>
<span id="cb205-24"><a href="hazards.html#cb205-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb205-25"><a href="hazards.html#cb205-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb205-26"><a href="hazards.html#cb205-26" aria-hidden="true" tabindex="-1"></a>  b0 <span class="sc">~</span>  <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">100</span>)</span>
<span id="cb205-27"><a href="hazards.html#cb205-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-28"><a href="hazards.html#cb205-28" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="hazards.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># distance specification</span></span>
<span id="cb206-2"><a href="hazards.html#cb206-2" aria-hidden="true" tabindex="-1"></a>coords_sf <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_as_sf</span>(malaria_village[,<span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)], <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;long&quot;</span>,<span class="st">&quot;lat&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb206-3"><a href="hazards.html#cb206-3" aria-hidden="true" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_set_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb206-4"><a href="hazards.html#cb206-4" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> sf<span class="sc">::</span><span class="fu">st_distance</span>(coords_sf)</span>
<span id="cb206-5"><a href="hazards.html#cb206-5" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, km)</span>
<span id="cb206-6"><a href="hazards.html#cb206-6" aria-hidden="true" tabindex="-1"></a>obs_dist_mat <span class="ot">&lt;-</span> units<span class="sc">::</span><span class="fu">set_units</span>(obs_dist_mat, <span class="cn">NULL</span>)</span>
<span id="cb206-7"><a href="hazards.html#cb206-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-8"><a href="hazards.html#cb206-8" aria-hidden="true" tabindex="-1"></a><span class="co"># define indicator variables for each village</span></span>
<span id="cb206-9"><a href="hazards.html#cb206-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-10"><a href="hazards.html#cb206-10" aria-hidden="true" tabindex="-1"></a>gambia_df <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb206-11"><a href="hazards.html#cb206-11" aria-hidden="true" tabindex="-1"></a>  gambia,</span>
<span id="cb206-12"><a href="hazards.html#cb206-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_child =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(gambia), <span class="co"># add an id for each child</span></span>
<span id="cb206-13"><a href="hazards.html#cb206-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="dv">1</span>, <span class="co"># this will be needed later for the villages</span></span>
<span id="cb206-14"><a href="hazards.html#cb206-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_village =</span> <span class="fu">as.numeric</span>(<span class="fu">interaction</span>( <span class="co"># add an id for the villages</span></span>
<span id="cb206-15"><a href="hazards.html#cb206-15" aria-hidden="true" tabindex="-1"></a>    x, y, <span class="at">drop =</span> <span class="cn">TRUE</span>, <span class="at">lex.order =</span> <span class="cn">TRUE</span></span>
<span id="cb206-16"><a href="hazards.html#cb206-16" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb206-17"><a href="hazards.html#cb206-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb206-18"><a href="hazards.html#cb206-18" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">spread</span>(id_area, value, <span class="at">fill =</span> <span class="dv">0</span>) </span>
<span id="cb206-19"><a href="hazards.html#cb206-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-20"><a href="hazards.html#cb206-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Model specification</span></span>
<span id="cb206-21"><a href="hazards.html#cb206-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables matrix</span></span>
<span id="cb206-22"><a href="hazards.html#cb206-22" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">age =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(gambia_df[,<span class="st">&quot;age&quot;</span>])),</span>
<span id="cb206-23"><a href="hazards.html#cb206-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">netuse =</span> gambia_df[,<span class="st">&quot;netuse&quot;</span>],</span>
<span id="cb206-24"><a href="hazards.html#cb206-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">treated =</span> gambia_df[,<span class="st">&quot;treated&quot;</span>],</span>
<span id="cb206-25"><a href="hazards.html#cb206-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">green =</span> <span class="fu">as.vector</span>(<span class="fu">scale</span>(gambia_df[,<span class="st">&quot;green&quot;</span>])),</span>
<span id="cb206-26"><a href="hazards.html#cb206-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">phc =</span> gambia_df[,<span class="st">&quot;phc&quot;</span>],</span>
<span id="cb206-27"><a href="hazards.html#cb206-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">area2 =</span> gambia_df[,<span class="st">&quot;2&quot;</span>],</span>
<span id="cb206-28"><a href="hazards.html#cb206-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">area3 =</span> gambia_df[,<span class="st">&quot;3&quot;</span>],</span>
<span id="cb206-29"><a href="hazards.html#cb206-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">area4 =</span> gambia_df[,<span class="st">&quot;4&quot;</span>],</span>
<span id="cb206-30"><a href="hazards.html#cb206-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">area5 =</span> gambia_df[,<span class="st">&quot;5&quot;</span>] )</span>
<span id="cb206-31"><a href="hazards.html#cb206-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-32"><a href="hazards.html#cb206-32" aria-hidden="true" tabindex="-1"></a>index_village <span class="ot">&lt;-</span> gambia_df[,<span class="st">&quot;id_village&quot;</span>]</span>
<span id="cb206-33"><a href="hazards.html#cb206-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-34"><a href="hazards.html#cb206-34" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># child number</span></span>
<span id="cb206-35"><a href="hazards.html#cb206-35" aria-hidden="true" tabindex="-1"></a>zeroes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n) <span class="co"># auxiliary vector of zeroes for model</span></span>
<span id="cb206-36"><a href="hazards.html#cb206-36" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nrow</span>(malaria_village)</span>
<span id="cb206-37"><a href="hazards.html#cb206-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-38"><a href="hazards.html#cb206-38" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="co"># number of childs</span></span>
<span id="cb206-39"><a href="hazards.html#cb206-39" aria-hidden="true" tabindex="-1"></a>                   <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb206-40"><a href="hazards.html#cb206-40" aria-hidden="true" tabindex="-1"></a>                   <span class="at">zeroes =</span> zeroes, <span class="co"># vector of zeroes </span></span>
<span id="cb206-41"><a href="hazards.html#cb206-41" aria-hidden="true" tabindex="-1"></a>                   <span class="at">prior_max_dist =</span> <span class="fu">max</span>(obs_dist_mat)<span class="sc">/</span><span class="dv">6</span>, <span class="co"># max dist for phi prior</span></span>
<span id="cb206-42"><a href="hazards.html#cb206-42" aria-hidden="true" tabindex="-1"></a>                   <span class="at">k =</span>  <span class="fu">ncol</span>(X) <span class="co"># number of predictors</span></span>
<span id="cb206-43"><a href="hazards.html#cb206-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb206-44"><a href="hazards.html#cb206-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-45"><a href="hazards.html#cb206-45" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> gambia<span class="sc">$</span>pos, <span class="co"># malaria positive test </span></span>
<span id="cb206-46"><a href="hazards.html#cb206-46" aria-hidden="true" tabindex="-1"></a>                 <span class="at">obs_dist_mat =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb206-47"><a href="hazards.html#cb206-47" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X =</span> X, <span class="co"># predictors matrix</span></span>
<span id="cb206-48"><a href="hazards.html#cb206-48" aria-hidden="true" tabindex="-1"></a>                 <span class="at">index_village =</span> index_village</span>
<span id="cb206-49"><a href="hazards.html#cb206-49" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb206-50"><a href="hazards.html#cb206-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-51"><a href="hazards.html#cb206-51" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sigma =</span> <span class="fl">0.01</span>, <span class="at">p =</span> <span class="fu">rep</span>(<span class="fl">0.01</span>, n))</span>
<span id="cb206-52"><a href="hazards.html#cb206-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-53"><a href="hazards.html#cb206-53" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb206-54"><a href="hazards.html#cb206-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb206-55"><a href="hazards.html#cb206-55" aria-hidden="true" tabindex="-1"></a>    Example10_14_Nimble,</span>
<span id="cb206-56"><a href="hazards.html#cb206-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb206-57"><a href="hazards.html#cb206-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb206-58"><a href="hazards.html#cb206-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb206-59"><a href="hazards.html#cb206-59" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb206-60"><a href="hazards.html#cb206-60" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb206-61"><a href="hazards.html#cb206-61" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb206-62"><a href="hazards.html#cb206-62" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb206-63"><a href="hazards.html#cb206-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;S&quot;</span>, <span class="st">&quot;p&quot;</span>))</span>
<span id="cb206-64"><a href="hazards.html#cb206-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-65"><a href="hazards.html#cb206-65" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb206-66"><a href="hazards.html#cb206-66" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb206-67"><a href="hazards.html#cb206-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb206-68"><a href="hazards.html#cb206-68" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb206-69"><a href="hazards.html#cb206-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb206-70"><a href="hazards.html#cb206-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb206-71"><a href="hazards.html#cb206-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span></span>
<span id="cb206-72"><a href="hazards.html#cb206-72" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb206-73"><a href="hazards.html#cb206-73" aria-hidden="true" tabindex="-1"></a>niters <span class="ot">&lt;-</span> <span class="dv">60000</span></span>
<span id="cb206-74"><a href="hazards.html#cb206-74" aria-hidden="true" tabindex="-1"></a>nburnins <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niters</span>
<span id="cb206-75"><a href="hazards.html#cb206-75" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb206-76"><a href="hazards.html#cb206-76" aria-hidden="true" tabindex="-1"></a>nthins <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb206-77"><a href="hazards.html#cb206-77" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb206-78"><a href="hazards.html#cb206-78" aria-hidden="true" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb206-79"><a href="hazards.html#cb206-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> niters,</span>
<span id="cb206-80"><a href="hazards.html#cb206-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnins,</span>
<span id="cb206-81"><a href="hazards.html#cb206-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nthins,</span>
<span id="cb206-82"><a href="hazards.html#cb206-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nchains,</span>
<span id="cb206-83"><a href="hazards.html#cb206-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb206-84"><a href="hazards.html#cb206-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb206-85"><a href="hazards.html#cb206-85" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="hazards.html#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b0&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-1.png" width="672" /></p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="hazards.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-2.png" width="672" /></p>
<div class="sourceCode" id="cb209"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb209-1"><a href="hazards.html#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[2]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[2]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-3.png" width="672" /></p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="hazards.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[3]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;b[3]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-4.png" width="672" /></p>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="hazards.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;tau&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-5.png" width="672" /></p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="hazards.html#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;sigma&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-6.png" width="672" /></p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="hazards.html#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;phi&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;phi&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-7.png" width="672" /></p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="hazards.html#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-8.png" width="672" /></p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="hazards.html#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;S[29]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;S[29]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-9.png" width="672" /></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="hazards.html#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-10.png" width="672" /></p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="hazards.html#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(post_samples<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;p[1519]&quot;</span>)], <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>, <span class="at">main =</span> <span class="st">&quot;p[1519]&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20traceplots%20ESS-11.png" width="672" /></p>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="hazards.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get minimum effective size (ESS) and which variable has the min ESS</span></span>
<span id="cb218-2"><a href="hazards.html#cb218-2" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 45.73089</code></pre>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="hazards.html#cb220-1" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names <span class="ot">&lt;-</span> <span class="fu">colnames</span>(post_samples<span class="sc">$</span>samples<span class="sc">$</span>chain1)</span>
<span id="cb220-2"><a href="hazards.html#cb220-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-3"><a href="hazards.html#cb220-3" aria-hidden="true" tabindex="-1"></a>mcmc_variable_names[<span class="fu">which</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples) <span class="sc">==</span> <span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(post_samples<span class="sc">$</span>samples)))]</span></code></pre></div>
<pre><code>## [1] &quot;S[24]&quot;</code></pre>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="hazards.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb222-2"><a href="hazards.html#cb222-2" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;b0&quot;</span>, <span class="st">&quot;b[1]&quot;</span>, <span class="st">&quot;b[2]&quot;</span>, <span class="st">&quot;b[3]&quot;</span>, <span class="st">&quot;b[4]&quot;</span>, <span class="st">&quot;b[5]&quot;</span>, <span class="st">&quot;b[6]&quot;</span>, <span class="st">&quot;b[7]&quot;</span>, <span class="st">&quot;b[8]&quot;</span>,<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>)</span>
<span id="cb222-3"><a href="hazards.html#cb222-3" aria-hidden="true" tabindex="-1"></a>summary_nimble <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb222-4"><a href="hazards.html#cb222-4" aria-hidden="true" tabindex="-1"></a>summary_nimble[variables,]</span></code></pre></div>
<pre><code>##              Mean      Median    St.Dev.   95%CI_low   95%CI_upp
## b0    -0.07821017 -0.07866953 0.09530318 -0.26039853  0.11264327
## b[1]   0.22737838  0.22767184 0.04618430  0.13803109  0.31885996
## b[2]  -0.18731107 -0.18785547 0.08276566 -0.34833922 -0.02309801
## b[3]  -0.13817965 -0.13780720 0.08756801 -0.30784114  0.03404314
## b[4]   0.06743147  0.06740229 0.08364687 -0.09612806  0.22465669
## b[5]  -0.09918825 -0.09961521 0.08919783 -0.27053548  0.07938004
## b[6]  -0.04290904 -0.04314967 0.09870257 -0.23825054  0.14497246
## b[7]  -0.07670637 -0.07766601 0.10591469 -0.27979292  0.13445184
## b[8]  -0.01741855 -0.01903414 0.09674214 -0.20572518  0.17469427
## tau    0.25217547  0.23193702 0.16586774  0.01191082  0.60044902
## sigma  0.88004187  0.86970870 0.16759158  0.58301842  1.25010272
## phi    6.77644110  6.12413226 3.70964466  1.50880349 15.74142491</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="hazards.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot posterior summary for the spatial random effect by village</span></span>
<span id="cb224-2"><a href="hazards.html#cb224-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> post_samples<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb224-3"><a href="hazards.html#cb224-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-4"><a href="hazards.html#cb224-4" aria-hidden="true" tabindex="-1"></a>post_sum_S <span class="ot">&lt;-</span></span>
<span id="cb224-5"><a href="hazards.html#cb224-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb224-6"><a href="hazards.html#cb224-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;S&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb224-7"><a href="hazards.html#cb224-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, Mean, <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)  <span class="sc">|&gt;</span></span>
<span id="cb224-8"><a href="hazards.html#cb224-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))</span>
<span id="cb224-9"><a href="hazards.html#cb224-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-10"><a href="hazards.html#cb224-10" aria-hidden="true" tabindex="-1"></a>post_sum_S<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb224-11"><a href="hazards.html#cb224-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(post_sum_S<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb224-12"><a href="hazards.html#cb224-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-13"><a href="hazards.html#cb224-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_S, <span class="fu">aes</span>(<span class="at">x =</span> village)) <span class="sc">+</span></span>
<span id="cb224-14"><a href="hazards.html#cb224-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>, <span class="at">ymax =</span> <span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>, <span class="at">y =</span> Mean)) <span class="sc">+</span></span>
<span id="cb224-15"><a href="hazards.html#cb224-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-16"><a href="hazards.html#cb224-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb224-17"><a href="hazards.html#cb224-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> post_sum_S<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(post_sum_S<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb224-18"><a href="hazards.html#cb224-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb224-19"><a href="hazards.html#cb224-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20nimble%20summary%20p-1.png" width="672" /></p>
</div>
<div id="stan-3" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="hazards.html#stan-3" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<pre><code>data {
  int&lt;lower=1&gt; n; //  number of children
  int&lt;lower=1&gt; k; // number of covariates
  int N; //  total number of villages
  int y[n]; //  tests
  matrix[N,N] dist_matrix; //  distance matrix
  matrix[n, k] X; // matrix with covariates
  int index_village[n];
}

parameters {
  real&lt;lower=0&gt; phi_inv;
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sigma;
  vector[N] S; // spatial random effect
  vector[k] betas;
  real beta0;
}

transformed parameters {
  // vector[n] p = inv_logit(logit_p);
  real sigma_sq = square(sigma);
  real tau_sq = square(tau);
  real&lt;lower=0&gt; phi = 1/phi_inv;
}

model {
  matrix[N, N] L;
  matrix[N, N] Sigma;
  vector[N] zeroes; // vector of zeroes
  vector[n] logit_p;

 for(i in 1:(N-1)){
   for(j in (i+1):N){
     Sigma[i,j] = sigma_sq*exp(-dist_matrix[i,j]/phi);
     Sigma[j,i] = Sigma[i,j];
   }
 }
   // diagonal elements covariances
for(i in 1:N){
  Sigma[i,i] = sigma_sq + tau_sq;
}

// sample spatial random effect
  L = cholesky_decompose(Sigma);
  zeroes = rep_vector(0, N);
  S ~ multi_normal_cholesky(zeroes, L);

  for(i in 1:n) {
    logit_p[i] = beta0 + X[i,]*betas + S[index_village[i]];
    y[i] ~ binomial_logit(1, logit_p[i]);
  }

  beta0 ~ normal(0,10);
  betas ~ normal(0,10);
  phi_inv ~ gamma(5, 5);
  tau ~ cauchy(0,1);
  sigma ~ cauchy(0,1);
  

}</code></pre>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="hazards.html#cb226-1" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>( <span class="at">n =</span> <span class="fu">nrow</span>(gambia), <span class="co"># number of children</span></span>
<span id="cb226-2"><a href="hazards.html#cb226-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">k =</span> <span class="fu">ncol</span>(X), <span class="co"># number of covariates</span></span>
<span id="cb226-3"><a href="hazards.html#cb226-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">N =</span> N, <span class="co"># number of villages</span></span>
<span id="cb226-4"><a href="hazards.html#cb226-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">y =</span> gambia<span class="sc">$</span>pos, <span class="co"># positive tests</span></span>
<span id="cb226-5"><a href="hazards.html#cb226-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dist_matrix =</span> obs_dist_mat, <span class="co"># distance matrix in km</span></span>
<span id="cb226-6"><a href="hazards.html#cb226-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">X =</span> X, <span class="co"># altitude per village</span></span>
<span id="cb226-7"><a href="hazards.html#cb226-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">index_village =</span> index_village</span>
<span id="cb226-8"><a href="hazards.html#cb226-8" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb226-9"><a href="hazards.html#cb226-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-10"><a href="hazards.html#cb226-10" aria-hidden="true" tabindex="-1"></a>Example10_14Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb226-11"><a href="hazards.html#cb226-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example10_14.stan&quot;</span>,</span>
<span id="cb226-12"><a href="hazards.html#cb226-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb226-13"><a href="hazards.html#cb226-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">15000</span>,</span>
<span id="cb226-14"><a href="hazards.html#cb226-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">30000</span>,</span>
<span id="cb226-15"><a href="hazards.html#cb226-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb226-16"><a href="hazards.html#cb226-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb226-17"><a href="hazards.html#cb226-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>, <span class="st">&quot;S&quot;</span>),</span>
<span id="cb226-18"><a href="hazards.html#cb226-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb226-19"><a href="hazards.html#cb226-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="hazards.html#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb227-2"><a href="hazards.html#cb227-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-3"><a href="hazards.html#cb227-3" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>,<span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;phi&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="hazards.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb228-2"><a href="hazards.html#cb228-2" aria-hidden="true" tabindex="-1"></a>summary_stan <span class="ot">&lt;-</span></span>
<span id="cb228-3"><a href="hazards.html#cb228-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb228-4"><a href="hazards.html#cb228-4" aria-hidden="true" tabindex="-1"></a>    Example10_14Stan,</span>
<span id="cb228-5"><a href="hazards.html#cb228-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;betas&quot;</span>, <span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sigma&quot;</span>, <span class="st">&quot;phi&quot;</span>),</span>
<span id="cb228-6"><a href="hazards.html#cb228-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb228-7"><a href="hazards.html#cb228-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb228-8"><a href="hazards.html#cb228-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb228-9"><a href="hazards.html#cb228-9" aria-hidden="true" tabindex="-1"></a>summary_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                mean      se_mean         sd        2.5%        97.5%    n_eff
## beta0     0.3490451 0.0051282900 0.25728225 -0.15151348  0.875478571 2516.950
## betas[1]  0.2912213 0.0009596327 0.05229884  0.18811670  0.392865774 2970.120
## betas[2] -0.3908343 0.0030259545 0.16316011 -0.70605474 -0.063518837 2907.389
## betas[3] -0.3785223 0.0038144397 0.21299232 -0.79634664  0.035739200 3117.930
## betas[4]  0.3145243 0.0027763006 0.14699922  0.01658576  0.601363474 2803.477
## betas[5] -0.2085795 0.0045578093 0.24566762 -0.69379835  0.269366106 2905.250
## betas[6] -0.5181247 0.0073406902 0.37862662 -1.25108288  0.215498657 2660.410
## betas[7] -1.3862610 0.0062091338 0.30643964 -1.99545874 -0.800473741 2435.723
## betas[8] -0.8418714 0.0079769210 0.43363536 -1.70718394  0.003663864 2955.145
## betas[9]  0.0461154 0.0081532941 0.44032619 -0.84024075  0.867153432 2916.640
## tau       0.4345580 0.0044134571 0.23570642  0.02162615  0.843863676 2852.233
## sigma     0.5205217 0.0045896369 0.24275190  0.04129676  0.924030983 2797.491
## phi       1.4707159 0.0207822658 1.07232778  0.51110101  4.048574525 2662.376
##               Rhat
## beta0    1.0006598
## betas[1] 1.0001083
## betas[2] 1.0008585
## betas[3] 1.0001566
## betas[4] 0.9996854
## betas[5] 1.0001345
## betas[6] 0.9997193
## betas[7] 0.9995207
## betas[8] 1.0023106
## betas[9] 1.0011783
## tau      0.9997155
## sigma    0.9996924
## phi      0.9996160</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="hazards.html#cb230-1" aria-hidden="true" tabindex="-1"></a>S_summary <span class="ot">&lt;-</span></span>
<span id="cb230-2"><a href="hazards.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example10_14Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;S&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb230-3"><a href="hazards.html#cb230-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-4"><a href="hazards.html#cb230-4" aria-hidden="true" tabindex="-1"></a>S_summary_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(S_summary) <span class="sc">|&gt;</span></span>
<span id="cb230-5"><a href="hazards.html#cb230-5" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb230-6"><a href="hazards.html#cb230-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;S[&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>, <span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb230-7"><a href="hazards.html#cb230-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">village =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>) <span class="sc">|&gt;</span></span>
<span id="cb230-8"><a href="hazards.html#cb230-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(mean,  X2.<span class="fl">5.</span>, X97.<span class="fl">5.</span>, village)</span>
<span id="cb230-9"><a href="hazards.html#cb230-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-10"><a href="hazards.html#cb230-10" aria-hidden="true" tabindex="-1"></a>S_summary_df<span class="sc">$</span>village <span class="ot">&lt;-</span></span>
<span id="cb230-11"><a href="hazards.html#cb230-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">factor</span>(S_summary_df<span class="sc">$</span>village , <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">65</span>)</span>
<span id="cb230-12"><a href="hazards.html#cb230-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-13"><a href="hazards.html#cb230-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-14"><a href="hazards.html#cb230-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(S_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> village, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb230-15"><a href="hazards.html#cb230-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>, <span class="at">y =</span> mean)) <span class="sc">+</span></span>
<span id="cb230-16"><a href="hazards.html#cb230-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb230-17"><a href="hazards.html#cb230-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_discrete</span>(</span>
<span id="cb230-18"><a href="hazards.html#cb230-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> S_summary_df<span class="sc">$</span>village[<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(S_summary_df<span class="sc">$</span>village), <span class="at">by =</span> <span class="dv">5</span>)]) <span class="sc">+</span></span>
<span id="cb230-19"><a href="hazards.html#cb230-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;village&quot;</span>) <span class="sc">+</span></span>
<span id="cb230-20"><a href="hazards.html#cb230-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Posterior summary spatial random effect by village&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2010.14%20stan%20posterior%20plots-1.png" width="672" /></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Disease.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Time.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/10-Chpt10.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
