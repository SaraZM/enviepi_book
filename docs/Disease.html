<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Disease-spatial patterns | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 9 Disease-spatial patterns | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Disease-spatial patterns | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Disease-spatial patterns | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2022-12-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="trusted.html"/>
<link rel="next" href="hazards.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="strategies.html"><a href="strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies-implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But-can the data be trusted</a></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1"><i class="fa fa-check"></i>Example 10.1</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9"><i class="fa fa-check"></i>Example 10.9</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-implementation-of-a-random-walk"><i class="fa fa-check"></i>Example 11.16 implementation of a random walk</a>
<ul>
<li class="chapter" data-level="11.0.1" data-path="Time.html"><a href="Time.html#nimble-3"><i class="fa fa-check"></i><b>11.0.1</b> Nimble</a></li>
<li class="chapter" data-level="11.0.2" data-path="Time.html"><a href="Time.html#stan-2"><i class="fa fa-check"></i><b>11.0.2</b> Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Disease" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Disease-spatial patterns<a href="Disease.html#Disease" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This chapter introduces disease mapping and contains the theory for spatial lattice processes and models for performing smoothing of risks over space. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>Disease mapping, where we have seen how to improve estimates of risk by borrowing strength from adjacent regions which can reduce the instability inherent in risk estimates (SMRs) based on small expected numbers.</li>
<li>Seen how smoothing can be performed using either the empirical Bayes or fully Bayesian approaches.</li>
<li>Been introduced to computational methods for handling areal data.</li>
<li>Learned about Besag’s seminal contributions to the field of spatial statistics including the very important concept of a Markov random field.</li>
<li>Explored approaches to modelling a real data including the conditional auto regressive models.</li>
<li>Seen how Bayesian spatial models for lattice data use <code>nimble</code>, <code>stan</code>, <code>R</code> and <code>R–INLA</code>.</li>
</ul>
<div id="example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="section level2 unnumbered hasAnchor">
<h2>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010<a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Following Example 6.2 we look back at the hospital admission rates for COPD, in England for 2010. We can implement the same model we used on Example 6.2 using <code>nimble</code>.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="Disease.html#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load nimble</span></span>
<span id="cb51-2"><a href="Disease.html#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb51-3"><a href="Disease.html#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to read shapefile</span></span>
<span id="cb51-4"><a href="Disease.html#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="Disease.html#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb51-6"><a href="Disease.html#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb51-7"><a href="Disease.html#cb51-7" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb51-8"><a href="Disease.html#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="Disease.html#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb51-10"><a href="Disease.html#cb51-10" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb51-11"><a href="Disease.html#cb51-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb51-12"><a href="Disease.html#cb51-12" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb51-13"><a href="Disease.html#cb51-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The following is the code for the Poisson-Gamma model implemented in <code>nimble</code>.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="Disease.html#cb52-1" aria-hidden="true" tabindex="-1"></a>Example8_1Code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb52-2"><a href="Disease.html#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb52-3"><a href="Disease.html#cb52-3" aria-hidden="true" tabindex="-1"></a>    Y[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb52-4"><a href="Disease.html#cb52-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: There is an intercept in the book, </span></span>
<span id="cb52-5"><a href="Disease.html#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># but then we wouldn&#39;t be able to compare it to example 5.2</span></span>
<span id="cb52-6"><a href="Disease.html#cb52-6" aria-hidden="true" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> E[i] <span class="sc">*</span> theta[i]</span>
<span id="cb52-7"><a href="Disease.html#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># REVIEW: Same as before, the example in the book has theta[i] ~ Ga(a,a)</span></span>
<span id="cb52-8"><a href="Disease.html#cb52-8" aria-hidden="true" tabindex="-1"></a>    theta[i] <span class="sc">~</span> <span class="fu">dgamma</span>(a, b)</span>
<span id="cb52-9"><a href="Disease.html#cb52-9" aria-hidden="true" tabindex="-1"></a>    Y.fit[i] <span class="sc">~</span> <span class="fu">dpois</span>(mu[i])</span>
<span id="cb52-10"><a href="Disease.html#cb52-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb52-11"><a href="Disease.html#cb52-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb52-12"><a href="Disease.html#cb52-12" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dexp</span>(lambda_a)</span>
<span id="cb52-13"><a href="Disease.html#cb52-13" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dexp</span>(lambda_b)</span>
<span id="cb52-14"><a href="Disease.html#cb52-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-15"><a href="Disease.html#cb52-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Define the constants, data and initials lists for the <code>nimble</code> model.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="Disease.html#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb53-2"><a href="Disease.html#cb53-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb53-3"><a href="Disease.html#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb53-4"><a href="Disease.html#cb53-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb53-5"><a href="Disease.html#cb53-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb53-6"><a href="Disease.html#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># parameter of exponential prior for a</span></span>
<span id="cb53-7"><a href="Disease.html#cb53-7" aria-hidden="true" tabindex="-1"></a>lambda_a <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-8"><a href="Disease.html#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co"># parameter of exponential prior for b</span></span>
<span id="cb53-9"><a href="Disease.html#cb53-9" aria-hidden="true" tabindex="-1"></a>lambda_b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-10"><a href="Disease.html#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb53-11"><a href="Disease.html#cb53-11" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb53-12"><a href="Disease.html#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb53-13"><a href="Disease.html#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb53-14"><a href="Disease.html#cb53-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> lambda_a,</span>
<span id="cb53-15"><a href="Disease.html#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> lambda_b</span>
<span id="cb53-16"><a href="Disease.html#cb53-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-17"><a href="Disease.html#cb53-17" aria-hidden="true" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb53-18"><a href="Disease.html#cb53-18" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Y =</span> y)</span>
<span id="cb53-19"><a href="Disease.html#cb53-19" aria-hidden="true" tabindex="-1"></a><span class="co"># initial values list</span></span>
<span id="cb53-20"><a href="Disease.html#cb53-20" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">&lt;-</span></span>
<span id="cb53-21"><a href="Disease.html#cb53-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb53-22"><a href="Disease.html#cb53-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">theta =</span> <span class="fu">rgamma</span>(N, <span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb53-23"><a href="Disease.html#cb53-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">a =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_a),</span>
<span id="cb53-24"><a href="Disease.html#cb53-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">b =</span> <span class="fu">rexp</span>(<span class="dv">1</span>, lambda_b),</span>
<span id="cb53-25"><a href="Disease.html#cb53-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">Y.fit =</span> <span class="fu">rpois</span>(N, E)</span>
<span id="cb53-26"><a href="Disease.html#cb53-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-27"><a href="Disease.html#cb53-27" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters to monitor</span></span>
<span id="cb53-28"><a href="Disease.html#cb53-28" aria-hidden="true" tabindex="-1"></a>params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;Y.fit&quot;</span>)</span>
<span id="cb53-29"><a href="Disease.html#cb53-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-30"><a href="Disease.html#cb53-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb53-31"><a href="Disease.html#cb53-31" aria-hidden="true" tabindex="-1"></a>mcmc.out <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(</span>
<span id="cb53-32"><a href="Disease.html#cb53-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> Example8_1Code,</span>
<span id="cb53-33"><a href="Disease.html#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb53-34"><a href="Disease.html#cb53-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb53-35"><a href="Disease.html#cb53-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits,</span>
<span id="cb53-36"><a href="Disease.html#cb53-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> params,</span>
<span id="cb53-37"><a href="Disease.html#cb53-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">50000</span>,</span>
<span id="cb53-38"><a href="Disease.html#cb53-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb53-39"><a href="Disease.html#cb53-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">30</span>,</span>
<span id="cb53-40"><a href="Disease.html#cb53-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-41"><a href="Disease.html#cb53-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb53-42"><a href="Disease.html#cb53-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-43"><a href="Disease.html#cb53-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb53-44"><a href="Disease.html#cb53-44" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Show the WAIC, effective sample size, and trace plots for some of the parameters.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="Disease.html#cb54-1" aria-hidden="true" tabindex="-1"></a>mcmc.out<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2416.191
## Field &quot;lppd&quot;:
## [1] -1060.222
## Field &quot;pWAIC&quot;:
## [1] 147.8734</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="Disease.html#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(mcmc.out<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 261.2587</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="Disease.html#cb58-1" aria-hidden="true" tabindex="-1"></a>mvSamples <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>samples</span>
<span id="cb58-2"><a href="Disease.html#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="Disease.html#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co"># trace plot of a</span></span>
<span id="cb58-4"><a href="Disease.html#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="Disease.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trace plot of b</span></span>
<span id="cb59-2"><a href="Disease.html#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="Disease.html#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trace plots of theta</span></span>
<span id="cb60-2"><a href="Disease.html#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb60-3"><a href="Disease.html#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(mvSamples[, <span class="fu">c</span>(<span class="fu">paste</span>(<span class="st">&quot;theta[&quot;</span>, i, <span class="st">&quot;]&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>))])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-4.png" width="672" /><img src="_main_files/figure-html/Ex%209.1%20nimble%20WAIC,%20ESS%20and%20traceplots-5.png" width="672" /></p>
<p>Now that we have checked the convergence of the chains we can plot the posterior mean and 95% CIs for each of the parameters.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="Disease.html#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print posterior summary for parameters a and b</span></span>
<span id="cb61-2"><a href="Disease.html#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mvSamples[, <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>)])</span></code></pre></div>
<pre><code>## 
## Iterations = 1:1000
## Thinning interval = 1 
## Number of chains = 2 
## Sample size per chain = 1000 
## 
## 1. Empirical mean and standard deviation for each variable,
##    plus standard error of the mean:
## 
##    Mean    SD Naive SE Time-series SE
## a 11.79 1.032  0.02308        0.06573
## b 12.13 1.088  0.02432        0.06804
## 
## 2. Quantiles for each variable:
## 
##     2.5%   25%   50%   75% 97.5%
## a  9.835 11.07 11.75 12.48 13.94
## b 10.051 11.36 12.08 12.84 14.40</code></pre>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="Disease.html#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior summaries of theta_i</span></span>
<span id="cb63-2"><a href="Disease.html#cb63-2" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> mcmc.out<span class="sc">$</span>summary<span class="sc">$</span>all.chains  <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb63-3"><a href="Disease.html#cb63-3" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">&quot;variable&quot;</span>)</span>
<span id="cb63-4"><a href="Disease.html#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="Disease.html#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pot the mean and 95% CIs for the thetas</span></span>
<span id="cb63-6"><a href="Disease.html#cb63-6" aria-hidden="true" tabindex="-1"></a>post_theta <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;theta</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb63-7"><a href="Disease.html#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="Disease.html#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb63-9"><a href="Disease.html#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb63-10"><a href="Disease.html#cb63-10" aria-hidden="true" tabindex="-1"></a>  post_theta<span class="sc">$</span>Mean,</span>
<span id="cb63-11"><a href="Disease.html#cb63-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb63-12"><a href="Disease.html#cb63-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb63-13"><a href="Disease.html#cb63-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb63-14"><a href="Disease.html#cb63-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb63-15"><a href="Disease.html#cb63-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb63-16"><a href="Disease.html#cb63-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>))</span>
<span id="cb63-17"><a href="Disease.html#cb63-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-18"><a href="Disease.html#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb63-19"><a href="Disease.html#cb63-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], i, post_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb63-20"><a href="Disease.html#cb63-20" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="Disease.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># posterior summary of fitted values</span></span>
<span id="cb64-2"><a href="Disease.html#cb64-2" aria-hidden="true" tabindex="-1"></a>post_fitted <span class="ot">&lt;-</span>  post_summary[<span class="fu">grepl</span>(<span class="st">&quot;Y.fit</span><span class="sc">\\</span><span class="st">[&quot;</span>, post_summary<span class="sc">$</span>variable), ]</span>
<span id="cb64-3"><a href="Disease.html#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="Disease.html#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># plot mean and 95% CIs for the fitted values</span></span>
<span id="cb64-5"><a href="Disease.html#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb64-6"><a href="Disease.html#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb64-7"><a href="Disease.html#cb64-7" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb64-8"><a href="Disease.html#cb64-8" aria-hidden="true" tabindex="-1"></a>  post_fitted<span class="sc">$</span>Mean,</span>
<span id="cb64-9"><a href="Disease.html#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>), <span class="fu">max</span>(post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>)),</span>
<span id="cb64-10"><a href="Disease.html#cb64-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb64-11"><a href="Disease.html#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb64-12"><a href="Disease.html#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb64-13"><a href="Disease.html#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb64-14"><a href="Disease.html#cb64-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb64-15"><a href="Disease.html#cb64-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-16"><a href="Disease.html#cb64-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb64-17"><a href="Disease.html#cb64-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_low</span><span class="st">`</span>[i], y[i], post_fitted<span class="sc">$</span><span class="st">`</span><span class="at">95%CI_upp</span><span class="st">`</span>[i])</span>
<span id="cb64-18"><a href="Disease.html#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.1%20nimble%20posterior%20summary-2.png" width="672" /></p>
</div>
<div id="stan" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Load necessary libraries and data.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="Disease.html#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span></code></pre></div>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="Disease.html#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan) </span>
<span id="cb66-2"><a href="Disease.html#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to read shapefile</span></span>
<span id="cb66-3"><a href="Disease.html#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo) <span class="co"># To calculate WAIC</span></span>
<span id="cb66-4"><a href="Disease.html#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb66-5"><a href="Disease.html#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb66-6"><a href="Disease.html#cb66-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-7"><a href="Disease.html#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb66-8"><a href="Disease.html#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb66-9"><a href="Disease.html#cb66-9" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb66-10"><a href="Disease.html#cb66-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-11"><a href="Disease.html#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb66-12"><a href="Disease.html#cb66-12" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb66-13"><a href="Disease.html#cb66-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb66-14"><a href="Disease.html#cb66-14" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb66-15"><a href="Disease.html#cb66-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Write the <code>stan</code> model. This model is in a separate file called <code>Example8_1.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=0&gt; N;
  real&lt;lower=0&gt; E[N]; // need to indicate that variable is strictly positive
  int&lt;lower=0&gt; Y[N];
  real&lt;lower=0&gt;lambda_a;
  real&lt;lower=0&gt;lambda_b;
}

parameters {
  real&lt;lower=0&gt; theta[N];
  real&lt;lower=0&gt; a;
  real&lt;lower=0&gt; b;
}

transformed parameters{
  real &lt;lower=0&gt; mu[N];
  
  for(i in 1:N){
    mu[i]=E[i]*theta[i];
  }
  
}

model {
  // likelihood function and prior for theta
  for(i in 1:N){
    Y[i] ~ poisson(mu[i]);
    theta[i]~gamma(a,b);
  }
  a~exponential(lambda_a);
  b~exponential(lambda_b);
}

generated quantities {
  vector [N] log_lik;
  int&lt;lower=0&gt; yfit [N];
  
  //computing the log_likelihood for each value of the mean mu and the fitted values
  for(i in 1:N){
    log_lik[i]=poisson_lpmf(Y[i] |mu[i]);
    yfit[i]=poisson_rng(mu[i]);
  }
  
}</code></pre>
<p>Define the data for the model, similar to <code>nimble</code>.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="Disease.html#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co"># observations</span></span>
<span id="cb68-2"><a href="Disease.html#cb68-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb68-3"><a href="Disease.html#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co"># offset</span></span>
<span id="cb68-4"><a href="Disease.html#cb68-4" aria-hidden="true" tabindex="-1"></a>E <span class="ot">&lt;-</span> expected<span class="sc">$</span>E2010</span>
<span id="cb68-5"><a href="Disease.html#cb68-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb68-6"><a href="Disease.html#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co"># data list </span></span>
<span id="cb68-7"><a href="Disease.html#cb68-7" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb68-8"><a href="Disease.html#cb68-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> <span class="fu">length</span>(y),</span>
<span id="cb68-9"><a href="Disease.html#cb68-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> y,</span>
<span id="cb68-10"><a href="Disease.html#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb68-11"><a href="Disease.html#cb68-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_a =</span> <span class="dv">1</span>,</span>
<span id="cb68-12"><a href="Disease.html#cb68-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">lambda_b =</span> <span class="dv">1</span></span>
<span id="cb68-13"><a href="Disease.html#cb68-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-14"><a href="Disease.html#cb68-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-15"><a href="Disease.html#cb68-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the model in Stan</span></span>
<span id="cb68-16"><a href="Disease.html#cb68-16" aria-hidden="true" tabindex="-1"></a>mod0 <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb68-17"><a href="Disease.html#cb68-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example8_1.stan&quot;</span>,</span>
<span id="cb68-18"><a href="Disease.html#cb68-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb68-19"><a href="Disease.html#cb68-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb68-20"><a href="Disease.html#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb68-21"><a href="Disease.html#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">3000</span>,</span>
<span id="cb68-22"><a href="Disease.html#cb68-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">14</span>,</span>
<span id="cb68-23"><a href="Disease.html#cb68-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QUESTION: should we explain this?</span></span>
<span id="cb68-24"><a href="Disease.html#cb68-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.8</span>, <span class="at">max_treedepth =</span> <span class="dv">15</span>), </span>
<span id="cb68-25"><a href="Disease.html#cb68-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> <span class="st">&quot;random&quot;</span>,</span>
<span id="cb68-26"><a href="Disease.html#cb68-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;log_lik&quot;</span>, <span class="st">&quot;yfit&quot;</span>),</span>
<span id="cb68-27"><a href="Disease.html#cb68-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb68-28"><a href="Disease.html#cb68-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Compute the WAIC, show the trace plots and posterior summaries of the parameters.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="Disease.html#cb69-1" aria-hidden="true" tabindex="-1"></a>loglik0 <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(mod0)</span>
<span id="cb69-2"><a href="Disease.html#cb69-2" aria-hidden="true" tabindex="-1"></a>waic0 <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglik0)</span>
<span id="cb69-3"><a href="Disease.html#cb69-3" aria-hidden="true" tabindex="-1"></a>waic0</span></code></pre></div>
<pre><code>## 
## Computed from 1500 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1208.3  7.6
## p_waic       148.0  3.5
## waic        2416.7 15.2
## 
## 176 (54.3%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="Disease.html#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># traceplots of parameters a and b</span></span>
<span id="cb71-2"><a href="Disease.html#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20waic%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="Disease.html#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># traceplots of parameter theta</span></span>
<span id="cb72-2"><a href="Disease.html#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta[1]&quot;</span>, <span class="st">&quot;theta[2]&quot;</span>, <span class="st">&quot;theta[3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20waic%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="Disease.html#cb73-1" aria-hidden="true" tabindex="-1"></a>summary_theta <span class="ot">&lt;-</span></span>
<span id="cb73-2"><a href="Disease.html#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb73-3"><a href="Disease.html#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="Disease.html#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb73-5"><a href="Disease.html#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb73-6"><a href="Disease.html#cb73-6" aria-hidden="true" tabindex="-1"></a>  summary_theta<span class="sc">$</span>mean,</span>
<span id="cb73-7"><a href="Disease.html#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb73-8"><a href="Disease.html#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.8</span>,</span>
<span id="cb73-9"><a href="Disease.html#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb73-10"><a href="Disease.html#cb73-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Borough&quot;</span>,</span>
<span id="cb73-11"><a href="Disease.html#cb73-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Posterior Summary Rate&quot;</span>,</span>
<span id="cb73-12"><a href="Disease.html#cb73-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>))</span>
<span id="cb73-13"><a href="Disease.html#cb73-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-14"><a href="Disease.html#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb73-15"><a href="Disease.html#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], i, summary_theta<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb73-16"><a href="Disease.html#cb73-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">1</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="Disease.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior summary of fitted values</span></span>
<span id="cb74-2"><a href="Disease.html#cb74-2" aria-hidden="true" tabindex="-1"></a>summary_fit <span class="ot">&lt;-</span></span>
<span id="cb74-3"><a href="Disease.html#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(mod0, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>), <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>))<span class="sc">$</span>summary <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb74-4"><a href="Disease.html#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="Disease.html#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot mean and 95% CIs for the fitted values</span></span>
<span id="cb74-6"><a href="Disease.html#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb74-7"><a href="Disease.html#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb74-8"><a href="Disease.html#cb74-8" aria-hidden="true" tabindex="-1"></a>  y,</span>
<span id="cb74-9"><a href="Disease.html#cb74-9" aria-hidden="true" tabindex="-1"></a>  summary_fit<span class="sc">$</span>mean,</span>
<span id="cb74-10"><a href="Disease.html#cb74-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>), <span class="fu">max</span>(summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>)),</span>
<span id="cb74-11"><a href="Disease.html#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Observed&quot;</span>,</span>
<span id="cb74-12"><a href="Disease.html#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;Fitted&quot;</span>,</span>
<span id="cb74-13"><a href="Disease.html#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb74-14"><a href="Disease.html#cb74-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">cex =</span> <span class="fl">0.7</span>,</span>
<span id="cb74-15"><a href="Disease.html#cb74-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span></span>
<span id="cb74-16"><a href="Disease.html#cb74-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb74-17"><a href="Disease.html#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N)</span>
<span id="cb74-18"><a href="Disease.html#cb74-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">segments</span>(y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">5%</span><span class="st">`</span>[i], y[i], summary_fit<span class="sc">$</span><span class="st">`</span><span class="at">95%</span><span class="st">`</span>[i])</span>
<span id="cb74-19"><a href="Disease.html#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.1%20stan%20posterior%20summary-2.png" width="672" /></p>
</div>
</div>
<div id="example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="section level2 unnumbered hasAnchor">
<h2>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-1" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Disease.html#nimble-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="Disease.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># to plot map</span></span>
<span id="cb75-2"><a href="Disease.html#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep) <span class="co"># read the shapefile (read_sf) and build neighbors list (poly2nb)</span></span>
<span id="cb75-3"><a href="Disease.html#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb75-4"><a href="Disease.html#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="Disease.html#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb75-6"><a href="Disease.html#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb75-7"><a href="Disease.html#cb75-7" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb75-8"><a href="Disease.html#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="Disease.html#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb75-10"><a href="Disease.html#cb75-10" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb75-11"><a href="Disease.html#cb75-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb75-12"><a href="Disease.html#cb75-12" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb75-13"><a href="Disease.html#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>Define a function to obtain the number of neighbors.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="Disease.html#cb76-1" aria-hidden="true" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb76-2"><a href="Disease.html#cb76-2" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb76-3"><a href="Disease.html#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb76-4"><a href="Disease.html#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb76-5"><a href="Disease.html#cb76-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb76-6"><a href="Disease.html#cb76-6" aria-hidden="true" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb76-7"><a href="Disease.html#cb76-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb76-8"><a href="Disease.html#cb76-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb76-9"><a href="Disease.html#cb76-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb76-10"><a href="Disease.html#cb76-10" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb76-11"><a href="Disease.html#cb76-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb76-12"><a href="Disease.html#cb76-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="Disease.html#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb77-2"><a href="Disease.html#cb77-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb77-3"><a href="Disease.html#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb77-4"><a href="Disease.html#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="Disease.html#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb77-6"><a href="Disease.html#cb77-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb77-7"><a href="Disease.html#cb77-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-8"><a href="Disease.html#cb77-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb77-9"><a href="Disease.html#cb77-9" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb77-10"><a href="Disease.html#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="Disease.html#cb77-11" aria-hidden="true" tabindex="-1"></a>neigh <span class="ot">=</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb77-12"><a href="Disease.html#cb77-12" aria-hidden="true" tabindex="-1"></a>numneigh <span class="ot">=</span> <span class="fu">apply</span>(W.mat,<span class="dv">2</span>,sum)</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="Disease.html#cb78-1" aria-hidden="true" tabindex="-1"></a>CAR_Code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb78-2"><a href="Disease.html#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Likelihood</span></span>
<span id="cb78-3"><a href="Disease.html#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb78-4"><a href="Disease.html#cb78-4" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb78-5"><a href="Disease.html#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">log</span>(lambda[i]) <span class="ot">&lt;-</span> <span class="fu">log</span>(E[i]) <span class="sc">+</span> b[i] <span class="sc">+</span> beta0</span>
<span id="cb78-6"><a href="Disease.html#cb78-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-7"><a href="Disease.html#cb78-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-8"><a href="Disease.html#cb78-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Priors</span></span>
<span id="cb78-9"><a href="Disease.html#cb78-9" aria-hidden="true" tabindex="-1"></a>  beta0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">0.98</span>)</span>
<span id="cb78-10"><a href="Disease.html#cb78-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-11"><a href="Disease.html#cb78-11" aria-hidden="true" tabindex="-1"></a>  b[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dcar_normal</span>(adj[<span class="dv">1</span><span class="sc">:</span>L], weights[<span class="dv">1</span><span class="sc">:</span>L], num[<span class="dv">1</span><span class="sc">:</span>N], tau, <span class="at">zero_mean =</span> <span class="dv">1</span>)</span>
<span id="cb78-12"><a href="Disease.html#cb78-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-13"><a href="Disease.html#cb78-13" aria-hidden="true" tabindex="-1"></a>  tau <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (sigma_b <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb78-14"><a href="Disease.html#cb78-14" aria-hidden="true" tabindex="-1"></a>  sigma_b <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="dv">0</span>,)</span>
<span id="cb78-15"><a href="Disease.html#cb78-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb78-16"><a href="Disease.html#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fitted values and likelihood for WAIC</span></span>
<span id="cb78-17"><a href="Disease.html#cb78-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb78-18"><a href="Disease.html#cb78-18" aria-hidden="true" tabindex="-1"></a>    fitted[i] <span class="sc">~</span> <span class="fu">dpois</span>(lambda[i])</span>
<span id="cb78-19"><a href="Disease.html#cb78-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb78-20"><a href="Disease.html#cb78-20" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Define the constants, data and initial values lists and run the model.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="Disease.html#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># constants list</span></span>
<span id="cb79-2"><a href="Disease.html#cb79-2" aria-hidden="true" tabindex="-1"></a>constants <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb79-3"><a href="Disease.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb79-4"><a href="Disease.html#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> expected<span class="sc">$</span>E2010,</span>
<span id="cb79-5"><a href="Disease.html#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">L =</span> <span class="fu">length</span>(neigh),</span>
<span id="cb79-6"><a href="Disease.html#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">adj =</span> neigh,</span>
<span id="cb79-7"><a href="Disease.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">length</span>(neigh)),</span>
<span id="cb79-8"><a href="Disease.html#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">num =</span> <span class="fu">as.vector</span>(numneigh),</span>
<span id="cb79-9"><a href="Disease.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">3</span></span>
<span id="cb79-10"><a href="Disease.html#cb79-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-11"><a href="Disease.html#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="co"># data list</span></span>
<span id="cb79-12"><a href="Disease.html#cb79-12" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">=</span> <span class="fu">list</span>(<span class="at">y =</span> observed<span class="sc">$</span>Y2010)</span>
<span id="cb79-13"><a href="Disease.html#cb79-13" aria-hidden="true" tabindex="-1"></a>inits <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb79-14"><a href="Disease.html#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta0 =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>),</span>
<span id="cb79-15"><a href="Disease.html#cb79-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitted =</span> <span class="fu">rpois</span>(N, <span class="dv">2</span>),</span>
<span id="cb79-16"><a href="Disease.html#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">sigma_b =</span> <span class="dv">1</span>,</span>
<span id="cb79-17"><a href="Disease.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb79-18"><a href="Disease.html#cb79-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-19"><a href="Disease.html#cb79-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-20"><a href="Disease.html#cb79-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Run model in nimble</span></span>
<span id="cb79-21"><a href="Disease.html#cb79-21" aria-hidden="true" tabindex="-1"></a>CAR_Model <span class="ot">=</span> <span class="fu">nimbleModel</span>(</span>
<span id="cb79-22"><a href="Disease.html#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">code =</span> CAR_Code,</span>
<span id="cb79-23"><a href="Disease.html#cb79-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">constants =</span> constants,</span>
<span id="cb79-24"><a href="Disease.html#cb79-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb79-25"><a href="Disease.html#cb79-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">inits =</span> inits</span>
<span id="cb79-26"><a href="Disease.html#cb79-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-27"><a href="Disease.html#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="Disease.html#cb79-28" aria-hidden="true" tabindex="-1"></a><span class="co"># QUESTION: can I run this model without configuring it as I did in the previous examples? </span></span>
<span id="cb79-29"><a href="Disease.html#cb79-29" aria-hidden="true" tabindex="-1"></a>CAR_conf <span class="ot">&lt;-</span></span>
<span id="cb79-30"><a href="Disease.html#cb79-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(CAR_Model, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;fitted&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;sigma_b&quot;</span>))</span>
<span id="cb79-31"><a href="Disease.html#cb79-31" aria-hidden="true" tabindex="-1"></a>CAR_MCMC <span class="ot">=</span> <span class="fu">buildMCMC</span>(</span>
<span id="cb79-32"><a href="Disease.html#cb79-32" aria-hidden="true" tabindex="-1"></a>  CAR_Model,</span>
<span id="cb79-33"><a href="Disease.html#cb79-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">enableWAIC =</span> T,</span>
<span id="cb79-34"><a href="Disease.html#cb79-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;fitted&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;sigma_b&quot;</span>)</span>
<span id="cb79-35"><a href="Disease.html#cb79-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb79-36"><a href="Disease.html#cb79-36" aria-hidden="true" tabindex="-1"></a>CAR_Cmodel <span class="ot">=</span> <span class="fu">compileNimble</span>(CAR_Model)</span>
<span id="cb79-37"><a href="Disease.html#cb79-37" aria-hidden="true" tabindex="-1"></a>CAR_Cmcmc <span class="ot">=</span> <span class="fu">compileNimble</span>(CAR_MCMC, <span class="at">project =</span> CAR_Model)</span>
<span id="cb79-38"><a href="Disease.html#cb79-38" aria-hidden="true" tabindex="-1"></a>CAR_runMCMC <span class="ot">=</span> <span class="fu">runMCMC</span>(</span>
<span id="cb79-39"><a href="Disease.html#cb79-39" aria-hidden="true" tabindex="-1"></a>  CAR_Cmcmc,</span>
<span id="cb79-40"><a href="Disease.html#cb79-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> <span class="dv">20000</span>,</span>
<span id="cb79-41"><a href="Disease.html#cb79-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> <span class="dv">40000</span>,</span>
<span id="cb79-42"><a href="Disease.html#cb79-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">80</span>,</span>
<span id="cb79-43"><a href="Disease.html#cb79-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb79-44"><a href="Disease.html#cb79-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>,</span>
<span id="cb79-45"><a href="Disease.html#cb79-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">WAIC =</span> T,</span>
<span id="cb79-46"><a href="Disease.html#cb79-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">summary =</span> <span class="cn">TRUE</span></span>
<span id="cb79-47"><a href="Disease.html#cb79-47" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Show the WAIC, effective sample size, and trace plots for some of the parameters.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="Disease.html#cb80-1" aria-hidden="true" tabindex="-1"></a>CAR_runMCMC<span class="sc">$</span>WAIC</span></code></pre></div>
<pre><code>## nimbleList object of type waicList
## Field &quot;WAIC&quot;:
## [1] 2432.088
## Field &quot;lppd&quot;:
## [1] -1071.777
## Field &quot;pWAIC&quot;:
## [1] 144.2669</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="Disease.html#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">min</span>(coda<span class="sc">::</span><span class="fu">effectiveSize</span>(CAR_runMCMC<span class="sc">$</span>samples))</span></code></pre></div>
<pre><code>## [1] 282.0092</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="Disease.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CAR_runMCMC<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20WAIC,%20ESS%20and%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="Disease.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CAR_runMCMC<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;b[2]&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20WAIC,%20ESS%20and%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="Disease.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(CAR_runMCMC<span class="sc">$</span>samples[, <span class="fu">c</span>(<span class="st">&quot;sigma_b&quot;</span>)])</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20WAIC,%20ESS%20and%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="Disease.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb87-2"><a href="Disease.html#cb87-2" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;sigma_b&quot;</span>)</span>
<span id="cb87-3"><a href="Disease.html#cb87-3" aria-hidden="true" tabindex="-1"></a>summary_CAR_nimble <span class="ot">&lt;-</span> CAR_runMCMC<span class="sc">$</span>summary<span class="sc">$</span>all.chains</span>
<span id="cb87-4"><a href="Disease.html#cb87-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-5"><a href="Disease.html#cb87-5" aria-hidden="true" tabindex="-1"></a>summary_CAR_nimble[variables,]</span></code></pre></div>
<pre><code>##                Mean      Median     St.Dev.   95%CI_low   95%CI_upp
## beta0   -0.06408205 -0.06401644 0.007503381 -0.07980628 -0.05019444
## sigma_b  0.40757884  0.40794431 0.024512633  0.36248136  0.45380645</code></pre>
<p>Map the mean of the posterior estimate for the latent effect.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="Disease.html#cb89-1" aria-hidden="true" tabindex="-1"></a>samples_CAR_b <span class="ot">&lt;-</span> summary_CAR_nimble[<span class="fu">grepl</span>(<span class="st">&quot;b</span><span class="sc">\\</span><span class="st">[&quot;</span>, <span class="fu">rownames</span>(summary_CAR_nimble)),] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb89-2"><a href="Disease.html#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="Disease.html#cb89-3" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb89-4"><a href="Disease.html#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="Disease.html#cb89-5" aria-hidden="true" tabindex="-1"></a>samples_CAR_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb89-6"><a href="Disease.html#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="Disease.html#cb89-7" aria-hidden="true" tabindex="-1"></a>CAR_nimble_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, samples_CAR_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>) </span>
<span id="cb89-8"><a href="Disease.html#cb89-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-9"><a href="Disease.html#cb89-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-10"><a href="Disease.html#cb89-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb89-11"><a href="Disease.html#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_nimble_merge, <span class="fu">aes</span>(<span class="at">fill =</span> Mean)) <span class="sc">+</span> </span>
<span id="cb89-12"><a href="Disease.html#cb89-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb89-13"><a href="Disease.html#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects stan&#39;</span>) <span class="sc">+</span></span>
<span id="cb89-14"><a href="Disease.html#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb89-15"><a href="Disease.html#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb89-16"><a href="Disease.html#cb89-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-17"><a href="Disease.html#cb89-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-18"><a href="Disease.html#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb89-19"><a href="Disease.html#cb89-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect =</span> <span class="fu">element_blank</span>()</span>
<span id="cb89-20"><a href="Disease.html#cb89-20" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p><img src="_main_files/figure-html/plot%20map%20nimble-1.png" width="672" /></p>
</div>
<div id="stan-1" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Disease.html#stan-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here, we implement the CAR model using <code>stan</code>.</p>
<!-- QUESTION: Is it ok to reload the data everytime? -->
<p>We will need two functions to structure the matrix of neighbors that will be needed in <code>stan</code>.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="Disease.html#cb90-1" aria-hidden="true" tabindex="-1"></a>adjlist <span class="ot">=</span> <span class="cf">function</span>(W, N) {</span>
<span id="cb90-2"><a href="Disease.html#cb90-2" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb90-3"><a href="Disease.html#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb90-4"><a href="Disease.html#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb90-5"><a href="Disease.html#cb90-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (W[i, j] <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb90-6"><a href="Disease.html#cb90-6" aria-hidden="true" tabindex="-1"></a>        adj <span class="ot">=</span> <span class="fu">append</span>(adj, j)</span>
<span id="cb90-7"><a href="Disease.html#cb90-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb90-8"><a href="Disease.html#cb90-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-9"><a href="Disease.html#cb90-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-10"><a href="Disease.html#cb90-10" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">=</span> adj[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb90-11"><a href="Disease.html#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(adj)</span>
<span id="cb90-12"><a href="Disease.html#cb90-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-13"><a href="Disease.html#cb90-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-14"><a href="Disease.html#cb90-14" aria-hidden="true" tabindex="-1"></a>mungeCARdata4stan <span class="ot">=</span> <span class="cf">function</span>(adjBUGS, numBUGS) {</span>
<span id="cb90-15"><a href="Disease.html#cb90-15" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">=</span> <span class="fu">length</span>(numBUGS)</span>
<span id="cb90-16"><a href="Disease.html#cb90-16" aria-hidden="true" tabindex="-1"></a>  nn <span class="ot">=</span> numBUGS</span>
<span id="cb90-17"><a href="Disease.html#cb90-17" aria-hidden="true" tabindex="-1"></a>  N_edges <span class="ot">=</span> <span class="fu">length</span>(adjBUGS) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb90-18"><a href="Disease.html#cb90-18" aria-hidden="true" tabindex="-1"></a>  node1 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb90-19"><a href="Disease.html#cb90-19" aria-hidden="true" tabindex="-1"></a>  node2 <span class="ot">=</span> <span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> N_edges)</span>
<span id="cb90-20"><a href="Disease.html#cb90-20" aria-hidden="true" tabindex="-1"></a>  iAdj <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb90-21"><a href="Disease.html#cb90-21" aria-hidden="true" tabindex="-1"></a>  iEdge <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb90-22"><a href="Disease.html#cb90-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-23"><a href="Disease.html#cb90-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb90-24"><a href="Disease.html#cb90-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nn[i]) {</span>
<span id="cb90-25"><a href="Disease.html#cb90-25" aria-hidden="true" tabindex="-1"></a>      iAdj <span class="ot">=</span> iAdj <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb90-26"><a href="Disease.html#cb90-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> adjBUGS[iAdj]) {</span>
<span id="cb90-27"><a href="Disease.html#cb90-27" aria-hidden="true" tabindex="-1"></a>        iEdge <span class="ot">=</span> iEdge <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb90-28"><a href="Disease.html#cb90-28" aria-hidden="true" tabindex="-1"></a>        node1[iEdge] <span class="ot">=</span> i</span>
<span id="cb90-29"><a href="Disease.html#cb90-29" aria-hidden="true" tabindex="-1"></a>        node2[iEdge] <span class="ot">=</span> adjBUGS[iAdj]</span>
<span id="cb90-30"><a href="Disease.html#cb90-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb90-31"><a href="Disease.html#cb90-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-32"><a href="Disease.html#cb90-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb90-33"><a href="Disease.html#cb90-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (<span class="fu">list</span>(</span>
<span id="cb90-34"><a href="Disease.html#cb90-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N&quot;</span> <span class="ot">=</span> N,</span>
<span id="cb90-35"><a href="Disease.html#cb90-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;N_edges&quot;</span> <span class="ot">=</span> N_edges,</span>
<span id="cb90-36"><a href="Disease.html#cb90-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node1&quot;</span> <span class="ot">=</span> node1,</span>
<span id="cb90-37"><a href="Disease.html#cb90-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;node2&quot;</span> <span class="ot">=</span> node2</span>
<span id="cb90-38"><a href="Disease.html#cb90-38" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb90-39"><a href="Disease.html#cb90-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-40"><a href="Disease.html#cb90-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!-- REVIEW: I am missing the adjacency matrix but I calculated like they did for the CARBayes example, is that right? -->
<p>Define the adjacency matrix and indexes for <code>stan</code> using the <code>nb2mat</code> and <code>adjlist</code></p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="Disease.html#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb91-2"><a href="Disease.html#cb91-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb91-3"><a href="Disease.html#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb91-4"><a href="Disease.html#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="Disease.html#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb91-6"><a href="Disease.html#cb91-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span>
<span id="cb91-7"><a href="Disease.html#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="Disease.html#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the spatial structure to use in stan</span></span>
<span id="cb91-9"><a href="Disease.html#cb91-9" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(england<span class="sc">$</span>ID))</span>
<span id="cb91-10"><a href="Disease.html#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="Disease.html#cb91-11" aria-hidden="true" tabindex="-1"></a>neigh <span class="ot">=</span> <span class="fu">adjlist</span>(W.mat, N)</span>
<span id="cb91-12"><a href="Disease.html#cb91-12" aria-hidden="true" tabindex="-1"></a>numneigh <span class="ot">=</span> <span class="fu">apply</span>(W.mat, <span class="dv">2</span>, sum)</span>
<span id="cb91-13"><a href="Disease.html#cb91-13" aria-hidden="true" tabindex="-1"></a>nbs <span class="ot">=</span> <span class="fu">mungeCARdata4stan</span>(neigh, numneigh)</span>
<span id="cb91-14"><a href="Disease.html#cb91-14" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> nbs<span class="sc">$</span>N</span>
<span id="cb91-15"><a href="Disease.html#cb91-15" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> nbs<span class="sc">$</span>node1</span>
<span id="cb91-16"><a href="Disease.html#cb91-16" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> nbs<span class="sc">$</span>node2</span>
<span id="cb91-17"><a href="Disease.html#cb91-17" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> nbs<span class="sc">$</span>N_edges</span></code></pre></div>
<p><code>Stan</code> model for CAR effects.
This model is in a separate file called <code>Example8_3.stan</code> that will be called later.</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  int&lt;lower=1&gt; N_edges;
  int&lt;lower=1, upper=N&gt; node1[N_edges];  // node1[i] adjacent to node2[i]
  int&lt;lower=1, upper=N&gt; node2[N_edges];  // and node1[i] &lt; node2[i]
  int&lt;lower=0&gt; y[N];              // count outcomes
  vector&lt;lower=0&gt;[N] E;           // exposure 
}

transformed data {
  vector[N] log_E = log(E);
}

parameters {
  real beta0;            // intercept
  vector[N] s;         // spatial effects
  real&lt;lower=0&gt; sigma_s;        // marginal standard deviation of spatial effects
}

transformed parameters {
  vector[N] b; // latent effect
  b =  sigma_s*s;
}

model {
  y ~ poisson_log(log_E + beta0 + b); 
  // This is the prior for s! (up to proportionality)
  target += -0.5 * dot_self(s[node1] - s[node2]);
  sum(s) ~ normal(0, 0.001 * N); 
  
  beta0 ~ normal(0.0, 10.0);
  sigma_s ~ normal(0.0,1.0);
}

generated quantities {
  vector[N] mu=exp(log_E + beta0 + b);
  vector[N] lik;
  vector[N] log_lik;
  
  for(i in 1:N){
    lik[i] = exp(poisson_lpmf(y[i] | mu[i] ));
    log_lik[i] = poisson_lpmf(y[i] | mu[i] );
  }
}</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="Disease.html#cb93-1" aria-hidden="true" tabindex="-1"></a>N_edges <span class="ot">=</span> N_edges</span>
<span id="cb93-2"><a href="Disease.html#cb93-2" aria-hidden="true" tabindex="-1"></a>node1 <span class="ot">=</span> node1</span>
<span id="cb93-3"><a href="Disease.html#cb93-3" aria-hidden="true" tabindex="-1"></a>node2 <span class="ot">=</span> node2</span>
<span id="cb93-4"><a href="Disease.html#cb93-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> N</span>
<span id="cb93-5"><a href="Disease.html#cb93-5" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> observed<span class="sc">$</span>Y2010</span>
<span id="cb93-6"><a href="Disease.html#cb93-6" aria-hidden="true" tabindex="-1"></a>E <span class="ot">=</span> expected<span class="sc">$</span>E2010</span>
<span id="cb93-7"><a href="Disease.html#cb93-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-8"><a href="Disease.html#cb93-8" aria-hidden="true" tabindex="-1"></a>ex.data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb93-9"><a href="Disease.html#cb93-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N,</span>
<span id="cb93-10"><a href="Disease.html#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb93-11"><a href="Disease.html#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb93-12"><a href="Disease.html#cb93-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_edges =</span> N_edges,</span>
<span id="cb93-13"><a href="Disease.html#cb93-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">node1 =</span> node1,</span>
<span id="cb93-14"><a href="Disease.html#cb93-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">node2 =</span> node2</span>
<span id="cb93-15"><a href="Disease.html#cb93-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb93-16"><a href="Disease.html#cb93-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-17"><a href="Disease.html#cb93-17" aria-hidden="true" tabindex="-1"></a>COPD_fitCAR  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb93-18"><a href="Disease.html#cb93-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example8_3.stan&quot;</span>,</span>
<span id="cb93-19"><a href="Disease.html#cb93-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ex.data,</span>
<span id="cb93-20"><a href="Disease.html#cb93-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">10000</span>,</span>
<span id="cb93-21"><a href="Disease.html#cb93-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">20000</span>,</span>
<span id="cb93-22"><a href="Disease.html#cb93-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb93-23"><a href="Disease.html#cb93-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb93-24"><a href="Disease.html#cb93-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;log_lik&quot;</span>),</span>
<span id="cb93-25"><a href="Disease.html#cb93-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb93-26"><a href="Disease.html#cb93-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Show traceplots.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="Disease.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co">#computing WAIC using the package loo</span></span>
<span id="cb94-2"><a href="Disease.html#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="Disease.html#cb94-3" aria-hidden="true" tabindex="-1"></a>loglikcar <span class="ot">&lt;-</span> <span class="fu">extract_log_lik</span>(COPD_fitCAR)</span>
<span id="cb94-4"><a href="Disease.html#cb94-4" aria-hidden="true" tabindex="-1"></a>waiccar <span class="ot">&lt;-</span> <span class="fu">waic</span>(loglikcar)</span></code></pre></div>
<pre><code>## Warning: 
## 130 (40.1%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="Disease.html#cb96-1" aria-hidden="true" tabindex="-1"></a>waiccar</span></code></pre></div>
<pre><code>## 
## Computed from 2000 by 324 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic  -1215.8 11.8
## p_waic       144.1  6.5
## waic        2431.7 23.5
## 
## 130 (40.1%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb98-1"><a href="Disease.html#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(COPD_fitCAR, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>,<span class="st">&quot;sigma_s&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%208.3%20stan%20CAR%20traceplots-1.png" width="672" /></p>
<p>Show the posterior summary for the parameters if interest.
Keep in mind that in the stan model the we are sampling the standard deviation of the random effect unlike <code>CARBayes</code> where the variance is obtained.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="Disease.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract samples</span></span>
<span id="cb99-2"><a href="Disease.html#cb99-2" aria-hidden="true" tabindex="-1"></a>summary_CAR_stan <span class="ot">&lt;-</span></span>
<span id="cb99-3"><a href="Disease.html#cb99-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb99-4"><a href="Disease.html#cb99-4" aria-hidden="true" tabindex="-1"></a>    COPD_fitCAR,</span>
<span id="cb99-5"><a href="Disease.html#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;beta0&quot;</span>, <span class="st">&quot;sigma_s&quot;</span>),</span>
<span id="cb99-6"><a href="Disease.html#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb99-7"><a href="Disease.html#cb99-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb99-8"><a href="Disease.html#cb99-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-9"><a href="Disease.html#cb99-9" aria-hidden="true" tabindex="-1"></a>summary_CAR_stan<span class="sc">$</span>summary</span></code></pre></div>
<pre><code>##                mean      se_mean          sd        2.5%       97.5%    n_eff
## beta0   -0.06461915 0.0001835412 0.007962486 -0.07996799 -0.04885839 1882.046
## sigma_s  0.41000124 0.0006351226 0.024939469  0.36417255  0.46078777 1541.911
##              Rhat
## beta0   0.9999884
## sigma_s 0.9990811</code></pre>
<p>Map the mean of the posterior estimate for the latent effect.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="Disease.html#cb101-1" aria-hidden="true" tabindex="-1"></a>summary_CAR_stan_b <span class="ot">&lt;-</span></span>
<span id="cb101-2"><a href="Disease.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(</span>
<span id="cb101-3"><a href="Disease.html#cb101-3" aria-hidden="true" tabindex="-1"></a>    COPD_fitCAR,</span>
<span id="cb101-4"><a href="Disease.html#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>),</span>
<span id="cb101-5"><a href="Disease.html#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)</span>
<span id="cb101-6"><a href="Disease.html#cb101-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-7"><a href="Disease.html#cb101-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-8"><a href="Disease.html#cb101-8" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(observed, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb101-9"><a href="Disease.html#cb101-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-10"><a href="Disease.html#cb101-10" aria-hidden="true" tabindex="-1"></a>summary_CAR_stan_b<span class="sc">$</span>ID <span class="ot">&lt;-</span> observed<span class="sc">$</span>ID</span>
<span id="cb101-11"><a href="Disease.html#cb101-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-12"><a href="Disease.html#cb101-12" aria-hidden="true" tabindex="-1"></a>CAR_stan_merge <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, summary_CAR_stan_b, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>) </span>
<span id="cb101-13"><a href="Disease.html#cb101-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-14"><a href="Disease.html#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb101-15"><a href="Disease.html#cb101-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb101-16"><a href="Disease.html#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> CAR_stan_merge, <span class="fu">aes</span>(<span class="at">fill =</span> summary.mean)) <span class="sc">+</span> </span>
<span id="cb101-17"><a href="Disease.html#cb101-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change legend&#39;s label</span></span>
<span id="cb101-18"><a href="Disease.html#cb101-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">&#39;Latent effects stan&#39;</span>) <span class="sc">+</span></span>
<span id="cb101-19"><a href="Disease.html#cb101-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb101-20"><a href="Disease.html#cb101-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb101-21"><a href="Disease.html#cb101-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb101-22"><a href="Disease.html#cb101-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb101-23"><a href="Disease.html#cb101-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb101-24"><a href="Disease.html#cb101-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect =</span> <span class="fu">element_blank</span>()</span>
<span id="cb101-25"><a href="Disease.html#cb101-25" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p><img src="_main_files/figure-html/plot%20map%20stan-1.png" width="672" /></p>
<!-- IDEA: Maybe we should agree on what output we will show for every method -->
</div>
</div>
<div id="example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="section level2 unnumbered hasAnchor">
<h2>Example 9.4: Fitting a conditional spatial model using CARBayes<a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the necessary libraries and the COPD data. As in example 5.2 <code>englandlocalauthority.shp</code> and it’s related files contain the location, shape, and attributes of English local authorities.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="Disease.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(CARBayes)</span>
<span id="cb102-2"><a href="Disease.html#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb102-3"><a href="Disease.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb102-4"><a href="Disease.html#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb102-5"><a href="Disease.html#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="Disease.html#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in borders</span></span>
<span id="cb102-7"><a href="Disease.html#cb102-7" aria-hidden="true" tabindex="-1"></a>england <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;data/englandlocalauthority.shp&quot;</span>)</span>
<span id="cb102-8"><a href="Disease.html#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="Disease.html#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Reading in data</span></span>
<span id="cb102-10"><a href="Disease.html#cb102-10" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span></span>
<span id="cb102-11"><a href="Disease.html#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityobserved.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb102-12"><a href="Disease.html#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="Disease.html#cb102-13" aria-hidden="true" tabindex="-1"></a>expected <span class="ot">&lt;-</span></span>
<span id="cb102-14"><a href="Disease.html#cb102-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">&quot;data/copdmortalityexpected.csv&quot;</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>To calculate the smoother SMRs, we first need to create a <em>neighborhood</em> structure. The functions <code>poly2nb()</code> and <code>nb2mat()</code> from the <code>spdep</code> package can be used to create this</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="Disease.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the neighborhood</span></span>
<span id="cb103-2"><a href="Disease.html#cb103-2" aria-hidden="true" tabindex="-1"></a>W.nb <span class="ot">&lt;-</span></span>
<span id="cb103-3"><a href="Disease.html#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">poly2nb</span>(england, <span class="at">row.names =</span> <span class="fu">rownames</span>(england))</span>
<span id="cb103-4"><a href="Disease.html#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="Disease.html#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates a matrix for following function call</span></span>
<span id="cb103-6"><a href="Disease.html#cb103-6" aria-hidden="true" tabindex="-1"></a>W.mat <span class="ot">&lt;-</span> <span class="fu">nb2mat</span>(W.nb, <span class="at">style =</span> <span class="st">&quot;B&quot;</span>)</span></code></pre></div>
<p>Here, we use <em>first neighbors</em> to define the structure, so any local authority sharing a border are considered neighbors.</p>
<p>The function <code>S.CARleroux()</code> allows us to use the neighborhood structure and performs a Bayesian analysis to create a smoothed set of observed values.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="Disease.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Running smoothing model</span></span>
<span id="cb104-2"><a href="Disease.html#cb104-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span></span>
<span id="cb104-3"><a href="Disease.html#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">S.CARleroux</span>(</span>
<span id="cb104-4"><a href="Disease.html#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model Formula</span></span>
<span id="cb104-5"><a href="Disease.html#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> observed<span class="sc">$</span>Y2010 <span class="sc">~</span> <span class="fu">offset</span>(<span class="fu">log</span>(expected<span class="sc">$</span>E2010)),</span>
<span id="cb104-6"><a href="Disease.html#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Choosing Poisson Regression</span></span>
<span id="cb104-7"><a href="Disease.html#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb104-8"><a href="Disease.html#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Neighborhood matrix</span></span>
<span id="cb104-9"><a href="Disease.html#cb104-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">W =</span> W.mat,</span>
<span id="cb104-10"><a href="Disease.html#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of burn in samples</span></span>
<span id="cb104-11"><a href="Disease.html#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">burnin =</span> <span class="dv">20000</span>,</span>
<span id="cb104-12"><a href="Disease.html#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of MCMC samples</span></span>
<span id="cb104-13"><a href="Disease.html#cb104-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">n.sample =</span> <span class="dv">100000</span>,</span>
<span id="cb104-14"><a href="Disease.html#cb104-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> <span class="dv">10</span>,</span>
<span id="cb104-15"><a href="Disease.html#cb104-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">rho =</span> <span class="dv">1</span></span>
<span id="cb104-16"><a href="Disease.html#cb104-16" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>We can extract the new smoother values from the model output and divide them by the expected values in order to compare both methods.</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb105-1"><a href="Disease.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a dataset with smoothed SMRs in 2010</span></span>
<span id="cb105-2"><a href="Disease.html#cb105-2" aria-hidden="true" tabindex="-1"></a>SMR2010 <span class="ot">&lt;-</span> model<span class="sc">$</span>fitted.values <span class="sc">/</span> expected<span class="sc">$</span>E2010</span>
<span id="cb105-3"><a href="Disease.html#cb105-3" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(SMR2010, <span class="at">row.names =</span> <span class="fu">rownames</span>(observed))</span></code></pre></div>
<p>Check that there are no errors and summarize the results</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="Disease.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Printing first six rows of smoothed SMRs</span></span>
<span id="cb106-2"><a href="Disease.html#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##        SMR2010
## 00AA 1.0107570
## 00AB 1.2643099
## 00AC 0.6882496
## 00AD 0.9748505
## 00AE 0.6019860
## 00AF 0.8601705</code></pre>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="Disease.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summarizing smoothed SMRs</span></span>
<span id="cb108-2"><a href="Disease.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(SMR_smooth)</span></code></pre></div>
<pre><code>##     SMR2010      
##  Min.   :0.5511  
##  1st Qu.:0.8002  
##  Median :0.9278  
##  Mean   :0.9693  
##  3rd Qu.:1.0854  
##  Max.   :1.7300</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="Disease.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of the parameters under the CAR model.</span></span>
<span id="cb110-2"><a href="Disease.html#cb110-2" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>summary.results[]</span></code></pre></div>
<pre><code>##                Mean   2.5%   97.5% n.sample % accept n.effective Geweke.diag
## (Intercept) -0.0643 -0.082 -0.0466     8000       34      7101.0         0.8
## tau2         0.1657  0.130  0.2081     8000      100      5761.2        -0.7
## rho          1.0000  1.000  1.0000       NA       NA          NA          NA</code></pre>
<p>Use <code>ggplot()</code> and <code>geom_sf()</code> to plot the map of smoothed SMRs.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r foldable"><code class="sourceCode r"><span id="cb112-1"><a href="Disease.html#cb112-1" aria-hidden="true" tabindex="-1"></a>SMR_smooth <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(SMR_smooth, <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb112-2"><a href="Disease.html#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="Disease.html#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Combining smoothed SMRs and the shapefile</span></span>
<span id="cb112-4"><a href="Disease.html#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="Disease.html#cb112-5" aria-hidden="true" tabindex="-1"></a>SMRspatial_smooth <span class="ot">&lt;-</span> <span class="fu">merge</span>(england, SMR_smooth, <span class="at">by =</span> <span class="st">&quot;ID&quot;</span>)</span>
<span id="cb112-6"><a href="Disease.html#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="Disease.html#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating breaks for legend in plot</span></span>
<span id="cb112-8"><a href="Disease.html#cb112-8" aria-hidden="true" tabindex="-1"></a>range <span class="ot">&lt;-</span></span>
<span id="cb112-9"><a href="Disease.html#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="fu">min</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">-</span> <span class="fl">0.01</span>,</span>
<span id="cb112-10"><a href="Disease.html#cb112-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">max</span>(SMR_smooth<span class="sc">$</span>SMR2010) <span class="sc">+</span> <span class="fl">0.01</span>,</span>
<span id="cb112-11"><a href="Disease.html#cb112-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">length.out =</span> <span class="dv">11</span>)</span>
<span id="cb112-12"><a href="Disease.html#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="Disease.html#cb112-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating map of smoothed SMRs in England in 2010</span></span>
<span id="cb112-14"><a href="Disease.html#cb112-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-15"><a href="Disease.html#cb112-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb112-16"><a href="Disease.html#cb112-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose spatial object and column for plotting</span></span>
<span id="cb112-17"><a href="Disease.html#cb112-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> SMRspatial_smooth, <span class="fu">aes</span>(<span class="at">fill =</span> SMR2010)) <span class="sc">+</span></span>
<span id="cb112-18"><a href="Disease.html#cb112-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Break points for colours</span></span>
<span id="cb112-19"><a href="Disease.html#cb112-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> range) <span class="sc">+</span></span>
<span id="cb112-20"><a href="Disease.html#cb112-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clear background and plot borders</span></span>
<span id="cb112-21"><a href="Disease.html#cb112-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb112-22"><a href="Disease.html#cb112-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb112-23"><a href="Disease.html#cb112-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb112-24"><a href="Disease.html#cb112-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb112-25"><a href="Disease.html#cb112-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">rect =</span> <span class="fu">element_blank</span>()</span>
<span id="cb112-26"><a href="Disease.html#cb112-26" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%209.4%20carbayes%20map%20smoothed%20SMRs-1.png" width="672" /></p>
</div>
<div id="example-9.5-fitting-a-conditional-model-using-inla" class="section level2 unnumbered hasAnchor">
<h2>Example 9.5: Fitting a conditional model using INLA<a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<!-- TODO: Show output for this model  -->
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="Disease.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run the INLA model</span></span>
<span id="cb113-2"><a href="Disease.html#cb113-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb113-3"><a href="Disease.html#cb113-3" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">f</span>(ID , <span class="at">model =</span> <span class="st">&quot;besag&quot;</span>, <span class="at">graph =</span> <span class="st">&quot;UK.adj&quot;</span>),</span>
<span id="cb113-4"><a href="Disease.html#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>,</span>
<span id="cb113-5"><a href="Disease.html#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">E =</span> E,</span>
<span id="cb113-6"><a href="Disease.html#cb113-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data,</span>
<span id="cb113-7"><a href="Disease.html#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">control.predictor =</span> <span class="fu">list</span>(<span class="at">compute =</span> <span class="cn">TRUE</span>)</span>
<span id="cb113-8"><a href="Disease.html#cb113-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="trusted.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="hazards.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/09-Chpt9.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
