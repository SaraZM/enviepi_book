<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-04-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="hazards.html"/>
<link rel="next" href="exposure.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a>
<ul>
<li class="chapter" data-level="" data-path="why.html"><a href="why.html#example-1.5"><i class="fa fa-check"></i>Example 1.5</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.9: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.10: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.11: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.12-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.12: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.13-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.13: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.14-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.14: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i>PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-variogram"><i class="fa fa-check"></i>Example 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.9 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-3"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-3"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.10-spatial-predictions"><i class="fa fa-check"></i>Example 10.10: Spatial predictions</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-4"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-4"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.11-inla-creating-a-mesh"><i class="fa fa-check"></i>Example 10.11: INLA, creating a mesh</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.13-directional-variograms"><i class="fa fa-check"></i>Example 10.13: Directional variograms</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.14-spatial-modeling-of-malaria-in-gambia"><i class="fa fa-check"></i>Example 10.14: Spatial modeling of malaria in Gambia</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-5"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-5"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-fitting-a-random-walk-model-to-pm10-concentrations-in-london"><i class="fa fa-check"></i>Example 11.16 Fitting a random walk model to PM10 concentrations in London</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nimble-6"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#stan-6"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-extra-implementation-of-a-dynamic-linear-model-uk-ozone-data"><i class="fa fa-check"></i>Example 11.16 EXTRA Implementation of a dynamic linear model: UK ozone data</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nimble-7"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#stan-7"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i>Solutions to Selected Exercises</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#exercise-11.11"><i class="fa fa-check"></i>Exercise 11.11</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#exercise-11.13"><i class="fa fa-check"></i>Exercise 11.13</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-2"><i class="fa fa-check"></i>Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i>Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i>Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i>Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Time" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> Time-why it also matters<a href="Time.html#Time" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The chapter contains the theory required for handling time series data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>That a temporal process consists of both low and high frequency components, the former playing a key role in determining long-term trends while the latter may be associated with shorter-term changes.</li>
<li>Techniques for the exploratory analysis of the data generated by the temporal process, including the ACF (correlogram) and PACF (periodogram).</li>
<li>Models for irregular (high frequency) components after the regular components (trend) have been removed.</li>
<li>Methods for forecasting, including exponential smoothing and ARIMA modelling.</li>
<li>The state space modelling approach, which sits naturally within a Bayesian setting and which provides a general framework for most of the classical time series models and many more besides.</li>
<li>Implementing time series processes within a Bayesian hierarchical framework.</li>
</ul>
<div id="example-11.1-ground-level-ozone-concentrations" class="section level2 unnumbered hasAnchor">
<h2>Example 11.1 Ground level ozone concentrations<a href="Time.html#example-11.1-ground-level-ozone-concentrations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the daily and hourly data for one site.</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="Time.html#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb267-2"><a href="Time.html#cb267-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-3"><a href="Time.html#cb267-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for one site</span></span>
<span id="cb267-4"><a href="Time.html#cb267-4" aria-hidden="true" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb267-5"><a href="Time.html#cb267-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-6"><a href="Time.html#cb267-6" aria-hidden="true" tabindex="-1"></a><span class="co"># change the format of the date column</span></span>
<span id="cb267-7"><a href="Time.html#cb267-7" aria-hidden="true" tabindex="-1"></a>site_daily<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(site_daily<span class="sc">$</span>date, <span class="st">&quot;%m/%d/%Y&quot;</span>)</span>
<span id="cb267-8"><a href="Time.html#cb267-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-9"><a href="Time.html#cb267-9" aria-hidden="true" tabindex="-1"></a><span class="co"># load hourly data from that same site</span></span>
<span id="cb267-10"><a href="Time.html#cb267-10" aria-hidden="true" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Plot the daily and hourly time series.</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb268-1"><a href="Time.html#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot daily data</span></span>
<span id="cb268-2"><a href="Time.html#cb268-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb268-3"><a href="Time.html#cb268-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb268-4"><a href="Time.html#cb268-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw a line at the first data</span></span>
<span id="cb268-5"><a href="Time.html#cb268-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">&quot;2013-01-01&quot;</span>), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb268-6"><a href="Time.html#cb268-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8 hour regulatory standard of 0.075 (ppm)</span></span>
<span id="cb268-7"><a href="Time.html#cb268-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb268-8"><a href="Time.html#cb268-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb268-9"><a href="Time.html#cb268-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.1%20plot%20time%20series-1.png" width="672" /></p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="Time.html#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot hourly data</span></span>
<span id="cb269-2"><a href="Time.html#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_hourly,) <span class="sc">+</span></span>
<span id="cb269-3"><a href="Time.html#cb269-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb269-4"><a href="Time.html#cb269-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb269-5"><a href="Time.html#cb269-5" aria-hidden="true" tabindex="-1"></a>   <span class="co"># 8 hour regulatory standard of 0.075 (ppm).</span></span>
<span id="cb269-6"><a href="Time.html#cb269-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb269-7"><a href="Time.html#cb269-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Hour in 2013&#39;s ozone season&quot;</span>) <span class="sc">+</span></span>
<span id="cb269-8"><a href="Time.html#cb269-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Hourly Ozone Concentration (ppm)&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.1%20plot%20time%20series-2.png" width="672" /></p>
</div>
<div id="example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average" class="section level2 unnumbered hasAnchor">
<h2>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average<a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For this example we will use the TTR package (Technical Trading Rules). This allow us to manipulate objects like time series for forecasting.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="Time.html#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb270-2"><a href="Time.html#cb270-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily data</span></span>
<span id="cb270-3"><a href="Time.html#cb270-3" aria-hidden="true" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb270-4"><a href="Time.html#cb270-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add an identifier column for each day in the sample</span></span>
<span id="cb270-5"><a href="Time.html#cb270-5" aria-hidden="true" tabindex="-1"></a>site_daily<span class="sc">$</span>day <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)</span></code></pre></div>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="Time.html#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add loess smooth</span></span>
<span id="cb271-2"><a href="Time.html#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Single day</span></span>
<span id="cb271-3"><a href="Time.html#cb271-3" aria-hidden="true" tabindex="-1"></a>ozone.loess <span class="ot">&lt;-</span> <span class="fu">loess</span>(max.ozone <span class="sc">~</span> day, <span class="at">span =</span> <span class="fl">0.75</span>, <span class="at">data =</span> site_daily[,<span class="fu">c</span>(<span class="st">&quot;max.ozone&quot;</span>, <span class="st">&quot;day&quot;</span>)])</span>
<span id="cb271-4"><a href="Time.html#cb271-4" aria-hidden="true" tabindex="-1"></a>ozone.predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(ozone.loess, <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)))</span>
<span id="cb271-5"><a href="Time.html#cb271-5" aria-hidden="true" tabindex="-1"></a>ozone.predict_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily),</span>
<span id="cb271-6"><a href="Time.html#cb271-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ozone.prediction =</span> ozone.predict)</span>
<span id="cb271-7"><a href="Time.html#cb271-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-8"><a href="Time.html#cb271-8" aria-hidden="true" tabindex="-1"></a>plot_SMA1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb271-9"><a href="Time.html#cb271-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb271-10"><a href="Time.html#cb271-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb271-11"><a href="Time.html#cb271-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-12"><a href="Time.html#cb271-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-13"><a href="Time.html#cb271-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Single day&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-14"><a href="Time.html#cb271-14" aria-hidden="true" tabindex="-1"></a> <span class="fu">theme_classic</span>()</span>
<span id="cb271-15"><a href="Time.html#cb271-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Three days</span></span>
<span id="cb271-16"><a href="Time.html#cb271-16" aria-hidden="true" tabindex="-1"></a>ozone_SMA3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">3</span>),</span>
<span id="cb271-17"><a href="Time.html#cb271-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb271-18"><a href="Time.html#cb271-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-19"><a href="Time.html#cb271-19" aria-hidden="true" tabindex="-1"></a>plot_SMA3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA3) <span class="sc">+</span></span>
<span id="cb271-20"><a href="Time.html#cb271-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb271-21"><a href="Time.html#cb271-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb271-22"><a href="Time.html#cb271-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-23"><a href="Time.html#cb271-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-24"><a href="Time.html#cb271-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Three days&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-25"><a href="Time.html#cb271-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb271-26"><a href="Time.html#cb271-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-27"><a href="Time.html#cb271-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-28"><a href="Time.html#cb271-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Six days</span></span>
<span id="cb271-29"><a href="Time.html#cb271-29" aria-hidden="true" tabindex="-1"></a>ozone_SMA6 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">6</span>),</span>
<span id="cb271-30"><a href="Time.html#cb271-30" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb271-31"><a href="Time.html#cb271-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-32"><a href="Time.html#cb271-32" aria-hidden="true" tabindex="-1"></a>plot_SMA6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA6) <span class="sc">+</span></span>
<span id="cb271-33"><a href="Time.html#cb271-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb271-34"><a href="Time.html#cb271-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb271-35"><a href="Time.html#cb271-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-36"><a href="Time.html#cb271-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-37"><a href="Time.html#cb271-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Six days&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-38"><a href="Time.html#cb271-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb271-39"><a href="Time.html#cb271-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-40"><a href="Time.html#cb271-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-41"><a href="Time.html#cb271-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Twelve days</span></span>
<span id="cb271-42"><a href="Time.html#cb271-42" aria-hidden="true" tabindex="-1"></a>ozone_SMA12 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb271-43"><a href="Time.html#cb271-43" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb271-44"><a href="Time.html#cb271-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-45"><a href="Time.html#cb271-45" aria-hidden="true" tabindex="-1"></a>plot_SMA12 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA12) <span class="sc">+</span></span>
<span id="cb271-46"><a href="Time.html#cb271-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb271-47"><a href="Time.html#cb271-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb271-48"><a href="Time.html#cb271-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at LA Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-49"><a href="Time.html#cb271-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-50"><a href="Time.html#cb271-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Twelve days&quot;</span>) <span class="sc">+</span></span>
<span id="cb271-51"><a href="Time.html#cb271-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb271-52"><a href="Time.html#cb271-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-53"><a href="Time.html#cb271-53" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(plot_SMA1, plot_SMA3, plot_SMA6, plot_SMA12, <span class="at">labels =</span> <span class="st">&quot;auto&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.2%20moving%20averages%20plot-1.png" width="672" /></p>
</div>
<div id="example-11.13-forecasting-ozone-levels" class="section level2 unnumbered hasAnchor">
<h2>Example 11.13 Forecasting ozone levels<a href="Time.html#example-11.13-forecasting-ozone-levels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb272"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb272-1"><a href="Time.html#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb272-2"><a href="Time.html#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb272-3"><a href="Time.html#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load hourly data for site 060379033</span></span>
<span id="cb272-4"><a href="Time.html#cb272-4" aria-hidden="true" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb272-5"><a href="Time.html#cb272-5" aria-hidden="true" tabindex="-1"></a><span class="co"># one night hour per day missing for instrument calibration - imputed for simplicity</span></span>
<span id="cb272-6"><a href="Time.html#cb272-6" aria-hidden="true" tabindex="-1"></a>imputeNA <span class="ot">&lt;-</span> <span class="fu">mean</span>(site_hourly<span class="sc">$</span>ozone, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb272-7"><a href="Time.html#cb272-7" aria-hidden="true" tabindex="-1"></a>site_hourly<span class="sc">$</span>ozone[<span class="fu">is.na</span>(site_hourly<span class="sc">$</span>ozone)] <span class="ot">&lt;-</span> imputeNA</span></code></pre></div>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="Time.html#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the first seven days in july</span></span>
<span id="cb273-2"><a href="Time.html#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="co"># days_pattern contains the dates for the first seven days</span></span>
<span id="cb273-3"><a href="Time.html#cb273-3" aria-hidden="true" tabindex="-1"></a>days_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;^2013070&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>)</span>
<span id="cb273-4"><a href="Time.html#cb273-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-5"><a href="Time.html#cb273-5" aria-hidden="true" tabindex="-1"></a><span class="co"># select all the rows that follow that pattern using grepl</span></span>
<span id="cb273-6"><a href="Time.html#cb273-6" aria-hidden="true" tabindex="-1"></a>july_seven_days <span class="ot">&lt;-</span> site_hourly[<span class="fu">grepl</span>(days_pattern, site_hourly<span class="sc">$</span>datetime),]</span>
<span id="cb273-7"><a href="Time.html#cb273-7" aria-hidden="true" tabindex="-1"></a>july_seven_days<span class="sc">$</span>hours <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(july_seven_days)</span>
<span id="cb273-8"><a href="Time.html#cb273-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-9"><a href="Time.html#cb273-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Holt-Winters model fitting</span></span>
<span id="cb273-10"><a href="Time.html#cb273-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn this into a time series object to use Holt-Winters forecast</span></span>
<span id="cb273-11"><a href="Time.html#cb273-11" aria-hidden="true" tabindex="-1"></a>level_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(july_seven_days<span class="sc">$</span>ozone,</span>
<span id="cb273-12"><a href="Time.html#cb273-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">frequency =</span> <span class="dv">24</span>,</span>
<span id="cb273-13"><a href="Time.html#cb273-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1</span>))</span>
<span id="cb273-14"><a href="Time.html#cb273-14" aria-hidden="true" tabindex="-1"></a>ozone_forecast <span class="ot">&lt;-</span> <span class="fu">HoltWinters</span>(level_ts)</span>
<span id="cb273-15"><a href="Time.html#cb273-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-16"><a href="Time.html#cb273-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using the default function</span></span>
<span id="cb273-17"><a href="Time.html#cb273-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb273-18"><a href="Time.html#cb273-18" aria-hidden="true" tabindex="-1"></a>  ozone_forecast,</span>
<span id="cb273-19"><a href="Time.html#cb273-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Hours - First Week -July 2013&quot;</span>,</span>
<span id="cb273-20"><a href="Time.html#cb273-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;O3 (ppm)&quot;</span>,</span>
<span id="cb273-21"><a href="Time.html#cb273-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">col.predicted =</span> <span class="dv">1</span>,</span>
<span id="cb273-22"><a href="Time.html#cb273-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb273-23"><a href="Time.html#cb273-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb273-24"><a href="Time.html#cb273-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb273-25"><a href="Time.html#cb273-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20data%20munge-1.png" width="672" /></p>
<div class="sourceCode" id="cb274"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb274-1"><a href="Time.html#cb274-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Holt- Winters 24 ahead forast on Day 8</span></span>
<span id="cb274-2"><a href="Time.html#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="co"># no need to specify Holt-Winters forecast as the object is already HoltWinters class</span></span>
<span id="cb274-3"><a href="Time.html#cb274-3" aria-hidden="true" tabindex="-1"></a>ozoneforecast_day8 <span class="ot">&lt;-</span> <span class="fu">forecast</span>(ozone_forecast, <span class="at">h=</span><span class="dv">24</span>)</span>
<span id="cb274-4"><a href="Time.html#cb274-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb274-5"><a href="Time.html#cb274-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using default function</span></span>
<span id="cb274-6"><a href="Time.html#cb274-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ozoneforecast_day8, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.13%20data%20munge-2.png" width="672" /></p>
</div>
<div id="example-11.14-forecasting-volcanic-ash" class="section level2 unnumbered hasAnchor">
<h2>Example 11.14 Forecasting volcanic ash<a href="Time.html#example-11.14-forecasting-volcanic-ash" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data in this example consists of atmospheric levels of volcanic ash from 1500AD to 2000AD.</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="Time.html#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb275-2"><a href="Time.html#cb275-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb275-3"><a href="Time.html#cb275-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb275-4"><a href="Time.html#cb275-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-5"><a href="Time.html#cb275-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load volcano dust data</span></span>
<span id="cb275-6"><a href="Time.html#cb275-6" aria-hidden="true" tabindex="-1"></a><span class="do">## REVIEW: Data source: Hyn�d�man, R.J.  Time Series Data Library, http://data.is/TSDLdemo</span></span>
<span id="cb275-7"><a href="Time.html#cb275-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cover the period from 1500AD to 2000AD</span></span>
<span id="cb275-8"><a href="Time.html#cb275-8" aria-hidden="true" tabindex="-1"></a>volcano_dust <span class="ot">&lt;-</span></span>
<span id="cb275-9"><a href="Time.html#cb275-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scan</span>(<span class="st">&quot;https://robjhyndman.com/tsdldata/annual/dvi.dat&quot;</span>, <span class="at">skip =</span> <span class="dv">1</span>)</span></code></pre></div>
<p>The following figure shows the plot of the original time series.</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb276-1"><a href="Time.html#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn data into data frame to plot it in ggplot</span></span>
<span id="cb276-2"><a href="Time.html#cb276-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">year =</span> <span class="dv">1500</span><span class="sc">:</span>(<span class="dv">1500</span><span class="sc">+</span><span class="fu">length</span>(volcano_dust)<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb276-3"><a href="Time.html#cb276-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">dust =</span> volcano_dust)</span>
<span id="cb276-4"><a href="Time.html#cb276-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb276-5"><a href="Time.html#cb276-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> volcano_dust_df) <span class="sc">+</span></span>
<span id="cb276-6"><a href="Time.html#cb276-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> dust, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb276-7"><a href="Time.html#cb276-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="sc">+</span></span>
<span id="cb276-8"><a href="Time.html#cb276-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Atmospheric levels of volcanic ash&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20plot%20time%20series%20ACF%20and%20PACF-1.png" width="672" /></p>
<p>We can also plot the autocorrelogram (ACF) and partial autocorrelogram (PACF) to identify any autocorrelation in the time series.</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="Time.html#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert data into a time series object</span></span>
<span id="cb277-2"><a href="Time.html#cb277-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_series <span class="ot">&lt;-</span> <span class="fu">ts</span>(volcano_dust, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1500</span>))</span>
<span id="cb277-3"><a href="Time.html#cb277-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute autocorrelogram with max lag 20</span></span>
<span id="cb277-4"><a href="Time.html#cb277-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(</span>
<span id="cb277-5"><a href="Time.html#cb277-5" aria-hidden="true" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb277-6"><a href="Time.html#cb277-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb277-7"><a href="Time.html#cb277-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb277-8"><a href="Time.html#cb277-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Autocorrelogram volcano dust&quot;</span></span>
<span id="cb277-9"><a href="Time.html#cb277-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20acf%20and%20pacf-1.png" width="672" /></p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="Time.html#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the partial autocorrelogram with max lag 20</span></span>
<span id="cb278-2"><a href="Time.html#cb278-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pacf</span>(</span>
<span id="cb278-3"><a href="Time.html#cb278-3" aria-hidden="true" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb278-4"><a href="Time.html#cb278-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb278-5"><a href="Time.html#cb278-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb278-6"><a href="Time.html#cb278-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Partial autocorrelogram volcano dust&quot;</span></span>
<span id="cb278-7"><a href="Time.html#cb278-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20acf%20and%20pacf-2.png" width="672" /></p>
<div class="sourceCode" id="cb279"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb279-1"><a href="Time.html#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding an ARIMA model</span></span>
<span id="cb279-2"><a href="Time.html#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(volcano_dust_series, <span class="at">ic =</span> <span class="st">&quot;aic&quot;</span>)</span></code></pre></div>
<pre><code>## Series: volcano_dust_series 
## ARIMA(1,0,2) with non-zero mean 
## 
## Coefficients:
##          ar1     ma1     ma2     mean
##       0.4723  0.2694  0.1279  57.5178
## s.e.  0.0936  0.0969  0.0752   8.4883
## 
## sigma^2 = 4897:  log likelihood = -2661.84
## AIC=5333.68   AICc=5333.81   BIC=5354.45</code></pre>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="Time.html#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting the ARIMA(2,0,0) model</span></span>
<span id="cb281-2"><a href="Time.html#cb281-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_arima <span class="ot">&lt;-</span> <span class="fu">arima</span>(volcano_dust_series, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb281-3"><a href="Time.html#cb281-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-4"><a href="Time.html#cb281-4" aria-hidden="true" tabindex="-1"></a><span class="co"># forecast 31 years with the ARIMA(2,0,0) model</span></span>
<span id="cb281-5"><a href="Time.html#cb281-5" aria-hidden="true" tabindex="-1"></a>volcano_dust_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(volcano_dust_arima, <span class="at">h =</span> <span class="dv">31</span>)</span>
<span id="cb281-6"><a href="Time.html#cb281-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(volcano_dust_forecast, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.14%20arima%20model-1.png" width="672" /></p>
</div>
<div id="example-11.16-fitting-a-random-walk-model-to-pm10-concentrations-in-london" class="section level2 unnumbered hasAnchor">
<h2>Example 11.16 Fitting a random walk model to PM10 concentrations in London<a href="Time.html#example-11.16-fitting-a-random-walk-model-to-pm10-concentrations-in-london" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="blackbox">
<div class="center">
<p><strong>NOTE</strong></p>
</div>
<p>The code for the implementation of DLMs in Stan and Nimble was developed by Paritosh Kumar Roy. This code and other more complex DLM structures are available through his <a href="https://github.com/paritoshkroy">github</a>.</p>
</div>
<div id="nimble-6" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Time.html#nimble-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb282"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb282-1"><a href="Time.html#cb282-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb282-2"><a href="Time.html#cb282-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb282-3"><a href="Time.html#cb282-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb282-4"><a href="Time.html#cb282-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb282-5"><a href="Time.html#cb282-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb282-6"><a href="Time.html#cb282-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/FFBS_functions_nimble.R&quot;</span>) <span class="co"># load necessary functions for ffbs</span></span>
<span id="cb282-7"><a href="Time.html#cb282-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data </span></span>
<span id="cb282-8"><a href="Time.html#cb282-8" aria-hidden="true" tabindex="-1"></a>pm10 <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/11_13_data.txt&quot;</span>)[[<span class="st">&quot;value&quot;</span>]][[<span class="st">&quot;y&quot;</span>]] <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb282-9"><a href="Time.html#cb282-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb282-10"><a href="Time.html#cb282-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose 250 days for example</span></span>
<span id="cb282-11"><a href="Time.html#cb282-11" aria-hidden="true" tabindex="-1"></a>pm10_250 <span class="ot">&lt;-</span> pm10[<span class="dv">385</span><span class="sc">:</span><span class="dv">634</span>]</span></code></pre></div>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="Time.html#cb283-1" aria-hidden="true" tabindex="-1"></a>Example11_16_PM10_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb283-2"><a href="Time.html#cb283-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb283-3"><a href="Time.html#cb283-3" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb283-4"><a href="Time.html#cb283-4" aria-hidden="true" tabindex="-1"></a>  Vt <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb283-5"><a href="Time.html#cb283-5" aria-hidden="true" tabindex="-1"></a>  sqrt_Wt_diag <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb283-6"><a href="Time.html#cb283-6" aria-hidden="true" tabindex="-1"></a>  Wt <span class="ot">&lt;-</span> sqrt_Wt_diag<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb283-7"><a href="Time.html#cb283-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb283-8"><a href="Time.html#cb283-8" aria-hidden="true" tabindex="-1"></a>  theta_mean[<span class="dv">1</span>] <span class="ot">&lt;-</span> m0</span>
<span id="cb283-9"><a href="Time.html#cb283-9" aria-hidden="true" tabindex="-1"></a>  theta[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(theta_mean[<span class="dv">1</span>], <span class="at">var =</span> C0)</span>
<span id="cb283-10"><a href="Time.html#cb283-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb283-11"><a href="Time.html#cb283-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>J) {</span>
<span id="cb283-12"><a href="Time.html#cb283-12" aria-hidden="true" tabindex="-1"></a>    theta_mean[t<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> Gt <span class="sc">*</span> theta[t]</span>
<span id="cb283-13"><a href="Time.html#cb283-13" aria-hidden="true" tabindex="-1"></a>    theta[t<span class="sc">+</span><span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(theta_mean[t<span class="sc">+</span><span class="dv">1</span>], <span class="at">var =</span> Wt)</span>
<span id="cb283-14"><a href="Time.html#cb283-14" aria-hidden="true" tabindex="-1"></a>    yt_mean[t] <span class="ot">&lt;-</span> Ft[t] <span class="sc">*</span> theta[t<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb283-15"><a href="Time.html#cb283-15" aria-hidden="true" tabindex="-1"></a>    yt[t] <span class="sc">~</span> <span class="fu">dnorm</span>(yt_mean[t], <span class="at">var =</span> Vt)</span>
<span id="cb283-16"><a href="Time.html#cb283-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-17"><a href="Time.html#cb283-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb283-18"><a href="Time.html#cb283-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb284"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb284-1"><a href="Time.html#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb284-2"><a href="Time.html#cb284-2" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(pm10_250)</span>
<span id="cb284-3"><a href="Time.html#cb284-3" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">&lt;-</span>pm10_250</span>
<span id="cb284-4"><a href="Time.html#cb284-4" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, J)</span>
<span id="cb284-5"><a href="Time.html#cb284-5" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb284-6"><a href="Time.html#cb284-6" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(yt, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-7"><a href="Time.html#cb284-7" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb284-8"><a href="Time.html#cb284-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb284-9"><a href="Time.html#cb284-9" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">J =</span> J)</span>
<span id="cb284-10"><a href="Time.html#cb284-10" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb284-11"><a href="Time.html#cb284-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">yt =</span> yt,</span>
<span id="cb284-12"><a href="Time.html#cb284-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb284-13"><a href="Time.html#cb284-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Gt =</span> Gt,</span>
<span id="cb284-14"><a href="Time.html#cb284-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb284-15"><a href="Time.html#cb284-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb284-16"><a href="Time.html#cb284-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb284-17"><a href="Time.html#cb284-17" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span></span>
<span id="cb284-18"><a href="Time.html#cb284-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>,</span>
<span id="cb284-19"><a href="Time.html#cb284-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">sqrt_Wt_diag =</span> <span class="fl">0.1</span>,</span>
<span id="cb284-20"><a href="Time.html#cb284-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">theta =</span> <span class="fu">rep</span>(<span class="dv">0</span>, J <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb284-21"><a href="Time.html#cb284-21" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb284-22"><a href="Time.html#cb284-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb284-23"><a href="Time.html#cb284-23" aria-hidden="true" tabindex="-1"></a>    Example11_16_PM10_Nimble,</span>
<span id="cb284-24"><a href="Time.html#cb284-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb284-25"><a href="Time.html#cb284-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb284-26"><a href="Time.html#cb284-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb284-27"><a href="Time.html#cb284-27" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb284-28"><a href="Time.html#cb284-28" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb284-29"><a href="Time.html#cb284-29" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb284-30"><a href="Time.html#cb284-30" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb284-31"><a href="Time.html#cb284-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;yt&quot;</span>))</span>
<span id="cb284-32"><a href="Time.html#cb284-32" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;theta[]&quot;</span>)</span>
<span id="cb284-33"><a href="Time.html#cb284-33" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(</span>
<span id="cb284-34"><a href="Time.html#cb284-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">target =</span> <span class="st">&quot;theta&quot;</span>,</span>
<span id="cb284-35"><a href="Time.html#cb284-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;ffbs_uous&quot;</span>,</span>
<span id="cb284-36"><a href="Time.html#cb284-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(</span>
<span id="cb284-37"><a href="Time.html#cb284-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">ytName =</span> <span class="st">&quot;yt&quot;</span>,</span>
<span id="cb284-38"><a href="Time.html#cb284-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">FtName =</span> <span class="st">&quot;Ft&quot;</span>,</span>
<span id="cb284-39"><a href="Time.html#cb284-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">VtName =</span> <span class="st">&quot;Vt&quot;</span>,</span>
<span id="cb284-40"><a href="Time.html#cb284-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">GtName =</span> <span class="st">&quot;Gt&quot;</span>,</span>
<span id="cb284-41"><a href="Time.html#cb284-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">WtName =</span> <span class="st">&quot;Wt&quot;</span>,</span>
<span id="cb284-42"><a href="Time.html#cb284-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">m0Name =</span> <span class="st">&quot;m0&quot;</span>,</span>
<span id="cb284-43"><a href="Time.html#cb284-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">C0Name =</span> <span class="st">&quot;C0&quot;</span></span>
<span id="cb284-44"><a href="Time.html#cb284-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb284-45"><a href="Time.html#cb284-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb284-46"><a href="Time.html#cb284-46" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">byType =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-47"><a href="Time.html#cb284-47" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;sqrt_Wt_diag&quot;</span>)</span>
<span id="cb284-48"><a href="Time.html#cb284-48" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&quot;sqrt_Wt_diag&quot;</span>,</span>
<span id="cb284-49"><a href="Time.html#cb284-49" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="st">&quot;RW&quot;</span>,</span>
<span id="cb284-50"><a href="Time.html#cb284-50" aria-hidden="true" tabindex="-1"></a>                <span class="at">control =</span> <span class="fu">list</span>(<span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb284-51"><a href="Time.html#cb284-51" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;tau&quot;</span>)</span>
<span id="cb284-52"><a href="Time.html#cb284-52" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&quot;tau&quot;</span>,</span>
<span id="cb284-53"><a href="Time.html#cb284-53" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="st">&quot;RW&quot;</span>,</span>
<span id="cb284-54"><a href="Time.html#cb284-54" aria-hidden="true" tabindex="-1"></a>                <span class="at">control =</span> <span class="fu">list</span>(<span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb284-55"><a href="Time.html#cb284-55" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">byType =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-56"><a href="Time.html#cb284-56" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">executionOrder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb284-57"><a href="Time.html#cb284-57" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb284-58"><a href="Time.html#cb284-58" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb284-59"><a href="Time.html#cb284-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb284-60"><a href="Time.html#cb284-60" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb284-61"><a href="Time.html#cb284-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb284-62"><a href="Time.html#cb284-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb284-63"><a href="Time.html#cb284-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span></span>
<span id="cb284-64"><a href="Time.html#cb284-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb284-65"><a href="Time.html#cb284-65" aria-hidden="true" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">60000</span></span>
<span id="cb284-66"><a href="Time.html#cb284-66" aria-hidden="true" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb284-67"><a href="Time.html#cb284-67" aria-hidden="true" tabindex="-1"></a>nchain <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb284-68"><a href="Time.html#cb284-68" aria-hidden="true" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb284-69"><a href="Time.html#cb284-69" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb284-70"><a href="Time.html#cb284-70" aria-hidden="true" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb284-71"><a href="Time.html#cb284-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> niter,</span>
<span id="cb284-72"><a href="Time.html#cb284-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnin,</span>
<span id="cb284-73"><a href="Time.html#cb284-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nthin,</span>
<span id="cb284-74"><a href="Time.html#cb284-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nchain,</span>
<span id="cb284-75"><a href="Time.html#cb284-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb284-76"><a href="Time.html#cb284-76" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="Time.html#cb285-1" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb285-2"><a href="Time.html#cb285-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb285-3"><a href="Time.html#cb285-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots</span></span>
<span id="cb285-4"><a href="Time.html#cb285-4" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb285-5"><a href="Time.html#cb285-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.chain, .iteration, .draw, <span class="st">&#39;tau&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb285-6"><a href="Time.html#cb285-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb285-7"><a href="Time.html#cb285-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb285-8"><a href="Time.html#cb285-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb285-9"><a href="Time.html#cb285-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb285-10"><a href="Time.html#cb285-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb285-11"><a href="Time.html#cb285-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb285-12"><a href="Time.html#cb285-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb285-13"><a href="Time.html#cb285-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20nimble%20extract%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="Time.html#cb286-1" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb286-2"><a href="Time.html#cb286-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.chain, .iteration, .draw, <span class="st">&#39;sqrt_Wt_diag&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb286-3"><a href="Time.html#cb286-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb286-4"><a href="Time.html#cb286-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb286-5"><a href="Time.html#cb286-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb286-6"><a href="Time.html#cb286-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb286-7"><a href="Time.html#cb286-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb286-8"><a href="Time.html#cb286-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb286-9"><a href="Time.html#cb286-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb286-10"><a href="Time.html#cb286-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20nimble%20extract%20posterior%20summary-2.png" width="672" /></p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="Time.html#cb287-1" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb287-2"><a href="Time.html#cb287-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.chain, .iteration, .draw, <span class="fu">paste0</span>(<span class="st">&#39;theta[&#39;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>),<span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb287-3"><a href="Time.html#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb287-4"><a href="Time.html#cb287-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb287-5"><a href="Time.html#cb287-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb287-6"><a href="Time.html#cb287-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb287-7"><a href="Time.html#cb287-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb287-8"><a href="Time.html#cb287-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb287-9"><a href="Time.html#cb287-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb287-10"><a href="Time.html#cb287-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20nimble%20extract%20posterior%20summary-3.png" width="672" /></p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="Time.html#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(post_summary)</span></code></pre></div>
<pre><code>##              post.mean post.sd   q2.5    q50  q97.5 f0    n.eff  Rhat
## sqrt_Wt_diag     4.547   0.873  2.988  4.513  6.398  1  530.716 1.000
## tau              6.765   0.684  5.372  6.773  8.057  1  736.766 1.000
## theta[1]        26.086   2.832 20.642 26.032 31.613  1 3966.763 1.001
## theta[2]        25.687   3.547 18.921 25.672 32.679  1 3983.608 1.000
## theta[3]        22.765   3.688 15.613 22.837 29.896  1 4284.000 1.001
## theta[4]        19.140   3.830 11.596 19.111 26.576  1 3575.991 1.000</code></pre>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="Time.html#cb290-1" aria-hidden="true" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb290-2"><a href="Time.html#cb290-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb290-3"><a href="Time.html#cb290-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb290-4"><a href="Time.html#cb290-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))) <span class="sc">|&gt;</span></span>
<span id="cb290-5"><a href="Time.html#cb290-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(time, post.mean, post.sd, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb290-6"><a href="Time.html#cb290-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb290-7"><a href="Time.html#cb290-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb290-8"><a href="Time.html#cb290-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb290-9"><a href="Time.html#cb290-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb290-10"><a href="Time.html#cb290-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb290-11"><a href="Time.html#cb290-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time (days)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb290-12"><a href="Time.html#cb290-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;Trend &quot;</span>, PM[<span class="dv">10</span>], <span class="st">&quot; London site&quot;</span>))) <span class="sc">+</span></span>
<span id="cb290-13"><a href="Time.html#cb290-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/11.16%20pm10%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="Time.html#cb291-1" aria-hidden="true" tabindex="-1"></a>npsample <span class="ot">&lt;-</span> <span class="fu">floor</span>((niter <span class="sc">-</span> nburnin)<span class="sc">/</span>nthin)</span>
<span id="cb291-2"><a href="Time.html#cb291-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-3"><a href="Time.html#cb291-3" aria-hidden="true" tabindex="-1"></a>Cnim_postfit_uous <span class="ot">&lt;-</span></span>
<span id="cb291-4"><a href="Time.html#cb291-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(nim_postfit_uous, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="Time.html#cb293-1" aria-hidden="true" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb293-2"><a href="Time.html#cb293-2" aria-hidden="true" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sqrt_Wt_diag</span>
<span id="cb293-3"><a href="Time.html#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="co"># post_yt &lt;- tidy_post_samples$yt</span></span>
<span id="cb293-4"><a href="Time.html#cb293-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-5"><a href="Time.html#cb293-5" aria-hidden="true" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(nchain <span class="sc">*</span> npsample), <span class="cf">function</span>(i) {</span>
<span id="cb293-6"><a href="Time.html#cb293-6" aria-hidden="true" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i] <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb293-7"><a href="Time.html#cb293-7" aria-hidden="true" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> post_sqrt_Wt_diag[i] <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb293-8"><a href="Time.html#cb293-8" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uous</span>(</span>
<span id="cb293-9"><a href="Time.html#cb293-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">yt =</span> dat_list<span class="sc">$</span>yt,</span>
<span id="cb293-10"><a href="Time.html#cb293-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft,</span>
<span id="cb293-11"><a href="Time.html#cb293-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Vt =</span> post_Vt,</span>
<span id="cb293-12"><a href="Time.html#cb293-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt,</span>
<span id="cb293-13"><a href="Time.html#cb293-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Wt =</span> post_Wt,</span>
<span id="cb293-14"><a href="Time.html#cb293-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0,</span>
<span id="cb293-15"><a href="Time.html#cb293-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0</span>
<span id="cb293-16"><a href="Time.html#cb293-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb293-17"><a href="Time.html#cb293-17" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span></span>
<span id="cb293-18"><a href="Time.html#cb293-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb293-19"><a href="Time.html#cb293-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb293-20"><a href="Time.html#cb293-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb293-21"><a href="Time.html#cb293-21" aria-hidden="true" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb293-22"><a href="Time.html#cb293-22" aria-hidden="true" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb293-23"><a href="Time.html#cb293-23" aria-hidden="true" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb293-24"><a href="Time.html#cb293-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb293-25"><a href="Time.html#cb293-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb293-26"><a href="Time.html#cb293-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb293-27"><a href="Time.html#cb293-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb293-28"><a href="Time.html#cb293-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb293-29"><a href="Time.html#cb293-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb293-30"><a href="Time.html#cb293-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb293-31"><a href="Time.html#cb293-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-32"><a href="Time.html#cb293-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb293-33"><a href="Time.html#cb293-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb293-34"><a href="Time.html#cb293-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean), <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb293-35"><a href="Time.html#cb293-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb293-36"><a href="Time.html#cb293-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="fu">bquote</span>(<span class="st">&quot;PM&quot;</span>[<span class="dv">10</span>]<span class="sc">~</span><span class="st">&quot;Concentration&quot;</span>)) <span class="sc">+</span></span>
<span id="cb293-37"><a href="Time.html#cb293-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time (days)&quot;</span>) <span class="sc">+</span> </span>
<span id="cb293-38"><a href="Time.html#cb293-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;Fitted values &quot;</span>, PM[<span class="dv">10</span>], <span class="st">&quot; London site&quot;</span>))) <span class="sc">+</span></span>
<span id="cb293-39"><a href="Time.html#cb293-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20nimble%20fitted%20values-1.png" width="672" /></p>
</div>
<div id="stan-6" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Time.html#stan-6" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="Time.html#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb294-2"><a href="Time.html#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb294-3"><a href="Time.html#cb294-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb294-4"><a href="Time.html#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb294-5"><a href="Time.html#cb294-5" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb294-6"><a href="Time.html#cb294-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb294-7"><a href="Time.html#cb294-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-8"><a href="Time.html#cb294-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-9"><a href="Time.html#cb294-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: change the name of this dataset cause it is used here and in the exercises</span></span>
<span id="cb294-10"><a href="Time.html#cb294-10" aria-hidden="true" tabindex="-1"></a>pm10 <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/11_13_data.txt&quot;</span>)[[<span class="st">&quot;value&quot;</span>]][[<span class="st">&quot;y&quot;</span>]] <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb294-11"><a href="Time.html#cb294-11" aria-hidden="true" tabindex="-1"></a>pm10_250 <span class="ot">&lt;-</span> pm10[<span class="dv">385</span><span class="sc">:</span><span class="dv">634</span>]</span></code></pre></div>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="Time.html#cb295-1" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(pm10_250)</span>
<span id="cb295-2"><a href="Time.html#cb295-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> pm10_250</span>
<span id="cb295-3"><a href="Time.html#cb295-3" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, J)</span>
<span id="cb295-4"><a href="Time.html#cb295-4" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb295-5"><a href="Time.html#cb295-5" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb295-6"><a href="Time.html#cb295-6" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb295-7"><a href="Time.html#cb295-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb295-8"><a href="Time.html#cb295-8" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb295-9"><a href="Time.html#cb295-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Tt =</span> J,</span>
<span id="cb295-10"><a href="Time.html#cb295-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb295-11"><a href="Time.html#cb295-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb295-12"><a href="Time.html#cb295-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">G =</span> Gt,</span>
<span id="cb295-13"><a href="Time.html#cb295-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb295-14"><a href="Time.html#cb295-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb295-15"><a href="Time.html#cb295-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>functions {
    real uous_dlm_ldensity(array[] real y, array[] real Ft, real G, real V, real W, real m0, real C0, int Tt){
    array[Tt+1] real a;
    array[Tt+1] real R;
    array[Tt] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:Tt) {
      real u;
      real Q;
      real A;
      real L;
      u = y[i] - Ft[i] * a[i];
      Q = Ft[i] * R[i] * Ft[i] + V;
      A = G * R[i] * Ft[i] * inv(Q);
      L = G - A * Ft[i];
      lldata[i] = normal_lpdf(u | 0, sqrt(Q));
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L + W;
    }
  return sum(lldata);
  }
  
  
  array[] real uous_ffbs_rng(array[] real y, array[] real Ft, real G, real V, real W, real m0, real C0, int Tt){
    
    array[Tt] real theta;
    array[Tt] real a;
    array[Tt] real R;
    array[Tt] real m;
    array[Tt] real C;
    
    // Kalman filtering
    
    real mt = m0;
    real Ct = C0;
    
    for(i in 1:Tt){
      
      real ft;
      real Qt;
      real at;
      real Rt;
      real At;
      
      at = G * mt;
      Rt = G * Ct * G + W;
      ft = Ft[i] * at;
      Qt = Ft[i] * Rt * Ft[i] + V;
      At = Rt * Ft[i] * inv(Qt);
      mt = at + At * (y[i] - ft);
      Ct = Rt - At * Qt * At;
      
      //store for backward sampling
      a[i] = at;
      R[i] = Rt;
      m[i] = mt;
      C[i] = Ct;
  }
    // backward sampling
    array[Tt-1] int ind = sort_indices_desc(linspaced_int_array(Tt-1,1,Tt-1));
    theta[Tt] = normal_rng(m[Tt], sqrt(C[Tt]));
    for(i in ind) {
      real Bt;
      real ht;
      real Ht;
      Bt = C[i] * G * inv(R[i+1]);
      ht = m[i] + Bt * (theta[i+1] - a[i+1]);
      Ht = C[i] - Bt * G * C[i];
      theta[i] = normal_rng(ht, sqrt(Ht));
    }
  return theta;
}


  array[] real uous_dlm_one_step_ahead_rng(array[] real y, array[] real Ft, real G, real V, real W, real m0, real C0, int Tt){
    array[Tt] real yfit;
    array[Tt+1] real a;
    array[Tt+1] real R;
    array[Tt] real lldata;
    
    a[1] = m0;
    R[1] = C0;
    
    for (i in 1:Tt) {
      real u;
      real Q;
      real A;
      real L;
      u = y[i] - Ft[i] * a[i];
      Q = Ft[i] * R[i] * Ft[i] + V; //F[i]&#39; * R[i] * F[i] + V;
      A = G * R[i] * Ft[i] * inv(Q);
      L = G - A * Ft[i];
      yfit[i] = normal_rng(Ft[i] * a[i], sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L + W;
    }
  return yfit;
  }
  
  
}
  

data{
  int Tt;
  array[Tt] real y;
  array[Tt] real Ft;
  real G;
  real m0;
  real&lt;lower=0&gt; C0;
}

parameters{
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sqrt_W;
}

model {
  real V = square(tau);
  real W = square(sqrt_W);
  tau ~ std_normal();
  sqrt_W ~ std_normal();
  target += uous_dlm_ldensity(y, Ft, G, V, W, m0, C0, Tt);
}

generated quantities{
  array[Tt] real theta;
  array[Tt] real yfit;

  real V = square(tau);
  real W = square(sqrt_W);
  theta = uous_ffbs_rng(y, Ft, G, V, W, m0, C0, Tt);
  yfit = uous_dlm_one_step_ahead_rng(y, Ft, G, V, W, m0, C0, Tt);

}</code></pre>
<div class="sourceCode" id="cb297"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb297-1"><a href="Time.html#cb297-1" aria-hidden="true" tabindex="-1"></a>Example11_16_PM10_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb297-2"><a href="Time.html#cb297-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_PM10.stan&quot;</span>,</span>
<span id="cb297-3"><a href="Time.html#cb297-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb297-4"><a href="Time.html#cb297-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb297-5"><a href="Time.html#cb297-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb297-6"><a href="Time.html#cb297-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb297-7"><a href="Time.html#cb297-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb297-8"><a href="Time.html#cb297-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## hash mismatch so recompiling; make sure Stan code ends with a blank line</code></pre>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="Time.html#cb299-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_PM10_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;sqrt_W&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20run%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="Time.html#cb300-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_PM10_Stan, <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20run%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="Time.html#cb301-1" aria-hidden="true" tabindex="-1"></a>stanfit_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(Example11_16_PM10_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;sqrt_W&quot;</span>,<span class="st">&quot;theta&quot;</span>, <span class="st">&quot;yfit&quot;</span>))</span>
<span id="cb301-2"><a href="Time.html#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stanfit_summary<span class="sc">$</span>summary)</span></code></pre></div>
<pre><code>##               mean     se_mean        sd      2.5%       25%       50%
## tau       6.059572 0.006011225 0.4520659  5.173290  5.754283  6.060914
## sqrt_W    4.268502 0.007901555 0.5789220  3.155335  3.873516  4.266370
## theta[1] 25.772793 0.029473371 3.3465006 19.266802 23.494325 25.707770
## theta[2] 22.723128 0.028054146 3.4480789 15.981407 20.404997 22.693075
## theta[3] 19.086662 0.029104885 3.5356129 12.167884 16.697797 19.097985
## theta[4] 17.434448 0.030008784 3.5659752 10.352259 15.027600 17.477404
##                75%     97.5%     n_eff      Rhat
## tau       6.363179  6.932639  5655.586 0.9999911
## sqrt_W    4.654269  5.431407  5368.031 1.0000244
## theta[1] 28.042850 32.328176 12892.056 0.9998918
## theta[2] 25.026313 29.478562 15106.376 0.9999013
## theta[3] 21.503471 25.896446 14756.985 1.0000483
## theta[4] 19.828534 24.325792 14120.818 1.0000220</code></pre>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="Time.html#cb303-1" aria-hidden="true" tabindex="-1"></a>stan_fit_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(stanfit_summary<span class="sc">$</span>summary) <span class="sc">|&gt;</span></span>
<span id="cb303-2"><a href="Time.html#cb303-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb303-3"><a href="Time.html#cb303-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb303-4"><a href="Time.html#cb303-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb303-5"><a href="Time.html#cb303-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-6"><a href="Time.html#cb303-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> stan_fit_df, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb303-7"><a href="Time.html#cb303-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb303-8"><a href="Time.html#cb303-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb303-9"><a href="Time.html#cb303-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb303-10"><a href="Time.html#cb303-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb303-11"><a href="Time.html#cb303-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time (days)&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot; &quot;</span>) <span class="sc">+</span> </span>
<span id="cb303-12"><a href="Time.html#cb303-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;Trend &quot;</span>, PM[<span class="dv">10</span>], <span class="st">&quot; London site&quot;</span>))) <span class="sc">+</span></span>
<span id="cb303-13"><a href="Time.html#cb303-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.</code></pre>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20run%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="Time.html#cb305-1" aria-hidden="true" tabindex="-1"></a>yfit_summary_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(stanfit_summary<span class="sc">$</span>summary) <span class="sc">|&gt;</span></span>
<span id="cb305-2"><a href="Time.html#cb305-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb305-3"><a href="Time.html#cb305-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;yfit&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb305-4"><a href="Time.html#cb305-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb305-5"><a href="Time.html#cb305-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-6"><a href="Time.html#cb305-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(yfit_summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb305-7"><a href="Time.html#cb305-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb305-8"><a href="Time.html#cb305-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb305-9"><a href="Time.html#cb305-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb305-10"><a href="Time.html#cb305-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb305-11"><a href="Time.html#cb305-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb305-12"><a href="Time.html#cb305-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time (days)&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot; &quot;</span>) <span class="sc">+</span></span>
<span id="cb305-13"><a href="Time.html#cb305-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;Fitted values &quot;</span>, PM[<span class="dv">10</span>], <span class="st">&quot; London site&quot;</span>))) <span class="sc">+</span></span>
<span id="cb305-14"><a href="Time.html#cb305-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20pm10%20run%20stan-4.png" width="672" /></p>
</div>
</div>
<div id="example-11.16-extra-implementation-of-a-dynamic-linear-model-uk-ozone-data" class="section level2 unnumbered hasAnchor">
<h2>Example 11.16 EXTRA Implementation of a dynamic linear model: UK ozone data<a href="Time.html#example-11.16-extra-implementation-of-a-dynamic-linear-model-uk-ozone-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nimble-7" class="section level3 unnumbered hasAnchor">
<h3>Nimble<a href="Time.html#nimble-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="Time.html#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb306-2"><a href="Time.html#cb306-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb306-3"><a href="Time.html#cb306-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(sf)</span></span>
<span id="cb306-4"><a href="Time.html#cb306-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb306-5"><a href="Time.html#cb306-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb306-6"><a href="Time.html#cb306-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nleqslv)</span>
<span id="cb306-7"><a href="Time.html#cb306-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb306-8"><a href="Time.html#cb306-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb306-9"><a href="Time.html#cb306-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-10"><a href="Time.html#cb306-10" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/FFBS_functions_nimble.R&quot;</span>)</span>
<span id="cb306-11"><a href="Time.html#cb306-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-12"><a href="Time.html#cb306-12" aria-hidden="true" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/uk_ozone_one_site.csv&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="Time.html#cb307-1" aria-hidden="true" tabindex="-1"></a>Example11_16_O3_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb307-2"><a href="Time.html#cb307-2" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb307-3"><a href="Time.html#cb307-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb307-4"><a href="Time.html#cb307-4" aria-hidden="true" tabindex="-1"></a>    Vt[t] <span class="ot">&lt;-</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb307-5"><a href="Time.html#cb307-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb307-6"><a href="Time.html#cb307-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-7"><a href="Time.html#cb307-7" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb307-8"><a href="Time.html#cb307-8" aria-hidden="true" tabindex="-1"></a>    sqrt_Wt_diag[j] <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb307-9"><a href="Time.html#cb307-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb307-10"><a href="Time.html#cb307-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-11"><a href="Time.html#cb307-11" aria-hidden="true" tabindex="-1"></a>  Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(<span class="at">x =</span> sqrt_Wt_diag[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb307-12"><a href="Time.html#cb307-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-13"><a href="Time.html#cb307-13" aria-hidden="true" tabindex="-1"></a>  mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> m0[<span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb307-14"><a href="Time.html#cb307-14" aria-hidden="true" tabindex="-1"></a>  Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> C0[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb307-15"><a href="Time.html#cb307-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-16"><a href="Time.html#cb307-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb307-17"><a href="Time.html#cb307-17" aria-hidden="true" tabindex="-1"></a>    at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> mt[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>]</span>
<span id="cb307-18"><a href="Time.html#cb307-18" aria-hidden="true" tabindex="-1"></a>    Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span></span>
<span id="cb307-19"><a href="Time.html#cb307-19" aria-hidden="true" tabindex="-1"></a>      Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]) <span class="sc">+</span> Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb307-20"><a href="Time.html#cb307-20" aria-hidden="true" tabindex="-1"></a>    ft[t] <span class="ot">&lt;-</span> (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> at[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb307-21"><a href="Time.html#cb307-21" aria-hidden="true" tabindex="-1"></a>    Qt[t] <span class="ot">&lt;-</span></span>
<span id="cb307-22"><a href="Time.html#cb307-22" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> Vt[t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb307-23"><a href="Time.html#cb307-23" aria-hidden="true" tabindex="-1"></a>    yt[t] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="at">mean =</span> ft[t], <span class="at">var =</span> Qt[t])</span>
<span id="cb307-24"><a href="Time.html#cb307-24" aria-hidden="true" tabindex="-1"></a>    At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="sc">/</span> Qt[t]</span>
<span id="cb307-25"><a href="Time.html#cb307-25" aria-hidden="true" tabindex="-1"></a>    mt[<span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">*</span> (yt[t] <span class="sc">-</span> ft[t]))</span>
<span id="cb307-26"><a href="Time.html#cb307-26" aria-hidden="true" tabindex="-1"></a>    Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb307-27"><a href="Time.html#cb307-27" aria-hidden="true" tabindex="-1"></a>      Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">-</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(At[<span class="dv">1</span><span class="sc">:</span>p, t])) <span class="sc">*</span> Qt[t]</span>
<span id="cb307-28"><a href="Time.html#cb307-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb307-29"><a href="Time.html#cb307-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-30"><a href="Time.html#cb307-30" aria-hidden="true" tabindex="-1"></a>  theta[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span></span>
<span id="cb307-31"><a href="Time.html#cb307-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nim_bsample</span>(</span>
<span id="cb307-32"><a href="Time.html#cb307-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">mt =</span> mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb307-33"><a href="Time.html#cb307-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">Ct =</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb307-34"><a href="Time.html#cb307-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">at =</span> at[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt],</span>
<span id="cb307-35"><a href="Time.html#cb307-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">Gt =</span> Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p],</span>
<span id="cb307-36"><a href="Time.html#cb307-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">Rt =</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt]</span>
<span id="cb307-37"><a href="Time.html#cb307-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb307-38"><a href="Time.html#cb307-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb307-39"><a href="Time.html#cb307-39" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div id="time-varying-level-model" class="section level4 unnumbered hasAnchor">
<h4>Time-varying level model<a href="Time.html#time-varying-level-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="Time.html#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb308-2"><a href="Time.html#cb308-2" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb308-3"><a href="Time.html#cb308-3" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb308-4"><a href="Time.html#cb308-4" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb308-5"><a href="Time.html#cb308-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-6"><a href="Time.html#cb308-6" aria-hidden="true" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb308-7"><a href="Time.html#cb308-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb308-8"><a href="Time.html#cb308-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-9"><a href="Time.html#cb308-9" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>( p, Tt))</span>
<span id="cb308-10"><a href="Time.html#cb308-10" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb308-11"><a href="Time.html#cb308-11" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">2</span>,] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb308-12"><a href="Time.html#cb308-12" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">3</span>,] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb308-13"><a href="Time.html#cb308-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-14"><a href="Time.html#cb308-14" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb308-15"><a href="Time.html#cb308-15" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yt), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb308-16"><a href="Time.html#cb308-16" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb308-17"><a href="Time.html#cb308-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-18"><a href="Time.html#cb308-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-19"><a href="Time.html#cb308-19" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Tt =</span> Tt,</span>
<span id="cb308-20"><a href="Time.html#cb308-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">p =</span> p)</span>
<span id="cb308-21"><a href="Time.html#cb308-21" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb308-22"><a href="Time.html#cb308-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">yt =</span> yt,</span>
<span id="cb308-23"><a href="Time.html#cb308-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb308-24"><a href="Time.html#cb308-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">Gt =</span> Gt,</span>
<span id="cb308-25"><a href="Time.html#cb308-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb308-26"><a href="Time.html#cb308-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb308-27"><a href="Time.html#cb308-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb308-28"><a href="Time.html#cb308-28" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fu">sqrt</span>(<span class="fu">rep</span>(<span class="fl">0.1</span>, p)))</span>
<span id="cb308-29"><a href="Time.html#cb308-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-30"><a href="Time.html#cb308-30" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb308-31"><a href="Time.html#cb308-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb308-32"><a href="Time.html#cb308-32" aria-hidden="true" tabindex="-1"></a>    Example11_16_O3_Nimble,</span>
<span id="cb308-33"><a href="Time.html#cb308-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb308-34"><a href="Time.html#cb308-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb308-35"><a href="Time.html#cb308-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb308-36"><a href="Time.html#cb308-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb308-37"><a href="Time.html#cb308-37" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb308-38"><a href="Time.html#cb308-38" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb308-39"><a href="Time.html#cb308-39" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb308-40"><a href="Time.html#cb308-40" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb308-41"><a href="Time.html#cb308-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;ft&quot;</span>))</span>
<span id="cb308-42"><a href="Time.html#cb308-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-43"><a href="Time.html#cb308-43" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb308-44"><a href="Time.html#cb308-44" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb308-45"><a href="Time.html#cb308-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb308-46"><a href="Time.html#cb308-46" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb308-47"><a href="Time.html#cb308-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb308-48"><a href="Time.html#cb308-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb308-49"><a href="Time.html#cb308-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span></span>
<span id="cb308-50"><a href="Time.html#cb308-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb308-51"><a href="Time.html#cb308-51" aria-hidden="true" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb308-52"><a href="Time.html#cb308-52" aria-hidden="true" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb308-53"><a href="Time.html#cb308-53" aria-hidden="true" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb308-54"><a href="Time.html#cb308-54" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb308-55"><a href="Time.html#cb308-55" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb308-56"><a href="Time.html#cb308-56" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span></span>
<span id="cb308-57"><a href="Time.html#cb308-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runMCMC</span>(</span>
<span id="cb308-58"><a href="Time.html#cb308-58" aria-hidden="true" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb308-59"><a href="Time.html#cb308-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> niter,</span>
<span id="cb308-60"><a href="Time.html#cb308-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nburnin,</span>
<span id="cb308-61"><a href="Time.html#cb308-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> nthin,</span>
<span id="cb308-62"><a href="Time.html#cb308-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nchains,</span>
<span id="cb308-63"><a href="Time.html#cb308-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb308-64"><a href="Time.html#cb308-64" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb308-65"><a href="Time.html#cb308-65" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb308-66"><a href="Time.html#cb308-66" aria-hidden="true" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb308-67"><a href="Time.html#cb308-67" aria-hidden="true" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="Time.html#cb309-1" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb309-2"><a href="Time.html#cb309-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb309-3"><a href="Time.html#cb309-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb309-4"><a href="Time.html#cb309-4" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb309-5"><a href="Time.html#cb309-5" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb309-6"><a href="Time.html#cb309-6" aria-hidden="true" tabindex="-1"></a>    .chain,</span>
<span id="cb309-7"><a href="Time.html#cb309-7" aria-hidden="true" tabindex="-1"></a>    .iteration,</span>
<span id="cb309-8"><a href="Time.html#cb309-8" aria-hidden="true" tabindex="-1"></a>    .draw,</span>
<span id="cb309-9"><a href="Time.html#cb309-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;tau&#39;</span>,</span>
<span id="cb309-10"><a href="Time.html#cb309-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb309-11"><a href="Time.html#cb309-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb309-12"><a href="Time.html#cb309-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span></span>
<span id="cb309-13"><a href="Time.html#cb309-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb309-14"><a href="Time.html#cb309-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb309-15"><a href="Time.html#cb309-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb309-16"><a href="Time.html#cb309-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb309-17"><a href="Time.html#cb309-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb309-18"><a href="Time.html#cb309-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb309-19"><a href="Time.html#cb309-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb309-20"><a href="Time.html#cb309-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb309-21"><a href="Time.html#cb309-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="Time.html#cb310-1" aria-hidden="true" tabindex="-1"></a>post_summary[<span class="fu">c</span>(<span class="st">&#39;tau&#39;</span>,</span>
<span id="cb310-2"><a href="Time.html#cb310-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb310-3"><a href="Time.html#cb310-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb310-4"><a href="Time.html#cb310-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>), ]</span></code></pre></div>
<pre><code>##                 post.mean post.sd  q2.5   q50 q97.5 f0    n.eff  Rhat
## tau                 0.549   0.033 0.486 0.550 0.614  1 1141.190 1.003
## sqrt_Wt_diag[1]     0.117   0.042 0.049 0.113 0.209  1 1191.359 1.009
## sqrt_Wt_diag[2]     0.017   0.009 0.004 0.015 0.037  1 1823.198 1.003
## sqrt_Wt_diag[3]     0.036   0.033 0.001 0.026 0.121  1  979.027 1.002</code></pre>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="Time.html#cb312-1" aria-hidden="true" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb312-2"><a href="Time.html#cb312-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb312-3"><a href="Time.html#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb312-4"><a href="Time.html#cb312-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb312-5"><a href="Time.html#cb312-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(rowname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb312-6"><a href="Time.html#cb312-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">component =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x1))) <span class="sc">|&gt;</span></span>
<span id="cb312-7"><a href="Time.html#cb312-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x2))) <span class="sc">|&gt;</span></span>
<span id="cb312-8"><a href="Time.html#cb312-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(component, time, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb312-9"><a href="Time.html#cb312-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-10"><a href="Time.html#cb312-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb312-11"><a href="Time.html#cb312-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb312-12"><a href="Time.html#cb312-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb312-13"><a href="Time.html#cb312-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb312-14"><a href="Time.html#cb312-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb312-15"><a href="Time.html#cb312-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb312-16"><a href="Time.html#cb312-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> component,</span>
<span id="cb312-17"><a href="Time.html#cb312-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb312-18"><a href="Time.html#cb312-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb312-19"><a href="Time.html#cb312-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">label_bquote</span>(theta[.(component)])</span>
<span id="cb312-20"><a href="Time.html#cb312-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb312-21"><a href="Time.html#cb312-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb312-22"><a href="Time.html#cb312-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="Time.html#cb313-1" aria-hidden="true" tabindex="-1"></a>npsample <span class="ot">&lt;-</span> <span class="fu">floor</span>((niter <span class="sc">-</span> nburnin)<span class="sc">/</span>nthin)</span>
<span id="cb313-2"><a href="Time.html#cb313-2" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(tidy_post_samples)</span></code></pre></div>
<pre><code>## tibble [10,000 × 1,110] (S3: tbl_df/tbl/data.frame)
##  $ .chain         : int [1:10000] 1 1 1 1 1 1 1 1 1 1 ...
##  $ .iteration     : int [1:10000] 1 2 3 4 5 6 7 8 9 10 ...
##  $ .draw          : int [1:10000] 1 2 3 4 5 6 7 8 9 10 ...
##  $ ft[1]          : num [1:10000] 8.15 8.15 8.15 8.15 8.15 ...
##  $ ft[2]          : num [1:10000] 8.97 8.97 8.97 8.96 8.96 ...
##  $ ft[3]          : num [1:10000] 8.97 8.97 8.96 8.95 8.95 ...
##  $ ft[4]          : num [1:10000] 8.69 8.69 8.66 8.66 8.66 ...
##  $ ft[5]          : num [1:10000] 9.29 9.29 9.19 9.17 9.18 ...
##  $ ft[6]          : num [1:10000] 8.87 8.87 8.9 8.9 8.9 ...
##  $ ft[7]          : num [1:10000] 8.95 8.95 8.97 8.96 8.96 ...
##  $ ft[8]          : num [1:10000] 8.49 8.49 8.87 8.85 8.8 ...
##  $ ft[9]          : num [1:10000] 8.43 8.43 8.6 8.59 8.57 ...
##  $ ft[10]         : num [1:10000] 8.69 8.69 8.73 8.72 8.71 ...
##  $ ft[11]         : num [1:10000] 8.06 8.06 8.21 8.21 8.19 ...
##  $ ft[12]         : num [1:10000] 7.66 7.65 7.84 7.85 7.81 ...
##  $ ft[13]         : num [1:10000] 8.18 8.18 8.26 8.26 8.24 ...
##  $ ft[14]         : num [1:10000] 8.65 8.65 8.51 8.52 8.53 ...
##  $ ft[15]         : num [1:10000] 8.77 8.77 8.73 8.72 8.73 ...
##  $ ft[16]         : num [1:10000] 8.13 8.13 8.35 8.33 8.3 ...
##  $ ft[17]         : num [1:10000] 8.36 8.36 8.52 8.5 8.46 ...
##  $ ft[18]         : num [1:10000] 8.55 8.55 8.56 8.55 8.54 ...
##  $ ft[19]         : num [1:10000] 8.49 8.49 8.35 8.36 8.37 ...
##  $ ft[20]         : num [1:10000] 8.85 8.85 8.75 8.75 8.77 ...
##  $ ft[21]         : num [1:10000] 9.15 9.15 9.08 9.08 9.09 ...
##  $ ft[22]         : num [1:10000] 8.93 8.93 8.87 8.88 8.89 ...
##  $ ft[23]         : num [1:10000] 8.99 8.99 8.71 8.73 8.78 ...
##  $ ft[24]         : num [1:10000] 9.22 9.23 8.89 8.92 8.98 ...
##  $ ft[25]         : num [1:10000] 8.82 8.82 8.55 8.58 8.64 ...
##  $ ft[26]         : num [1:10000] 8.98 8.98 8.71 8.74 8.79 ...
##  $ ft[27]         : num [1:10000] 9.09 9.09 8.86 8.89 8.94 ...
##  $ ft[28]         : num [1:10000] 8.79 8.79 8.75 8.77 8.79 ...
##  $ ft[29]         : num [1:10000] 8.79 8.79 8.77 8.78 8.8 ...
##  $ ft[30]         : num [1:10000] 8.64 8.64 8.53 8.55 8.58 ...
##  $ ft[31]         : num [1:10000] 8.33 8.32 8.39 8.4 8.4 ...
##  $ ft[32]         : num [1:10000] 8.57 8.57 8.56 8.57 8.57 ...
##  $ ft[33]         : num [1:10000] 8.66 8.66 8.68 8.68 8.69 ...
##  $ ft[34]         : num [1:10000] 8.85 8.86 8.83 8.85 8.86 ...
##  $ ft[35]         : num [1:10000] 8.76 8.76 8.71 8.72 8.73 ...
##  $ ft[36]         : num [1:10000] 8.96 8.96 8.86 8.87 8.9 ...
##  $ ft[37]         : num [1:10000] 9.02 9.01 8.77 8.79 8.83 ...
##  $ ft[38]         : num [1:10000] 8.9 8.89 8.66 8.68 8.72 ...
##  $ ft[39]         : num [1:10000] 8.97 8.97 8.84 8.86 8.89 ...
##  $ ft[40]         : num [1:10000] 9.06 9.06 8.9 8.93 8.96 ...
##  $ ft[41]         : num [1:10000] 9.34 9.34 9.14 9.17 9.23 ...
##  $ ft[42]         : num [1:10000] 8.96 8.96 8.88 8.89 8.92 ...
##  $ ft[43]         : num [1:10000] 9.05 9.05 9.02 9.03 9.06 ...
##  $ ft[44]         : num [1:10000] 9.04 9.04 9 9.02 9.04 ...
##  $ ft[45]         : num [1:10000] 8.99 8.99 8.96 8.97 8.99 ...
##  $ ft[46]         : num [1:10000] 9.09 9.09 9.13 9.14 9.15 ...
##  $ ft[47]         : num [1:10000] 9.01 9.01 9.02 9.03 9.04 ...
##  $ ft[48]         : num [1:10000] 9.36 9.37 9.28 9.3 9.33 ...
##  $ ft[49]         : num [1:10000] 9.31 9.32 9.25 9.26 9.28 ...
##  $ ft[50]         : num [1:10000] 9.15 9.15 9 9.01 9.04 ...
##  $ ft[51]         : num [1:10000] 8.97 8.96 8.82 8.83 8.86 ...
##  $ ft[52]         : num [1:10000] 8.77 8.76 8.84 8.84 8.83 ...
##  $ ft[53]         : num [1:10000] 9.1 9.1 9.14 9.14 9.15 ...
##  $ ft[54]         : num [1:10000] 9.04 9.04 9.03 9.04 9.04 ...
##  $ ft[55]         : num [1:10000] 9.23 9.23 9.27 9.28 9.28 ...
##  $ ft[56]         : num [1:10000] 9.28 9.28 9.36 9.36 9.36 ...
##  $ ft[57]         : num [1:10000] 8.96 8.97 9.06 9.06 9.04 ...
##  $ ft[58]         : num [1:10000] 8.92 8.91 8.97 8.97 8.96 ...
##  $ ft[59]         : num [1:10000] 8.98 9 9.05 9.04 9.03 ...
##  $ ft[60]         : num [1:10000] 9.17 9.17 9.06 9.07 9.08 ...
##  $ ft[61]         : num [1:10000] 9.01 8.95 8.93 8.94 8.93 ...
##  $ ft[62]         : num [1:10000] 9.24 9.25 9.03 9.05 9.08 ...
##  $ ft[63]         : num [1:10000] 9.44 9.46 9.11 9.14 9.2 ...
##  $ ft[64]         : num [1:10000] 9.61 9.62 9.28 9.31 9.38 ...
##  $ ft[65]         : num [1:10000] 9.81 9.82 9.39 9.43 9.52 ...
##  $ ft[66]         : num [1:10000] 9.77 9.77 9.47 9.51 9.58 ...
##  $ ft[67]         : num [1:10000] 9.75 9.74 9.47 9.51 9.58 ...
##  $ ft[68]         : num [1:10000] 9.89 9.86 9.51 9.57 9.65 ...
##  $ ft[69]         : num [1:10000] 9.79 9.79 9.56 9.6 9.66 ...
##  $ ft[70]         : num [1:10000] 9.6 9.64 9.54 9.56 9.61 ...
##  $ ft[71]         : num [1:10000] 9.59 9.6 9.57 9.59 9.62 ...
##  $ ft[72]         : num [1:10000] 9.27 9.27 9.38 9.39 9.39 ...
##  $ ft[73]         : num [1:10000] 9.32 9.31 9.36 9.37 9.37 ...
##  $ ft[74]         : num [1:10000] 9.34 9.34 9.32 9.33 9.34 ...
##  $ ft[75]         : num [1:10000] 8.79 8.79 9 8.99 8.96 ...
##  $ ft[76]         : num [1:10000] 8.94 8.94 9.16 9.15 9.12 ...
##  $ ft[77]         : num [1:10000] 8.07 8.04 8.48 8.44 8.37 ...
##  $ ft[78]         : num [1:10000] 8.49 8.52 8.89 8.86 8.79 ...
##  $ ft[79]         : num [1:10000] 8.5 8.52 8.88 8.84 8.77 ...
##  $ ft[80]         : num [1:10000] 8.57 8.6 8.93 8.89 8.82 ...
##  $ ft[81]         : num [1:10000] 8.5 8.48 8.76 8.72 8.65 ...
##  $ ft[82]         : num [1:10000] 8.57 8.57 8.75 8.72 8.66 ...
##  $ ft[83]         : num [1:10000] 8.27 8.27 8.58 8.53 8.46 ...
##  $ ft[84]         : num [1:10000] 8.23 8.24 8.32 8.3 8.26 ...
##  $ ft[85]         : num [1:10000] 8.2 8.21 8.16 8.15 8.15 ...
##  $ ft[86]         : num [1:10000] 8.2 8.2 8.29 8.27 8.24 ...
##  $ ft[87]         : num [1:10000] 8.46 8.46 8.4 8.39 8.39 ...
##  $ ft[88]         : num [1:10000] 8.83 8.83 8.59 8.59 8.62 ...
##  $ ft[89]         : num [1:10000] 8.88 8.86 8.55 8.56 8.6 ...
##  $ ft[90]         : num [1:10000] 9.12 9.12 8.88 8.9 8.93 ...
##  $ ft[91]         : num [1:10000] 8.78 8.79 8.66 8.67 8.7 ...
##  $ ft[92]         : num [1:10000] 8.79 8.8 8.78 8.79 8.79 ...
##  $ ft[93]         : num [1:10000] 8.71 8.73 8.73 8.73 8.73 ...
##  $ ft[94]         : num [1:10000] 8.45 8.44 8.49 8.49 8.49 ...
##  $ ft[95]         : num [1:10000] 8.47 8.47 8.68 8.67 8.64 ...
##  $ ft[96]         : num [1:10000] 8.37 8.38 8.57 8.55 8.52 ...
##   [list output truncated]</code></pre>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="Time.html#cb315-1" aria-hidden="true" tabindex="-1"></a>Cnim_postfit_uoms <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(nim_postfit_uoms, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="Time.html#cb317-1" aria-hidden="true" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb317-2"><a href="Time.html#cb317-2" aria-hidden="true" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span></span>
<span id="cb317-3"><a href="Time.html#cb317-3" aria-hidden="true" tabindex="-1"></a>  tidy_post_samples  <span class="sc">|&gt;</span>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;sqrt_Wt_diag&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb317-4"><a href="Time.html#cb317-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()<span class="sc">|&gt;</span>  <span class="fu">unname</span>()</span>
<span id="cb317-5"><a href="Time.html#cb317-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-6"><a href="Time.html#cb317-6" aria-hidden="true" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(nchains<span class="sc">*</span>npsample), <span class="cf">function</span>(i) {</span>
<span id="cb317-7"><a href="Time.html#cb317-7" aria-hidden="true" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb317-8"><a href="Time.html#cb317-8" aria-hidden="true" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(post_sqrt_Wt_diag[i,]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb317-9"><a href="Time.html#cb317-9" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uoms</span>(<span class="at">yt =</span> dat_list<span class="sc">$</span>yt, </span>
<span id="cb317-10"><a href="Time.html#cb317-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft, </span>
<span id="cb317-11"><a href="Time.html#cb317-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Vt =</span> post_Vt,</span>
<span id="cb317-12"><a href="Time.html#cb317-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt, </span>
<span id="cb317-13"><a href="Time.html#cb317-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Wt =</span> post_Wt,</span>
<span id="cb317-14"><a href="Time.html#cb317-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0, </span>
<span id="cb317-15"><a href="Time.html#cb317-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0)</span>
<span id="cb317-16"><a href="Time.html#cb317-16" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb317-17"><a href="Time.html#cb317-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb317-18"><a href="Time.html#cb317-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb317-19"><a href="Time.html#cb317-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb317-20"><a href="Time.html#cb317-20" aria-hidden="true" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb317-21"><a href="Time.html#cb317-21" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>## &#39;data.frame&#39;:    2750000 obs. of  2 variables:
##  $ ft  : num  4.59 11.3 7.04 7.9 7.9 ...
##  $ time: int  1 2 3 4 5 6 7 8 9 10 ...</code></pre>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="Time.html#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>##          ft time
## 1  4.592059    1
## 2 11.300782    2
## 3  7.037173    3
## 4  7.901925    4
## 5  7.895742    5
## 6 10.799002    6</code></pre>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="Time.html#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb321-2"><a href="Time.html#cb321-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(tidy_post_ft)</span></code></pre></div>
<pre><code>##          ft time
## 1  4.592059    1
## 2 11.300782    2
## 3  7.037173    3
## 4  7.901925    4
## 5  7.895742    5
## 6 10.799002    6</code></pre>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="Time.html#cb323-1" aria-hidden="true" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span> </span>
<span id="cb323-2"><a href="Time.html#cb323-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb323-3"><a href="Time.html#cb323-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb323-4"><a href="Time.html#cb323-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb323-5"><a href="Time.html#cb323-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb323-6"><a href="Time.html#cb323-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span></span>
<span id="cb323-7"><a href="Time.html#cb323-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb323-8"><a href="Time.html#cb323-8" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(post_sum_ft)</span></code></pre></div>
<pre><code>## tibble [275 × 6] (S3: tbl_df/tbl/data.frame)
##  $ time     : int [1:275] 1 2 3 4 5 6 7 8 9 10 ...
##  $ post.mean: num [1:275] 8.16 8.97 8.97 8.67 9.2 ...
##  $ post.sd  : num [1:275] 2.268 1.268 1.147 0.791 0.751 ...
##  $ q2.5     : Named num [1:275] 3.69 6.43 6.71 7.12 7.7 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;2.5%&quot; &quot;2.5%&quot; &quot;2.5%&quot; &quot;2.5%&quot; ...
##  $ q50      : Named num [1:275] 8.16 8.96 8.97 8.66 9.2 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;50%&quot; &quot;50%&quot; &quot;50%&quot; &quot;50%&quot; ...
##  $ q97.5    : Named num [1:275] 12.6 11.4 11.2 10.2 10.7 ...
##   ..- attr(*, &quot;names&quot;)= chr [1:275] &quot;97.5%&quot; &quot;97.5%&quot; &quot;97.5%&quot; &quot;97.5%&quot; ...</code></pre>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="Time.html#cb325-1" aria-hidden="true" tabindex="-1"></a>post_sum_ft <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 6
##    time post.mean post.sd  q2.5   q50 q97.5
##   &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1      8.16   2.27   3.69  8.16  12.6
## 2     2      8.97   1.27   6.43  8.96  11.4
## 3     3      8.97   1.15   6.71  8.97  11.2
## 4     4      8.67   0.791  7.12  8.66  10.2
## 5     5      9.20   0.751  7.70  9.20  10.7
## 6     6      8.88   0.900  7.13  8.88  10.7</code></pre>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="Time.html#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span> </span>
<span id="cb327-2"><a href="Time.html#cb327-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>,<span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb327-3"><a href="Time.html#cb327-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean),  <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb327-4"><a href="Time.html#cb327-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb327-5"><a href="Time.html#cb327-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb327-6"><a href="Time.html#cb327-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb327-7"><a href="Time.html#cb327-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.</code></pre>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20%20nimble%20fitted%20values-1.png" width="672" /></p>
</div>
<div id="trend-model" class="section level4 unnumbered hasAnchor">
<h4>Trend model<a href="Time.html#trend-model" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="Time.html#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb329-2"><a href="Time.html#cb329-2" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb329-3"><a href="Time.html#cb329-3" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb329-4"><a href="Time.html#cb329-4" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb329-5"><a href="Time.html#cb329-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-6"><a href="Time.html#cb329-6" aria-hidden="true" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb329-7"><a href="Time.html#cb329-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># (intercept, trend, wind, temp)</span></span>
<span id="cb329-8"><a href="Time.html#cb329-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-9"><a href="Time.html#cb329-9" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>( p, Tt))</span>
<span id="cb329-10"><a href="Time.html#cb329-10" aria-hidden="true" tabindex="-1"></a>Ft[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb329-11"><a href="Time.html#cb329-11" aria-hidden="true" tabindex="-1"></a>Ft[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb329-12"><a href="Time.html#cb329-12" aria-hidden="true" tabindex="-1"></a>Ft[<span class="dv">3</span>,] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb329-13"><a href="Time.html#cb329-13" aria-hidden="true" tabindex="-1"></a>Ft[<span class="dv">4</span>,] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb329-14"><a href="Time.html#cb329-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-15"><a href="Time.html#cb329-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-16"><a href="Time.html#cb329-16" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb329-17"><a href="Time.html#cb329-17" aria-hidden="true" tabindex="-1"></a>Gt[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb329-18"><a href="Time.html#cb329-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-19"><a href="Time.html#cb329-19" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yt), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb329-20"><a href="Time.html#cb329-20" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb329-21"><a href="Time.html#cb329-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-22"><a href="Time.html#cb329-22" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Tt =</span> Tt,</span>
<span id="cb329-23"><a href="Time.html#cb329-23" aria-hidden="true" tabindex="-1"></a>                   <span class="at">p =</span> p)</span>
<span id="cb329-24"><a href="Time.html#cb329-24" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb329-25"><a href="Time.html#cb329-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">yt =</span> yt,</span>
<span id="cb329-26"><a href="Time.html#cb329-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Ft =</span> Ft,</span>
<span id="cb329-27"><a href="Time.html#cb329-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">Gt =</span> Gt,</span>
<span id="cb329-28"><a href="Time.html#cb329-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb329-29"><a href="Time.html#cb329-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb329-30"><a href="Time.html#cb329-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb329-31"><a href="Time.html#cb329-31" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fu">sqrt</span>(<span class="fu">rep</span>(<span class="fl">0.1</span>, p)))</span>
<span id="cb329-32"><a href="Time.html#cb329-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-33"><a href="Time.html#cb329-33" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb329-34"><a href="Time.html#cb329-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb329-35"><a href="Time.html#cb329-35" aria-hidden="true" tabindex="-1"></a>    Example11_16_O3_Nimble,</span>
<span id="cb329-36"><a href="Time.html#cb329-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb329-37"><a href="Time.html#cb329-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb329-38"><a href="Time.html#cb329-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb329-39"><a href="Time.html#cb329-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb329-40"><a href="Time.html#cb329-40" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb329-41"><a href="Time.html#cb329-41" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb329-42"><a href="Time.html#cb329-42" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb329-43"><a href="Time.html#cb329-43" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb329-44"><a href="Time.html#cb329-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;ft&quot;</span>))</span>
<span id="cb329-45"><a href="Time.html#cb329-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-46"><a href="Time.html#cb329-46" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb329-47"><a href="Time.html#cb329-47" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb329-48"><a href="Time.html#cb329-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb329-49"><a href="Time.html#cb329-49" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb329-50"><a href="Time.html#cb329-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb329-51"><a href="Time.html#cb329-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb329-52"><a href="Time.html#cb329-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span></span>
<span id="cb329-53"><a href="Time.html#cb329-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb329-54"><a href="Time.html#cb329-54" aria-hidden="true" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb329-55"><a href="Time.html#cb329-55" aria-hidden="true" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb329-56"><a href="Time.html#cb329-56" aria-hidden="true" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb329-57"><a href="Time.html#cb329-57" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb329-58"><a href="Time.html#cb329-58" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb329-59"><a href="Time.html#cb329-59" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span></span>
<span id="cb329-60"><a href="Time.html#cb329-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runMCMC</span>(</span>
<span id="cb329-61"><a href="Time.html#cb329-61" aria-hidden="true" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb329-62"><a href="Time.html#cb329-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> niter,</span>
<span id="cb329-63"><a href="Time.html#cb329-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nburnin,</span>
<span id="cb329-64"><a href="Time.html#cb329-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> nthin,</span>
<span id="cb329-65"><a href="Time.html#cb329-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> nchains,</span>
<span id="cb329-66"><a href="Time.html#cb329-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb329-67"><a href="Time.html#cb329-67" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb329-68"><a href="Time.html#cb329-68" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb329-69"><a href="Time.html#cb329-69" aria-hidden="true" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb329-70"><a href="Time.html#cb329-70" aria-hidden="true" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="Time.html#cb330-1" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb330-2"><a href="Time.html#cb330-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb330-3"><a href="Time.html#cb330-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-4"><a href="Time.html#cb330-4" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb330-5"><a href="Time.html#cb330-5" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb330-6"><a href="Time.html#cb330-6" aria-hidden="true" tabindex="-1"></a>    .chain,</span>
<span id="cb330-7"><a href="Time.html#cb330-7" aria-hidden="true" tabindex="-1"></a>    .iteration,</span>
<span id="cb330-8"><a href="Time.html#cb330-8" aria-hidden="true" tabindex="-1"></a>    .draw,</span>
<span id="cb330-9"><a href="Time.html#cb330-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;tau&#39;</span>,</span>
<span id="cb330-10"><a href="Time.html#cb330-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb330-11"><a href="Time.html#cb330-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb330-12"><a href="Time.html#cb330-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>,</span>
<span id="cb330-13"><a href="Time.html#cb330-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[4]&#39;</span></span>
<span id="cb330-14"><a href="Time.html#cb330-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb330-15"><a href="Time.html#cb330-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb330-16"><a href="Time.html#cb330-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb330-17"><a href="Time.html#cb330-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb330-18"><a href="Time.html#cb330-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb330-19"><a href="Time.html#cb330-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb330-20"><a href="Time.html#cb330-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb330-21"><a href="Time.html#cb330-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb330-22"><a href="Time.html#cb330-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb330-23"><a href="Time.html#cb330-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20trend%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="Time.html#cb331-1" aria-hidden="true" tabindex="-1"></a>post_summary[<span class="fu">c</span>(<span class="st">&#39;tau&#39;</span>,</span>
<span id="cb331-2"><a href="Time.html#cb331-2" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb331-3"><a href="Time.html#cb331-3" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb331-4"><a href="Time.html#cb331-4" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>,</span>
<span id="cb331-5"><a href="Time.html#cb331-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;sqrt_Wt_diag[4]&#39;</span>), ]</span></code></pre></div>
<pre><code>##                 post.mean post.sd  q2.5   q50 q97.5 f0    n.eff  Rhat
## tau                 0.546   0.035 0.478 0.545 0.614  1  930.770 1.001
## sqrt_Wt_diag[1]     0.127   0.053 0.028 0.126 0.237  1 1043.367 1.004
## sqrt_Wt_diag[2]     0.002   0.002 0.000 0.001 0.007  1  927.014 1.000
## sqrt_Wt_diag[3]     0.017   0.009 0.004 0.016 0.040  1 1560.133 1.011
## sqrt_Wt_diag[4]     0.035   0.031 0.001 0.027 0.117  1 1017.542 1.000</code></pre>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="Time.html#cb333-1" aria-hidden="true" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb333-2"><a href="Time.html#cb333-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb333-3"><a href="Time.html#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb333-4"><a href="Time.html#cb333-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb333-5"><a href="Time.html#cb333-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(rowname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb333-6"><a href="Time.html#cb333-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">component =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x1))) <span class="sc">|&gt;</span></span>
<span id="cb333-7"><a href="Time.html#cb333-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x2))) <span class="sc">|&gt;</span></span>
<span id="cb333-8"><a href="Time.html#cb333-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(component, time, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb333-9"><a href="Time.html#cb333-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-10"><a href="Time.html#cb333-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb333-11"><a href="Time.html#cb333-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb333-12"><a href="Time.html#cb333-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb333-13"><a href="Time.html#cb333-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb333-14"><a href="Time.html#cb333-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb333-15"><a href="Time.html#cb333-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb333-16"><a href="Time.html#cb333-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> component,</span>
<span id="cb333-17"><a href="Time.html#cb333-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb333-18"><a href="Time.html#cb333-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb333-19"><a href="Time.html#cb333-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">label_bquote</span>(theta[.(component)])</span>
<span id="cb333-20"><a href="Time.html#cb333-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb333-21"><a href="Time.html#cb333-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb333-22"><a href="Time.html#cb333-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb333-23"><a href="Time.html#cb333-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20nimble%20trend%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="Time.html#cb334-1" aria-hidden="true" tabindex="-1"></a>npsample <span class="ot">&lt;-</span> <span class="fu">floor</span>((niter <span class="sc">-</span> nburnin)<span class="sc">/</span>nthin)</span>
<span id="cb334-2"><a href="Time.html#cb334-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb334-3"><a href="Time.html#cb334-3" aria-hidden="true" tabindex="-1"></a>Cnim_postfit_uoms <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(nim_postfit_uoms, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="Time.html#cb336-1" aria-hidden="true" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb336-2"><a href="Time.html#cb336-2" aria-hidden="true" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span></span>
<span id="cb336-3"><a href="Time.html#cb336-3" aria-hidden="true" tabindex="-1"></a>  tidy_post_samples  <span class="sc">|&gt;</span>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">&quot;sqrt_Wt_diag&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb336-4"><a href="Time.html#cb336-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>()<span class="sc">|&gt;</span>  <span class="fu">unname</span>()</span>
<span id="cb336-5"><a href="Time.html#cb336-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-6"><a href="Time.html#cb336-6" aria-hidden="true" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>(nchains<span class="sc">*</span>npsample), <span class="cf">function</span>(i) {</span>
<span id="cb336-7"><a href="Time.html#cb336-7" aria-hidden="true" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i]<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb336-8"><a href="Time.html#cb336-8" aria-hidden="true" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(post_sqrt_Wt_diag[i,]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb336-9"><a href="Time.html#cb336-9" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uoms</span>(<span class="at">yt =</span> dat_list<span class="sc">$</span>yt, </span>
<span id="cb336-10"><a href="Time.html#cb336-10" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft, </span>
<span id="cb336-11"><a href="Time.html#cb336-11" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Vt =</span> post_Vt,</span>
<span id="cb336-12"><a href="Time.html#cb336-12" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt, </span>
<span id="cb336-13"><a href="Time.html#cb336-13" aria-hidden="true" tabindex="-1"></a>                               <span class="at">Wt =</span> post_Wt,</span>
<span id="cb336-14"><a href="Time.html#cb336-14" aria-hidden="true" tabindex="-1"></a>                               <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0, </span>
<span id="cb336-15"><a href="Time.html#cb336-15" aria-hidden="true" tabindex="-1"></a>                               <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0)</span>
<span id="cb336-16"><a href="Time.html#cb336-16" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb336-17"><a href="Time.html#cb336-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb336-18"><a href="Time.html#cb336-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb336-19"><a href="Time.html#cb336-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-20"><a href="Time.html#cb336-20" aria-hidden="true" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb336-21"><a href="Time.html#cb336-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-22"><a href="Time.html#cb336-22" aria-hidden="true" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb336-23"><a href="Time.html#cb336-23" aria-hidden="true" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span>  </span>
<span id="cb336-24"><a href="Time.html#cb336-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb336-25"><a href="Time.html#cb336-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb336-26"><a href="Time.html#cb336-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb336-27"><a href="Time.html#cb336-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb336-28"><a href="Time.html#cb336-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb336-29"><a href="Time.html#cb336-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb336-30"><a href="Time.html#cb336-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-31"><a href="Time.html#cb336-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-32"><a href="Time.html#cb336-32" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span> </span>
<span id="cb336-33"><a href="Time.html#cb336-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>,<span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb336-34"><a href="Time.html#cb336-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean),  <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb336-35"><a href="Time.html#cb336-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y=</span>yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb336-36"><a href="Time.html#cb336-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb336-37"><a href="Time.html#cb336-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb336-38"><a href="Time.html#cb336-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() </span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20nimble%20trend%20fitted%20values-1.png" width="672" /></p>
</div>
</div>
<div id="stan-7" class="section level3 unnumbered hasAnchor">
<h3>Stan<a href="Time.html#stan-7" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="Time.html#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb337-2"><a href="Time.html#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb337-3"><a href="Time.html#cb337-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb337-4"><a href="Time.html#cb337-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb337-5"><a href="Time.html#cb337-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb337-6"><a href="Time.html#cb337-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-7"><a href="Time.html#cb337-7" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb337-8"><a href="Time.html#cb337-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb337-9"><a href="Time.html#cb337-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-10"><a href="Time.html#cb337-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for RW case</span></span>
<span id="cb337-11"><a href="Time.html#cb337-11" aria-hidden="true" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/uk_ozone_one_site.csv&quot;</span>)</span></code></pre></div>
<div id="time-varying-level-model-1" class="section level4 unnumbered hasAnchor">
<h4>Time-varying level model<a href="Time.html#time-varying-level-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="Time.html#cb338-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb338-2"><a href="Time.html#cb338-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb338-3"><a href="Time.html#cb338-3" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb338-4"><a href="Time.html#cb338-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-5"><a href="Time.html#cb338-5" aria-hidden="true" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb338-6"><a href="Time.html#cb338-6" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb338-7"><a href="Time.html#cb338-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-8"><a href="Time.html#cb338-8" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(Tt, p))</span>
<span id="cb338-9"><a href="Time.html#cb338-9" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb338-10"><a href="Time.html#cb338-10" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">2</span>] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb338-11"><a href="Time.html#cb338-11" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">3</span>] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb338-12"><a href="Time.html#cb338-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-13"><a href="Time.html#cb338-13" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb338-14"><a href="Time.html#cb338-14" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb338-15"><a href="Time.html#cb338-15" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb338-16"><a href="Time.html#cb338-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-17"><a href="Time.html#cb338-17" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">T =</span> Tt, <span class="at">p =</span> p, <span class="at">y =</span> y, <span class="at">F =</span> Ft, <span class="at">G =</span> Gt, <span class="at">m0=</span> m0, <span class="at">C0 =</span> C0)</span></code></pre></div>
<pre><code>functions {
  
  // FFBS for DLM with univariate observation equation and univariate system equation
  array[] vector uoms_ffbs_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    
    array[T] vector[p] theta;
    array[T] vector[p] a;
    array[T] matrix[p,p] R;
    array[T] vector[p] m;
    array[T] matrix[p,p] C;
    
    // Kalman filtering
    
    vector[p] mt = m0;
    matrix[p,p] Ct = C0;
    
    for(i in 1:T){
      
      real ft;
      real Qt;
      vector[p] at;
      matrix[p,p] Rt;
      vector[p] At;
      
      at = G * mt;
      Rt = G * Ct * G&#39; + W;
      ft = F[i]&#39; * at;
      Qt = quad_form(Rt, F[i]) + V; //F[i]&#39; * Rt * F[i] + V;
      At = Rt * F[i] * inv(Qt);
      mt = at + At * (y[i] - ft);
      Ct = Rt - At * Qt * At&#39;;
      
      //store for backward sampling
      a[i] = at;
      R[i] = Rt;
      m[i] = mt;
      C[i] = Ct;
  }
    // backward sampling
    array[T-1] int ind = sort_indices_desc(linspaced_int_array(T-1,1,T-1));
    theta[T] = multi_normal_rng(m[T], C[T]);
    for(i in ind) {
      matrix[p,p] Bt;
      vector[p] ht;
      matrix[p,p] Ht;
      Bt = C[i] * G&#39; * inverse(R[i+1]);
      ht = m[i] + Bt * (theta[i+1] - a[i+1]);
      Ht = C[i] - Bt * R[i+1] * Bt&#39;;
      theta[i] = multi_normal_rng(ht, Ht);
    }
  return theta;
}

  real uoms_dlm_ldensity(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      //lldata[i] = -0.5 * (log(2 * pi()) + log(Q) + Qinv*square(u));
      lldata[i] = normal_lpdf(u | 0, sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return sum(lldata);
  }
  
  array[] real uoms_dlm_one_step_ahead_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T] real yfit;
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      yfit[i] = normal_rng(F[i]&#39; * a[i], sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return yfit;
  }
}

data{
  int T;
  int p;
  array[T] real y;
  array[T] vector[p] F;
  matrix[p, p] G;
  vector[p] m0;
  cov_matrix[p] C0;
}

parameters{
  real&lt;lower=0&gt; tau;
  vector&lt;lower=0&gt;[p] sqrt_W_diag;
}

model {
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  tau ~ std_normal();
  sqrt_W_diag ~ std_normal();
  target += uoms_dlm_ldensity(y, F, G, V, W, m0, C0, T, p);
}

generated quantities{
  array[T] vector[p] theta;
  array[T] real yfit;
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  theta = uoms_ffbs_rng(y, F, G, V, W, m0, C0, T, p);
  yfit = uoms_dlm_one_step_ahead_rng(y, F, G, V, W, m0, C0, T, p);
}</code></pre>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="Time.html#cb340-1" aria-hidden="true" tabindex="-1"></a>Example11_16_UK_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb340-2"><a href="Time.html#cb340-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_UK.stan&quot;</span>,</span>
<span id="cb340-3"><a href="Time.html#cb340-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb340-4"><a href="Time.html#cb340-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb340-5"><a href="Time.html#cb340-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb340-6"><a href="Time.html#cb340-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb340-7"><a href="Time.html#cb340-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb340-8"><a href="Time.html#cb340-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="Time.html#cb341-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb341-2"><a href="Time.html#cb341-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>, <span class="st">&quot;theta[1,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="Time.html#cb342-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb342-2"><a href="Time.html#cb342-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="Time.html#cb343-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb343-2"><a href="Time.html#cb343-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,2]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="Time.html#cb344-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb344-2"><a href="Time.html#cb344-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-4.png" width="672" /></p>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="Time.html#cb345-1" aria-hidden="true" tabindex="-1"></a>fixedpars_summary <span class="ot">&lt;-</span></span>
<span id="cb345-2"><a href="Time.html#cb345-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb345-3"><a href="Time.html#cb345-3" aria-hidden="true" tabindex="-1"></a>fixedpars_summary</span></code></pre></div>
<pre><code>##                      mean      se_mean          sd        2.5%        25%
## tau            0.55010626 3.488395e-04 0.033468464 0.484432869 0.52797009
## sqrt_W_diag[1] 0.11815950 4.656882e-04 0.042928733 0.050865809 0.08646848
## sqrt_W_diag[2] 0.01689699 8.836672e-05 0.008904249 0.003430261 0.01068365
## sqrt_W_diag[3] 0.03411268 3.029880e-04 0.030825578 0.001108826 0.01119069
##                       50%       75%      97.5%     n_eff      Rhat
## tau            0.55045820 0.5723100 0.61472703  9204.927 0.9999293
## sqrt_W_diag[1] 0.11284435 0.1444072 0.21526998  8497.784 0.9999954
## sqrt_W_diag[2] 0.01546892 0.0215257 0.03824708 10153.532 0.9999893
## sqrt_W_diag[3] 0.02521080 0.0478548 0.11696704 10350.745 1.0002863</code></pre>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="Time.html#cb347-1" aria-hidden="true" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span></span>
<span id="cb347-2"><a href="Time.html#cb347-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb347-3"><a href="Time.html#cb347-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-4"><a href="Time.html#cb347-4" aria-hidden="true" tabindex="-1"></a>yfit_summary <span class="ot">&lt;-</span></span>
<span id="cb347-5"><a href="Time.html#cb347-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb347-6"><a href="Time.html#cb347-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-7"><a href="Time.html#cb347-7" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb347-8"><a href="Time.html#cb347-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb347-9"><a href="Time.html#cb347-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,1]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb347-10"><a href="Time.html#cb347-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb347-11"><a href="Time.html#cb347-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb347-12"><a href="Time.html#cb347-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb347-13"><a href="Time.html#cb347-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb347-14"><a href="Time.html#cb347-14" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb347-15"><a href="Time.html#cb347-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb347-16"><a href="Time.html#cb347-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Intercept&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb347-17"><a href="Time.html#cb347-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb347-18"><a href="Time.html#cb347-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-19"><a href="Time.html#cb347-19" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb347-20"><a href="Time.html#cb347-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb347-21"><a href="Time.html#cb347-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,2]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb347-22"><a href="Time.html#cb347-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb347-23"><a href="Time.html#cb347-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb347-24"><a href="Time.html#cb347-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb347-25"><a href="Time.html#cb347-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb347-26"><a href="Time.html#cb347-26" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb347-27"><a href="Time.html#cb347-27" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb347-28"><a href="Time.html#cb347-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Wind&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb347-29"><a href="Time.html#cb347-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb347-30"><a href="Time.html#cb347-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-31"><a href="Time.html#cb347-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-32"><a href="Time.html#cb347-32" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb347-33"><a href="Time.html#cb347-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb347-34"><a href="Time.html#cb347-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,3]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb347-35"><a href="Time.html#cb347-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb347-36"><a href="Time.html#cb347-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb347-37"><a href="Time.html#cb347-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb347-38"><a href="Time.html#cb347-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb347-39"><a href="Time.html#cb347-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb347-40"><a href="Time.html#cb347-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb347-41"><a href="Time.html#cb347-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Temperature&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb347-42"><a href="Time.html#cb347-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb347-43"><a href="Time.html#cb347-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-44"><a href="Time.html#cb347-44" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-5.png" width="672" /></p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="Time.html#cb348-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted values</span></span>
<span id="cb348-2"><a href="Time.html#cb348-2" aria-hidden="true" tabindex="-1"></a>yfit_summary_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(yfit_summary) <span class="sc">|&gt;</span></span>
<span id="cb348-3"><a href="Time.html#cb348-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb348-4"><a href="Time.html#cb348-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb348-5"><a href="Time.html#cb348-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb348-6"><a href="Time.html#cb348-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(yfit_summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb348-7"><a href="Time.html#cb348-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb348-8"><a href="Time.html#cb348-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb348-9"><a href="Time.html#cb348-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb348-10"><a href="Time.html#cb348-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb348-11"><a href="Time.html#cb348-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb348-12"><a href="Time.html#cb348-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb348-13"><a href="Time.html#cb348-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb348-14"><a href="Time.html#cb348-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20stan-6.png" width="672" /></p>
</div>
<div id="trend-model-1" class="section level4 unnumbered hasAnchor">
<h4>Trend model<a href="Time.html#trend-model-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="Time.html#cb349-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(UK_ozone<span class="sc">$</span>ozone)</span>
<span id="cb349-2"><a href="Time.html#cb349-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb349-3"><a href="Time.html#cb349-3" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb349-4"><a href="Time.html#cb349-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-5"><a href="Time.html#cb349-5" aria-hidden="true" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb349-6"><a href="Time.html#cb349-6" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># (intercept, trend, wind, temp)</span></span>
<span id="cb349-7"><a href="Time.html#cb349-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-8"><a href="Time.html#cb349-8" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(Tt, p))</span>
<span id="cb349-9"><a href="Time.html#cb349-9" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb349-10"><a href="Time.html#cb349-10" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb349-11"><a href="Time.html#cb349-11" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">3</span>] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb349-12"><a href="Time.html#cb349-12" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">4</span>] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb349-13"><a href="Time.html#cb349-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-14"><a href="Time.html#cb349-14" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb349-15"><a href="Time.html#cb349-15" aria-hidden="true" tabindex="-1"></a>Gt[<span class="dv">1</span>, <span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb349-16"><a href="Time.html#cb349-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-17"><a href="Time.html#cb349-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-18"><a href="Time.html#cb349-18" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y), <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb349-19"><a href="Time.html#cb349-19" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb349-20"><a href="Time.html#cb349-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-21"><a href="Time.html#cb349-21" aria-hidden="true" tabindex="-1"></a>stan_data_trend <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb349-22"><a href="Time.html#cb349-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> Tt,</span>
<span id="cb349-23"><a href="Time.html#cb349-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb349-24"><a href="Time.html#cb349-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb349-25"><a href="Time.html#cb349-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">F =</span> Ft,</span>
<span id="cb349-26"><a href="Time.html#cb349-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">G =</span> Gt,</span>
<span id="cb349-27"><a href="Time.html#cb349-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb349-28"><a href="Time.html#cb349-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb349-29"><a href="Time.html#cb349-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb349-30"><a href="Time.html#cb349-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb349-31"><a href="Time.html#cb349-31" aria-hidden="true" tabindex="-1"></a>Example11_16_UK_trend_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb349-32"><a href="Time.html#cb349-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_UK.stan&quot;</span>,</span>
<span id="cb349-33"><a href="Time.html#cb349-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data_trend,</span>
<span id="cb349-34"><a href="Time.html#cb349-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb349-35"><a href="Time.html#cb349-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb349-36"><a href="Time.html#cb349-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb349-37"><a href="Time.html#cb349-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb349-38"><a href="Time.html#cb349-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in validityMethod(object): The following variables have undefined
## values: theta[1,1],The following variables have undefined values: theta[2,1],The
## following variables have undefined values: theta[3,1],The following variables
## have undefined values: theta[4,1],The following variables have undefined
## values: theta[5,1],The following variables have undefined values: theta[6,1],The
## following variables have undefined values: theta[7,1],The following variables
## have undefined values: theta[8,1],The following variables have undefined values:
## theta[9,1],The following variables have undefined values: theta[10,1],The
## following variables have undefined values: theta[11,1],The following
## variables have undefined values: theta[12,1],The following variables have
## undefined values: theta[13,1],The following variables have undefined values:
## theta[14,1],The following variables have undefined values: theta[15,1],The
## following variables have undefined values: theta[16,1],The following
## variables have undefined values: theta[17,1],The following variables have
## undefined values: theta[18,1],The following variables have undefined values:
## theta[19,1],The following variables have undefined values: theta[20,1],The
## following variables have undefined values: theta[21,1],The following
## variables have undefined values: theta[22,1],The following variables have
## undefined values: theta[23,1],The following variables have undefined values:
## theta[24,1],The following variables have undefined values: theta[25,1],The
## following variables have undefined values: theta[26,1],The following
## variables have undefined values: theta[27,1],The following variables have
## undefined values: theta[28,1],The following variables have undefined values:
## theta[29,1],The following variables have undefined values: theta[30,1],The
## following variables have undefined values: theta[31,1],The following
## variables have undefined values: theta[32,1],The following variables have
## undefined values: theta[33,1],The following variables have undefined values:
## theta[34,1],The following variables have undefined values: theta[35,1],The
## following variables have undefined values: theta[36,1],The following
## variables have undefined values: theta[37,1],The following variables have
## undefined values: theta[38,1],The following variables have undefined values:
## theta[39,1],The following variables have undefined values: theta[40,1],The
## following variables have undefined values: theta[41,1],The following
## variables have undefined values: theta[42,1],The following variables have
## undefined values: theta[43,1],The following variables have undefined values:
## theta[44,1],The following variables have undefined values: theta[45,1],The
## following variables have undefined values: theta[46,1],The following
## variables have undefined values: theta[47,1],The following variables have
## undefined values: theta[48,1],The following variables have undefined values:
## theta[49,1],The following variables have undefined values: theta[50,1],The
## following variables have undefined values: theta[51,1],The following
## variables have undefined values: theta[52,1],The following variables have
## undefined values: theta[53,1],The following variables have undefined values:
## theta[54,1],The following variables have undefined values: theta[55,1],The
## following variables have undefined values: theta[56,1],The following
## variables have undefined values: theta[57,1],The following variables have
## undefined values: theta[58,1],The following variables have undefined values:
## theta[59,1],The following variables have undefined values: theta[60,1],The
## following variables have undefined values: theta[61,1],The following
## variables have undefined values: theta[62,1],The following variables have
## undefined values: theta[63,1],The following variables have undefined values:
## theta[64,1],The following variables have undefined values: theta[65,1],The
## following variables have undefined values: theta[66,1],The following
## variables have undefined values: theta[67,1],The following variables have
## undefined values: theta[68,1],The following variables have undefined values:
## theta[69,1],The following variables have undefined values: theta[70,1],The
## following variables have undefined values: theta[71,1],The following
## variables have undefined values: theta[72,1],The following variables have
## undefined values: theta[73,1],The following variables have undefined values:
## theta[74,1],The following variables have undefined values: theta[75,1],The
## following variables have undefined values: theta[76,1],The following
## variables have undefined values: theta[77,1],The following variables have
## undefined values: theta[78,1],The following variables have undefined values:
## theta[79,1],The following variables have undefined values: theta[80,1],The
## following variables have undefined values: theta[81,1],The following
## variables have undefined values: theta[82,1],The following variables have
## undefined values: theta[83,1],The following variables have undefined values:
## theta[84,1],The following variables have undefined values: theta[85,1],The
## following variables have undefined values: theta[86,1],The following
## variables have undefined values: theta[87,1],The following variables have
## undefined values: theta[88,1],The following variables have undefined values:
## theta[89,1],The following variables have undefined values: theta[90,1],The
## following variables have undefined values: theta[91,1],The following
## variables have undefined values: theta[92,1],The following variables have
## undefined values: theta[93,1],The following variables have undefined values:
## theta[94,1],The following variables have undefined values: theta[95,1],The
## following variables have undefined values: theta[96,1],The following
## variables have undefined values: theta[97,1],The following variables have
## undefined values: theta[98,1],The following variables have undefined values:
## theta[99,1],The following variables have undefined values: theta[100,1],The
## following variables have undefined values: theta[101,1],The following
## variables have undefined values: theta[102,1],The following variables have
## undefined values: theta[103,1],The following variables have undefined values:
## theta[104,1],The following variables have undefined values: theta[105,1],The
## following variables have undefined values: theta[106,1],The following
## variables have undefined values: theta[107,1],The following variables have
## undefined values: theta[108,1],The following variables have undefined values:
## theta[109,1],The following variables have undefined values: theta[110,1],The
## following variables have undefined values: theta[111,1],The following
## variables have undefined values: theta[112,1],The following variables have
## undefined values: theta[113,1],The following variables have undefined values:
## theta[114,1],The following variables have undefined values: theta[115,1],The
## following variables have undefined values: theta[116,1],The following
## variables have undefined values: theta[117,1],The following variables have
## undefined values: theta[118,1],The following variables have undefined values:
## theta[119,1],The following variables have undefined values: theta[120,1],The
## following variables have undefined values: theta[121,1],The following
## variables have undefined values: theta[122,1],The following variables have
## undefined values: theta[123,1],The following variables have undefined values:
## theta[124,1],The following variables have undefined values: theta[125,1],The
## following variables have undefined values: theta[126,1],The following
## variables have undefined values: theta[127,1],The following variables have
## undefined values: theta[128,1],The following variables have undefined values:
## theta[129,1],The following variables have undefined values: theta[130,1],The
## following variables have undefined values: theta[131,1],The following
## variables have undefined values: theta[132,1],The following variables have
## undefined values: theta[133,1],The following variables have undefined values:
## theta[134,1],The following variables have undefined values: theta[135,1],The
## following variables have undefined values: theta[136,1],Th</code></pre>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="Time.html#cb351-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan,</span>
<span id="cb351-2"><a href="Time.html#cb351-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>, <span class="st">&quot;theta[1,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="Time.html#cb352-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan, </span>
<span id="cb352-2"><a href="Time.html#cb352-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,1]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="Time.html#cb353-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan, </span>
<span id="cb353-2"><a href="Time.html#cb353-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,2]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="Time.html#cb354-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan, </span>
<span id="cb354-2"><a href="Time.html#cb354-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,3]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-4.png" width="672" /></p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="Time.html#cb355-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_trend_Stan, </span>
<span id="cb355-2"><a href="Time.html#cb355-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(Tt, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,4]&quot;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20traceplots%20trend%20stan-5.png" width="672" /></p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="Time.html#cb356-1" aria-hidden="true" tabindex="-1"></a>fixedpars_summary <span class="ot">&lt;-</span></span>
<span id="cb356-2"><a href="Time.html#cb356-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb356-3"><a href="Time.html#cb356-3" aria-hidden="true" tabindex="-1"></a>fixedpars_summary</span></code></pre></div>
<pre><code>##                       mean      se_mean          sd         2.5%          25%
## tau            0.543642607 3.914308e-04 0.034375997 4.772720e-01 0.5201395929
## sqrt_W_diag[1] 0.131536090 6.375197e-04 0.051581535 3.457818e-02 0.0958162138
## sqrt_W_diag[2] 0.002059789 1.722597e-05 0.001898505 7.153768e-05 0.0007138005
## sqrt_W_diag[3] 0.016773427 8.278251e-05 0.009020480 3.348869e-03 0.0104632621
## sqrt_W_diag[4] 0.034660473 2.839305e-04 0.030739697 1.150335e-03 0.0117165930
##                        50%         75%       97.5%     n_eff      Rhat
## tau            0.543274715 0.566861458 0.612240194  7712.597 1.0010600
## sqrt_W_diag[1] 0.129392438 0.165679335 0.236533778  6546.380 1.0010844
## sqrt_W_diag[2] 0.001559833 0.002842681 0.007096176 12146.628 1.0006294
## sqrt_W_diag[3] 0.015253811 0.021381703 0.038668290 11873.590 1.0001375
## sqrt_W_diag[4] 0.026333330 0.048433147 0.115248048 11721.283 0.9998328</code></pre>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="Time.html#cb358-1" aria-hidden="true" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span></span>
<span id="cb358-2"><a href="Time.html#cb358-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb358-3"><a href="Time.html#cb358-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-4"><a href="Time.html#cb358-4" aria-hidden="true" tabindex="-1"></a>yfit_summary <span class="ot">&lt;-</span></span>
<span id="cb358-5"><a href="Time.html#cb358-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_trend_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;yfit&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb358-6"><a href="Time.html#cb358-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-7"><a href="Time.html#cb358-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-8"><a href="Time.html#cb358-8" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb358-9"><a href="Time.html#cb358-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb358-10"><a href="Time.html#cb358-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,1]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb358-11"><a href="Time.html#cb358-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb358-12"><a href="Time.html#cb358-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb358-13"><a href="Time.html#cb358-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb358-14"><a href="Time.html#cb358-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb358-15"><a href="Time.html#cb358-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb358-16"><a href="Time.html#cb358-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb358-17"><a href="Time.html#cb358-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Intercept&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb358-18"><a href="Time.html#cb358-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb358-19"><a href="Time.html#cb358-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-20"><a href="Time.html#cb358-20" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb358-21"><a href="Time.html#cb358-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb358-22"><a href="Time.html#cb358-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,4]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb358-23"><a href="Time.html#cb358-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb358-24"><a href="Time.html#cb358-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb358-25"><a href="Time.html#cb358-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb358-26"><a href="Time.html#cb358-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb358-27"><a href="Time.html#cb358-27" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb358-28"><a href="Time.html#cb358-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb358-29"><a href="Time.html#cb358-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Trend&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb358-30"><a href="Time.html#cb358-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb358-31"><a href="Time.html#cb358-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-32"><a href="Time.html#cb358-32" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb358-33"><a href="Time.html#cb358-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb358-34"><a href="Time.html#cb358-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,2]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb358-35"><a href="Time.html#cb358-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb358-36"><a href="Time.html#cb358-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb358-37"><a href="Time.html#cb358-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb358-38"><a href="Time.html#cb358-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb358-39"><a href="Time.html#cb358-39" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb358-40"><a href="Time.html#cb358-40" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb358-41"><a href="Time.html#cb358-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Wind&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb358-42"><a href="Time.html#cb358-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb358-43"><a href="Time.html#cb358-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-44"><a href="Time.html#cb358-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-45"><a href="Time.html#cb358-45" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb358-46"><a href="Time.html#cb358-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb358-47"><a href="Time.html#cb358-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>Tt, <span class="st">&quot;,3]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb358-48"><a href="Time.html#cb358-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">|&gt;</span></span>
<span id="cb358-49"><a href="Time.html#cb358-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb358-50"><a href="Time.html#cb358-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb358-51"><a href="Time.html#cb358-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb358-52"><a href="Time.html#cb358-52" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb358-53"><a href="Time.html#cb358-53" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb358-54"><a href="Time.html#cb358-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Temperature&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb358-55"><a href="Time.html#cb358-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb358-56"><a href="Time.html#cb358-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-57"><a href="Time.html#cb358-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-58"><a href="Time.html#cb358-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb358-59"><a href="Time.html#cb358-59" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3, p4, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20trend%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="Time.html#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fitted values</span></span>
<span id="cb359-2"><a href="Time.html#cb359-2" aria-hidden="true" tabindex="-1"></a>yfit_summary_dt <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(yfit_summary) <span class="sc">|&gt;</span></span>
<span id="cb359-3"><a href="Time.html#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb359-4"><a href="Time.html#cb359-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname)))</span>
<span id="cb359-5"><a href="Time.html#cb359-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb359-6"><a href="Time.html#cb359-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(yfit_summary_dt, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb359-7"><a href="Time.html#cb359-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb359-8"><a href="Time.html#cb359-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb359-9"><a href="Time.html#cb359-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb359-10"><a href="Time.html#cb359-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb359-11"><a href="Time.html#cb359-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">linewidth =</span> <span class="fl">0.1</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb359-12"><a href="Time.html#cb359-12" aria-hidden="true" tabindex="-1"></a> <span class="fu">ylab</span>(<span class="st">&quot;Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb359-13"><a href="Time.html#cb359-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">&quot;Fitted values Ozone level UK&quot;</span>) <span class="sc">+</span></span>
<span id="cb359-14"><a href="Time.html#cb359-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/Ex%2011.16%20o3%20post%20summaries%20trend%20stan-2.png" width="672" /></p>
</div>
</div>
</div>
<div id="solutions-to-selected-exercises-1" class="section level2 unnumbered hasAnchor">
<h2>Solutions to Selected Exercises<a href="Time.html#solutions-to-selected-exercises-1" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="exercise-11.11" class="section level2 unnumbered hasAnchor">
<h2>Exercise 11.11<a href="Time.html#exercise-11.11" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The joint distribution of <span class="math inline">\(\mathbf{\gamma} = \{\gamma_1, \gamma_2, \dots, \gamma_{N_T}\}\)</span> can be written as:
<span class="math display">\[
p(\mathbf{\gamma}) = p(\gamma_1) \prod_{t=1}^{N_T-1}p(\gamma_{t+1}\mid\gamma)\\
= p(\gamma_1)(2\pi\sigma_w^2)^{-(N_T-1)/2}\exp\{- \frac{1}{2\sigma_w^2} \sum_{t=1}^{N_T-1} (\gamma_{t+1} - \gamma)^2) \}\\
\propto p(\gamma_1) \exp\{-\frac{1}{2\sigma_w^2}\mathbf{\gamma}^\top M \mathbf{\gamma}\},
\]</span>
where the entries of <span class="math inline">\(M\)</span> are:
<span class="math display">\[
M_{ij} = \begin{cases}
1, &amp; i = j = 1, N_T\\
2, &amp; i = j = 2, 3, \dots, N_T - 1 \\
-1 &amp; i = (j-1), \text{where } j = 2, 3, \dots, N_T\\
-1 &amp; i = (j+1), \text{where } j = 1, 2, \dots, N_T - 1 \\
0 &amp; \text{else}
\end{cases}.
\]</span>
Now, if we assume that <span class="math inline">\(p(\gamma_1) \propto 1\)</span>, i.e., an uninformative, improper prior, we have that
<span class="math display">\[
p(\mathbf{\gamma}) \propto \exp\{-\frac{1}{2\sigma_w^2}\mathbf{\gamma}^\top M \mathbf{\gamma}\},
\]</span>
which implies that, for any <span class="math inline">\(t\)</span>, by Bayes rule,</p>
<p><span class="math display">\[
p(\gamma_t|\mathbf{\gamma}_{-t}) = \frac{p(\mathbf{\gamma})}{p(\mathbf{\gamma}_{-t})} \propto p(\mathbf{\gamma}).
\]</span></p>
<p>Eliminating terms in the joint distribution <span class="math inline">\(P(\gamma)\)</span> not related to <span class="math inline">\(\gamma_t\)</span>, we obtain</p>
<p><span class="math display">\[
p(\gamma_t|\mathbf{\gamma}_{-t}) \propto
\begin{cases}
\exp\{-\frac{1}{2\sigma_w^2}(\gamma_t^2 - 2\gamma_t\gamma_{t+1})\}, &amp; t = 1\\
\exp\{-\frac{1}{2\sigma_w^2}(2\gamma_t^2 - 2\gamma_t\gamma_{t+1} - 2\gamma_{t-1}\gamma_t)\}, &amp; t = 2, 3, \dots, N_T-1 \\
\exp\{-\frac{1}{2\sigma_w^2}(\gamma_t^2 - 2\gamma_{t-1}\gamma_{t})\}, &amp; t = N_T
\end{cases}.
\]</span></p>
<p>The proportional form implies that these are Normal densities. By completing the square, we can obtain</p>
<p><span class="math display">\[
p(\gamma|\gamma_{-t}) \propto \begin{cases}
N(\gamma_{t+1}, \sigma_w^2), &amp; t = 1 \\
N(\frac{\gamma_{t-1}+\gamma_{t+1}}{2}, \sigma^2_w/2), &amp; t = 2, 3 \dots, N_T-1 \\
N(\gamma_{t-1}, \sigma_w^2), &amp; t = N_T
\end{cases},
\]</span>
as required. A necessary assumption for this conclusion was that <span class="math inline">\(p(\gamma_1) \propto 1\)</span>.
## Exercise 11.12 {-}</p>
<p>The joint density of <span class="math inline">\(\gamma_t\)</span> and <span class="math inline">\(\tau_w\)</span>, given <span class="math inline">\(\gamma_{t-1}\)</span> is given by
<span class="math display">\[
p(\gamma_t, \tau_w \mid \gamma_{t-1}) = \frac{\tau_w^{1/2}}{\sqrt{2\pi}}\exp \left(-\frac{\tau(\gamma_t - \gamma_{t-1})^2}{2} \right) \frac{b^a}{\Gamma(a)}\tau_w^{a-1}\exp(-b\tau_w).
\]</span>
Marginalizing <span class="math inline">\(\tau_w\)</span> gives
<span class="math display">\[
p(\gamma_t \mid \gamma_{t-1}) = \int_{0}^{\infty} \frac{\tau_2^{1/2}}{\sqrt{2\pi}}\exp \left(-\frac{\tau(\gamma_t - \gamma_{t-1})^2}{2} \right) \frac{b^a}{\Gamma(a)}\tau_w^{a-1}\exp(-b\tau_w) d\tau_w \\
= \frac{b^2}{\Gamma(a)\sqrt{2\pi}} \int_{0}^\infty \tau_w^{a-0.5} \exp \left(-\tau_w \left[ \frac{(\gamma_t - \gamma_{t-1})^2}{2} + b\right] \right) d\tau_w \\
= \frac{b^a \Gamma(a+0.5)}{\gamma(a)\sqrt{2\pi} ((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}} \int_{0}^\infty \frac{(\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}}{\Gamma(a+0.5)} \tau_w^{(a +0.5) - 1} \exp\left( -\tau_w \left[ \frac{(\gamma_t - \gamma_{t-1})^2}{2} + b\right]\right)\\
= \frac{b^a \Gamma(a+0.5)}{\gamma(a)\sqrt{2\pi} ((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}},
\]</span>
where the last equality follows because the integrand was the density of a Gamma distribution. Now, by Bayes rule, we have the following expression for the posterior:
<span class="math display">\[
p(\tau_{w}|\gamma_t, \gamma_{t-1}) = \frac{p(\gamma_t, \tau_w \mid \gamma_{t-1})}{p(\gamma_t \mid \gamma_{t-1}) } = \frac{((\gamma_t - \gamma_{t-1})^2/2+b)^{a+0.5}}{\Gamma(a + 0.5)}\tau^{(a+0.5)-1} \exp \left(-\tau_w \left[\frac{(\gamma_t - \gamma_{t-1})^2}{2} + b \right] \right),
\]</span>
which is the density function of the <span class="math inline">\(Ga(a + 0.5, (\gamma_t - \gamma_{t-1})^2/2 + b)\)</span> distribution. The shape parameter of the posterior is the prior shape parameter shifted by <span class="math inline">\(0.5\)</span>, and the rate parameter is the prior rate parameter shifted by the term <span class="math inline">\((\gamma_t - \gamma_{t-1})^2/2\)</span>.</p>
</div>
<div id="exercise-11.13" class="section level2 unnumbered hasAnchor">
<h2>Exercise 11.13<a href="Time.html#exercise-11.13" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We use the <code>rjags</code> package here, as it most closely resembles WinBUGS, but is compatible with all operating systems.</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="Time.html#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rjags)</span>
<span id="cb360-2"><a href="Time.html#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code></pre></div>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="Time.html#cb361-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/11_13_data.txt&quot;</span>)</span>
<span id="cb361-2"><a href="Time.html#cb361-2" aria-hidden="true" tabindex="-1"></a>inits1 <span class="ot">&lt;-</span> <span class="fu">source</span>(<span class="st">&quot;data/11_13_model1_inits1.txt&quot;</span>)</span>
<span id="cb361-3"><a href="Time.html#cb361-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb361-4"><a href="Time.html#cb361-4" aria-hidden="true" tabindex="-1"></a>model_ar <span class="ot">&lt;-</span> <span class="fu">jags.model</span>(<span class="at">file =</span> <span class="st">&quot;data/11_13_model1.txt&quot;</span>,</span>
<span id="cb361-5"><a href="Time.html#cb361-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> data<span class="sc">$</span>value,</span>
<span id="cb361-6"><a href="Time.html#cb361-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">inits =</span> inits1<span class="sc">$</span>value,</span>
<span id="cb361-7"><a href="Time.html#cb361-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">n.chains =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 1410
##    Unobserved stochastic nodes: 1514
##    Total graph size: 2934
## 
## Initializing model</code></pre>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="Time.html#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="fu">update</span>(model_ar, <span class="dv">5000</span>) <span class="do">## burn in</span></span>
<span id="cb363-2"><a href="Time.html#cb363-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-3"><a href="Time.html#cb363-3" aria-hidden="true" tabindex="-1"></a>samples_sigmas <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(model_ar, </span>
<span id="cb363-4"><a href="Time.html#cb363-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">variable.names =</span> <span class="fu">c</span>(</span>
<span id="cb363-5"><a href="Time.html#cb363-5" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;sigma.v&quot;</span>,</span>
<span id="cb363-6"><a href="Time.html#cb363-6" aria-hidden="true" tabindex="-1"></a>                                              <span class="st">&quot;sigma.w&quot;</span></span>
<span id="cb363-7"><a href="Time.html#cb363-7" aria-hidden="true" tabindex="-1"></a>                                              ),</span>
<span id="cb363-8"><a href="Time.html#cb363-8" aria-hidden="true" tabindex="-1"></a>                           <span class="at">n.iter =</span> <span class="dv">100</span>, </span>
<span id="cb363-9"><a href="Time.html#cb363-9" aria-hidden="true" tabindex="-1"></a>                           <span class="at">thin =</span> <span class="dv">2</span>)</span>
<span id="cb363-10"><a href="Time.html#cb363-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-11"><a href="Time.html#cb363-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(samples_sigmas, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-1.png" width="672" /></p>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="Time.html#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(samples_sigmas[[<span class="dv">1</span>]], <span class="dv">2</span>, quantile)</span></code></pre></div>
<pre><code>##          sigma.v   sigma.w
## 0%   0.009788876 0.3944185
## 25%  0.010050774 0.4348300
## 50%  0.010248967 0.4414875
## 75%  0.010388581 0.4527602
## 100% 0.010778813 0.4778964</code></pre>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="Time.html#cb366-1" aria-hidden="true" tabindex="-1"></a>samples_gamma <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(model_ar, </span>
<span id="cb366-2"><a href="Time.html#cb366-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">variable.names =</span> <span class="fu">c</span>(</span>
<span id="cb366-3"><a href="Time.html#cb366-3" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;gamma&quot;</span>,</span>
<span id="cb366-4"><a href="Time.html#cb366-4" aria-hidden="true" tabindex="-1"></a>                                <span class="st">&quot;y&quot;</span></span>
<span id="cb366-5"><a href="Time.html#cb366-5" aria-hidden="true" tabindex="-1"></a>                              ),</span>
<span id="cb366-6"><a href="Time.html#cb366-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n.iter =</span> <span class="dv">2000</span>, </span>
<span id="cb366-7"><a href="Time.html#cb366-7" aria-hidden="true" tabindex="-1"></a>                              <span class="at">thin =</span> <span class="dv">1</span>)</span>
<span id="cb366-8"><a href="Time.html#cb366-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-9"><a href="Time.html#cb366-9" aria-hidden="true" tabindex="-1"></a>missings <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(data<span class="sc">$</span>value<span class="sc">$</span>y))</span>
<span id="cb366-10"><a href="Time.html#cb366-10" aria-hidden="true" tabindex="-1"></a>nonmissing <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">var =</span> <span class="st">&quot;y&quot;</span>, <span class="at">time =</span> <span class="fu">as.double</span>(<span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">length</span>(data<span class="sc">$</span>value<span class="sc">$</span>y))),</span>
<span id="cb366-11"><a href="Time.html#cb366-11" aria-hidden="true" tabindex="-1"></a>                         <span class="at">value =</span> data<span class="sc">$</span>value<span class="sc">$</span>y) <span class="sc">|&gt;</span></span>
<span id="cb366-12"><a href="Time.html#cb366-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(time <span class="sc">%in%</span> missings))</span>
<span id="cb366-13"><a href="Time.html#cb366-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb366-14"><a href="Time.html#cb366-14" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(samples_gamma[[<span class="dv">1</span>]])</span>
<span id="cb366-15"><a href="Time.html#cb366-15" aria-hidden="true" tabindex="-1"></a>plot_df <span class="ot">&lt;-</span> plot_df <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb366-16"><a href="Time.html#cb366-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">names_to =</span> <span class="st">&quot;variable&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb366-17"><a href="Time.html#cb366-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(variable, <span class="fu">c</span>(<span class="st">&quot;var&quot;</span>, <span class="st">&quot;time&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb366-18"><a href="Time.html#cb366-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(time)) <span class="sc">|&gt;</span></span>
<span id="cb366-19"><a href="Time.html#cb366-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(var <span class="sc">==</span> <span class="st">&quot;y&quot;</span> <span class="sc">&amp;</span> <span class="sc">!</span>(time <span class="sc">%in%</span> missings))) <span class="sc">|&gt;</span></span>
<span id="cb366-20"><a href="Time.html#cb366-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(nonmissing) <span class="sc">|&gt;</span></span>
<span id="cb366-21"><a href="Time.html#cb366-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(var, time) <span class="sc">|&gt;</span> </span>
<span id="cb366-22"><a href="Time.html#cb366-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">q025 =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb366-23"><a href="Time.html#cb366-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">q975 =</span> <span class="fu">quantile</span>(value, <span class="at">prob =</span> <span class="fl">0.975</span>),</span>
<span id="cb366-24"><a href="Time.html#cb366-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">median =</span> <span class="fu">median</span>(value))<span class="sc">|&gt;</span></span>
<span id="cb366-25"><a href="Time.html#cb366-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">range =</span> q975<span class="sc">-</span>q025)</span></code></pre></div>
<pre><code>## Warning: Expected 2 pieces. Additional pieces discarded in 5844000 rows [1, 2,
## 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, ...].</code></pre>
<pre><code>## `summarise()` has grouped output by &#39;var&#39;. You can override using the `.groups`
## argument.</code></pre>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="Time.html#cb369-1" aria-hidden="true" tabindex="-1"></a>plot_scatter_df <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(plot_df, var, time, median) <span class="sc">|&gt;</span></span>
<span id="cb369-2"><a href="Time.html#cb369-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> var, <span class="at">values_from =</span> median)</span>
<span id="cb369-3"><a href="Time.html#cb369-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-4"><a href="Time.html#cb369-4" aria-hidden="true" tabindex="-1"></a>plot_scatter <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_scatter_df, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> gamma)) <span class="sc">+</span></span>
<span id="cb369-5"><a href="Time.html#cb369-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb369-6"><a href="Time.html#cb369-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-7"><a href="Time.html#cb369-7" aria-hidden="true" tabindex="-1"></a>plot_scatter</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-2.png" width="672" /></p>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="Time.html#cb370-1" aria-hidden="true" tabindex="-1"></a>plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">filter</span>(plot_df, var <span class="sc">==</span> <span class="st">&quot;gamma&quot;</span>), <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb370-2"><a href="Time.html#cb370-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> median), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb370-3"><a href="Time.html#cb370-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> q025), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb370-4"><a href="Time.html#cb370-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> q975), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb370-5"><a href="Time.html#cb370-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(plot_df, (var <span class="sc">==</span> <span class="st">&quot;y&quot;</span> <span class="sc">&amp;</span></span>
<span id="cb370-6"><a href="Time.html#cb370-6" aria-hidden="true" tabindex="-1"></a>                                       time <span class="sc">%in%</span> missings)),</span>
<span id="cb370-7"><a href="Time.html#cb370-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> <span class="dv">0</span>),</span>
<span id="cb370-8"><a href="Time.html#cb370-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>) <span class="sc">+</span> <span class="fu">theme_classic</span>()</span>
<span id="cb370-9"><a href="Time.html#cb370-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb370-10"><a href="Time.html#cb370-10" aria-hidden="true" tabindex="-1"></a>plot</span></code></pre></div>
<p><img src="_main_files/figure-html/Exercise%2011.13-3.png" width="672" /></p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="hazards.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exposure.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/11-Chpt11.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
