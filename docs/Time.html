<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology</title>
  <meta name="description" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  <meta name="generator" content="bookdown 0.32 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/img/cover.jpg" />
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Time-why it also matters | Spatio-temporal methods in environmental epidemiology" />
  
  
  <meta name="twitter:image" content="/img/cover.jpg" />

<meta name="author" content="Gavin Shaddick, James V. Zidek, and Alexandra M. Schmidt" />


<meta name="date" content="2023-03-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="hazards.html"/>
<link rel="next" href="exposure.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatio-temporal methods in environmental epidemiology</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="preface-2nd-edition.html"><a href="preface-2nd-edition.html"><i class="fa fa-check"></i>Preface (2nd edition)</a></li>
<li class="chapter" data-level="1" data-path="why.html"><a href="why.html"><i class="fa fa-check"></i><b>1</b> Why spatio-temporal epidemiology?</a>
<ul>
<li class="chapter" data-level="" data-path="why.html"><a href="why.html#example-1.5"><i class="fa fa-check"></i>Example 1.5</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Epidemiology-the basics</a>
<ul>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.9-estimating-the-smr-using-a-poisson-glm"><i class="fa fa-check"></i>Example 2.9: Estimating the SMR using a Poisson GLM</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.10-estimating-the-smr-using-quasi-likelihood"><i class="fa fa-check"></i>Example 2.10: Estimating the SMR using quasi-likelihood</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.11-modelling-differences-in-smrs-in-relation-to-differences-in-exposures"><i class="fa fa-check"></i>Example 2.11: Modelling differences in SMRs in relation to differences in exposures</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.12-modelling-the-risks-associated-with-lagged-effects-of-air-pollution"><i class="fa fa-check"></i>Example 2.12: Modelling the risks associated with lagged effects of air pollution</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.13-estimating-the-odds-ratio-in-a-case-control-study-using-a-logistic-model"><i class="fa fa-check"></i>Example 2.13: Estimating the odds ratio in a case-control study using a logistic model</a></li>
<li class="chapter" data-level="" data-path="basics.html"><a href="basics.html#example-2.14-estimating-the-odds-ratio-of-asthma-associated-with-proximity-to-roads"><i class="fa fa-check"></i>Example 2.14: Estimating the odds ratio of asthma associated with proximity to roads</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>3</b> Uncertainty and its reduction</a></li>
<li class="chapter" data-level="4" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>4</b> Data: increasing information and reducing uncertainty</a></li>
<li class="chapter" data-level="5" data-path="embracing.html"><a href="embracing.html"><i class="fa fa-check"></i><b>5</b> Embracing uncertainty: the Bayesian approach</a></li>
<li class="chapter" data-level="6" data-path="tactics.html"><a href="tactics.html"><i class="fa fa-check"></i><b>6</b> Tactics-implementing uncertainty models</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.2-chronic-obstructive-pulmonary-disease-copd-in-england"><i class="fa fa-check"></i>Example 6.2: Chronic obstructive pulmonary disease (COPD) in England</a>
<ul>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-the-raw-standardized-mortality-rates-smrs"><i class="fa fa-check"></i>Modelling the raw standardized mortality rates (SMRs)</a></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#modelling-a-poisson-gamma-with-an-mcmc-implemented-in-r"><i class="fa fa-check"></i>Modelling a Poisson-Gamma with an MCMC implemented in <code>R</code></a></li>
</ul></li>
<li class="chapter" data-level="" data-path="tactics.html"><a href="tactics.html#example-6.3-fitting-a-poisson-regression-model-in-nimble"><i class="fa fa-check"></i>Example 6.3: Fitting a Poisson regression model in <code>Nimble</code></a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Strategies.html"><a href="Strategies.html"><i class="fa fa-check"></i><b>7</b> Strategies implementing uncertainty models</a></li>
<li class="chapter" data-level="8" data-path="trusted.html"><a href="trusted.html"><i class="fa fa-check"></i><b>8</b> But can the data be trusted</a>
<ul>
<li class="chapter" data-level="8.1" data-path="trusted.html"><a href="trusted.html#solutions-to-selected-exercises"><i class="fa fa-check"></i><b>8.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="trusted.html"><a href="trusted.html#placeholder-repeat-the-black-smoke-analysis-conducted-in-watson-et-al.-2019.-in-the-naive-model."><i class="fa fa-check"></i><b>8.1.1</b> PLACEHOLDER: Repeat the Black Smoke analysis conducted in Watson et al. 2019. in the “naive” model.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="Disease.html"><a href="Disease.html"><i class="fa fa-check"></i><b>9</b> Disease-spatial patterns</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.1-empirical-bayes-and-bayes-smoothing-of-copd-mortality-for-2010"><i class="fa fa-check"></i>Example 9.1: Empirical Bayes and Bayes smoothing of COPD mortality for 2010</a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.3-fitting-a-conditional-spatial-model-in-nimble-and-stan"><i class="fa fa-check"></i>Example 9.3: Fitting a conditional spatial model in <code>nimble</code> and <code>stan</code></a>
<ul>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#nimble-1"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#stan-1"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.4-fitting-a-conditional-spatial-model-using-carbayes"><i class="fa fa-check"></i>Example 9.4: Fitting a conditional spatial model using CARBayes</a></li>
<li class="chapter" data-level="" data-path="Disease.html"><a href="Disease.html#example-9.5-fitting-a-conditional-model-using-inla"><i class="fa fa-check"></i>Example 9.5: Fitting a conditional model using INLA</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="hazards.html"><a href="hazards.html"><i class="fa fa-check"></i><b>10</b> Environmental hazards-spatial models</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.1-spatial-patterns-of-benzene-concentrations-in-montreal-qc-canada"><i class="fa fa-check"></i>Example 10.1 Spatial patterns of benzene concentrations in Montreal, QC, Canada</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.2-examining-the-log-concentrations-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.2: Examining the log concentrations of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.3-mapping-the-locations-of-ozone-monitoring-sites-in-new-york-state"><i class="fa fa-check"></i>Example 10.3: Mapping the locations of ozone monitoring sites in New York State</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.5-variogram"><i class="fa fa-check"></i>Example 10.5: Variogram</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.6-basic-spatial-modelling-and-prediction-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.6 Basic spatial modelling and prediction of benzene in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.9-spatial-modelling-of-benzene-in-montreal"><i class="fa fa-check"></i>Example 10.9 Spatial modelling of Benzene in Montreal</a>
<ul>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#nimble-2"><i class="fa fa-check"></i>Nimble</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#stan-2"><i class="fa fa-check"></i>Stan</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.12-fitting-an-spde-model-using-rinla-benzene-concentration-in-montreal"><i class="fa fa-check"></i>Example 10.12: Fitting an SPDE model using R–INLA: benzene concentration in Montreal</a></li>
<li class="chapter" data-level="" data-path="hazards.html"><a href="hazards.html#example-10.13-directional-variograms"><i class="fa fa-check"></i>Example 10.13: Directional variograms</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="Time.html"><a href="Time.html"><i class="fa fa-check"></i><b>11</b> Time-why it also matters</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.1-ground-level-ozone-concentrations"><i class="fa fa-check"></i>Example 11.1 Ground level ozone concentrations</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average"><i class="fa fa-check"></i>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.13-forecasting-ozone-levels"><i class="fa fa-check"></i>Example 11.13 Forecasting ozone levels</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.14-forecasting-volcanic-ash"><i class="fa fa-check"></i>Example 11.14 Forecasting volcanic ash</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#example-11.16-implementation-of-a-dynamic-linear-model"><i class="fa fa-check"></i>Example 11.16 implementation of a dynamic linear model</a>
<ul>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#nile-river-data"><i class="fa fa-check"></i>Nile river data</a></li>
<li class="chapter" data-level="" data-path="Time.html"><a href="Time.html#uk-ozone-data"><i class="fa fa-check"></i>UK ozone data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="exposure.html"><a href="exposure.html"><i class="fa fa-check"></i><b>12</b> Exposure assessment-over space and time</a></li>
<li class="chapter" data-level="13" data-path="causality.html"><a href="causality.html"><i class="fa fa-check"></i><b>13</b> Causality-roadblocks on the way to it</a>
<ul>
<li class="chapter" data-level="13.1" data-path="causality.html"><a href="causality.html#solutions-to-selected-exercises-1"><i class="fa fa-check"></i><b>13.1</b> Solutions to Selected Exercises</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="causality.html"><a href="causality.html#question-13.16-load-the-italy-and-china-data-described-in-example-13.3-and-included-in-the-supplementary-bookdown-material-into-r."><i class="fa fa-check"></i><b>13.1.1</b> Question 13.16: Load the Italy and China data, described in Example 13.3, and included in the supplementary Bookdown material into R.</a></li>
<li class="chapter" data-level="13.1.2" data-path="causality.html"><a href="causality.html#question-13.17-using-the-italy-and-china-data-stratified-by-the-age-groups-70-and-geq-70-obtain-empirical-estimates-of-p_1-and-p_2-as-defined-in-an-sdis.-in-the-following-questions-assume-that-p_1-and-p_2-are-the-population-values."><i class="fa fa-check"></i><b>13.1.2</b> Question 13.17: Using the Italy and China data stratified by the age groups <span class="math inline">\(&lt;70\)</span> and <span class="math inline">\(\geq 70\)</span>, obtain empirical estimates of <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span>, as defined in an SDis. In the following questions, assume that <span class="math inline">\(P_1\)</span> and <span class="math inline">\(P_2\)</span> are the population values.</a></li>
<li class="chapter" data-level="13.1.3" data-path="causality.html"><a href="causality.html#question-13.18-stratify-the-italy-and-china-data-by-the-age-groups-50-and-geq-50.-display-the-corresponding-contingency-tables."><i class="fa fa-check"></i><b>13.1.3</b> Question 13.18: Stratify the Italy and China data by the age groups <span class="math inline">\(&lt;50\)</span> and <span class="math inline">\(\geq 50\)</span>. Display the corresponding contingency tables.</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="monitoring.html"><a href="monitoring.html"><i class="fa fa-check"></i><b>14</b> Better monitoring network design-getting better measurements</a></li>
<li class="chapter" data-level="15" data-path="frontiers.html"><a href="frontiers.html"><i class="fa fa-check"></i><b>15</b> Current frontiers</a></li>
<li class="chapter" data-level="" data-path="course.html"><a href="course.html"><i class="fa fa-check"></i>Course</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatio-temporal methods in environmental epidemiology</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="Time" class="section level1 hasAnchor" number="11">
<h1><span class="header-section-number">Chapter 11</span> Time-why it also matters<a href="Time.html#Time" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The chapter contains the theory required for handling time series data. From this chapter, the reader will have gained an understanding of the following topics:</p>
<ul>
<li>That a temporal process consists of both low and high frequency components, the former playing a key role in determining long-term trends while the latter may be associated with shorter-term changes.</li>
<li>Techniques for the exploratory analysis of the data generated by the temporal process, including the ACF (correlogram) and PACF (periodogram).</li>
<li>Models for irregular (high frequency) components after the regular components (trend) have been removed.</li>
<li>Methods for forecasting, including exponential smoothing and ARIMA modelling.</li>
<li>The state space modelling approach, which sits naturally within a Bayesian setting and which provides a general framework for most of the classical time series models and many more besides.</li>
<li>Implementing time series processes within a Bayesian hierarchical framework.</li>
</ul>
<div id="example-11.1-ground-level-ozone-concentrations" class="section level2 unnumbered hasAnchor">
<h2>Example 11.1 Ground level ozone concentrations<a href="Time.html#example-11.1-ground-level-ozone-concentrations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Load the daily and hourly data for one site.</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="Time.html#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb193-2"><a href="Time.html#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="Time.html#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for one site</span></span>
<span id="cb193-4"><a href="Time.html#cb193-4" aria-hidden="true" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb193-5"><a href="Time.html#cb193-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-6"><a href="Time.html#cb193-6" aria-hidden="true" tabindex="-1"></a><span class="co"># change the format of the date column</span></span>
<span id="cb193-7"><a href="Time.html#cb193-7" aria-hidden="true" tabindex="-1"></a>site_daily<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(site_daily<span class="sc">$</span>date, <span class="st">&quot;%m/%d/%Y&quot;</span>)</span>
<span id="cb193-8"><a href="Time.html#cb193-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-9"><a href="Time.html#cb193-9" aria-hidden="true" tabindex="-1"></a><span class="co"># load hourly data from that same site</span></span>
<span id="cb193-10"><a href="Time.html#cb193-10" aria-hidden="true" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb193-11"><a href="Time.html#cb193-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-12"><a href="Time.html#cb193-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot (optional)</span></span>
<span id="cb193-13"><a href="Time.html#cb193-13" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb193-14"><a href="Time.html#cb193-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb193-15"><a href="Time.html#cb193-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb193-16"><a href="Time.html#cb193-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb193-17"><a href="Time.html#cb193-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb193-18"><a href="Time.html#cb193-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># keep axis line</span></span>
<span id="cb193-19"><a href="Time.html#cb193-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb193-20"><a href="Time.html#cb193-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Plot the daily and hourly time series.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="Time.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot daily data</span></span>
<span id="cb194-2"><a href="Time.html#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb194-3"><a href="Time.html#cb194-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb194-4"><a href="Time.html#cb194-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># draw a line at the first data</span></span>
<span id="cb194-5"><a href="Time.html#cb194-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">as.Date</span>(<span class="st">&quot;2013-01-01&quot;</span>), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-6"><a href="Time.html#cb194-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 8 hour regulatory standard of 0.075 (ppm)</span></span>
<span id="cb194-7"><a href="Time.html#cb194-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-8"><a href="Time.html#cb194-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb194-9"><a href="Time.html#cb194-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span> <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.1%20plot%20time%20series-1.png" width="672" /></p>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="Time.html#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot hourly data</span></span>
<span id="cb195-2"><a href="Time.html#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_hourly,) <span class="sc">+</span></span>
<span id="cb195-3"><a href="Time.html#cb195-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb195-4"><a href="Time.html#cb195-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb195-5"><a href="Time.html#cb195-5" aria-hidden="true" tabindex="-1"></a>   <span class="co"># 8 hour regulatory standard of 0.075 (ppm).</span></span>
<span id="cb195-6"><a href="Time.html#cb195-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.075</span>, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb195-7"><a href="Time.html#cb195-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Hour in 2013&#39;s ozone season&quot;</span>) <span class="sc">+</span></span>
<span id="cb195-8"><a href="Time.html#cb195-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Hourly Ozone Concentration (ppm)&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.1%20plot%20time%20series-2.png" width="672" /></p>
</div>
<div id="example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average" class="section level2 unnumbered hasAnchor">
<h2>Example 11.2 Low-pass filtering of carbon monoxide levels using the moving average<a href="Time.html#example-11.2-low-pass-filtering-of-carbon-monoxide-levels-using-the-moving-average" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For this example we will use the TTR package (Technical Trading Rules). This allow us to manipulate objects like time series for forecasting.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="Time.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb196-2"><a href="Time.html#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily data</span></span>
<span id="cb196-3"><a href="Time.html#cb196-3" aria-hidden="true" tabindex="-1"></a>site_daily <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_daily.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb196-4"><a href="Time.html#cb196-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add an identifier column for each day in the sample</span></span>
<span id="cb196-5"><a href="Time.html#cb196-5" aria-hidden="true" tabindex="-1"></a>site_daily<span class="sc">$</span>day <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)</span>
<span id="cb196-6"><a href="Time.html#cb196-6" aria-hidden="true" tabindex="-1"></a><span class="co"># add a theme to clear axes and background in ggplot</span></span>
<span id="cb196-7"><a href="Time.html#cb196-7" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb196-8"><a href="Time.html#cb196-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb196-9"><a href="Time.html#cb196-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb196-10"><a href="Time.html#cb196-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb196-11"><a href="Time.html#cb196-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb196-12"><a href="Time.html#cb196-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>), <span class="co"># keep axis line</span></span>
<span id="cb196-13"><a href="Time.html#cb196-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb196-14"><a href="Time.html#cb196-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="Time.html#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add loess smooth</span></span>
<span id="cb197-2"><a href="Time.html#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Single day</span></span>
<span id="cb197-3"><a href="Time.html#cb197-3" aria-hidden="true" tabindex="-1"></a>ozone.loess <span class="ot">&lt;-</span> <span class="fu">loess</span>(max.ozone <span class="sc">~</span> day, <span class="at">span =</span> <span class="fl">0.75</span>, <span class="at">data =</span> site_daily[,<span class="fu">c</span>(<span class="st">&quot;max.ozone&quot;</span>, <span class="st">&quot;day&quot;</span>)])</span>
<span id="cb197-4"><a href="Time.html#cb197-4" aria-hidden="true" tabindex="-1"></a>ozone.predict <span class="ot">&lt;-</span> <span class="fu">predict</span>(ozone.loess, <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily)))</span>
<span id="cb197-5"><a href="Time.html#cb197-5" aria-hidden="true" tabindex="-1"></a>ozone.predict_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily),</span>
<span id="cb197-6"><a href="Time.html#cb197-6" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ozone.prediction =</span> ozone.predict)</span>
<span id="cb197-7"><a href="Time.html#cb197-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-8"><a href="Time.html#cb197-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> site_daily) <span class="sc">+</span></span>
<span id="cb197-9"><a href="Time.html#cb197-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> max.ozone, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb197-10"><a href="Time.html#cb197-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb197-11"><a href="Time.html#cb197-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb197-12"><a href="Time.html#cb197-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb197-13"><a href="Time.html#cb197-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Single day&quot;</span>) <span class="sc">+</span></span>
<span id="cb197-14"><a href="Time.html#cb197-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.2%20moving%20averages%20plot-1.png" width="672" /></p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="Time.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Three days</span></span>
<span id="cb198-2"><a href="Time.html#cb198-2" aria-hidden="true" tabindex="-1"></a>ozone_SMA3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">3</span>),</span>
<span id="cb198-3"><a href="Time.html#cb198-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb198-4"><a href="Time.html#cb198-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-5"><a href="Time.html#cb198-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA3) <span class="sc">+</span></span>
<span id="cb198-6"><a href="Time.html#cb198-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb198-7"><a href="Time.html#cb198-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb198-8"><a href="Time.html#cb198-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb198-9"><a href="Time.html#cb198-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb198-10"><a href="Time.html#cb198-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Three days&quot;</span>) <span class="sc">+</span></span>
<span id="cb198-11"><a href="Time.html#cb198-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.2%20moving%20averages%20plot-2.png" width="672" /></p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="Time.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Six days</span></span>
<span id="cb199-2"><a href="Time.html#cb199-2" aria-hidden="true" tabindex="-1"></a>ozone_SMA6 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">6</span>),</span>
<span id="cb199-3"><a href="Time.html#cb199-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb199-4"><a href="Time.html#cb199-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-5"><a href="Time.html#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA6) <span class="sc">+</span></span>
<span id="cb199-6"><a href="Time.html#cb199-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb199-7"><a href="Time.html#cb199-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb199-8"><a href="Time.html#cb199-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb199-9"><a href="Time.html#cb199-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb199-10"><a href="Time.html#cb199-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Six days&quot;</span>) <span class="sc">+</span></span>
<span id="cb199-11"><a href="Time.html#cb199-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.2%20moving%20averages%20plot-3.png" width="672" /></p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="Time.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Twelve days</span></span>
<span id="cb200-2"><a href="Time.html#cb200-2" aria-hidden="true" tabindex="-1"></a>ozone_SMA12 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sma =</span> <span class="fu">SMA</span>(site_daily<span class="sc">$</span>max.ozone, <span class="at">n =</span> <span class="dv">12</span>),</span>
<span id="cb200-3"><a href="Time.html#cb200-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(site_daily))</span>
<span id="cb200-4"><a href="Time.html#cb200-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-5"><a href="Time.html#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ozone_SMA12) <span class="sc">+</span></span>
<span id="cb200-6"><a href="Time.html#cb200-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> sma, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb200-7"><a href="Time.html#cb200-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ozone.predict_df, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> ozone.predict)) <span class="sc">+</span></span>
<span id="cb200-8"><a href="Time.html#cb200-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Day in 2013 at Los Angeles Site 060379033&quot;</span>) <span class="sc">+</span></span>
<span id="cb200-9"><a href="Time.html#cb200-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Max Daily 8hr Ozone Level (ppm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb200-10"><a href="Time.html#cb200-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Twelve days&quot;</span>) <span class="sc">+</span></span>
<span id="cb200-11"><a href="Time.html#cb200-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.2%20moving%20averages%20plot-4.png" width="672" /></p>
</div>
<div id="example-11.13-forecasting-ozone-levels" class="section level2 unnumbered hasAnchor">
<h2>Example 11.13 Forecasting ozone levels<a href="Time.html#example-11.13-forecasting-ozone-levels" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="Time.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb201-2"><a href="Time.html#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb201-3"><a href="Time.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Load hourly data for site 060379033</span></span>
<span id="cb201-4"><a href="Time.html#cb201-4" aria-hidden="true" tabindex="-1"></a>site_hourly <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/LA_ozone_hourly.csv&quot;</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb201-5"><a href="Time.html#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="co"># one night hour per day missing for instrument calibration - imputed for simplicity</span></span>
<span id="cb201-6"><a href="Time.html#cb201-6" aria-hidden="true" tabindex="-1"></a>imputeNA <span class="ot">&lt;-</span> <span class="fu">mean</span>(site_hourly<span class="sc">$</span>ozone, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb201-7"><a href="Time.html#cb201-7" aria-hidden="true" tabindex="-1"></a>site_hourly<span class="sc">$</span>ozone[<span class="fu">is.na</span>(site_hourly<span class="sc">$</span>ozone)] <span class="ot">&lt;-</span> imputeNA</span></code></pre></div>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="Time.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the first seven days in july</span></span>
<span id="cb202-2"><a href="Time.html#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="co"># days_pattern contains the dates for the first seven days</span></span>
<span id="cb202-3"><a href="Time.html#cb202-3" aria-hidden="true" tabindex="-1"></a>days_pattern <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;^2013070&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">collapse=</span><span class="st">&quot;|&quot;</span>)</span>
<span id="cb202-4"><a href="Time.html#cb202-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-5"><a href="Time.html#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co"># select all the rows that follow that pattern using grepl</span></span>
<span id="cb202-6"><a href="Time.html#cb202-6" aria-hidden="true" tabindex="-1"></a>july_seven_days <span class="ot">&lt;-</span> site_hourly[<span class="fu">grepl</span>(days_pattern, site_hourly<span class="sc">$</span>datetime),]</span>
<span id="cb202-7"><a href="Time.html#cb202-7" aria-hidden="true" tabindex="-1"></a>july_seven_days<span class="sc">$</span>hours <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(july_seven_days)</span>
<span id="cb202-8"><a href="Time.html#cb202-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-9"><a href="Time.html#cb202-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Holt-Winters model fitting</span></span>
<span id="cb202-10"><a href="Time.html#cb202-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn this into a time series object to use Holt-Winters forecast</span></span>
<span id="cb202-11"><a href="Time.html#cb202-11" aria-hidden="true" tabindex="-1"></a>level_ts <span class="ot">&lt;-</span> <span class="fu">ts</span>(july_seven_days<span class="sc">$</span>ozone,</span>
<span id="cb202-12"><a href="Time.html#cb202-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">frequency =</span> <span class="dv">24</span>,</span>
<span id="cb202-13"><a href="Time.html#cb202-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1</span>))</span>
<span id="cb202-14"><a href="Time.html#cb202-14" aria-hidden="true" tabindex="-1"></a>ozone_forecast <span class="ot">&lt;-</span> <span class="fu">HoltWinters</span>(level_ts)</span>
<span id="cb202-15"><a href="Time.html#cb202-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-16"><a href="Time.html#cb202-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using the default function</span></span>
<span id="cb202-17"><a href="Time.html#cb202-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb202-18"><a href="Time.html#cb202-18" aria-hidden="true" tabindex="-1"></a>  ozone_forecast,</span>
<span id="cb202-19"><a href="Time.html#cb202-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">&quot;Hours - First Week -July 2013&quot;</span>,</span>
<span id="cb202-20"><a href="Time.html#cb202-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">&quot;O3 (ppm)&quot;</span>,</span>
<span id="cb202-21"><a href="Time.html#cb202-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">col.predicted =</span> <span class="dv">1</span>,</span>
<span id="cb202-22"><a href="Time.html#cb202-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb202-23"><a href="Time.html#cb202-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb202-24"><a href="Time.html#cb202-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb202-25"><a href="Time.html#cb202-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.13%20data%20munge-1.png" width="672" /></p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="Time.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Holt- Winters 24 ahead forast on Day 8</span></span>
<span id="cb203-2"><a href="Time.html#cb203-2" aria-hidden="true" tabindex="-1"></a><span class="co"># no need to specify Holt-Winters forecast as the object is already HoltWinters class</span></span>
<span id="cb203-3"><a href="Time.html#cb203-3" aria-hidden="true" tabindex="-1"></a>ozoneforecast_day8 <span class="ot">&lt;-</span> <span class="fu">forecast</span>(ozone_forecast, <span class="at">h=</span><span class="dv">24</span>)</span>
<span id="cb203-4"><a href="Time.html#cb203-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-5"><a href="Time.html#cb203-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using default function</span></span>
<span id="cb203-6"><a href="Time.html#cb203-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ozoneforecast_day8, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.13%20data%20munge-2.png" width="672" /></p>
</div>
<div id="example-11.14-forecasting-volcanic-ash" class="section level2 unnumbered hasAnchor">
<h2>Example 11.14 Forecasting volcanic ash<a href="Time.html#example-11.14-forecasting-volcanic-ash" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data in this example consists of atmospheric levels of volcanic ash from 1500AD to 2000AD.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="Time.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb204-2"><a href="Time.html#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(forecast)</span>
<span id="cb204-3"><a href="Time.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(TTR)</span>
<span id="cb204-4"><a href="Time.html#cb204-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-5"><a href="Time.html#cb204-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load volcano dust data</span></span>
<span id="cb204-6"><a href="Time.html#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="do">## REVIEW: Data source: Hyn�d�man, R.J.  Time Series Data Library, http://data.is/TSDLdemo</span></span>
<span id="cb204-7"><a href="Time.html#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cover the period from 1500AD to 2000AD</span></span>
<span id="cb204-8"><a href="Time.html#cb204-8" aria-hidden="true" tabindex="-1"></a>volcano_dust <span class="ot">&lt;-</span></span>
<span id="cb204-9"><a href="Time.html#cb204-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scan</span>(<span class="st">&quot;https://robjhyndman.com/tsdldata/annual/dvi.dat&quot;</span>, <span class="at">skip =</span> <span class="dv">1</span>)</span>
<span id="cb204-10"><a href="Time.html#cb204-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-11"><a href="Time.html#cb204-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot</span></span>
<span id="cb204-12"><a href="Time.html#cb204-12" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb204-13"><a href="Time.html#cb204-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb204-14"><a href="Time.html#cb204-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb204-15"><a href="Time.html#cb204-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb204-16"><a href="Time.html#cb204-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb204-17"><a href="Time.html#cb204-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>), <span class="co"># keep axis line</span></span>
<span id="cb204-18"><a href="Time.html#cb204-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb204-19"><a href="Time.html#cb204-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The following figure shows the plot of the original time series.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="Time.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Turn data into data frame to plot it in ggplot</span></span>
<span id="cb205-2"><a href="Time.html#cb205-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">year =</span> <span class="dv">1500</span><span class="sc">:</span>(<span class="dv">1500</span><span class="sc">+</span><span class="fu">length</span>(volcano_dust)<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb205-3"><a href="Time.html#cb205-3" aria-hidden="true" tabindex="-1"></a>                              <span class="at">dust =</span> volcano_dust)</span>
<span id="cb205-4"><a href="Time.html#cb205-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-5"><a href="Time.html#cb205-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> volcano_dust_df) <span class="sc">+</span></span>
<span id="cb205-6"><a href="Time.html#cb205-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> dust, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb205-7"><a href="Time.html#cb205-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="sc">+</span></span>
<span id="cb205-8"><a href="Time.html#cb205-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Atmospheric levels of volcanic ash&quot;</span>) <span class="sc">+</span> <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.14%20plot%20time%20series%20ACF%20and%20PACF-1.png" width="672" /></p>
<p>We can also plot the autocorrelogram (ACF) and partial autocorrelogram (PACF) to identify any autocorrelation in the time series.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="Time.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert data into a time series object</span></span>
<span id="cb206-2"><a href="Time.html#cb206-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_series <span class="ot">&lt;-</span> <span class="fu">ts</span>(volcano_dust, <span class="at">start =</span> <span class="fu">c</span>(<span class="dv">1500</span>))</span>
<span id="cb206-3"><a href="Time.html#cb206-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute autocorrelogram with max lag 20</span></span>
<span id="cb206-4"><a href="Time.html#cb206-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(</span>
<span id="cb206-5"><a href="Time.html#cb206-5" aria-hidden="true" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb206-6"><a href="Time.html#cb206-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb206-7"><a href="Time.html#cb206-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb206-8"><a href="Time.html#cb206-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Autocorrelogram volcano dust&quot;</span></span>
<span id="cb206-9"><a href="Time.html#cb206-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.14%20acf%20and%20pacf-1.png" width="672" /></p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="Time.html#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the partial autocorrelogram with max lag 20</span></span>
<span id="cb207-2"><a href="Time.html#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="fu">pacf</span>(</span>
<span id="cb207-3"><a href="Time.html#cb207-3" aria-hidden="true" tabindex="-1"></a>  volcano_dust_series,</span>
<span id="cb207-4"><a href="Time.html#cb207-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">lag.max =</span> <span class="dv">20</span>,</span>
<span id="cb207-5"><a href="Time.html#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb207-6"><a href="Time.html#cb207-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">&quot;Partial autocorrelogram volcano dust&quot;</span></span>
<span id="cb207-7"><a href="Time.html#cb207-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.14%20acf%20and%20pacf-2.png" width="672" /></p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="Time.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding an ARIMA model</span></span>
<span id="cb208-2"><a href="Time.html#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="fu">auto.arima</span>(volcano_dust_series, <span class="at">ic =</span> <span class="st">&quot;aic&quot;</span>)</span></code></pre></div>
<pre><code>## Series: volcano_dust_series 
## ARIMA(1,0,2) with non-zero mean 
## 
## Coefficients:
##          ar1     ma1     ma2     mean
##       0.4723  0.2694  0.1279  57.5178
## s.e.  0.0936  0.0969  0.0752   8.4883
## 
## sigma^2 = 4897:  log likelihood = -2661.84
## AIC=5333.68   AICc=5333.81   BIC=5354.45</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="Time.html#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting the ARIMA(2,0,0) model</span></span>
<span id="cb210-2"><a href="Time.html#cb210-2" aria-hidden="true" tabindex="-1"></a>volcano_dust_arima <span class="ot">&lt;-</span> <span class="fu">arima</span>(volcano_dust_series, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb210-3"><a href="Time.html#cb210-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-4"><a href="Time.html#cb210-4" aria-hidden="true" tabindex="-1"></a><span class="co"># forecast 31 years with the ARIMA(2,0,0) model</span></span>
<span id="cb210-5"><a href="Time.html#cb210-5" aria-hidden="true" tabindex="-1"></a>volcano_dust_forecast <span class="ot">&lt;-</span> <span class="fu">forecast</span>(volcano_dust_arima, <span class="at">h =</span> <span class="dv">31</span>)</span>
<span id="cb210-6"><a href="Time.html#cb210-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(volcano_dust_forecast, <span class="at">bty =</span> <span class="st">&quot;n&quot;</span>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.14%20arima%20model-1.png" width="672" /></p>
</div>
<div id="example-11.16-implementation-of-a-dynamic-linear-model" class="section level2 unnumbered hasAnchor">
<h2>Example 11.16 implementation of a dynamic linear model<a href="Time.html#example-11.16-implementation-of-a-dynamic-linear-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="blackbox">
<div class="center">
<p><strong>NOTE</strong></p>
</div>
<p>The code for the implementation of DLMs in Stan and Nimble was developed by Paritosh Kumar Roy. This code and other more complex DLM structures are available through his <a href="https://github.com/paritoshkroy">github</a>.</p>
</div>
<div id="nile-river-data" class="section level3 unnumbered hasAnchor">
<h3>Nile river data<a href="Time.html#nile-river-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Measurements of the annual flow of the river Nile at Aswan (formerly Assuan), 1871–1970, in <span class="math inline">\(10^8\)</span> <span class="math inline">\(m^3\)</span>, “with apparent change point near 1898” (<span class="math inline">\(\ref{Cobb1978}\)</span>, Table 1, p.249).</p>
<div id="stan-3" class="section level4 unnumbered hasAnchor">
<h4>Stan<a href="Time.html#stan-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb211"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb211-1"><a href="Time.html#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb211-2"><a href="Time.html#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb211-3"><a href="Time.html#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb211-4"><a href="Time.html#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb211-5"><a href="Time.html#cb211-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-6"><a href="Time.html#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb211-7"><a href="Time.html#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb211-8"><a href="Time.html#cb211-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-9"><a href="Time.html#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for RW case</span></span>
<span id="cb211-10"><a href="Time.html#cb211-10" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Nile&quot;</span>, <span class="at">package =</span> <span class="st">&quot;datasets&quot;</span>)</span>
<span id="cb211-11"><a href="Time.html#cb211-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb211-12"><a href="Time.html#cb211-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot (optional)</span></span>
<span id="cb211-13"><a href="Time.html#cb211-13" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb211-14"><a href="Time.html#cb211-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb211-15"><a href="Time.html#cb211-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb211-16"><a href="Time.html#cb211-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb211-17"><a href="Time.html#cb211-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb211-18"><a href="Time.html#cb211-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># keep axis line</span></span>
<span id="cb211-19"><a href="Time.html#cb211-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb211-20"><a href="Time.html#cb211-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="Time.html#cb212-1" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(Nile)</span>
<span id="cb212-2"><a href="Time.html#cb212-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Nile)</span>
<span id="cb212-3"><a href="Time.html#cb212-3" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, J)</span>
<span id="cb212-4"><a href="Time.html#cb212-4" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb212-5"><a href="Time.html#cb212-5" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(y)</span>
<span id="cb212-6"><a href="Time.html#cb212-6" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb212-7"><a href="Time.html#cb212-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb212-8"><a href="Time.html#cb212-8" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb212-9"><a href="Time.html#cb212-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">T =</span> J,</span>
<span id="cb212-10"><a href="Time.html#cb212-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb212-11"><a href="Time.html#cb212-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">F =</span> Ft,</span>
<span id="cb212-12"><a href="Time.html#cb212-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">G =</span> Gt,</span>
<span id="cb212-13"><a href="Time.html#cb212-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">m0 =</span> m0,</span>
<span id="cb212-14"><a href="Time.html#cb212-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">C0 =</span> C0</span>
<span id="cb212-15"><a href="Time.html#cb212-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>functions {
    real uous_dlm_ldensity(array[] real y, array[] real F, real G, real V, real W, real m0, real C0, int T){
    array[T+1] real a;
    array[T+1] real R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real A;
      real L;
      u = y[i] - F[i] * a[i];
      Q = F[i] * R[i] * F[i] + V;
      A = G * R[i] * F[i] * inv(Q);
      L = G - A * F[i];
      lldata[i] = normal_lpdf(u | 0, sqrt(Q));
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L + W;
    }
  return sum(lldata);
  }
  
  
  array[] real uous_ffbs_rng(array[] real y, array[] real F, real G, real V, real W, real m0, real C0, int T){
    
    array[T] real theta;
    array[T] real a;
    array[T] real R;
    array[T] real m;
    array[T] real C;
    
    // Kalman filtering
    
    real mt = m0;
    real Ct = C0;
    
    for(i in 1:T){
      
      real ft;
      real Qt;
      real at;
      real Rt;
      real At;
      
      at = G * mt;
      Rt = G * Ct * G + W;
      ft = F[i] * at;
      Qt = F[i] * Rt * F[i] + V;
      At = Rt * F[i] * inv(Qt);
      mt = at + At * (y[i] - ft);
      Ct = Rt - At * Qt * At;
      
      //store for backward sampling
      a[i] = at;
      R[i] = Rt;
      m[i] = mt;
      C[i] = Ct;
  }
    // backward sampling
    array[T-1] int ind = sort_indices_desc(linspaced_int_array(T-1,1,T-1));
    theta[T] = normal_rng(m[T], sqrt(C[T]));
    for(i in ind) {
      real Bt;
      real ht;
      real Ht;
      Bt = C[i] * G * inv(R[i+1]);
      ht = m[i] + Bt * (theta[i+1] - a[i+1]);
      Ht = C[i] - Bt * G * C[i];
      theta[i] = normal_rng(ht, sqrt(Ht));
    }
  return theta;
}
}
  

data{
  int T;
  array[T] real y;
  array[T] real F;
  real G;
  real m0;
  real&lt;lower=0&gt; C0;
}

parameters{
  real&lt;lower=0&gt; tau;
  real&lt;lower=0&gt; sqrt_W;
}

model {
  real V = square(tau);
  real W = square(sqrt_W);
  tau ~ std_normal();
  sqrt_W ~ std_normal();
  target += uous_dlm_ldensity(y, F, G, V, W, m0, C0, T);
}

generated quantities{
  array[T] real theta;
  real V = square(tau);
  real W = square(sqrt_W);
  theta = uous_ffbs_rng(y, F, G, V, W, m0, C0, T);
}</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="Time.html#cb214-1" aria-hidden="true" tabindex="-1"></a>Example11_16_Nile_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb214-2"><a href="Time.html#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_Nile.stan&quot;</span>,</span>
<span id="cb214-3"><a href="Time.html#cb214-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb214-4"><a href="Time.html#cb214-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb214-5"><a href="Time.html#cb214-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb214-6"><a href="Time.html#cb214-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb214-7"><a href="Time.html#cb214-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb214-8"><a href="Time.html#cb214-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="Time.html#cb215-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_Nile_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;sqrt_W&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20post%20summaries%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="Time.html#cb216-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_Nile_Stan, <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;]&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20post%20summaries%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb217-1"><a href="Time.html#cb217-1" aria-hidden="true" tabindex="-1"></a>stanfit_summary <span class="ot">&lt;-</span> <span class="fu">summary</span>(Example11_16_Nile_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;sqrt_W&quot;</span>,<span class="st">&quot;theta&quot;</span>))</span>
<span id="cb217-2"><a href="Time.html#cb217-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stanfit_summary<span class="sc">$</span>summary)</span></code></pre></div>
<pre><code>##                mean     se_mean         sd       2.5%        25%        50%
## tau        30.64389 0.008404629  0.6416821   29.41102   30.20758   30.63576
## sqrt_W     17.21506 0.011273123  0.8769351   15.51607   16.61797   17.20847
## theta[1] 1016.64864 0.127256079 14.3621162  988.86719 1006.99701 1016.44117
## theta[2] 1056.85361 0.133034738 15.7505555 1026.22258 1046.12525 1056.82528
## theta[3] 1064.38968 0.130097838 15.6423051 1033.54656 1053.91461 1064.57982
## theta[4] 1104.50003 0.135380603 16.1483639 1073.00301 1093.50408 1104.42296
##                 75%      97.5%     n_eff     Rhat
## tau        31.07973   31.92418  5829.117 1.000922
## sqrt_W     17.80102   18.95826  6051.268 1.000392
## theta[1] 1026.41967 1044.64621 12737.371 1.000461
## theta[2] 1067.34249 1088.16050 14017.212 1.000192
## theta[3] 1074.71421 1095.31926 14456.439 1.000053
## theta[4] 1115.43239 1136.06188 14228.010 1.000098</code></pre>
<div class="sourceCode" id="cb219"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb219-1"><a href="Time.html#cb219-1" aria-hidden="true" tabindex="-1"></a>stan_fit_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(stanfit_summary<span class="sc">$</span>summary) <span class="sc">|&gt;</span></span>
<span id="cb219-2"><a href="Time.html#cb219-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb219-3"><a href="Time.html#cb219-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb219-4"><a href="Time.html#cb219-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> zoo<span class="sc">::</span><span class="fu">as.yearmon</span>(<span class="fu">time</span>(Nile))) </span>
<span id="cb219-5"><a href="Time.html#cb219-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-6"><a href="Time.html#cb219-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-7"><a href="Time.html#cb219-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> stan_fit_df, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb219-8"><a href="Time.html#cb219-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb219-9"><a href="Time.html#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb219-10"><a href="Time.html#cb219-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb219-11"><a href="Time.html#cb219-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;gray99&quot;</span>) <span class="sc">+</span></span>
<span id="cb219-12"><a href="Time.html#cb219-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;year&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.</code></pre>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20post%20summaries%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb221-1"><a href="Time.html#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: I am still missing the plots for the fitted values here</span></span></code></pre></div>
</div>
<div id="nimble-3" class="section level4 unnumbered hasAnchor">
<h4>Nimble<a href="Time.html#nimble-3" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="Time.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb222-2"><a href="Time.html#cb222-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb222-3"><a href="Time.html#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb222-4"><a href="Time.html#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb222-5"><a href="Time.html#cb222-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb222-6"><a href="Time.html#cb222-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-7"><a href="Time.html#cb222-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/FFBS_functions_nimble.R&quot;</span>) <span class="co"># load necessary functions for ffbs</span></span>
<span id="cb222-8"><a href="Time.html#cb222-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-9"><a href="Time.html#cb222-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for one site</span></span>
<span id="cb222-10"><a href="Time.html#cb222-10" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;Nile&quot;</span>, <span class="at">package =</span> <span class="st">&quot;datasets&quot;</span>)</span>
<span id="cb222-11"><a href="Time.html#cb222-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-12"><a href="Time.html#cb222-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot (optional)</span></span>
<span id="cb222-13"><a href="Time.html#cb222-13" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb222-14"><a href="Time.html#cb222-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb222-15"><a href="Time.html#cb222-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb222-16"><a href="Time.html#cb222-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb222-17"><a href="Time.html#cb222-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb222-18"><a href="Time.html#cb222-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># keep axis line</span></span>
<span id="cb222-19"><a href="Time.html#cb222-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb222-20"><a href="Time.html#cb222-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb223-1"><a href="Time.html#cb223-1" aria-hidden="true" tabindex="-1"></a>Example11_16_Nile_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb223-2"><a href="Time.html#cb223-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb223-3"><a href="Time.html#cb223-3" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb223-4"><a href="Time.html#cb223-4" aria-hidden="true" tabindex="-1"></a>  Vt <span class="ot">&lt;-</span> tau<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb223-5"><a href="Time.html#cb223-5" aria-hidden="true" tabindex="-1"></a>  sqrt_Wt_diag <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb223-6"><a href="Time.html#cb223-6" aria-hidden="true" tabindex="-1"></a>  Wt <span class="ot">&lt;-</span> sqrt_Wt_diag<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb223-7"><a href="Time.html#cb223-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb223-8"><a href="Time.html#cb223-8" aria-hidden="true" tabindex="-1"></a>  theta_mean[<span class="dv">1</span>] <span class="ot">&lt;-</span> m0</span>
<span id="cb223-9"><a href="Time.html#cb223-9" aria-hidden="true" tabindex="-1"></a>  theta[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(theta_mean[<span class="dv">1</span>], <span class="at">var =</span> C0)</span>
<span id="cb223-10"><a href="Time.html#cb223-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb223-11"><a href="Time.html#cb223-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>J) {</span>
<span id="cb223-12"><a href="Time.html#cb223-12" aria-hidden="true" tabindex="-1"></a>    theta_mean[t<span class="sc">+</span><span class="dv">1</span>] <span class="ot">&lt;-</span> Gt <span class="sc">*</span> theta[t]</span>
<span id="cb223-13"><a href="Time.html#cb223-13" aria-hidden="true" tabindex="-1"></a>    theta[t<span class="sc">+</span><span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(theta_mean[t<span class="sc">+</span><span class="dv">1</span>], <span class="at">var =</span> Wt)</span>
<span id="cb223-14"><a href="Time.html#cb223-14" aria-hidden="true" tabindex="-1"></a>    yt_mean[t] <span class="ot">&lt;-</span> Ft[t] <span class="sc">*</span> theta[t<span class="sc">+</span><span class="dv">1</span>]</span>
<span id="cb223-15"><a href="Time.html#cb223-15" aria-hidden="true" tabindex="-1"></a>    yt[t] <span class="sc">~</span> <span class="fu">dnorm</span>(yt_mean[t], <span class="at">var =</span> Vt)</span>
<span id="cb223-16"><a href="Time.html#cb223-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb223-17"><a href="Time.html#cb223-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb223-18"><a href="Time.html#cb223-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb224-1"><a href="Time.html#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb224-2"><a href="Time.html#cb224-2" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(Nile)</span>
<span id="cb224-3"><a href="Time.html#cb224-3" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Nile)</span>
<span id="cb224-4"><a href="Time.html#cb224-4" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span>, J)</span>
<span id="cb224-5"><a href="Time.html#cb224-5" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb224-6"><a href="Time.html#cb224-6" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(yt)</span>
<span id="cb224-7"><a href="Time.html#cb224-7" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb224-8"><a href="Time.html#cb224-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb224-9"><a href="Time.html#cb224-9" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">J =</span> J)</span>
<span id="cb224-10"><a href="Time.html#cb224-10" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">yt =</span> yt, <span class="at">Ft =</span> Ft, <span class="at">Gt =</span> Gt,  <span class="at">m0 =</span> m0, <span class="at">C0 =</span> C0)</span>
<span id="cb224-11"><a href="Time.html#cb224-11" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fl">0.1</span>, <span class="at">theta =</span> <span class="fu">rep</span>(<span class="dv">0</span>, J<span class="sc">+</span><span class="dv">1</span>))</span>
<span id="cb224-12"><a href="Time.html#cb224-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-13"><a href="Time.html#cb224-13" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(Example11_16_Nile_Nimble, <span class="at">constants=</span>const_list, <span class="at">data=</span>dat_list, <span class="at">inits=</span>init_list)</span>
<span id="cb224-14"><a href="Time.html#cb224-14" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb224-15"><a href="Time.html#cb224-15" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb224-16"><a href="Time.html#cb224-16" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>,<span class="st">&quot;sqrt_Wt_diag&quot;</span>,<span class="st">&quot;theta&quot;</span>))</span>
<span id="cb224-17"><a href="Time.html#cb224-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-18"><a href="Time.html#cb224-18" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;theta[]&quot;</span>)</span>
<span id="cb224-19"><a href="Time.html#cb224-19" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&quot;theta&quot;</span>, <span class="at">type =</span> <span class="st">&quot;ffbs_uous&quot;</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">ytName =</span> <span class="st">&quot;yt&quot;</span>, <span class="at">FtName =</span> <span class="st">&quot;Ft&quot;</span>, <span class="at">VtName =</span> <span class="st">&quot;Vt&quot;</span>, <span class="at">GtName =</span> <span class="st">&quot;Gt&quot;</span>, <span class="at">WtName =</span> <span class="st">&quot;Wt&quot;</span>, <span class="at">m0Name =</span> <span class="st">&quot;m0&quot;</span>, <span class="at">C0Name =</span> <span class="st">&quot;C0&quot;</span>))</span>
<span id="cb224-20"><a href="Time.html#cb224-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-21"><a href="Time.html#cb224-21" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">byType =</span> <span class="cn">TRUE</span>)</span>
<span id="cb224-22"><a href="Time.html#cb224-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-23"><a href="Time.html#cb224-23" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;sqrt_Wt_diag&quot;</span>)</span>
<span id="cb224-24"><a href="Time.html#cb224-24" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="at">type =</span> <span class="st">&quot;RW&quot;</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb224-25"><a href="Time.html#cb224-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-26"><a href="Time.html#cb224-26" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">removeSampler</span>(<span class="at">target =</span> <span class="st">&quot;tau&quot;</span>)</span>
<span id="cb224-27"><a href="Time.html#cb224-27" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&quot;tau&quot;</span>, <span class="at">type =</span> <span class="st">&quot;RW&quot;</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb224-28"><a href="Time.html#cb224-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-29"><a href="Time.html#cb224-29" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">byType =</span> <span class="cn">TRUE</span>)</span>
<span id="cb224-30"><a href="Time.html#cb224-30" aria-hidden="true" tabindex="-1"></a>conf<span class="sc">$</span><span class="fu">printSamplers</span>(<span class="at">executionOrder =</span> <span class="cn">TRUE</span>)</span>
<span id="cb224-31"><a href="Time.html#cb224-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb224-32"><a href="Time.html#cb224-32" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb224-33"><a href="Time.html#cb224-33" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmcmc, <span class="at">project =</span> Cmodel, <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>, </span>
<span id="cb224-34"><a href="Time.html#cb224-34" aria-hidden="true" tabindex="-1"></a>                       <span class="at">showCompilerOutput =</span> <span class="cn">TRUE</span>)</span>
<span id="cb224-35"><a href="Time.html#cb224-35" aria-hidden="true" tabindex="-1"></a>niters <span class="ot">&lt;-</span> <span class="dv">60000</span></span>
<span id="cb224-36"><a href="Time.html#cb224-36" aria-hidden="true" tabindex="-1"></a>nburnins <span class="ot">&lt;-</span> <span class="fl">0.5</span><span class="sc">*</span>niters</span>
<span id="cb224-37"><a href="Time.html#cb224-37" aria-hidden="true" tabindex="-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb224-38"><a href="Time.html#cb224-38" aria-hidden="true" tabindex="-1"></a>nthins <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb224-39"><a href="Time.html#cb224-39" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span> <span class="fu">runMCMC</span>(</span>
<span id="cb224-40"><a href="Time.html#cb224-40" aria-hidden="true" tabindex="-1"></a>  Cmcmc,</span>
<span id="cb224-41"><a href="Time.html#cb224-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">niter =</span> niters,</span>
<span id="cb224-42"><a href="Time.html#cb224-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">nburnin =</span> nburnins,</span>
<span id="cb224-43"><a href="Time.html#cb224-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin =</span> nthins,</span>
<span id="cb224-44"><a href="Time.html#cb224-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">nchains =</span> nchains,</span>
<span id="cb224-45"><a href="Time.html#cb224-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb224-46"><a href="Time.html#cb224-46" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb225-1"><a href="Time.html#cb225-1" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb225-2"><a href="Time.html#cb225-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-3"><a href="Time.html#cb225-3" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb225-4"><a href="Time.html#cb225-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-5"><a href="Time.html#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots</span></span>
<span id="cb225-6"><a href="Time.html#cb225-6" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb225-7"><a href="Time.html#cb225-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(.chain, .iteration, .draw, <span class="st">&#39;tau&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb225-8"><a href="Time.html#cb225-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb225-9"><a href="Time.html#cb225-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb225-10"><a href="Time.html#cb225-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">size =</span> <span class="fl">0.25</span>,</span>
<span id="cb225-11"><a href="Time.html#cb225-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb225-12"><a href="Time.html#cb225-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb225-13"><a href="Time.html#cb225-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb225-14"><a href="Time.html#cb225-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb225-15"><a href="Time.html#cb225-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb226-1"><a href="Time.html#cb226-1" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb226-2"><a href="Time.html#cb226-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(.chain, .iteration, .draw, <span class="st">&#39;sqrt_Wt_diag&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb226-3"><a href="Time.html#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb226-4"><a href="Time.html#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb226-5"><a href="Time.html#cb226-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">size =</span> <span class="fl">0.25</span>,</span>
<span id="cb226-6"><a href="Time.html#cb226-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb226-7"><a href="Time.html#cb226-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb226-8"><a href="Time.html#cb226-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb226-9"><a href="Time.html#cb226-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb226-10"><a href="Time.html#cb226-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20nimble%20traceplots-2.png" width="672" /></p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb227-1"><a href="Time.html#cb227-1" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb227-2"><a href="Time.html#cb227-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(.chain, .iteration, .draw, <span class="fu">paste0</span>(<span class="st">&#39;theta[&#39;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>),<span class="st">&quot;]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb227-3"><a href="Time.html#cb227-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb227-4"><a href="Time.html#cb227-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb227-5"><a href="Time.html#cb227-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb227-6"><a href="Time.html#cb227-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb227-7"><a href="Time.html#cb227-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb227-8"><a href="Time.html#cb227-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb227-9"><a href="Time.html#cb227-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb227-10"><a href="Time.html#cb227-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20nimble%20traceplots-3.png" width="672" /></p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb228-1"><a href="Time.html#cb228-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(post_summary)</span></code></pre></div>
<pre><code>##              post.mean post.sd    q2.5      q50    q97.5 f0    n.eff   Rhat
## sqrt_Wt_diag   107.882  61.411  25.266  121.057  188.266  1 2411.150 10.286
## tau             61.397  60.344   0.026   53.636  143.811  1  550.516 14.878
## theta[1]       921.261  10.105 901.513  921.241  940.873  1 4284.000  1.047
## theta[2]      1052.332  75.143 919.073 1108.214 1123.653  1 2634.552  5.371
## theta[3]      1091.584  78.460 941.369 1148.067 1163.633  1 1756.144  4.556
## theta[4]      1000.384  53.710 951.858  965.527 1133.013  1 1877.161  2.539</code></pre>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb230-1"><a href="Time.html#cb230-1" aria-hidden="true" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb230-2"><a href="Time.html#cb230-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb230-3"><a href="Time.html#cb230-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb230-4"><a href="Time.html#cb230-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, rowname))) <span class="sc">|&gt;</span></span>
<span id="cb230-5"><a href="Time.html#cb230-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(time, post.mean, post.sd, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb230-6"><a href="Time.html#cb230-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-7"><a href="Time.html#cb230-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb230-8"><a href="Time.html#cb230-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb230-9"><a href="Time.html#cb230-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb230-10"><a href="Time.html#cb230-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb230-11"><a href="Time.html#cb230-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb230-12"><a href="Time.html#cb230-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span> <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span> <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/11.16%20nile%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb231-1"><a href="Time.html#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># REVIEW: it is not giving the same results as Stan and the credible intervals</span></span>
<span id="cb231-2"><a href="Time.html#cb231-2" aria-hidden="true" tabindex="-1"></a><span class="co"># are wider</span></span></code></pre></div>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb232-1"><a href="Time.html#cb232-1" aria-hidden="true" tabindex="-1"></a>Cnim_postfit_uous <span class="ot">&lt;-</span></span>
<span id="cb232-2"><a href="Time.html#cb232-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(nim_postfit_uous, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>## Compiling
##   [Note] This may take a minute.
##   [Note] Use &#39;showCompilerOutput = TRUE&#39; to see C++ compilation details.</code></pre>
<div class="sourceCode" id="cb234"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb234-1"><a href="Time.html#cb234-1" aria-hidden="true" tabindex="-1"></a>post_tau <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>tau</span>
<span id="cb234-2"><a href="Time.html#cb234-2" aria-hidden="true" tabindex="-1"></a>post_sqrt_Wt_diag <span class="ot">&lt;-</span> tidy_post_samples<span class="sc">$</span>sqrt_Wt_diag</span>
<span id="cb234-3"><a href="Time.html#cb234-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-4"><a href="Time.html#cb234-4" aria-hidden="true" tabindex="-1"></a>post_ft_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(post_tau), <span class="cf">function</span>(i) {</span>
<span id="cb234-5"><a href="Time.html#cb234-5" aria-hidden="true" tabindex="-1"></a>  post_Vt <span class="ot">&lt;-</span> post_tau[i] <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb234-6"><a href="Time.html#cb234-6" aria-hidden="true" tabindex="-1"></a>  post_Wt <span class="ot">&lt;-</span> post_sqrt_Wt_diag[i] <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb234-7"><a href="Time.html#cb234-7" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span> <span class="fu">Cnim_postfit_uous</span>(</span>
<span id="cb234-8"><a href="Time.html#cb234-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">yt =</span> dat_list<span class="sc">$</span>yt,</span>
<span id="cb234-9"><a href="Time.html#cb234-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">Ft =</span> dat_list<span class="sc">$</span>Ft,</span>
<span id="cb234-10"><a href="Time.html#cb234-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">Vt =</span> post_Vt,</span>
<span id="cb234-11"><a href="Time.html#cb234-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">Gt =</span> dat_list<span class="sc">$</span>Gt,</span>
<span id="cb234-12"><a href="Time.html#cb234-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Wt =</span> post_Wt,</span>
<span id="cb234-13"><a href="Time.html#cb234-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">m0 =</span> dat_list<span class="sc">$</span>m0,</span>
<span id="cb234-14"><a href="Time.html#cb234-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">C0 =</span> dat_list<span class="sc">$</span>C0</span>
<span id="cb234-15"><a href="Time.html#cb234-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb234-16"><a href="Time.html#cb234-16" aria-hidden="true" tabindex="-1"></a>  post_ft <span class="ot">&lt;-</span></span>
<span id="cb234-17"><a href="Time.html#cb234-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">ft =</span> post_ft) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">row_number</span>())</span>
<span id="cb234-18"><a href="Time.html#cb234-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(post_ft)</span>
<span id="cb234-19"><a href="Time.html#cb234-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb234-20"><a href="Time.html#cb234-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-21"><a href="Time.html#cb234-21" aria-hidden="true" tabindex="-1"></a>tidy_post_ft <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;rbind&quot;</span>, post_ft_list)</span>
<span id="cb234-22"><a href="Time.html#cb234-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-23"><a href="Time.html#cb234-23" aria-hidden="true" tabindex="-1"></a><span class="do">## posterior summaries of ft</span></span>
<span id="cb234-24"><a href="Time.html#cb234-24" aria-hidden="true" tabindex="-1"></a>post_sum_ft <span class="ot">&lt;-</span> tidy_post_ft <span class="sc">|&gt;</span> <span class="fu">group_by</span>(time) <span class="sc">|&gt;</span></span>
<span id="cb234-25"><a href="Time.html#cb234-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb234-26"><a href="Time.html#cb234-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">post.mean =</span> <span class="fu">mean</span>(ft),</span>
<span id="cb234-27"><a href="Time.html#cb234-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">post.sd =</span> <span class="fu">sd</span>(ft),</span>
<span id="cb234-28"><a href="Time.html#cb234-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">q2.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.025</span>),</span>
<span id="cb234-29"><a href="Time.html#cb234-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">q50 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.50</span>),</span>
<span id="cb234-30"><a href="Time.html#cb234-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">q97.5 =</span> <span class="fu">quantile</span>(ft, <span class="at">prob =</span> <span class="fl">0.975</span>)</span>
<span id="cb234-31"><a href="Time.html#cb234-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb234-32"><a href="Time.html#cb234-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb234-33"><a href="Time.html#cb234-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-34"><a href="Time.html#cb234-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_ft, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb234-35"><a href="Time.html#cb234-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>), <span class="at">fill =</span> <span class="st">&quot;lightblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-36"><a href="Time.html#cb234-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> post.mean), <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb234-37"><a href="Time.html#cb234-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> yt), <span class="at">size =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb234-38"><a href="Time.html#cb234-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-39"><a href="Time.html#cb234-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb234-40"><a href="Time.html#cb234-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>()</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20nile%20nimble%20fitted%20values-1.png" width="672" /></p>
</div>
</div>
<div id="uk-ozone-data" class="section level3 unnumbered hasAnchor">
<h3>UK ozone data<a href="Time.html#uk-ozone-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="stan-4" class="section level4 hasAnchor" number="11.0.0.1">
<h4><span class="header-section-number">11.0.0.1</span> Stan<a href="Time.html#stan-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb235"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb235-1"><a href="Time.html#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb235-2"><a href="Time.html#cb235-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb235-3"><a href="Time.html#cb235-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb235-4"><a href="Time.html#cb235-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb235-5"><a href="Time.html#cb235-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb235-6"><a href="Time.html#cb235-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-7"><a href="Time.html#cb235-7" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>())</span>
<span id="cb235-8"><a href="Time.html#cb235-8" aria-hidden="true" tabindex="-1"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb235-9"><a href="Time.html#cb235-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-10"><a href="Time.html#cb235-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for RW case</span></span>
<span id="cb235-11"><a href="Time.html#cb235-11" aria-hidden="true" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/uk_ozone_one_site.csv&quot;</span>)</span>
<span id="cb235-12"><a href="Time.html#cb235-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot (optional)</span></span>
<span id="cb235-13"><a href="Time.html#cb235-13" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb235-14"><a href="Time.html#cb235-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb235-15"><a href="Time.html#cb235-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb235-16"><a href="Time.html#cb235-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb235-17"><a href="Time.html#cb235-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb235-18"><a href="Time.html#cb235-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># keep axis line</span></span>
<span id="cb235-19"><a href="Time.html#cb235-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb235-20"><a href="Time.html#cb235-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb236"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb236-1"><a href="Time.html#cb236-1" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>ozone</span>
<span id="cb236-2"><a href="Time.html#cb236-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb236-3"><a href="Time.html#cb236-3" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb236-4"><a href="Time.html#cb236-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-5"><a href="Time.html#cb236-5" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb236-6"><a href="Time.html#cb236-6" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb236-7"><a href="Time.html#cb236-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-8"><a href="Time.html#cb236-8" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(J, p))</span>
<span id="cb236-9"><a href="Time.html#cb236-9" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb236-10"><a href="Time.html#cb236-10" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">2</span>] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>J] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>J])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>J])</span>
<span id="cb236-11"><a href="Time.html#cb236-11" aria-hidden="true" tabindex="-1"></a>Ft[, <span class="dv">3</span>] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>J] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>J])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>J])</span>
<span id="cb236-12"><a href="Time.html#cb236-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-13"><a href="Time.html#cb236-13" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb236-14"><a href="Time.html#cb236-14" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(y), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb236-15"><a href="Time.html#cb236-15" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb236-16"><a href="Time.html#cb236-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-17"><a href="Time.html#cb236-17" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">T =</span> J, <span class="at">p =</span> p, <span class="at">y =</span> y, <span class="at">F =</span> Ft, <span class="at">G =</span> Gt, <span class="at">m0=</span> m0, <span class="at">C0 =</span> C0)</span></code></pre></div>
<pre><code>functions {
  
  // FFBS for DLM with univariate observation equation and univariate system equation
  array[] vector uoms_ffbs_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    
    array[T] vector[p] theta;
    array[T] vector[p] a;
    array[T] matrix[p,p] R;
    array[T] vector[p] m;
    array[T] matrix[p,p] C;
    
    // Kalman filtering
    
    vector[p] mt = m0;
    matrix[p,p] Ct = C0;
    
    for(i in 1:T){
      
      real ft;
      real Qt;
      vector[p] at;
      matrix[p,p] Rt;
      vector[p] At;
      
      at = G * mt;
      Rt = G * Ct * G&#39; + W;
      ft = F[i]&#39; * at;
      Qt = quad_form(Rt, F[i]) + V; //F[i]&#39; * Rt * F[i] + V;
      At = Rt * F[i] * inv(Qt);
      mt = at + At * (y[i] - ft);
      Ct = Rt - At * Qt * At&#39;;
      
      //store for backward sampling
      a[i] = at;
      R[i] = Rt;
      m[i] = mt;
      C[i] = Ct;
  }
    // backward sampling
    array[T-1] int ind = sort_indices_desc(linspaced_int_array(T-1,1,T-1));
    theta[T] = multi_normal_rng(m[T], C[T]);
    for(i in ind) {
      matrix[p,p] Bt;
      vector[p] ht;
      matrix[p,p] Ht;
      Bt = C[i] * G&#39; * inverse(R[i+1]);
      ht = m[i] + Bt * (theta[i+1] - a[i+1]);
      Ht = C[i] - Bt * R[i+1] * Bt&#39;;
      theta[i] = multi_normal_rng(ht, Ht);
    }
  return theta;
}

  real uoms_dlm_ldensity(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      //lldata[i] = -0.5 * (log(2 * pi()) + log(Q) + Qinv*square(u));
      lldata[i] = normal_lpdf(u | 0, sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return sum(lldata);
  }
  
  array[] real uoms_dlm_one_step_ahead_rng(array[] real y, array[] vector F, matrix G, real V, matrix W, vector m0, matrix C0, int T, int p){
    array[T] real yfit;
    array[T+1] vector[p] a;
    array[T+1] matrix[p, p] R;
    array[T] real lldata;
    a[1] = m0;
    R[1] = C0;
    for (i in 1:T) {
      real u;
      real Q;
      real Qinv;
      vector[p] A;
      matrix[p, p] L;
      u = y[i] - F[i]&#39; * a[i];
      Q = quad_form(R[i],F[i]) + V; //F[i]&#39; * R[i] * F[i] + V;
      Qinv = inv(Q); //
      A = G * R[i] * F[i] * Qinv;
      L = G - A * F[i]&#39;;
      yfit[i] = normal_rng(F[i]&#39; * a[i], sqrt(Q)); // univariate
      a[i+1] = G * a[i] + A * u;
      R[i+1] = G * R[i] * L&#39; + W;
    }
  return yfit;
  }
}

data{
  int T;
  int p;
  array[T] real y;
  array[T] vector[p] F;
  matrix[p, p] G;
  vector[p] m0;
  cov_matrix[p] C0;
}

parameters{
  real&lt;lower=0&gt; tau;
  vector&lt;lower=0&gt;[p] sqrt_W_diag;
}

model {
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  tau ~ std_normal();
  sqrt_W_diag ~ std_normal();
  target += uoms_dlm_ldensity(y, F, G, V, W, m0, C0, T, p);
}

generated quantities{
  array[T] vector[p] theta;
  array[T] real yfit;
  real V = square(tau);
  matrix[p, p] W = diag_matrix(square(sqrt_W_diag));
  theta = uoms_ffbs_rng(y, F, G, V, W, m0, C0, T, p);
  yfit = uoms_dlm_one_step_ahead_rng(y, F, G, V, W, m0, C0, T, p);
}</code></pre>
<div class="sourceCode" id="cb238"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb238-1"><a href="Time.html#cb238-1" aria-hidden="true" tabindex="-1"></a>Example11_16_UK_Stan  <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb238-2"><a href="Time.html#cb238-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;functions/Example11_16_UK.stan&quot;</span>,</span>
<span id="cb238-3"><a href="Time.html#cb238-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb238-4"><a href="Time.html#cb238-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5000</span>,</span>
<span id="cb238-5"><a href="Time.html#cb238-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">10000</span>,</span>
<span id="cb238-6"><a href="Time.html#cb238-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">3</span>,</span>
<span id="cb238-7"><a href="Time.html#cb238-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">include =</span> <span class="cn">TRUE</span></span>
<span id="cb238-8"><a href="Time.html#cb238-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning: There were 3 divergent transitions after warmup. See
## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
## to find out why this is a problem and how to eliminate them.</code></pre>
<pre><code>## Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<div class="sourceCode" id="cb241"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb241-1"><a href="Time.html#cb241-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan,</span>
<span id="cb241-2"><a href="Time.html#cb241-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>, <span class="st">&quot;theta[1,1]&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20ozone%20post%20summaries%20stan-1.png" width="672" /></p>
<div class="sourceCode" id="cb242"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb242-1"><a href="Time.html#cb242-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb242-2"><a href="Time.html#cb242-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,1]&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20ozone%20post%20summaries%20stan-2.png" width="672" /></p>
<div class="sourceCode" id="cb243"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb243-1"><a href="Time.html#cb243-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb243-2"><a href="Time.html#cb243-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,2]&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20ozone%20post%20summaries%20stan-3.png" width="672" /></p>
<div class="sourceCode" id="cb244"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb244-1"><a href="Time.html#cb244-1" aria-hidden="true" tabindex="-1"></a>rstan<span class="sc">::</span><span class="fu">traceplot</span>(Example11_16_UK_Stan, </span>
<span id="cb244-2"><a href="Time.html#cb244-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="fu">sample.int</span>(J, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>), <span class="st">&quot;,3]&quot;</span>))</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20ozone%20post%20summaries%20stan-4.png" width="672" /></p>
<div class="sourceCode" id="cb245"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb245-1"><a href="Time.html#cb245-1" aria-hidden="true" tabindex="-1"></a>fixedpars_summary <span class="ot">&lt;-</span></span>
<span id="cb245-2"><a href="Time.html#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_W_diag&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb245-3"><a href="Time.html#cb245-3" aria-hidden="true" tabindex="-1"></a>fixedpars_summary</span></code></pre></div>
<pre><code>##                     mean     se_mean        sd       2.5%       25%       50%
## tau            7.3557829 0.004703800 0.3914611 6.59253412 7.0908380 7.3510177
## sqrt_W_diag[1] 2.6462922 0.007553726 0.6006965 1.50477136 2.2329780 2.6424571
## sqrt_W_diag[2] 0.2467058 0.001120097 0.1160182 0.08187897 0.1652562 0.2251065
## sqrt_W_diag[3] 0.5913775 0.005970895 0.5270182 0.01756817 0.1828199 0.4388231
##                      75%     97.5%     n_eff     Rhat
## tau            7.6161639 8.1418875  6925.950 1.001010
## sqrt_W_diag[1] 3.0500270 3.8559789  6323.940 1.000710
## sqrt_W_diag[2] 0.3045374 0.5329845 10728.547 1.000586
## sqrt_W_diag[3] 0.8532805 1.9277302  7790.626 1.000073</code></pre>
<div class="sourceCode" id="cb247"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb247-1"><a href="Time.html#cb247-1" aria-hidden="true" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span></span>
<span id="cb247-2"><a href="Time.html#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(Example11_16_UK_Stan, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">&quot;theta&quot;</span>))<span class="sc">$</span>summary</span>
<span id="cb247-3"><a href="Time.html#cb247-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-4"><a href="Time.html#cb247-4" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb247-5"><a href="Time.html#cb247-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb247-6"><a href="Time.html#cb247-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>J, <span class="st">&quot;,1]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb247-7"><a href="Time.html#cb247-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>J])) <span class="sc">|&gt;</span></span>
<span id="cb247-8"><a href="Time.html#cb247-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">group =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb247-9"><a href="Time.html#cb247-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb247-10"><a href="Time.html#cb247-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb247-11"><a href="Time.html#cb247-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb247-12"><a href="Time.html#cb247-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb247-13"><a href="Time.html#cb247-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Intercept&quot;</span>) <span class="sc">+</span> <span class="fu">theme_clear</span>() <span class="sc">+</span></span>
<span id="cb247-14"><a href="Time.html#cb247-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb247-15"><a href="Time.html#cb247-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-16"><a href="Time.html#cb247-16" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb247-17"><a href="Time.html#cb247-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb247-18"><a href="Time.html#cb247-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>J, <span class="st">&quot;,2]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb247-19"><a href="Time.html#cb247-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>J])) <span class="sc">|&gt;</span></span>
<span id="cb247-20"><a href="Time.html#cb247-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb247-21"><a href="Time.html#cb247-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb247-22"><a href="Time.html#cb247-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb247-23"><a href="Time.html#cb247-23" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb247-24"><a href="Time.html#cb247-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb247-25"><a href="Time.html#cb247-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Wind&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_clear</span>() <span class="sc">+</span></span>
<span id="cb247-26"><a href="Time.html#cb247-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb247-27"><a href="Time.html#cb247-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-28"><a href="Time.html#cb247-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-29"><a href="Time.html#cb247-29" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta_summary) <span class="sc">|&gt;</span></span>
<span id="cb247-30"><a href="Time.html#cb247-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb247-31"><a href="Time.html#cb247-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rowname <span class="sc">%in%</span> <span class="fu">paste0</span>(<span class="st">&quot;theta[&quot;</span>, <span class="dv">1</span><span class="sc">:</span>J, <span class="st">&quot;,3]&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb247-32"><a href="Time.html#cb247-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(UK_ozone<span class="sc">$</span>date[<span class="dv">1</span><span class="sc">:</span>J])) <span class="sc">|&gt;</span></span>
<span id="cb247-33"><a href="Time.html#cb247-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb247-34"><a href="Time.html#cb247-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> mean), <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb247-35"><a href="Time.html#cb247-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> X2.<span class="fl">5.</span>, <span class="at">ymax =</span> X97.<span class="fl">5.</span>),</span>
<span id="cb247-36"><a href="Time.html#cb247-36" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>,</span>
<span id="cb247-37"><a href="Time.html#cb247-37" aria-hidden="true" tabindex="-1"></a>              <span class="at">col =</span> <span class="st">&quot;lightgray&quot;</span>) <span class="sc">+</span></span>
<span id="cb247-38"><a href="Time.html#cb247-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&quot;Temperature&quot;</span>) <span class="sc">+</span>  <span class="fu">theme_clear</span>() <span class="sc">+</span></span>
<span id="cb247-39"><a href="Time.html#cb247-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb247-40"><a href="Time.html#cb247-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-41"><a href="Time.html#cb247-41" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1,p2,p3, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20ozone%20post%20summaries%20stan-5.png" width="672" /></p>
<div class="sourceCode" id="cb248"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb248-1"><a href="Time.html#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: I am still missing the plots for the fitted values here</span></span></code></pre></div>
</div>
<div id="nimble-4" class="section level4 hasAnchor" number="11.0.0.2">
<h4><span class="header-section-number">11.0.0.2</span> Nimble<a href="Time.html#nimble-4" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<div class="sourceCode" id="cb249"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb249-1"><a href="Time.html#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda)</span>
<span id="cb249-2"><a href="Time.html#cb249-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb249-3"><a href="Time.html#cb249-3" aria-hidden="true" tabindex="-1"></a><span class="co">#library(sf)</span></span>
<span id="cb249-4"><a href="Time.html#cb249-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb249-5"><a href="Time.html#cb249-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble, <span class="at">warn.conflicts =</span> <span class="cn">FALSE</span>)</span>
<span id="cb249-6"><a href="Time.html#cb249-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nleqslv)</span>
<span id="cb249-7"><a href="Time.html#cb249-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb249-8"><a href="Time.html#cb249-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-9"><a href="Time.html#cb249-9" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions/FFBS_functions_nimble.R&quot;</span>)</span>
<span id="cb249-10"><a href="Time.html#cb249-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-11"><a href="Time.html#cb249-11" aria-hidden="true" tabindex="-1"></a>UK_ozone <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/uk_ozone_one_site.csv&quot;</span>)</span>
<span id="cb249-12"><a href="Time.html#cb249-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a theme to clear axes and background in ggplot (optional)</span></span>
<span id="cb249-13"><a href="Time.html#cb249-13" aria-hidden="true" tabindex="-1"></a>theme_clear <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb249-14"><a href="Time.html#cb249-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb249-15"><a href="Time.html#cb249-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="co"># remove background grid</span></span>
<span id="cb249-16"><a href="Time.html#cb249-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb249-17"><a href="Time.html#cb249-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.background =</span> <span class="fu">element_blank</span>(), <span class="co"># remove grey background</span></span>
<span id="cb249-18"><a href="Time.html#cb249-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.line =</span> <span class="fu">element_line</span>(<span class="at">colour =</span> <span class="st">&quot;black&quot;</span>) <span class="co"># keep axis line</span></span>
<span id="cb249-19"><a href="Time.html#cb249-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb249-20"><a href="Time.html#cb249-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb250-1"><a href="Time.html#cb250-1" aria-hidden="true" tabindex="-1"></a>Example11_16_O3_Nimble <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb250-2"><a href="Time.html#cb250-2" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb250-3"><a href="Time.html#cb250-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb250-4"><a href="Time.html#cb250-4" aria-hidden="true" tabindex="-1"></a>    Vt[t] <span class="ot">&lt;-</span> tau <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb250-5"><a href="Time.html#cb250-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-6"><a href="Time.html#cb250-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-7"><a href="Time.html#cb250-7" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb250-8"><a href="Time.html#cb250-8" aria-hidden="true" tabindex="-1"></a>    sqrt_Wt_diag[j] <span class="sc">~</span> <span class="fu">T</span>(<span class="fu">dt</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">df =</span> <span class="dv">1</span>), <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb250-9"><a href="Time.html#cb250-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-10"><a href="Time.html#cb250-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-11"><a href="Time.html#cb250-11" aria-hidden="true" tabindex="-1"></a>  Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> <span class="fu">nim_diag</span>(<span class="at">x =</span> sqrt_Wt_diag[<span class="dv">1</span><span class="sc">:</span>p] <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb250-12"><a href="Time.html#cb250-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-13"><a href="Time.html#cb250-13" aria-hidden="true" tabindex="-1"></a>  mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> m0[<span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb250-14"><a href="Time.html#cb250-14" aria-hidden="true" tabindex="-1"></a>  Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="ot">&lt;-</span> C0[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb250-15"><a href="Time.html#cb250-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-16"><a href="Time.html#cb250-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>Tt) {</span>
<span id="cb250-17"><a href="Time.html#cb250-17" aria-hidden="true" tabindex="-1"></a>    at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> mt[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>]</span>
<span id="cb250-18"><a href="Time.html#cb250-18" aria-hidden="true" tabindex="-1"></a>    Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span></span>
<span id="cb250-19"><a href="Time.html#cb250-19" aria-hidden="true" tabindex="-1"></a>      Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p] <span class="sc">%*%</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]) <span class="sc">+</span> Wt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p]</span>
<span id="cb250-20"><a href="Time.html#cb250-20" aria-hidden="true" tabindex="-1"></a>    ft[t] <span class="ot">&lt;-</span> (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> at[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb250-21"><a href="Time.html#cb250-21" aria-hidden="true" tabindex="-1"></a>    Qt[t] <span class="ot">&lt;-</span></span>
<span id="cb250-22"><a href="Time.html#cb250-22" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">t</span>(Ft[<span class="dv">1</span><span class="sc">:</span>p, t]) <span class="sc">%*%</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> Vt[t])[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb250-23"><a href="Time.html#cb250-23" aria-hidden="true" tabindex="-1"></a>    yt[t] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="at">mean =</span> ft[t], <span class="at">var =</span> Qt[t])</span>
<span id="cb250-24"><a href="Time.html#cb250-24" aria-hidden="true" tabindex="-1"></a>    At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="ot">&lt;-</span> (Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> Ft[<span class="dv">1</span><span class="sc">:</span>p, t])[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span>] <span class="sc">/</span> Qt[t]</span>
<span id="cb250-25"><a href="Time.html#cb250-25" aria-hidden="true" tabindex="-1"></a>    mt[<span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> at[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">+</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">*</span> (yt[t] <span class="sc">-</span> ft[t]))</span>
<span id="cb250-26"><a href="Time.html#cb250-26" aria-hidden="true" tabindex="-1"></a>    Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span></span>
<span id="cb250-27"><a href="Time.html#cb250-27" aria-hidden="true" tabindex="-1"></a>      Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">-</span> (At[<span class="dv">1</span><span class="sc">:</span>p, t] <span class="sc">%*%</span> <span class="fu">t</span>(At[<span class="dv">1</span><span class="sc">:</span>p, t])) <span class="sc">*</span> Qt[t]</span>
<span id="cb250-28"><a href="Time.html#cb250-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb250-29"><a href="Time.html#cb250-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-30"><a href="Time.html#cb250-30" aria-hidden="true" tabindex="-1"></a>  theta[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)] <span class="ot">&lt;-</span></span>
<span id="cb250-31"><a href="Time.html#cb250-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nim_bsample</span>(</span>
<span id="cb250-32"><a href="Time.html#cb250-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">mt =</span> mt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb250-33"><a href="Time.html#cb250-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">Ct =</span> Ct[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>(Tt <span class="sc">+</span> <span class="dv">1</span>)],</span>
<span id="cb250-34"><a href="Time.html#cb250-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">at =</span> at[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt],</span>
<span id="cb250-35"><a href="Time.html#cb250-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">Gt =</span> Gt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p],</span>
<span id="cb250-36"><a href="Time.html#cb250-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">Rt =</span> Rt[<span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>p, <span class="dv">1</span><span class="sc">:</span>Tt]</span>
<span id="cb250-37"><a href="Time.html#cb250-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb250-38"><a href="Time.html#cb250-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb250-39"><a href="Time.html#cb250-39" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<div class="sourceCode" id="cb251"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb251-1"><a href="Time.html#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification</span></span>
<span id="cb251-2"><a href="Time.html#cb251-2" aria-hidden="true" tabindex="-1"></a>yt <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>ozone</span>
<span id="cb251-3"><a href="Time.html#cb251-3" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>temp</span>
<span id="cb251-4"><a href="Time.html#cb251-4" aria-hidden="true" tabindex="-1"></a>wind <span class="ot">&lt;-</span> UK_ozone<span class="sc">$</span>wind</span>
<span id="cb251-5"><a href="Time.html#cb251-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-6"><a href="Time.html#cb251-6" aria-hidden="true" tabindex="-1"></a>Tt <span class="ot">&lt;-</span> <span class="fu">length</span>(yt)</span>
<span id="cb251-7"><a href="Time.html#cb251-7" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># (intercept, wind, temp)</span></span>
<span id="cb251-8"><a href="Time.html#cb251-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-9"><a href="Time.html#cb251-9" aria-hidden="true" tabindex="-1"></a>Ft <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>( p, Tt))</span>
<span id="cb251-10"><a href="Time.html#cb251-10" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb251-11"><a href="Time.html#cb251-11" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">2</span>,] <span class="ot">&lt;-</span> (wind[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(wind[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb251-12"><a href="Time.html#cb251-12" aria-hidden="true" tabindex="-1"></a>Ft[ <span class="dv">3</span>,] <span class="ot">&lt;-</span> (temp[<span class="dv">1</span><span class="sc">:</span>Tt] <span class="sc">-</span> <span class="fu">mean</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])) <span class="sc">/</span> <span class="fu">sd</span>(temp[<span class="dv">1</span><span class="sc">:</span>Tt])</span>
<span id="cb251-13"><a href="Time.html#cb251-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-14"><a href="Time.html#cb251-14" aria-hidden="true" tabindex="-1"></a>Gt <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb251-15"><a href="Time.html#cb251-15" aria-hidden="true" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(yt), <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb251-16"><a href="Time.html#cb251-16" aria-hidden="true" tabindex="-1"></a>C0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">nrow =</span> p, <span class="at">ncol =</span> p)</span>
<span id="cb251-17"><a href="Time.html#cb251-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-18"><a href="Time.html#cb251-18" aria-hidden="true" tabindex="-1"></a>const_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Tt =</span> Tt,</span>
<span id="cb251-19"><a href="Time.html#cb251-19" aria-hidden="true" tabindex="-1"></a>                   <span class="at">p =</span> p,</span>
<span id="cb251-20"><a href="Time.html#cb251-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">m0 =</span> m0,</span>
<span id="cb251-21"><a href="Time.html#cb251-21" aria-hidden="true" tabindex="-1"></a>                   <span class="at">C0 =</span> C0)</span>
<span id="cb251-22"><a href="Time.html#cb251-22" aria-hidden="true" tabindex="-1"></a>dat_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">yt =</span> yt, <span class="at">Ft =</span> Ft, <span class="at">Gt =</span> Gt)</span>
<span id="cb251-23"><a href="Time.html#cb251-23" aria-hidden="true" tabindex="-1"></a>init_list <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="fl">0.01</span>, <span class="at">sqrt_Wt_diag =</span> <span class="fu">sqrt</span>(<span class="fu">rep</span>(<span class="fl">0.1</span>, p)))</span>
<span id="cb251-24"><a href="Time.html#cb251-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-25"><a href="Time.html#cb251-25" aria-hidden="true" tabindex="-1"></a>Rmodel <span class="ot">&lt;-</span></span>
<span id="cb251-26"><a href="Time.html#cb251-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nimbleModel</span>(</span>
<span id="cb251-27"><a href="Time.html#cb251-27" aria-hidden="true" tabindex="-1"></a>    Example11_16_O3_Nimble,</span>
<span id="cb251-28"><a href="Time.html#cb251-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">constants =</span> const_list,</span>
<span id="cb251-29"><a href="Time.html#cb251-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> dat_list,</span>
<span id="cb251-30"><a href="Time.html#cb251-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">inits =</span> init_list</span>
<span id="cb251-31"><a href="Time.html#cb251-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb251-32"><a href="Time.html#cb251-32" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">initializeInfo</span>()</span>
<span id="cb251-33"><a href="Time.html#cb251-33" aria-hidden="true" tabindex="-1"></a>Rmodel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb251-34"><a href="Time.html#cb251-34" aria-hidden="true" tabindex="-1"></a>Cmodel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rmodel, <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span>)</span>
<span id="cb251-35"><a href="Time.html#cb251-35" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span></span>
<span id="cb251-36"><a href="Time.html#cb251-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">configureMCMC</span>(Rmodel, <span class="at">monitors =</span> <span class="fu">c</span>(<span class="st">&quot;tau&quot;</span>, <span class="st">&quot;sqrt_Wt_diag&quot;</span>, <span class="st">&quot;theta&quot;</span>, <span class="st">&quot;ft&quot;</span>))</span>
<span id="cb251-37"><a href="Time.html#cb251-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-38"><a href="Time.html#cb251-38" aria-hidden="true" tabindex="-1"></a>Rmcmc <span class="ot">&lt;-</span> <span class="fu">buildMCMC</span>(conf)</span>
<span id="cb251-39"><a href="Time.html#cb251-39" aria-hidden="true" tabindex="-1"></a>Cmcmc <span class="ot">&lt;-</span></span>
<span id="cb251-40"><a href="Time.html#cb251-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compileNimble</span>(</span>
<span id="cb251-41"><a href="Time.html#cb251-41" aria-hidden="true" tabindex="-1"></a>    Rmcmc,</span>
<span id="cb251-42"><a href="Time.html#cb251-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> Cmodel,</span>
<span id="cb251-43"><a href="Time.html#cb251-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">resetFunctions =</span> <span class="cn">TRUE</span>,</span>
<span id="cb251-44"><a href="Time.html#cb251-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">showCompilerOutput =</span> <span class="cn">FALSE</span></span>
<span id="cb251-45"><a href="Time.html#cb251-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb251-46"><a href="Time.html#cb251-46" aria-hidden="true" tabindex="-1"></a>niter <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb251-47"><a href="Time.html#cb251-47" aria-hidden="true" tabindex="-1"></a>nburnin <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="sc">*</span> niter</span>
<span id="cb251-48"><a href="Time.html#cb251-48" aria-hidden="true" tabindex="-1"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb251-49"><a href="Time.html#cb251-49" aria-hidden="true" tabindex="-1"></a>start_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb251-50"><a href="Time.html#cb251-50" aria-hidden="true" tabindex="-1"></a>post_samples <span class="ot">&lt;-</span></span>
<span id="cb251-51"><a href="Time.html#cb251-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">runMCMC</span>(</span>
<span id="cb251-52"><a href="Time.html#cb251-52" aria-hidden="true" tabindex="-1"></a>    Cmcmc,</span>
<span id="cb251-53"><a href="Time.html#cb251-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">niter =</span> niter,</span>
<span id="cb251-54"><a href="Time.html#cb251-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">nburnin =</span> nburnin,</span>
<span id="cb251-55"><a href="Time.html#cb251-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">thin =</span> nthin,</span>
<span id="cb251-56"><a href="Time.html#cb251-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">nchains =</span> <span class="dv">2</span>,</span>
<span id="cb251-57"><a href="Time.html#cb251-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span></span>
<span id="cb251-58"><a href="Time.html#cb251-58" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb251-59"><a href="Time.html#cb251-59" aria-hidden="true" tabindex="-1"></a>end_time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb251-60"><a href="Time.html#cb251-60" aria-hidden="true" tabindex="-1"></a>run_time <span class="ot">&lt;-</span> end_time <span class="sc">-</span> start_time</span>
<span id="cb251-61"><a href="Time.html#cb251-61" aria-hidden="true" tabindex="-1"></a>run_time</span></code></pre></div>
<div class="sourceCode" id="cb252"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb252-1"><a href="Time.html#cb252-1" aria-hidden="true" tabindex="-1"></a>post_summary <span class="ot">&lt;-</span> <span class="fu">nimSummary</span>(post_samples)</span>
<span id="cb252-2"><a href="Time.html#cb252-2" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="ot">&lt;-</span> post_samples <span class="sc">|&gt;</span> <span class="fu">tidy_draws</span>()</span>
<span id="cb252-3"><a href="Time.html#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="Time.html#cb252-4" aria-hidden="true" tabindex="-1"></a>tidy_post_samples <span class="sc">|&gt;</span></span>
<span id="cb252-5"><a href="Time.html#cb252-5" aria-hidden="true" tabindex="-1"></a>   dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb252-6"><a href="Time.html#cb252-6" aria-hidden="true" tabindex="-1"></a>    .chain,</span>
<span id="cb252-7"><a href="Time.html#cb252-7" aria-hidden="true" tabindex="-1"></a>    .iteration,</span>
<span id="cb252-8"><a href="Time.html#cb252-8" aria-hidden="true" tabindex="-1"></a>    .draw,</span>
<span id="cb252-9"><a href="Time.html#cb252-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;tau&#39;</span>,</span>
<span id="cb252-10"><a href="Time.html#cb252-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,</span>
<span id="cb252-11"><a href="Time.html#cb252-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,</span>
<span id="cb252-12"><a href="Time.html#cb252-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;sqrt_Wt_diag[3]&#39;</span></span>
<span id="cb252-13"><a href="Time.html#cb252-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb252-14"><a href="Time.html#cb252-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather</span>(vars, value, <span class="sc">-</span>.chain, <span class="sc">-</span>.iteration, <span class="sc">-</span>.draw) <span class="sc">|&gt;</span></span>
<span id="cb252-15"><a href="Time.html#cb252-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .iteration, <span class="at">y =</span> value)) <span class="sc">+</span></span>
<span id="cb252-16"><a href="Time.html#cb252-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">factor</span>(.chain)), <span class="at">linewidth =</span> <span class="fl">0.25</span>,</span>
<span id="cb252-17"><a href="Time.html#cb252-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb252-18"><a href="Time.html#cb252-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> vars, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>, <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb252-19"><a href="Time.html#cb252-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span></span>
<span id="cb252-20"><a href="Time.html#cb252-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb252-21"><a href="Time.html#cb252-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20o3%20nimble%20traceplots-1.png" width="672" /></p>
<div class="sourceCode" id="cb253"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb253-1"><a href="Time.html#cb253-1" aria-hidden="true" tabindex="-1"></a>post_summary[<span class="fu">c</span>(<span class="st">&#39;tau&#39;</span>,<span class="st">&#39;sqrt_Wt_diag[1]&#39;</span>,<span class="st">&#39;sqrt_Wt_diag[2]&#39;</span>,<span class="st">&#39;sqrt_Wt_diag[3]&#39;</span>),]</span></code></pre></div>
<pre><code>##                 post.mean post.sd  q2.5   q50 q97.5 f0    n.eff  Rhat
## tau                 8.549   0.550 7.479 8.549 9.617  1 1021.424 1.001
## sqrt_Wt_diag[1]     2.208   0.731 1.018 2.125 3.768  1  907.450 1.002
## sqrt_Wt_diag[2]     0.250   0.124 0.075 0.227 0.549  1 1441.798 1.005
## sqrt_Wt_diag[3]     0.428   0.411 0.012 0.310 1.591  1  875.370 1.003</code></pre>
<div class="sourceCode" id="cb255"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb255-1"><a href="Time.html#cb255-1" aria-hidden="true" tabindex="-1"></a>post_sum_theta <span class="ot">&lt;-</span></span>
<span id="cb255-2"><a href="Time.html#cb255-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(post_summary) <span class="sc">|&gt;</span>  <span class="fu">rownames_to_column</span>() <span class="sc">|&gt;</span></span>
<span id="cb255-3"><a href="Time.html#cb255-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(rowname, <span class="st">&quot;theta&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb255-4"><a href="Time.html#cb255-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(rowname, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>) <span class="sc">|&gt;</span></span>
<span id="cb255-5"><a href="Time.html#cb255-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(rowname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x1&quot;</span>, <span class="st">&quot;x2&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>) <span class="sc">|&gt;</span></span>
<span id="cb255-6"><a href="Time.html#cb255-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">component =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x1))) <span class="sc">|&gt;</span></span>
<span id="cb255-7"><a href="Time.html#cb255-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">&quot;.*?([0-9]+).*&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, x2))) <span class="sc">|&gt;</span></span>
<span id="cb255-8"><a href="Time.html#cb255-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(component, time, q2<span class="fl">.5</span>, q50, q97<span class="fl">.5</span>)</span>
<span id="cb255-9"><a href="Time.html#cb255-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-10"><a href="Time.html#cb255-10" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> post_sum_theta, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb255-11"><a href="Time.html#cb255-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> q2<span class="fl">.5</span>, <span class="at">ymax =</span> q97<span class="fl">.5</span>),</span>
<span id="cb255-12"><a href="Time.html#cb255-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">fill =</span> <span class="st">&quot;lightgray&quot;</span>,</span>
<span id="cb255-13"><a href="Time.html#cb255-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb255-14"><a href="Time.html#cb255-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>(<span class="fu">aes</span>(<span class="at">y =</span> q50), <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">linewidth =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb255-15"><a href="Time.html#cb255-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb255-16"><a href="Time.html#cb255-16" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> component,</span>
<span id="cb255-17"><a href="Time.html#cb255-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">2</span>,</span>
<span id="cb255-18"><a href="Time.html#cb255-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb255-19"><a href="Time.html#cb255-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">label_bquote</span>(theta[.(component)])</span>
<span id="cb255-20"><a href="Time.html#cb255-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb255-21"><a href="Time.html#cb255-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;&quot;</span>) <span class="sc">+</span></span>
<span id="cb255-22"><a href="Time.html#cb255-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Time&quot;</span>) <span class="sc">+</span></span>
<span id="cb255-23"><a href="Time.html#cb255-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_clear</span>() <span class="sc">+</span></span>
<span id="cb255-24"><a href="Time.html#cb255-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb255-25"><a href="Time.html#cb255-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.background =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="bookdown-demo_files/figure-html/Ex%2011.16%20o3%20nimble%20posterior%20summary-1.png" width="672" /></p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="Time.html#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: I am missing the fitted values here</span></span></code></pre></div>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="hazards.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exposure.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/11-Chpt11.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["bookdown-demo.pdf", "bookdown-demo.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
